<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>KubernetesBinaryInstallation HA | William&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²kubernetesé«˜å¯ç”¨é›†ç¾¤">
<meta name="author" content="deemoprobe">
<link rel="canonical" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesbinaryinstallation-ha/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.86a98c52ea686f5031e49bb9626478e3e3886f043822229977ef4042e6f8bbb3.css" integrity="sha256-hqmMUupob1Ax5Ju5YmR44&#43;OIbwQ4IiKZd&#43;9AQub4u7M=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://deemoprobe.github.io/img/favicon/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://deemoprobe.github.io/img/favicon/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://deemoprobe.github.io/img/favicon/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://deemoprobe.github.io/img/favicon/apple-touch-icon.png">
<link rel="mask-icon" href="https://deemoprobe.github.io/img/favicon/android-chrome-192x192.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="KubernetesBinaryInstallation HA" />
<meta property="og:description" content="äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²kubernetesé«˜å¯ç”¨é›†ç¾¤" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesbinaryinstallation-ha/" />
<meta property="og:image" content="https://deemoprobe.github.io/img/kubernetes.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-29T14:17:51+08:00" />
<meta property="article:modified_time" content="2023-04-29T14:17:51+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://deemoprobe.github.io/img/kubernetes.png" />
<meta name="twitter:title" content="KubernetesBinaryInstallation HA"/>
<meta name="twitter:description" content="äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²kubernetesé«˜å¯ç”¨é›†ç¾¤"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://deemoprobe.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
          "item": "https://deemoprobe.github.io/posts/tech/"
        },

        {
          "@type": "ListItem",
          "position":  3 ,
          "name": "Kubernetes",
          "item": "https://deemoprobe.github.io/posts/tech/kubernetes/"
        }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "KubernetesBinaryInstallation HA",
      "item": "https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesbinaryinstallation-ha/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "KubernetesBinaryInstallation HA",
  "name": "KubernetesBinaryInstallation HA",
  "description": "äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²kubernetesé«˜å¯ç”¨é›†ç¾¤",
  "keywords": [
    ""
  ],
  "articleBody": "ç¯å¢ƒè¯´æ˜ å®¿ä¸»æœºç³»ç»Ÿï¼šWindows 10 è™šæ‹Ÿæœºç‰ˆæœ¬ï¼šVMwareÂ® Workstation 16 Pro IOSé•œåƒç‰ˆæœ¬ï¼šCentOS Linux release 7.9.2009 Kubernetesç‰ˆæœ¬ï¼š1.26.4 Runtimeï¼šContainerd v1.6.20 Etcdç‰ˆæœ¬ï¼š3.5.6 é›†ç¾¤æ“ä½œç”¨æˆ·ï¼šroot æ›´æ–°æ—¶é—´ï¼š2023-04-21 CentOS7å®‰è£…è¯·å‚è€ƒåšå®¢æ–‡ç« ï¼šLINUXä¹‹VMWARE WORKSTATIONå®‰è£…CENTOS-7\nèµ„æºåˆ†é… ç½‘æ®µåˆ’åˆ†\nKubernetesé›†ç¾¤éœ€è¦è§„åˆ’ä¸‰ä¸ªç½‘æ®µï¼š\nå®¿ä¸»æœºç½‘æ®µï¼šKubernetesé›†ç¾¤èŠ‚ç‚¹çš„ç½‘æ®µ Podç½‘æ®µï¼šé›†ç¾¤å†…Podçš„ç½‘æ®µï¼Œç›¸å½“äºå®¹å™¨çš„IP Serviceç½‘æ®µï¼šé›†ç¾¤å†…æœåŠ¡å‘ç°ä½¿ç”¨çš„ç½‘æ®µï¼Œserviceç”¨äºé›†ç¾¤å®¹å™¨é€šä¿¡ ç”Ÿäº§ç¯å¢ƒæ ¹æ®ç”³è¯·åˆ°çš„IPèµ„æºè¿›è¡Œåˆ†é…å³å¯ï¼ŒåŸåˆ™æ˜¯ä¸‰ä¸ªç½‘æ®µä¸å…è®¸æœ‰é‡åˆIPã€‚IPç½‘æ®µè®¡ç®—å¯ä»¥å‚è€ƒï¼šåœ¨çº¿IPåœ°å€è®¡ç®—ã€‚æœ¬æ–‡è™šæ‹Ÿæœºç»ƒä¹ ç¯å¢ƒIPåœ°å€ç½‘æ®µåˆ†é…å¦‚ä¸‹ï¼š\nå®¿ä¸»æœºç½‘æ®µï¼š192.168.43.1/24 Podç½‘æ®µï¼š172.16.0.0/12 Serviceï¼š10.96.0.0/12 èŠ‚ç‚¹åˆ†é…\né‡‡ç”¨3ç®¡ç†èŠ‚ç‚¹2å·¥ä½œèŠ‚ç‚¹çš„é«˜å¯ç”¨Kubernetesé›†ç¾¤æ¨¡å¼ï¼š\nk8s-master01/k8s-master02/k8s-master03 é›†ç¾¤çš„MasterèŠ‚ç‚¹ ä¸‰ä¸ªmasterèŠ‚ç‚¹åŒæ—¶åšetcdé›†ç¾¤ k8s-node01/k8s-node02 é›†ç¾¤çš„NodeèŠ‚ç‚¹ k8s-master-vipåšé«˜å¯ç”¨k8s-master01~03çš„VIPï¼Œä¸å ç”¨ç‰©ç†èµ„æº ä¸»æœºèŠ‚ç‚¹åç§° IP CPUæ ¸å¿ƒæ•° å†…å­˜å¤§å° ç£ç›˜å¤§å° k8s-master-vip 192.168.43.200 / / / k8s-master01 192.168.43.201 2 2G 40G k8s-master02 192.168.43.202 2 2G 40G k8s-master03 192.168.43.203 2 2G 40G k8s-node01 192.168.43.204 2 2G 40G k8s-node02 192.168.43.205 2 2G 40G æ“ä½œæ­¥éª¤ æ ‡é¢˜åå°æ‹¬å·æ³¨é‡Šè¡¨æ˜æ“ä½œèŒƒå›´ï¼š\nALL æ‰€æœ‰èŠ‚ç‚¹ï¼ˆk8s-master01/k8s-master02/k8s-master03/k8s-node01/k9s-node02ï¼‰æ‰§è¡Œ Master åªéœ€è¦åœ¨masterèŠ‚ç‚¹ï¼ˆk8s-master01/k8s-master02/k8s-master03ï¼‰æ‰§è¡Œ Node åªéœ€è¦åœ¨nodeèŠ‚ç‚¹ï¼ˆk8s-node01/k8s-node02ï¼‰æ‰§è¡Œ å·²æ ‡æ³¨çš„ä¸ªåˆ«å‘½ä»¤åªéœ€è¦åœ¨æŸä¸€å°æœºå™¨æ‰§è¡Œï¼Œä¼šåœ¨æ“ä½œå‰è¯´æ˜ æœªæ ‡æ³¨çš„ä¼šåœ¨æ“ä½œæ—¶è¯´æ˜ ä½¿ç”¨cat \u003c\u003c \"EOF\" \u003e\u003e fileæˆ–cat \u003e\u003e file \u003c\u003c \"EOF\"æ·»åŠ æ–‡ä»¶å†…å®¹æ³¨æ„catåé¢çš„EOFä¸€å®šè¦åŠ ä¸ŠåŒå¼•å·ï¼ˆæ ‡å‡†è¾“å…¥çš„ï¼‰ï¼Œå¦åˆ™ä¸ä¼šä¿ç•™è¾“å…¥æ—¶çš„ç¼©è¿›æ ¼å¼è€Œä¸”ä¼šç›´æ¥è§£æè¾“å…¥æ—¶çš„å˜é‡ï¼Œè¿›è€Œé€ æˆæ–‡ä»¶å¯è¯»æ€§å·®ç”šè‡³ä¸å¯ç”¨ï¼›åŒæ—¶æ³¨æ„æ–‡ä»¶çš„\u003eé‡å†™ä¸\u003e\u003eè¿½åŠ ã€‚è™½ç„¶å•ç‹¬è½¬ä¹‰è¾“å…¥æ—¶çš„å˜é‡ä¹Ÿèƒ½é¿å…å˜é‡è¢«è§£æï¼Œä½†æ˜¯ä¸æ¨èï¼Œæ¼è½¬ä¹‰ä¼šé€ æˆä¸å¿…è¦çš„éº»çƒ¦ã€‚\nå‡†å¤‡å·¥ä½œ(ALL) æ·»åŠ ä¸»æœºä¿¡æ¯ã€å…³é—­é˜²ç«å¢™ã€å…³é—­swapã€å…³é—­SELinuxã€dnsmasqã€NetworkManager\n# æ·»åŠ ä¸»æœºä¿¡æ¯ cat \u003c\u003c \"EOF\" \u003e\u003e /etc/hosts 192.168.43.200 k8s-master-vip 192.168.43.201 k8s-master01 192.168.43.202 k8s-master02 192.168.43.203 k8s-master03 192.168.43.204 k8s-node01 192.168.43.205 k8s-node02 EOF # å…³é—­é˜²ç«å¢™ã€dnsmasqã€NetworkManagerï¼Œ--nowå‚æ•°è¡¨ç¤ºå…³é—­æœåŠ¡å¹¶ç§»é™¤å¼€æœºè‡ªå¯ # è¿™äº›æœåŠ¡æ˜¯å¦å¯ä»¥å…³é—­è§†æƒ…å†µè€Œå®šï¼Œæœ¬æ–‡æ˜¯è™šæ‹Ÿæœºå®è·µï¼Œæ²¡æœ‰ç”¨åˆ°è¿™äº›æœåŠ¡ systemctl disable --now firewalld systemctl disable --now dnsmasq systemctl disable --now NetworkManager # å…³é—­swapï¼Œå¹¶æ³¨é‡Šfstabæ–‡ä»¶swapæ‰€åœ¨è¡Œ swapoff -a sed -i '/swap/s/^\\(.*\\)$/#\\1/g' /etc/fstab # å…³é—­SELinuxï¼Œå¹¶æ›´æ”¹selinuxé…ç½®æ–‡ä»¶ setenforce 0 sed -i \"s/=enforcing/=disabled/g\" /etc/selinux/config å€¼å¾—æ³¨æ„çš„æ˜¯/etc/sysconfig/selinuxæ–‡ä»¶æ˜¯/etc/selinux/configæ–‡ä»¶çš„è½¯è¿æ¥ï¼Œç”¨sed -iå‘½ä»¤ä¿®æ”¹è½¯è¿æ¥æ–‡ä»¶ä¼šç ´åè½¯è¿æ¥å±æ€§ï¼Œå°†/etc/sysconfig/selinuxå˜ä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼Œå³ä½¿è¯¥æ–‡ä»¶è¢«ä¿®æ”¹äº†ï¼Œä½†æºæ–‡ä»¶/etc/selinux/configé…ç½®æ˜¯æ²¡å˜çš„ã€‚æ­¤å¤–ï¼Œä½¿ç”¨vimç­‰ç¼–è¾‘å™¨ç¼–è¾‘æºæ–‡ä»¶æˆ–é“¾æ¥æ–‡ä»¶ï¼ˆç¼–è¾‘æ¨¡å¼ä¸ä¼šä¿®æ”¹æ–‡ä»¶å±æ€§ï¼‰ä¿®æ”¹ä¹Ÿå¯ä»¥ã€‚è½¯é“¾æ¥åŸç†å¯å‚è€ƒåšå®¢ï¼šLINUXä¹‹INODEè¯¦è§£\n# é»˜è®¤çš„yumæºå¤ªæ…¢ï¼Œæ›´æ–°ä¸ºé˜¿é‡Œæºï¼ŒåŒæ—¶ç”¨sedå‘½ä»¤åˆ é™¤æ–‡ä»¶ä¸­ä¸éœ€è¦çš„ä¸¤ä¸ªURLçš„è¡Œ curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo # å®‰è£…å¸¸ç”¨å·¥å…·åŒ… yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y # é…ç½®ntpdateï¼ŒåŒæ­¥æœåŠ¡å™¨æ—¶é—´ rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm yum install ntpdate -y # åŒæ­¥æ—¶åŒºå’Œæ—¶é—´ ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime echo 'Asia/Shanghai' \u003e/etc/timezone ntpdate time2.aliyun.com # å¯ä»¥åŠ å…¥è®¡åˆ’ä»»åŠ¡ï¼Œä¿è¯é›†ç¾¤æ—¶é’Ÿæ˜¯ä¸€è‡´çš„ # /var/spool/cron/rootæ–‡ä»¶ä¹Ÿæ˜¯crontab -eå†™å…¥çš„æ–‡ä»¶ # crontabæ‰§è¡Œæ—¥å¿—æŸ¥çœ‹å¯ç”¨ï¼štail -f /var/log/cron cat \u003c\u003c \"EOF\" \u003e\u003e /var/spool/cron/root */5 * * * * /usr/sbin/ntpdate time2.aliyun.com EOF # é¡»çŸ¥ï¼šå¦‚æœè®¾ç½®äº†å®šæ—¶ä»»åŠ¡ï¼Œä¼šç»å¸¸æ”¶åˆ°æç¤ºâ€œYou have new mail in /var/spool/mail/rootâ€ # ï¼ˆå¯é€‰ï¼‰ç¦ç”¨æç¤ºï¼šecho \"unset MAILCHECK\" \u003e\u003e ~/.bashrc;source ~/.bashrc # ç¦ç”¨æç¤ºå/var/spool/mail/rootæ–‡ä»¶ä¾æ—§ä¼šè®°å½•rootæ“ä½œæ—¥å¿—ï¼Œå¯éšæ—¶æŸ¥çœ‹ # ä¿è¯æ–‡ä»¶å¥æŸ„ä¸ä¼šé™åˆ¶é›†ç¾¤çš„å¯æŒç»­å‘å±•ï¼Œé…ç½®limits ulimit -SHn 65500 cat \u003c\u003c \"EOF\" \u003e\u003e /etc/security/limits.conf * soft nofile 65500 * hard nofile 65500 * soft nproc 65500 * hard nproc 65500 * soft memlock unlimited * hard memlock unlimited EOF # é…ç½®å…å¯†ç™»å½•ï¼Œk8s-master01åˆ°å…¶ä»–èŠ‚ç‚¹ # ç”Ÿæˆå¯†é’¥å¯¹ï¼ˆåœ¨k8s-master01èŠ‚ç‚¹é…ç½®å³å¯ï¼‰ ssh-keygen -t rsa # æ‹·è´å…¬é’¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œé¦–æ¬¡éœ€è¦è®¤è¯ä¸€ä¸‹å„ä¸ªèŠ‚ç‚¹çš„rootå¯†ç ï¼Œä»¥åå°±å¯ä»¥å…å¯†sshåˆ°å…¶ä»–èŠ‚ç‚¹ for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do ssh-copy-id -i .ssh/id_rsa.pub $i;done # å…‹éš†äºŒè¿›åˆ¶ä»“åº“1.26åˆ†æ”¯çš„æ–‡ä»¶ï¼ˆk8s-master01ä¸Šæ“ä½œå³å¯ï¼‰ cd /root;git clone https://gitee.com/deemoprobe/k8s-ha-install.git -b manual-installation-v1.26.x # æ‰€æœ‰èŠ‚ç‚¹ç³»ç»Ÿå‡çº§ yum update --exclude=kernel* -y å‡çº§å†…æ ¸ï¼Œ4.17ä»¥ä¸‹çš„å†…æ ¸cgroupå­˜åœ¨å†…å­˜æ³„æ¼çš„BUGï¼Œå…·ä½“åˆ†æè¿‡ç¨‹æµè§ˆå™¨æœKubernetesé›†ç¾¤ä¸ºä»€ä¹ˆè¦å‡çº§å†…æ ¸ä¼šæœ‰å¾ˆå¤šæ–‡ç« è®²è§£\nå†…æ ¸å¤‡ç”¨ä¸‹è½½ï¼ˆä¸‹è½½åˆ°æœ¬åœ°åä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå°½é‡ä¸è¦ç”¨wgetï¼‰ï¼š\nkernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm # ä¸‹è½½4.19ç‰ˆæœ¬å†…æ ¸ï¼Œå¦‚æœæ— æ³•ä¸‹è½½ï¼Œå¯ä»¥ç”¨ä¸Šé¢æä¾›çš„å¤‡ç”¨ä¸‹è½½ cd /root wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm # å¯ä»¥åœ¨k8s-master01èŠ‚ç‚¹ä¸‹è½½åï¼Œå…å¯†ä¼ åˆ°å…¶ä»–èŠ‚ç‚¹ for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp kernel-ml-* $i:/root;done # æ‰€æœ‰èŠ‚ç‚¹å®‰è£…å†…æ ¸ cd /root \u0026\u0026 yum localinstall -y kernel-ml* # æ‰€æœ‰èŠ‚ç‚¹æ›´æ”¹å†…æ ¸å¯åŠ¨é¡ºåº grub2-set-default 0 \u0026\u0026 grub2-mkconfig -o /etc/grub2.cfg grubby --args=\"user_namespace.enable=1\" --update-kernel=\"$(grubby --default-kernel)\" # æŸ¥çœ‹é»˜è®¤å†…æ ¸ï¼Œå¹¶é‡å¯èŠ‚ç‚¹ grubby --default-kernel reboot # ç¡®è®¤å†…æ ¸ç‰ˆæœ¬ uname -a # ï¼ˆå¯é€‰ï¼‰åˆ é™¤è€ç‰ˆæœ¬çš„å†…æ ¸ï¼Œé¿å…ä»¥åè¢«å‡çº§å–ä»£é»˜è®¤çš„å¼€æœº4.19å†…æ ¸ rpm -qa | grep kernel yum remove -y kernel-3* # å‡çº§ç³»ç»Ÿè½¯ä»¶åŒ…ï¼ˆå¦‚æœè·³è¿‡å†…æ ¸å‡çº§åŠ å‚æ•° --exclude=kernel*ï¼‰ yum update -y # å®‰è£…IPVSç›¸å…³å·¥å…·ï¼Œç”±äºIPVSåœ¨èµ„æºæ¶ˆè€—å’Œæ€§èƒ½ä¸Šå‡å·²æ˜æ˜¾ä¼˜äºiptablesï¼Œæ‰€ä»¥æ¨èå¼€å¯ # å…·ä½“åŸå› å¯å‚è€ƒå®˜ç½‘ä»‹ç» https://kubernetes.io/zh/blog/2018/07/09/ipvs-based-in-cluster-load-balancing-deep-dive/ yum install ipvsadm ipset sysstat conntrack libseccomp -y # åŠ è½½æ¨¡å—ï¼Œæœ€åä¸€æ¡4.18åŠä»¥ä¸‹å†…æ ¸ä½¿ç”¨nf_conntrack_ipv4ï¼Œ4.19å·²æ”¹ä¸ºnf_conntrack modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack # ç¼–å†™å‚æ•°æ–‡ä»¶ cat \u003c\u003c \"EOF\" \u003e /etc/modules-load.d/ipvs.conf ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp ip_vs_sh nf_conntrack ip_tables ip_set xt_set ipt_set ipt_rpfilter ipt_REJECT ipip EOF # systemd-modules-loadåŠ å…¥å¼€æœºè‡ªå¯ systemctl enable --now systemd-modules-load # è‡ªå®šä¹‰å†…æ ¸å‚æ•°ä¼˜åŒ–é…ç½®æ–‡ä»¶ cat \u003c\u003c \"EOF\" \u003e /etc/sysctl.d/kubernetes.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-ip6tables = 1 fs.may_detach_mounts = 1 net.ipv4.conf.all.route_localnet = 1 vm.overcommit_memory=1 vm.panic_on_oom=0 fs.inotify.max_user_watches=89100 fs.file-max=52706963 fs.nr_open=52706963 net.netfilter.nf_conntrack_max=2310720 net.ipv4.tcp_keepalive_time = 600 net.ipv4.tcp_keepalive_probes = 3 net.ipv4.tcp_keepalive_intvl =15 net.ipv4.tcp_max_tw_buckets = 36000 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_max_orphans = 327680 net.ipv4.tcp_orphan_retries = 3 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.ip_conntrack_max = 65536 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.tcp_timestamps = 0 net.core.somaxconn = 16384 EOF # åŠ è½½ sysctl --system # é‡å¯æŸ¥çœ‹IPVSæ¨¡å—æ˜¯å¦ä¾æ—§åŠ è½½ reboot lsmod | grep -e ip_vs -e nf_conntrack ä¿è¯æ¯å°æœåŠ¡å™¨ä¸­IPVSåŠ è½½æˆåŠŸï¼Œä»¥k8s-master01ä¸ºä¾‹ï¼Œå¦‚å›¾ï¼š éƒ¨ç½²Containerd(ALL) Kubernetes1.24ç‰ˆæœ¬ä»¥åå°†ä¸å†æ”¯æŒDockerä½œä¸ºRuntimeï¼Œæœ¬æ–‡å®‰è£…ä½¿ç”¨Containerdä½œä¸ºRuntimeã€‚\n# é…ç½®é˜¿é‡Œdockeræº yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo # å®‰è£…æœ€æ–°ç‰ˆæœ¬dockerå’Œcontainerd.ioï¼Œå®‰è£…dockeræ˜¯ä¸ºäº†ä½¿ç”¨docker CLI yum install docker-ce docker-ce-cli containerd.io -y # ï¼ˆå¯é€‰ï¼‰ä¹Ÿå¯ä»¥æŒ‰éœ€å®‰è£…æŒ‡å®šç‰ˆæœ¬ yum install docker-ce-20.10.* docker-ce-cli-20.10.* containerd -y # é…ç½®Containerdæ¨¡å— cat \u003c\u003c \"EOF\" \u003e /etc/modules-load.d/containerd.conf overlay br_netfilter EOF # åŠ è½½æ¨¡å— modprobe -- overlay modprobe -- br_netfilter # é…ç½®å†…æ ¸å‚æ•° cat \u003c\u003c \"EOF\" \u003e /etc/sysctl.d/containerd.conf net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 EOF # åŠ è½½å†…æ ¸å‚æ•° sysctl --system # ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶ mkdir -p /etc/containerd containerd config default | tee /etc/containerd/config.toml # æ›´æ”¹Cgroupä¸ºSystemdï¼Œåœ¨containerd.runtimes.runc.optionsè¡Œåçš„SystemdCgroup = falseä¿®æ”¹ä¸ºtrueï¼Œå¦‚æœé…ç½®é¡¹ä¸å­˜åœ¨å°±è‡ªè¡Œæ·»åŠ ï¼Œç¼©è¿›ä¿©ç©ºæ ¼æ·»åŠ SystemdCgroup = trueä¸€è¡Œ vim /etc/containerd/config.toml ... [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options] SystemdCgroup = true ... # å°†sandbox_imageçš„Pauseé•œåƒåœ°å€æ”¹æˆå›½å†…ï¼šregistry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7 vim /etc/containerd/config.toml sandbox_image = \"registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7\" # ï¼ˆå¯é€‰ï¼‰ä¹Ÿå¯ä»¥åœ¨k8s-master01ç¼–è¾‘/etc/containerd/config.tomlæ–‡ä»¶åï¼Œå°†ç¼–è¾‘ååŒåæ–‡ä»¶åŒæ­¥åˆ°å…¶ä»–æœåŠ¡å™¨ï¼Œè‡ªåŠ¨è¦†ç›– for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp /etc/containerd/config.toml $i:/etc/containerd/config.toml;done # æŸ¥çœ‹ç¡®è®¤æ˜¯å¦é…ç½®æˆåŠŸ cat /etc/containerd/config.toml | grep -e Systemd -e sandbox_image # å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯ systemctl daemon-reload systemctl enable --now containerd # containerdè¿è¡Œæ—¶çš„CLIæ˜¯ctr [root@k8s-master01 ~]# ctr images ls REF TYPE DIGEST SIZE PLATFORMS LABELS [root@k8s-master01 ~]# ctr version Client: Version: 1.6.20 Revision: 2806fc1057397dbaeefbea0e4e17bddfbd388f38 Go version: go1.19.7 Server: Version: 1.6.20 Revision: 2806fc1057397dbaeefbea0e4e17bddfbd388f38 UUID: 9958928e-300c-4778-b83c-6c0073414f3e # é…ç½®crictlè¿æ¥çš„è¿è¡Œæ—¶socketæ¥å£ï¼ˆæŒ‡å‘containerd's GRPC serverï¼š/run/containerd/containerd.sockï¼‰ # crictl é»˜è®¤è¿æ¥åˆ°unix:///var/run/dockershim.sock cat \u003c\u003c \"EOF\" \u003e /etc/crictl.yaml runtime-endpoint: unix:///run/containerd/containerd.sock image-endpoint: unix:///run/containerd/containerd.sock timeout: 10 debug: false EOF # crictlæŒ‰éœ€é€‰æ‹©ï¼Œhttps://github.com/kubernetes-sigs/cri-tools/releases # containerdå®¹å™¨ç®¡ç†CLIæ˜¯crictlï¼Œè¯¥å‘½ä»¤ä½¿ç”¨å’Œdockerå‘½ä»¤ç±»ä¼¼ï¼Œä¸‹è½½åŒ…ä¸Šä¼ åˆ°k8s-master01 [root@k8s-master01 ~]# tar -zxvf crictl-v1.27.0-linux-amd64.tar.gz [root@k8s-master01 ~]# mv crictl /usr/local/bin/ [root@k8s-master01 ~]# crictl version Version: 0.1.0 RuntimeName: containerd RuntimeVersion: 1.6.20 RuntimeApiVersion: v1 # äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å‘é€åˆ°å…¶ä»–èŠ‚ç‚¹ [root@k8s-master01 ~]# for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp /usr/local/bin/crictl $i:/usr/local/bin/;done crictl æ˜¯CRIï¼ˆContainer Runtime Interfaceï¼‰å…¼å®¹çš„å®¹å™¨è¿è¡Œæ—¶çš„CLIï¼ˆCommand-Line Interfaceï¼‰ã€‚å¯ä»¥è¿™ä¸ªå‘½ä»¤æ¥æ£€æŸ¥å’Œè°ƒè¯• Kubernetes èŠ‚ç‚¹ä¸Šçš„å®¹å™¨è¿è¡Œæ—¶å’Œåº”ç”¨ç¨‹åºã€‚ä»‹ç»å’Œå®‰è£…æ–¹å¼å¯è§ï¼šcritoolsæˆ–Kuberneteså®˜æ–¹ä»‹ç»\näºŒè¿›åˆ¶åŒ…å’Œè¯ä¹¦ k8s-master01èŠ‚ç‚¹ä¸Šä¸‹è½½å¹¶å®‰è£…KubernetesäºŒè¿›åˆ¶å®‰è£…åŒ…ï¼ˆserver-binariesï¼Œé€‰æ‹©å¯¹åº”çš„æ¶æ„å³å¯ï¼‰å’ŒETCDäºŒè¿›åˆ¶å®‰è£…åŒ…ï¼Œå¯åœ¨GitHubä¸ŠæŸ¥çœ‹Kubernetes1.23.xç‰ˆæœ¬çš„ä¿¡æ¯ï¼Œå®˜æ–¹GitHub-Kubernetes1.23ç‰ˆæœ¬é“¾æ¥ï¼ŒETCDå®˜æ–¹é“¾æ¥\n# ä»¥ä¸‹åœ¨k8s-master01æ‰§è¡Œ # ä¸‹è½½å¤ªæ…¢çš„è¯å¯ä»¥åœ¨ç›¸åº”é“¾æ¥ç½‘é¡µä¸Šä¸‹è½½å¥½ä¼ åˆ°æœåŠ¡å™¨ wget https://dl.k8s.io/v1.26.4/kubernetes-server-linux-amd64.tar.gz wget https://github.com/etcd-io/etcd/releases/download/v3.5.6/etcd-v3.5.6-linux-amd64.tar.gz # è§£å‹å®‰è£…ï¼Œ--strip-components=Nè¡¨ç¤ºè§£å‹æ—¶å¿½ç•¥è§£å‹åçš„Nå±‚ç›®å½•ï¼Œç›´æ¥è·å–Nå±‚ç›®å½•åçš„ç›®æ ‡æ–‡ä»¶ã€‚kubernetes/server/bin/æ˜¯ä¸‰å±‚ï¼Œetcd-v3.5.6-linux-amd64/æ˜¯ä¸€å±‚ tar -zxvf kubernetes-server-linux-amd64.tar.gz --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} tar -zxvf etcd-v3.5.6-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.6-linux-amd64/etcd{,ctl} # ç¡®è®¤ç‰ˆæœ¬ kubectl version kubelet --version etcdctl version # æ‹·è´ç»„ä»¶åˆ°å…¶ä»–èŠ‚ç‚¹ï¼ŒNodeèŠ‚ç‚¹åªéœ€è¦kubeletå’Œkube-proxy for i in k8s-master02 k8s-master03; do scp /usr/local/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} $i:/usr/local/bin/; scp /usr/local/bin/etcd* $i:/usr/local/bin/; done for i in k8s-node01 k8s-node02; do scp /usr/local/bin/kube{let,-proxy} $i:/usr/local/bin/; done é…ç½®è¯ä¹¦ # masterèŠ‚ç‚¹åˆ›å»ºetcdè¯ä¹¦ç›®å½• mkdir -p /etc/etcd/ssl # æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºpkiè¯ä¹¦ç›®å½•å’ŒCNIç›®å½•ï¼ˆåé¢calicoä½¿ç”¨ï¼‰ mkdir -p /etc/kubernetes/pki mkdir -p /opt/cni/bin # ä»¥ä¸‹åœ¨k8s-master01æ“ä½œ # å®‰è£…è¯ä¹¦ç”Ÿæˆå·¥å…·ï¼Œå¦‚æœé€Ÿåº¦æ…¢å¯ä»¥æµè§ˆå™¨ä¸‹è½½åä¸Šä¼ è‡³æœåŠ¡å™¨æ”¹åå³å¯ wget \"https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\" -O /usr/local/bin/cfssl wget \"https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\" -O /usr/local/bin/cfssljson chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson # åœ¨master01èŠ‚ç‚¹ç”Ÿæˆetcdè¯ä¹¦ cd /root/k8s-ha-install/pki cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca cfssl gencert \\ -ca=/etc/etcd/ssl/etcd-ca.pem \\ -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \\ -config=ca-config.json \\ -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.43.201,192.168.43.202,192.168.43.203 \\ -profile=kubernetes \\ etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd # å¤åˆ¶etcdè¯ä¹¦åˆ°å…¶ä»–masterèŠ‚ç‚¹ for i in k8s-master02 k8s-master03; do for FILE in etcd-ca-key.pem etcd-ca.pem etcd-key.pem etcd.pem; do scp /etc/etcd/ssl/${FILE} $i:/etc/etcd/ssl/${FILE} done done # ç”ŸæˆKubernetesé›†ç¾¤caè¯ä¹¦ cd /root/k8s-ha-install/pki cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca # k8s serviceç½‘æ®µ10.96.0.0/12ï¼Œå¡«å…¥ç½‘æ®µç¬¬ä¸€ä¸ªIPï¼›é›†ç¾¤VIPåœ°å€192.168.43.200 cfssl gencert -ca=/etc/kubernetes/pki/ca.pem -ca-key=/etc/kubernetes/pki/ca-key.pem -config=ca-config.json -hostname=10.96.0.1,192.168.43.200,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.43.201,192.168.43.202,192.168.43.203 -profile=kubernetes apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver # ç”Ÿæˆapiserverçš„ç¬¬ä¸‰æ–¹ç»„ä»¶ä½¿ç”¨çš„èšåˆè¯ä¹¦ï¼Œå‘Šè­¦å¯ä»¥å¿½ç•¥ cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca cfssl gencert -ca=/etc/kubernetes/pki/front-proxy-ca.pem -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem -config=ca-config.json -profile=kubernetes front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client # ç”Ÿæˆcontroller-managerè¯ä¹¦ cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager # è®¾ç½®é›†ç¾¤ä¿¡æ¯ï¼Œé›†ç¾¤åï¼škubernetes serverï¼šhttps://192.168.43.200:8443 # å¦‚æœä¸æ˜¯é«˜å¯ç”¨é›†ç¾¤ï¼Œ192.168.43.200:8443æ”¹ä¸ºmaster01çš„åœ°å€ï¼Œ8443æ”¹ä¸ºapiserverçš„ç«¯å£ï¼Œé»˜è®¤æ˜¯6443 kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.43.200:8443 \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œcontextä¸ºsystem:kube-controller-manager@kubernetes kubectl config set-context system:kube-controller-manager@kubernetes \\ --cluster=kubernetes \\ --user=system:kube-controller-manager \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # è®¾ç½®ç”¨æˆ·è®¤è¯ä¿¡æ¯ï¼Œç”¨æˆ·ä¸ºsystem:kube-controller-manager kubectl config set-credentials system:kube-controller-manager \\ --client-certificate=/etc/kubernetes/pki/controller-manager.pem \\ --client-key=/etc/kubernetes/pki/controller-manager-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # è®¾ç½®é»˜è®¤é›†ç¾¤ç¯å¢ƒ kubectl config use-context system:kube-controller-manager@kubernetes \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # ç”Ÿæˆschedulerè¯ä¹¦ cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler # åŒæ ·çš„ï¼Œscheduleréœ€è¦å’Œcontroller-managerè®¾ç½®ç›¸åŒçš„é›†ç¾¤ä¸Šä¸‹æ–‡ç­‰ä¿¡æ¯ kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.43.200:8443 \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config set-credentials system:kube-scheduler \\ --client-certificate=/etc/kubernetes/pki/scheduler.pem \\ --client-key=/etc/kubernetes/pki/scheduler-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config set-context system:kube-scheduler@kubernetes \\ --cluster=kubernetes \\ --user=system:kube-scheduler \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config use-context system:kube-scheduler@kubernetes \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig # é…ç½®adminè¯ä¹¦ï¼Œä»¥åŠé›†ç¾¤ä¸Šä¸‹æ–‡ç­‰ä¿¡æ¯ cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.pem --embed-certs=true --server=https://192.168.43.200:8443 --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config set-credentials kubernetes-admin --client-certificate=/etc/kubernetes/pki/admin.pem --client-key=/etc/kubernetes/pki/admin-key.pem --embed-certs=true --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config set-context kubernetes-admin@kubernetes --cluster=kubernetes --user=kubernetes-admin --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config use-context kubernetes-admin@kubernetes --kubeconfig=/etc/kubernetes/admin.kubeconfig # åˆ›å»ºServiceAccountå¯†é’¥å¯¹ openssl genrsa -out /etc/kubernetes/pki/sa.key 2048 openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub # æ‹·è´è¯ä¹¦åˆ°å…¶ä»–masterèŠ‚ç‚¹ for i in k8s-master02 k8s-master03; do for FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do scp /etc/kubernetes/pki/${FILE} $i:/etc/kubernetes/pki/${FILE}; done; for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do scp /etc/kubernetes/${FILE} $i:/etc/kubernetes/${FILE}; done; done # æŸ¥çœ‹è¯ä¹¦æ•°é‡æ˜¯å¦ä¸º23 ls /etc/kubernetes/pki/ | wc -l 23 ETCDé›†ç¾¤(Master) å¦‚æœEtcdé›†ç¾¤æœåŠ¡å™¨å’ŒKubernetesé›†ç¾¤æœåŠ¡å™¨ä¸é‡åˆï¼ˆå³ç‹¬ç«‹çš„Etcdé›†ç¾¤ï¼‰ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µé…ç½®é›†ç¾¤IPã€‚\n# master01 cat \u003c\u003c \"EOF\" \u003e /etc/etcd/etcd.config.yml name: 'k8s-master01' data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: 'https://192.168.43.201:2380' listen-client-urls: 'https://192.168.43.201:2379,http://127.0.0.1:2379' max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: 'https://192.168.43.201:2380' advertise-client-urls: 'https://192.168.43.201:2379' discovery: discovery-fallback: 'proxy' discovery-proxy: discovery-srv: initial-cluster: 'k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380' initial-cluster-token: 'etcd-k8s-cluster' initial-cluster-state: 'new' strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: 'off' proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true peer-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' peer-client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false EOF # master02 cat \u003c\u003c \"EOF\" \u003e /etc/etcd/etcd.config.yml name: 'k8s-master02' data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: 'https://192.168.43.202:2380' listen-client-urls: 'https://192.168.43.202:2379,http://127.0.0.1:2379' max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: 'https://192.168.43.202:2380' advertise-client-urls: 'https://192.168.43.202:2379' discovery: discovery-fallback: 'proxy' discovery-proxy: discovery-srv: initial-cluster: 'k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380' initial-cluster-token: 'etcd-k8s-cluster' initial-cluster-state: 'new' strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: 'off' proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true peer-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' peer-client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false EOF # master03 cat \u003c\u003c \"EOF\" \u003e /etc/etcd/etcd.config.yml name: 'k8s-master03' data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: 'https://192.168.43.203:2380' listen-client-urls: 'https://192.168.43.203:2379,http://127.0.0.1:2379' max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: 'https://192.168.43.203:2380' advertise-client-urls: 'https://192.168.43.203:2379' discovery: discovery-fallback: 'proxy' discovery-proxy: discovery-srv: initial-cluster: 'k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380' initial-cluster-token: 'etcd-k8s-cluster' initial-cluster-state: 'new' strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: 'off' proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true peer-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' peer-client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false EOF # åœ¨æ‰€æœ‰masterèŠ‚ç‚¹åˆ›å»ºetcdæœåŠ¡å¹¶å¯åŠ¨ cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/etcd.service [Unit] Description=Etcd Service Documentation=https://coreos.com/etcd/docs/latest/ After=network.target [Service] Type=notify ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml Restart=on-failure RestartSec=10 LimitNOFILE=65536 [Install] WantedBy=multi-user.target Alias=etcd3.service EOF # æ‰€æœ‰MasterèŠ‚ç‚¹åˆ›å»ºetcdè¯ä¹¦ç›®å½•å¹¶é“¾æ¥è¯ä¹¦ï¼Œå¦åˆ™å¯åŠ¨ä¼šå¤±è´¥ mkdir /etc/kubernetes/pki/etcd ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/ # å¯åŠ¨ systemctl daemon-reload \u0026\u0026 systemctl enable --now etcd # æŸ¥çœ‹etcdé›†ç¾¤çŠ¶æ€å¦‚ä¸‹å³å¯ ETCDCTL_API=3 etcdctl --endpoints=\"192.168.43.203:2379,192.168.43.202:2379,192.168.43.201:2379\" --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem endpoint status --write-out=table +---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | 192.168.43.203:2379 | fd1372a073304e | 3.5.1 | 20 kB | false | false | 2 | 9 | 9 | | | 192.168.43.202:2379 | 837ce9c47e0719eb | 3.5.1 | 20 kB | false | false | 2 | 9 | 9 | | | 192.168.43.201:2379 | e9bf8d99824c9061 | 3.5.1 | 20 kB | true | false | 2 | 9 | 9 | | +---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ é«˜å¯ç”¨ç»„ä»¶(Master) # æ‰€æœ‰masterèŠ‚ç‚¹å®‰è£…Keepalivedå’Œhaproxyï¼Œå¹¶åˆ›å»ºé…ç½®æ–‡ä»¶ç›®å½• yum install keepalived haproxy -y mkdir /etc/haproxy mkdir /etc/keepalived # ä¸ºæ‰€æœ‰masterèŠ‚ç‚¹æ·»åŠ haproxyé…ç½®ï¼Œé…ç½®éƒ½ä¸€æ ·ï¼Œæ£€æŸ¥æœ€åä¸‰è¡Œä¸»æœºåå’ŒIPåœ°å€å¯¹åº”ä¸Šå°±è¡Œ cat \u003c\u003c \"EOF\" \u003e /etc/haproxy/haproxy.cfg global maxconn 2000 ulimit-n 16384 log 127.0.0.1 local0 err stats timeout 30s defaults log global mode http option httplog timeout connect 5000 timeout client 50000 timeout server 50000 timeout http-request 15s timeout http-keep-alive 15s frontend monitor-in bind *:33305 mode http option httplog monitor-uri /monitor frontend k8s-master bind 0.0.0.0:8443 bind 127.0.0.1:8443 mode tcp option tcplog tcp-request inspect-delay 5s default_backend k8s-master backend k8s-master mode tcp option tcplog option tcp-check balance roundrobin default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100 server k8s-master01 192.168.43.201:6443 check server k8s-master02 192.168.43.202:6443 check server k8s-master03 192.168.43.203:6443 check EOF # keepalivedé…ç½®ä¸ä¸€æ ·ï¼Œæ³¨æ„åŒºåˆ†ç½‘å¡åã€IPåœ°å€å’Œè™šæ‹ŸIPåœ°å€ # æ£€æŸ¥æœåŠ¡å™¨ç½‘å¡å ip a æˆ– ifconfig # k8s-master01 Keepalivedé…ç½® cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state MASTER interface ens33 mcast_src_ip 192.168.43.201 virtual_router_id 51 priority 101 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.43.200 } track_script { chk_apiserver } } EOF # k8s-master02 Keepalivedé…ç½® cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state BACKUP interface ens33 mcast_src_ip 192.168.43.202 virtual_router_id 51 priority 100 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.43.200 } track_script { chk_apiserver } } EOF # k8s-master03 Keepalivedé…ç½® cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state BACKUP interface ens33 mcast_src_ip 192.168.43.203 virtual_router_id 51 priority 100 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.43.200 } track_script { chk_apiserver } } EOF # æ‰€æœ‰masterèŠ‚ç‚¹é…ç½®Keepalivedå¥åº·æ£€æŸ¥è„šæœ¬ cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/check_apiserver.sh #!/bin/bash err=0 for k in $(seq 1 3) do check_code=$(pgrep haproxy) if [[ $check_code == \"\" ]]; then err=$(expr $err + 1) sleep 1 continue else err=0 break fi done if [[ $err != \"0\" ]]; then echo \"systemctl stop keepalived\" /usr/bin/systemctl stop keepalived exit 1 else exit 0 fi EOF # èµ‹äºˆå¯æ‰§è¡Œæƒé™ chmod +x /etc/keepalived/check_apiserver.sh # å¯åŠ¨haproxyå’ŒKeepalivedå¹¶åŠ å…¥å¼€æœºå¯åŠ¨ systemctl daemon-reload \u0026\u0026 systemctl enable --now haproxy \u0026\u0026 systemctl enable --now keepalived # æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ # è¿™ç§å‘Šè­¦å¯ä»¥å¿½ç•¥ï¼šMar 06 14:03:35 k8s-master01 haproxy-systemd-wrapper[1981]: [WARNING] 064/140335 (1982) : config : frontend 'GLOBAL' has no 'bind' systemctl status haproxy systemctl status keepalived # æµ‹è¯•ä¸€æ³¢ telnet k8s-master-vip 8443 ping k8s-master-vip é…ç½®é›†ç¾¤ç»„ä»¶ # æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºä»¥ä¸‹é›†ç¾¤èµ„æºç›®å½• mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes Apiserver(Master)\næ‰€æœ‰masterèŠ‚ç‚¹é…ç½®kube-apiserveræœåŠ¡ # serviceç½‘æ®µä¸º10.96.0.0/12ï¼Œå¯è‡ªè¡Œè®¾ç½®ï¼Œå…¶ä»–å‚æ•°æŒ‰éœ€é…ç½®å³å¯ # master01é…ç½® cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-apiserver.service [Unit] Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-apiserver \\ --v=2 \\ --allow-privileged=true \\ --bind-address=0.0.0.0 \\ --secure-port=6443 \\ --advertise-address=192.168.43.201 \\ --service-cluster-ip-range=10.96.0.0/12 \\ --service-node-port-range=30000-32767 \\ --etcd-servers=https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 \\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\ --service-account-key-file=/etc/kubernetes/pki/sa.pub \\ --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\ --service-account-issuer=https://kubernetes.default.svc.cluster.local \\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\ --authorization-mode=Node,RBAC \\ --enable-bootstrap-token-auth=true \\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\ --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\ --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\ --requestheader-allowed-names=aggregator \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-username-headers=X-Remote-User # --token-auth-file=/etc/kubernetes/token.csv Restart=on-failure RestartSec=10s LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF # master02é…ç½® cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-apiserver.service [Unit] Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-apiserver \\ --v=2 \\ --allow-privileged=true \\ --bind-address=0.0.0.0 \\ --secure-port=6443 \\ --advertise-address=192.168.43.202 \\ --service-cluster-ip-range=10.96.0.0/12 \\ --service-node-port-range=30000-32767 \\ --etcd-servers=https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 \\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\ --service-account-key-file=/etc/kubernetes/pki/sa.pub \\ --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\ --service-account-issuer=https://kubernetes.default.svc.cluster.local \\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\ --authorization-mode=Node,RBAC \\ --enable-bootstrap-token-auth=true \\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\ --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\ --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\ --requestheader-allowed-names=aggregator \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-username-headers=X-Remote-User # --token-auth-file=/etc/kubernetes/token.csv Restart=on-failure RestartSec=10s LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF # master03é…ç½® cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-apiserver.service [Unit] Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-apiserver \\ --v=2 \\ --allow-privileged=true \\ --bind-address=0.0.0.0 \\ --secure-port=6443 \\ --advertise-address=192.168.43.203 \\ --service-cluster-ip-range=10.96.0.0/12 \\ --service-node-port-range=30000-32767 \\ --etcd-servers=https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 \\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\ --service-account-key-file=/etc/kubernetes/pki/sa.pub \\ --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\ --service-account-issuer=https://kubernetes.default.svc.cluster.local \\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\ --authorization-mode=Node,RBAC \\ --enable-bootstrap-token-auth=true \\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\ --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\ --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\ --requestheader-allowed-names=aggregator \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-username-headers=X-Remote-User # --token-auth-file=/etc/kubernetes/token.csv Restart=on-failure RestartSec=10s LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF # å¯åŠ¨kube-apiserver systemctl daemon-reload \u0026\u0026 systemctl enable --now kube-apiserver ControllerManager(Master)\næ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®kube-controller-manageræœåŠ¡ï¼Œé…ç½®éƒ½ä¸€æ ·\n# Podç½‘æ®µæ˜¯172.16.0.0/12ï¼Œå¯æŒ‰éœ€æ›´æ”¹ï¼Œä¸è¦å’Œå…¶ä»–åœ¨ç”¨ç½‘æ®µå†²çªå³å¯ # ç»™æ‰€æœ‰masterèŠ‚ç‚¹é…ç½®æœåŠ¡ cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-controller-manager.service [Unit] Description=Kubernetes Controller Manager Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-controller-manager \\ --v=2 \\ --root-ca-file=/etc/kubernetes/pki/ca.pem \\ --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\ --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\ --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\ --feature-gates=LegacyServiceAccountTokenNoAutoGeneration=false \\ --leader-elect=true \\ --use-service-account-credentials=true \\ --node-monitor-grace-period=40s \\ --node-monitor-period=5s \\ --pod-eviction-timeout=2m0s \\ --controllers=*,bootstrapsigner,tokencleaner \\ --allocate-node-cidrs=true \\ --cluster-cidr=172.16.0.0/12 \\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\ --node-cidr-mask-size=24 Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF # å¯åŠ¨ systemctl daemon-reload \u0026\u0026 systemctl enable --now kube-controller-manager Scheduler(Master)\næ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®kube-scheduleræœåŠ¡ï¼Œé…ç½®éƒ½ä¸€æ ·\ncat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-scheduler.service [Unit] Description=Kubernetes Scheduler Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-scheduler \\ --v=2 \\ --leader-elect=true \\ --authentication-kubeconfig=/etc/kubernetes/scheduler.kubeconfig \\ --authorization-kubeconfig=/etc/kubernetes/scheduler.kubeconfig \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF # å¯åŠ¨ systemctl daemon-reload \u0026\u0026 systemctl enable --now kube-scheduler ç¡®è®¤é›†ç¾¤ç»„ä»¶çŠ¶æ€\n# æ‰€æœ‰MasterèŠ‚ç‚¹å‡æ£€æŸ¥ï¼Œ-lå‚æ•°è¾“å‡ºå®Œæ•´ä¿¡æ¯ # å¦‚æœæœ‰Eå¼€å¤´çš„æŠ¥é”™ï¼Œéœ€è¦æ’æŸ¥è§£å†³ä¸€ä¸‹ï¼Œå¸¸è§é—®é¢˜æ˜¯IPå†²çªã€è¯ä¹¦é”™è¯¯ # Wå‘Šè­¦å¯æš‚æ—¶å¿½ç•¥ systemctl status kube-apiserver -l systemctl status kube-controller-manager -l systemctl status kube-scheduler -l é…ç½®TLS Bootstrapping åªéœ€åœ¨master01èŠ‚ç‚¹é…ç½®ï¼ŒTLS Bootstrappingçš„å®˜æ–¹è¯´æ˜è¯·è§ï¼šTLS Bootstrapping\ncd /root/k8s-ha-install/bootstrap # æŸ¥çœ‹ä¸€ä¸‹secretï¼Œnameåè¦å’Œtoken-idä¸€è‡´ï¼Œtoken-id.token-secretå’Œé›†ç¾¤è®¾ç½®--token=å¯¹åº”ä¸Š [root@k8s-master01 bootstrap]# cat bootstrap.secret.yaml apiVersion: v1 kind: Secret metadata: name: bootstrap-token-c8ad9c namespace: kube-system type: bootstrap.kubernetes.io/token stringData: description: \"The default bootstrap token generated by 'kubelet '.\" token-id: c8ad9c token-secret: 2e4d610cf3e7426e ... kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.pem --embed-certs=true --server=https://192.168.43.200:8443 --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config set-credentials tls-bootstrap-token-user --token=c8ad9c.2e4d610cf3e7426e --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config set-context tls-bootstrap-token-user@kubernetes --cluster=kubernetes --user=tls-bootstrap-token-user --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config use-context tls-bootstrap-token-user@kubernetes --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig # åˆ›å»ºé…ç½®ç›®å½•ï¼Œæ‹·è´admin.kubeconfigæ–‡ä»¶ä¸ºconfigï¼Œæˆæƒkubectlï¼Œä½¿å¾—å½“å‰ç”¨æˆ·å¯ä»¥ä½¿ç”¨kubectlåˆ›å»ºèµ„æº # å…¶ä»–masterèŠ‚ç‚¹å¦‚æœéœ€è¦ä½¿ç”¨kubectlå‘½ä»¤åˆ›å»ºèµ„æºï¼Œä¹Ÿå¯ä»¥æ‹·è´æ–‡ä»¶è¿‡å» # ä¸‹é¢æ˜¯æ²¡æœ‰æˆæƒçš„æƒ…å†µ # [root@k8s-master01 bootstrap]# kubectl get cs # The connection to the server localhost:8080 was refused - did you specify the right host or port? mkdir -p /root/.kube;cp /etc/kubernetes/admin.kubeconfig /root/.kube/config # æˆæƒåæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ [root@k8s-master01 bootstrap]# kubectl get cs Warning: v1 ComponentStatus is deprecated in v1.19+ NAME STATUS MESSAGE ERROR scheduler Healthy ok controller-manager Healthy ok etcd-0 Healthy {\"health\":\"true\",\"reason\":\"\"} etcd-1 Healthy {\"health\":\"true\",\"reason\":\"\"} etcd-2 Healthy {\"health\":\"true\",\"reason\":\"\"} # åˆ›å»ºbootstrap-secret [root@k8s-master01 bootstrap]# kubectl apply -f bootstrap.secret.yaml secret/bootstrap-token-c8ad9c created clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created é…ç½®Kubelet # ä»master01æ‹·è´è¯ä¹¦æ–‡ä»¶åˆ°å…¶ä»–èŠ‚ç‚¹ cd /etc/kubernetes/ for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do ssh $i mkdir -p /etc/kubernetes/pki for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig; do scp /etc/kubernetes/$FILE $i:/etc/kubernetes/${FILE} done done # æ‰€æœ‰èŠ‚ç‚¹é…ç½®kubeletæœåŠ¡ cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kubelet.service [Unit] Description=Kubernetes Kubelet Documentation=https://github.com/kubernetes/kubernetes [Service] ExecStart=/usr/local/bin/kubelet Restart=always StartLimitInterval=0 RestartSec=10 [Install] WantedBy=multi-user.target EOF # Runtimeä¸ºContainerdï¼ŒkubeletæœåŠ¡çš„é…ç½®æ–‡ä»¶ cat \u003c\u003c \"EOF\" \u003e /etc/systemd/system/kubelet.service.d/10-kubelet.conf [Service] Environment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig\" Environment=\"KUBELET_SYSTEM_ARGS=--container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock\" Environment=\"KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml\" Environment=\"KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' \" ExecStart= ExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_SYSTEM_ARGS $KUBELET_EXTRA_ARGS EOF # åˆ›å»ºkubeleté…ç½®æ–‡ä»¶ï¼Œå¯¹åº”ä¸Šé¢Environmenté…ç½®KUBELET_CONFIG_ARGS # clusterDNSé…ç½®ä¸ºserviceç½‘æ®µçš„ç¬¬åä¸ªåœ°å€ cat \u003c\u003c \"EOF\" \u003e /etc/kubernetes/kubelet-conf.yml apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration address: 0.0.0.0 port: 10250 readOnlyPort: 10255 authentication: anonymous: enabled: false webhook: cacheTTL: 2m0s enabled: true x509: clientCAFile: /etc/kubernetes/pki/ca.pem authorization: mode: Webhook webhook: cacheAuthorizedTTL: 5m0s cacheUnauthorizedTTL: 30s cgroupDriver: systemd cgroupsPerQOS: true clusterDNS: - 10.96.0.10 clusterDomain: cluster.local containerLogMaxFiles: 5 containerLogMaxSize: 10Mi contentType: application/vnd.kubernetes.protobuf cpuCFSQuota: true cpuManagerPolicy: none cpuManagerReconcilePeriod: 10s enableControllerAttachDetach: true enableDebuggingHandlers: true enforceNodeAllocatable: - pods eventBurst: 10 eventRecordQPS: 5 evictionHard: imagefs.available: 15% memory.available: 100Mi nodefs.available: 10% nodefs.inodesFree: 5% evictionPressureTransitionPeriod: 5m0s failSwapOn: true fileCheckFrequency: 20s hairpinMode: promiscuous-bridge healthzBindAddress: 127.0.0.1 healthzPort: 10248 httpCheckFrequency: 20s imageGCHighThresholdPercent: 85 imageGCLowThresholdPercent: 80 imageMinimumGCAge: 2m0s iptablesDropBit: 15 iptablesMasqueradeBit: 14 kubeAPIBurst: 10 kubeAPIQPS: 5 makeIPTablesUtilChains: true maxOpenFiles: 1000000 maxPods: 110 nodeStatusUpdateFrequency: 10s oomScoreAdj: -999 podPidsLimit: -1 registryBurst: 10 registryPullQPS: 5 resolvConf: /etc/resolv.conf rotateCertificates: true runtimeRequestTimeout: 2m0s serializeImagePulls: true staticPodPath: /etc/kubernetes/manifests streamingConnectionIdleTimeout: 4h0m0s syncFrequency: 1m0s volumeStatsAggPeriod: 1m0s EOF # å¯åŠ¨æœåŠ¡ systemctl daemon-reload \u0026\u0026 systemctl enable --now kubelet # ä»¥k8s-master01ä¸ºä¾‹æŸ¥çœ‹è¿è¡Œæ—¥å¿—å’ŒçŠ¶æ€ï¼Œåªæœ‰CNIä¸€å¤„æŠ¥é”™è¡¨ç¤ºé…ç½®æ­£ç¡®ï¼Œåé¢CNIé…ç½®å¥½åå°±ä¼šæ­£å¸¸ tail -f /var/log/messages ... Apr 21 16:15:56 k8s-master01 kubelet: E0421 16:15:56.608747 7169 kubelet.go:2475] \"Container runtime network not ready\" networkReady=\"NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized\" ... [root@k8s-master01 ~]# systemctl status kubelet â— kubelet.service - Kubernetes Kubelet Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled) Drop-In: /etc/systemd/system/kubelet.service.d â””â”€10-kubelet.conf Active: active (running) since äº” 2023-04-21 16:09:00 CST; 6min ago Docs: https://github.com/kubernetes/kubernetes Main PID: 7169 (kubelet) Tasks: 11 Memory: 40.6M CGroup: /system.slice/kubelet.service â””â”€7169 /usr/local/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kuberne... 4æœˆ 21 16:14:26 k8s-master01 kubelet[7169]: E0421 16:14:26.578931 7169 kubelet.go:2475] \"Container runtime network not read...alized\" 4æœˆ 21 16:14:31 k8s-master01 kubelet[7169]: E0421 16:14:31.580077 7169 kubelet.go:2475] \"Container runtime network not read...alized\" .... # å¹¶ä¸”æ­¤æ—¶èŠ‚ç‚¹çŠ¶æ€åº”è¯¥æ˜¯å¯æŸ¥è¯¢ä¸”å¤„äºNotReadyï¼ŒCNIé…ç½®åå°±ä¼šready [root@k8s-master01 ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master01 NotReady 7m12s v1.26.4 k8s-master02 NotReady 7m11s v1.26.4 k8s-master03 NotReady 7m10s v1.26.4 k8s-node01 NotReady 7m24s v1.26.4 k8s-node02 NotReady 7m12s v1.26.4 é…ç½®Kube-proxy # åªéœ€åœ¨k8s-master01ä¸Šæ‰§è¡Œ cd /root/k8s-ha-install kubectl -n kube-system create serviceaccount kube-proxy kubectl create clusterrolebinding system:kube-proxy --clusterrole system:node-proxier --serviceaccount kube-system:kube-proxy SECRET=$(kubectl -n kube-system get sa/kube-proxy \\ --output=jsonpath='{.secrets[0].name}') JWT_TOKEN=$(kubectl -n kube-system get secret/$SECRET \\ --output=jsonpath='{.data.token}' | base64 -d) PKI_DIR=/etc/kubernetes/pki K8S_DIR=/etc/kubernetes kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.pem --embed-certs=true --server=https://192.168.43.200:8443 --kubeconfig=${K8S_DIR}/kube-proxy.kubeconfig kubectl config set-credentials kubernetes --token=${JWT_TOKEN} --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig kubectl config set-context kubernetes --cluster=kubernetes --user=kubernetes --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig kubectl config use-context kubernetes --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig # ä»k8s-master01å°†kubeconfigæ‹·è´åˆ°å…¶ä»–èŠ‚ç‚¹ for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp /etc/kubernetes/kube-proxy.kubeconfig $i:/etc/kubernetes/kube-proxy.kubeconfig done # æ‰€æœ‰èŠ‚ç‚¹é…ç½®kube-proxyæœåŠ¡ cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-proxy.service [Unit] Description=Kubernetes Kube Proxy Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-proxy \\ --config=/etc/kubernetes/kube-proxy.yaml \\ --v=2 Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF # æ‰€æœ‰èŠ‚ç‚¹é…ç½®kube-proxy.yaml,clusterCIDRä¸ºpodç½‘æ®µ cat \u003c\u003c \"EOF\" \u003e /etc/kubernetes/kube-proxy.yaml apiVersion: kubeproxy.config.k8s.io/v1alpha1 bindAddress: 0.0.0.0 clientConnection: acceptContentTypes: \"\" burst: 10 contentType: application/vnd.kubernetes.protobuf kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig qps: 5 clusterCIDR: 172.16.0.0/12 configSyncPeriod: 15m0s conntrack: max: null maxPerCore: 32768 min: 131072 tcpCloseWaitTimeout: 1h0m0s tcpEstablishedTimeout: 24h0m0s enableProfiling: false healthzBindAddress: 0.0.0.0:10256 hostnameOverride: \"\" iptables: masqueradeAll: false masqueradeBit: 14 minSyncPeriod: 0s syncPeriod: 30s ipvs: masqueradeAll: true minSyncPeriod: 5s scheduler: \"rr\" syncPeriod: 30s kind: KubeProxyConfiguration metricsBindAddress: 127.0.0.1:10249 mode: \"ipvs\" nodePortAddresses: null oomScoreAdj: -999 portRange: \"\" udpIdleTimeout: 250ms EOF # å¯åŠ¨ systemctl daemon-reload \u0026\u0026 systemctl enable --now kube-proxy é…ç½®Calico # k8s-master01ä¸Šæ‰§è¡Œï¼Œæ›´æ”¹calicoä¸­Podç½‘æ®µä¸ºè‡ªå·±çš„ cd /root/k8s-ha-install/calico/ sed -i \"s#POD_CIDR#172.16.0.0/12#g\" calico.yaml # æ£€æŸ¥æ˜¯å¦æ›´æ”¹æˆåŠŸ [root@k8s-master01 calico]# grep \"IPV4POOL_CIDR\" calico.yaml -A 1 - name: CALICO_IPV4POOL_CIDR value: \"172.16.0.0/12\" # åº”ç”¨calico [root@k8s-master01 calico]# kubectl apply -f calico.yaml poddisruptionbudget.policy/calico-kube-controllers created poddisruptionbudget.policy/calico-typha created serviceaccount/calico-kube-controllers created serviceaccount/calico-node created configmap/calico-config created customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created clusterrole.rbac.authorization.k8s.io/calico-node created clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created clusterrolebinding.rbac.authorization.k8s.io/calico-node created service/calico-typha created daemonset.apps/calico-node created deployment.apps/calico-kube-controllers created deployment.apps/calico-typha created # ï¼ˆä¸­é—´çŠ¶æ€ï¼‰åœ¨calicoç”Ÿæ•ˆè¿‡ç¨‹ä¸­æŸ¥çœ‹å„èŠ‚ç‚¹æ±¡ç‚¹çŠ¶æ€ï¼Œå‘ç°å‡æœ‰ä¸å¯è°ƒåº¦æ±¡ç‚¹ï¼Œä¸å¿…ç®¡ä»–ï¼Œç­‰å¾…calicoç”Ÿæ•ˆå³å¯ï¼Œè¿™ç§æ±¡ç‚¹æ˜¯kubernetesé›†ç¾¤ä¿æŠ¤æœºåˆ¶ï¼Œåœ¨èŠ‚ç‚¹å¤„äºnot readyçŠ¶æ€æ—¶ï¼ŒèŠ‚ç‚¹ä¸å¯è°ƒåº¦ [root@k8s-master01 calico]# kubectl describe node| grep Taints: Taints: node.kubernetes.io/not-ready:NoSchedule Taints: node.kubernetes.io/not-ready:NoSchedule Taints: node.kubernetes.io/not-ready:NoSchedule Taints: node.kubernetes.io/not-ready:NoSchedule Taints: node.kubernetes.io/not-ready:NoSchedule # calico Podå¤„äºRunningåé›†ç¾¤ç½‘ç»œå°†å»ºç«‹ï¼Œnodeå°†å¤„äºReadyçŠ¶æ€ï¼Œcalicoå»ºç«‹ç½‘ç»œå–å†³äºç”µè„‘æ€§èƒ½ï¼ˆç¡¬ä»¶å’Œç½‘ç»œç¯å¢ƒï¼‰ï¼Œä¸€èˆ¬å‡ åˆ†é’Ÿå³å¯å®Œæˆï¼Œæ€§èƒ½å·®çš„å¯èƒ½ä¼šèŠ±è´¹æ›´é•¿æ—¶é—´ [root@k8s-master01 calico]# kubectl get po -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system calico-kube-controllers-6bd6b69df9-5nwkl 1/1 Running 0 10m kube-system calico-node-8cvcd 1/1 Running 0 10m kube-system calico-node-96mx8 1/1 Running 1 (36s ago) 10m kube-system calico-node-f49rb 1/1 Running 0 10m kube-system calico-node-rgs7f 1/1 Running 0 10m kube-system calico-node-vzrls 1/1 Running 0 10m kube-system calico-typha-77fc8866f5-h9bsj 1/1 Running 0 10m # æŸ¥çœ‹é›†ç¾¤çŠ¶æ€å’Œèµ„æº [root@k8s-master01 calico]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master01 Ready 23m v1.26.4 k8s-master02 Ready 23m v1.26.4 k8s-master03 Ready 23m v1.26.4 k8s-node01 Ready 23m v1.26.4 k8s-node02 Ready 23m v1.26.4 é…ç½®CoreDNS åœ¨k8s-master01æ“ä½œ # å¦‚æœæ›´æ”¹äº†k8s serviceçš„ç½‘æ®µéœ€è¦å°†corednsçš„serviceIPæ”¹æˆk8s serviceç½‘æ®µçš„ç¬¬åä¸ªIP cd /root/k8s-ha-install/ COREDNS_SERVICE_IP=`kubectl get svc | grep kubernetes | awk '{print $3}'`0 sed -i \"s#KUBEDNS_SERVICE_IP#${COREDNS_SERVICE_IP}#g\" CoreDNS/coredns.yaml kubectl apply -f CoreDNS/coredns.yaml [root@k8s-master01 k8s-ha-install]# kubectl get pod -A | grep coredns kube-system coredns-5db5696c7-tsqts 1/1 Running 0 80s é…ç½®Metrics åœ¨k8s-master01æ“ä½œ åœ¨æ–°ç‰ˆçš„Kubernetesä¸­ç³»ç»Ÿèµ„æºçš„é‡‡é›†å‡ä½¿ç”¨Metrics-serverï¼Œå¯ä»¥é€šè¿‡Metricsé‡‡é›†èŠ‚ç‚¹å’ŒPodçš„å†…å­˜ã€ç£ç›˜ã€CPUå’Œç½‘ç»œçš„ä½¿ç”¨ç‡ã€‚\ncd /root/k8s-ha-install/metrics-server kubectl create -f . # ç­‰å¾…metrics-serveréƒ¨ç½²å¥½åï¼Œä¾¿å¯ä½¿ç”¨ [root@k8s-master01 metrics-server]# kubectl top nodes NAME CPU(cores) CPU% MEMORY(bytes) MEMORY% k8s-master01 186m 9% 1094Mi 58% k8s-master02 192m 9% 1176Mi 62% k8s-master03 176m 8% 1123Mi 60% k8s-node01 72m 3% 463Mi 24% k8s-node02 66m 3% 472Mi 25% é…ç½®Dashboard Dashboardæ˜¯ä¸€ä¸ªå±•ç¤ºKubernetesé›†ç¾¤èµ„æºå’ŒPodæ—¥å¿—ï¼Œç”šè‡³å¯ä»¥æ‰§è¡Œå®¹å™¨å‘½ä»¤çš„webæ§åˆ¶å°ã€‚\n# ç›´æ¥éƒ¨ç½²å³å¯ cd /root/k8s-ha-install/dashboard/ kubectl apply -f . # æŸ¥çœ‹dashboardç«¯å£ï¼Œé»˜è®¤æ˜¯NodePortæ¨¡å¼ï¼Œè®¿é—®é›†ç¾¤å†…ä»»æ„èŠ‚ç‚¹çš„32486ç«¯å£å³å¯ [root@k8s-master01 ~]# kubectl get svc -A | grep dash kubernetes-dashboard dashboard-metrics-scraper ClusterIP 10.111.39.8 8000/TCP 12m kubernetes-dashboard kubernetes-dashboard NodePort 10.98.143.126 443:32486/TCP 12m è®¿é—®dashboardï¼šhttps://é›†ç¾¤å†…ä»»æ„èŠ‚ç‚¹IP:32486\nå‘ç°æç¤ºéšç§è®¾ç½®é”™è¯¯çš„é—®é¢˜ï¼Œè§£å†³æ–¹æ³•æ˜¯åœ¨Chromeæµè§ˆå™¨å¯åŠ¨å‚æ•°åŠ å…¥--test-type --ignore-certificate-errorsï¼Œå†è®¿é—®å°±æ²¡æœ‰è¿™ä¸ªæç¤º\n# è·å–ç™»é™†ä»¤ç‰Œï¼ˆtokenï¼‰ [root@k8s-master01 dashboard]# kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}') Name: admin-user-token-cj2kt Namespace: kube-system Labels: Annotations: kubernetes.io/service-account.name: admin-user kubernetes.io/service-account.uid: c86fbde2-36ea-4dd3-94fd-8ce8012fdf22 Type: kubernetes.io/service-account-token Data ==== ca.crt: 1411 bytes namespace: 11 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6ImFPeklobHBkNVRzZzZYVF9nbG5BMTgwOHdvMUNkV2FGbW1wdmUzZzdJRXcifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWNqMmt0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJjODZmYmRlMi0zNmVhLTRkZDMtOTRmZC04Y2U4MDEyZmRmMjIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.YgxIsaxR-hfyT9YLGdszggQ0Rvoc4SvyqswgvHz2ySc27q8lAQ7EJxhze3bhrdTL79z3J30T6vmuA5Be3kq_c2r42r2Iy-pC92t8xTISlPWEl7JfSg8GSbX2-UxUM_wqCmbMO3RWGYW5FpzrJ2pSVaeIGlu2JmYTugtS50LCFi87DmP2tDAKLQfh1NRylpEPI1AJPbl41E2wyDBUlS86YF_glUnQxyDCyrf2wJ2Akjqe7If2b9tAXHbSZBcQJFGHENymYhdBW6QObmTRxUsaOX9wdTToFcoHr-FaE4LcP9KuXhxP-gNNyVN7HN0k0WbhAp6CBIoypFCVLIN96EvNIg é€‰æ‹©ALL namespaceï¼Œå¯ä»¥æŸ¥çœ‹å¦‚ä¸‹å›¾ é›†ç¾¤ä¼˜åŒ–(å¯é€‰) Dockerå¯åœ¨/etc/docker/daemon.jsonè‡ªå®šä¹‰ä¼˜åŒ–é…ç½®ï¼Œæ‰€æœ‰é…ç½®å¯è§ï¼šå®˜æ–¹docker configurationï¼Œdockerå¸¸ç”¨ä¼˜åŒ–é…ç½®è§ä¸‹æ–¹æ³¨é‡Šè¯´æ˜ã€‚\n# ï¼ˆï¼ï¼ï¼å¦‚æœä½¿ç”¨dockerä½œä¸ºRuntimeçš„è¯ï¼‰ä¼˜åŒ–dockeré…ç½® # /etc/docker/daemon.jsonæ–‡ä»¶ï¼ŒæŒ‰éœ€é…ç½®ï¼Œä¸éœ€è¦å…¨éƒ¨éƒ½ç…§æŠ„ï¼Œä½¿ç”¨æ—¶åˆ é™¤æ³¨é‡Šï¼Œå› ä¸ºJSONæ–‡ä»¶ä¸æ”¯æŒæ³¨é‡Š { \"exec-opts\": [\"native.cgroupdriver=systemd\"], # cgroupsé©±åŠ¨ \"registry-mirrors\": [\"https://ynirk4k5.mirror.aliyuncs.com\"], # é•œåƒåŠ é€Ÿå™¨åœ°å€ \"allow-nondistributable-artifacts\": [], \"api-cors-header\": \"\", \"authorization-plugins\": [], \"bip\": \"\", \"bridge\": \"\", \"cgroup-parent\": \"\", \"cluster-advertise\": \"\", \"cluster-store\": \"\", \"cluster-store-opts\": {}, \"containerd\": \"/run/containerd/containerd.sock\", \"containerd-namespace\": \"docker\", \"data-root\": \"\", # æ•°æ®æ ¹ç›®å½•ï¼Œå¤§é‡dockeré•œåƒå¯èƒ½ä¼šå ç”¨è¾ƒå¤§å­˜å‚¨ï¼Œå¯ä»¥è®¾ç½®ç³»ç»Ÿç›˜å¤–çš„æŒ‚è½½ç›˜ \"debug\": true, \"default-address-pools\": [ { \"base\": \"172.30.0.0/16\", \"size\": 24 }, { \"base\": \"172.31.0.0/16\", \"size\": 24 } ], \"default-cgroupns-mode\": \"private\", \"default-gateway\": \"\", \"default-gateway-v6\": \"\", \"default-runtime\": \"runc\", \"default-shm-size\": \"64M\", \"default-ulimits\": { \"nofile\": { \"Hard\": 64000, \"Name\": \"nofile\", \"Soft\": 64000 } }, \"dns\": [], \"dns-opts\": [], \"dns-search\": [], \"exec-root\": \"\", \"experimental\": false, \"features\": {}, \"fixed-cidr\": \"\", \"fixed-cidr-v6\": \"\", \"group\": \"\", \"hosts\": [], \"icc\": false, \"init\": false, \"init-path\": \"/usr/libexec/docker-init\", \"insecure-registries\": [], \"ip\": \"0.0.0.0\", \"ip-forward\": false, \"ip-masq\": false, \"iptables\": false, \"ip6tables\": false, \"ipv6\": false, \"labels\": [], \"live-restore\": true, # dockerè¿›ç¨‹å®•æœºæ—¶å®¹å™¨ä¾ç„¶ä¿æŒå­˜æ´» \"log-driver\": \"json-file\", # æ—¥å¿—æ ¼å¼ \"log-level\": \"\", # æ—¥å¿—çº§åˆ« \"log-opts\": { # æ—¥å¿—ä¼˜åŒ– \"cache-disabled\": \"false\", \"cache-max-file\": \"5\", \"cache-max-size\": \"20m\", \"cache-compress\": \"true\", \"env\": \"os,customer\", \"labels\": \"somelabel\", \"max-file\": \"5\", # æœ€å¤§æ—¥å¿—æ•°é‡ \"max-size\": \"10m\" # ä¿å­˜çš„æœ€å¤§æ—¥å¿—å¤§å° }, \"max-concurrent-downloads\": 3, # pullä¸‹è½½å¹¶å‘æ•° \"max-concurrent-uploads\": 5, # pushä¸Šä¼ å¹¶å‘æ•° \"max-download-attempts\": 5, \"mtu\": 0, \"no-new-privileges\": false, \"node-generic-resources\": [ \"NVIDIA-GPU=UUID1\", \"NVIDIA-GPU=UUID2\" ], \"oom-score-adjust\": -500, \"pidfile\": \"\", \"raw-logs\": false, \"runtimes\": { \"cc-runtime\": { \"path\": \"/usr/bin/cc-runtime\" }, \"custom\": { \"path\": \"/usr/local/bin/my-runc-replacement\", \"runtimeArgs\": [ \"--debug\" ] } }, \"seccomp-profile\": \"\", \"selinux-enabled\": false, \"shutdown-timeout\": 15, \"storage-driver\": \"\", \"storage-opts\": [], \"swarm-default-advertise-addr\": \"\", \"tls\": true, \"tlscacert\": \"\", \"tlscert\": \"\", \"tlskey\": \"\", \"tlsverify\": true, \"userland-proxy\": false, \"userland-proxy-path\": \"/usr/libexec/docker-proxy\", \"userns-remap\": \"\" } # æ— æ³¨é‡Šç‰ˆ { \"exec-opts\": [\"native.cgroupdriver=systemd\"], \"registry-mirrors\": [\"https://ynirk4k5.mirror.aliyuncs.com\"], \"containerd-namespace\": \"docker\", \"data-root\": \"\", \"debug\": true, \"default-cgroupns-mode\": \"private\", \"default-gateway\": \"\", \"default-gateway-v6\": \"\", \"default-runtime\": \"runc\", \"default-shm-size\": \"64M\", \"default-ulimits\": { \"nofile\": { \"Hard\": 64000, \"Name\": \"nofile\", \"Soft\": 64000 } }, \"init-path\": \"/usr/libexec/docker-init\", \"live-restore\": true, \"log-driver\": \"json-file\", \"log-level\": \"\", \"log-opts\": { \"cache-disabled\": \"false\", \"cache-max-file\": \"5\", \"cache-max-size\": \"20m\", \"cache-compress\": \"true\", \"env\": \"os,customer\", \"labels\": \"somelabel\", \"max-file\": \"5\", \"max-size\": \"10m\" }, \"max-concurrent-downloads\": 3, \"max-concurrent-uploads\": 5, \"max-download-attempts\": 5, \"mtu\": 0, \"no-new-privileges\": false, \"oom-score-adjust\": -500, \"pidfile\": \"\", \"raw-logs\": false, \"runtimes\": { \"cc-runtime\": { \"path\": \"/usr/bin/cc-runtime\" }, \"custom\": { \"path\": \"/usr/local/bin/my-runc-replacement\", \"runtimeArgs\": [ \"--debug\" ] } }, \"seccomp-profile\": \"\", \"selinux-enabled\": false, \"shutdown-timeout\": 15, \"storage-driver\": \"\", \"storage-opts\": [], \"swarm-default-advertise-addr\": \"\", \"userland-proxy-path\": \"/usr/libexec/docker-proxy\", \"userns-remap\": \"\" } # è®¾ç½®è¯ä¹¦æœ‰æ•ˆæœŸ [root@k8s-master01 ~]# vim /usr/lib/systemd/system/kube-controller-manager.service ... # åŠ å…¥ä¸‹é¢é…ç½® --experimental-cluster-signing-duration=876000h0m0s ... [root@k8s-master01 ~]# systemctl daemon-reload [root@k8s-master01 ~]# systemctl restart kube-controller-manager # kubeletä¼˜åŒ–åŠ å¯†ç®—æ³•ï¼Œé»˜è®¤çš„ç®—æ³•å®¹æ˜“è¢«æ¼æ´æ‰«æï¼›å¢é•¿é•œåƒä¸‹è½½å‘¨æœŸï¼Œé¿å…æœ‰äº›å¤§é•œåƒæœªä¸‹è½½å®Œæˆå°±è¢«åŠ¨æ­»äº¡é€€å‡º # --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 # --image-pull-progress-deadline=30m [root@k8s-master01 ~]# vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf ... # ä¸‹é¢è¿™è¡Œä¸­KUBELET_EXTRA_ARGS=ååŠ å…¥é…ç½® Environment=\"KUBELET_EXTRA_ARGS=--tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 --image-pull-progress-deadline=30m\" ... # é›†ç¾¤é…ç½®ä¼˜åŒ–ï¼Œè¯¦è§https://kubernetes.io/zh/docs/tasks/administer-cluster/reserve-compute-resources/ [root@k8s-master01 ~]# vim /etc/kubernetes/kubelet-conf.yml # æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½® rotateServerCertificates: true allowedUnsafeSysctls: # å…è®¸åœ¨ä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œæ­¤æ“ä½œæŒ‰æƒ…å†µé€‰æ‹©ï¼Œç”¨ä¸åˆ°å°±ä¸ç”¨è®¾ç½® - \"net.core*\" - \"net.ipv4.*\" kubeReserved: # ä¸ºKubernetesé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹ç»„ä»¶é¢„ç•™èµ„æºï¼Œä¾‹å¦‚ï¼škubeletã€Runtimeç­‰ cpu: \"100m\" memory: 100Mi ephemeral-storage: 1Gi systemReserved: # ä¸ºç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹é¢„ç•™èµ„æºï¼Œä¾‹å¦‚ï¼šsshdã€cronç­‰ cpu: \"100m\" memory: 100Mi ephemeral-storage: 1Gi # ä¸ºé›†ç¾¤èŠ‚ç‚¹æ‰“æ ‡ç­¾ï¼Œåˆ é™¤æ ‡ç­¾æŠŠ = æ¢æˆ - å³å¯ kubectl label nodes k8s-node01 node-role.kubernetes.io/node= kubectl label nodes k8s-node02 node-role.kubernetes.io/node= kubectl label nodes k8s-master01 node-role.kubernetes.io/master= kubectl label nodes k8s-master02 node-role.kubernetes.io/master= kubectl label nodes k8s-master03 node-role.kubernetes.io/master= # æ·»åŠ æ ‡ç­¾åæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ [root@k8s-master01 ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master01 Ready master 35m v1.26.4 k8s-master02 Ready master 35m v1.26.4 k8s-master03 Ready master 35m v1.26.4 k8s-node01 Ready node 35m v1.26.4 k8s-node02 Ready node 35m v1.26.4 ç”Ÿäº§ç¯å¢ƒå»ºè®®ETCDé›†ç¾¤å’ŒKubernetesé›†ç¾¤åˆ†ç¦»ï¼Œè€Œä¸”ä½¿ç”¨é«˜æ€§èƒ½æ•°æ®ç›˜å­˜å‚¨æ•°æ®ï¼Œæ ¹æ®æƒ…å†µå†³å®šæ˜¯å¦å°†MasterèŠ‚ç‚¹ä¹Ÿä½œä¸ºPodè°ƒåº¦èŠ‚ç‚¹ã€‚\næµ‹è¯•é›†ç¾¤ # æµ‹è¯•namespace kubectl get namespace kubectl create namespace test kubectl get namespace kubectl delete namespace test # åˆ›å»ºnginxå®ä¾‹å¹¶å¼€æ”¾ç«¯å£ kubectl create deployment nginx --image=nginx kubectl expose deployment nginx --port=80 --type=NodePort # æŸ¥çœ‹è°ƒåº¦çŠ¶æ€å’Œç«¯å£å· [root@k8s-master01 ~]# kubectl get po,svc -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/nginx-748c667d99-dmtn6 1/1 Running 0 9m55s 172.25.244.194 k8s-master01 NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR service/kubernetes ClusterIP 10.96.0.1 443/TCP 69m service/nginx NodePort 10.110.18.105 80:31687/TCP 9s app=nginx åœ¨æµè§ˆå™¨è¾“å…¥http://ä»»æ„èŠ‚ç‚¹IP:31687/ è®¿é—®nginxï¼Œè®¿é—®ç»“æœå¦‚å›¾\nè‡³æ­¤ï¼ŒåŸºäºäºŒè¿›åˆ¶æ–¹å¼çš„Kubernetesé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²å¹¶éªŒè¯æˆåŠŸã€‚\n",
  "wordCount" : "10865",
  "inLanguage": "en",
  "image":"https://deemoprobe.github.io/img/kubernetes.png","datePublished": "2023-04-29T14:17:51+08:00",
  "dateModified": "2023-04-29T14:17:51+08:00",
  "author":[{
    "@type": "Person",
    "name": "deemoprobe"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesbinaryinstallation-ha/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "William's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://deemoprobe.github.io/img/favicon/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://deemoprobe.github.io/" accesskey="h" title="William&#39;s Blog (Alt + H)">
            <img src="https://deemoprobe.github.io/img/favicon/favicon-32x32.png" alt="logo" aria-label="logo"
                 height="32">William&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://deemoprobe.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tags" title="ğŸ¨ æ ‡ç­¾">
                <span>ğŸ¨ æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/archives/" title="ğŸ“ˆ å½’æ¡£">
                <span>ğŸ“ˆ å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tools" title="ğŸª å·¥å…·">
                <span>ğŸª å·¥å…·</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            
            <h1 class="post-title">
                KubernetesBinaryInstallation HA
            </h1>
            <div class="post-description">
                äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²kubernetesé«˜å¯ç”¨é›†ç¾¤
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-04-29
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>10865å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>22åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>deemoprobe
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://deemoprobe.github.io/tags/kubernetes/" style="color: var(--secondary)!important;">kubernetes</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="https://deemoprobe.github.io/img/kubernetes.png" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e8%af%b4%e6%98%8e" aria-label="ç¯å¢ƒè¯´æ˜">ç¯å¢ƒè¯´æ˜</a></li>
                <li>
                    <a href="#%e8%b5%84%e6%ba%90%e5%88%86%e9%85%8d" aria-label="èµ„æºåˆ†é…">èµ„æºåˆ†é…</a></li>
                <li>
                    <a href="#%e6%93%8d%e4%bd%9c%e6%ad%a5%e9%aa%a4" aria-label="æ“ä½œæ­¥éª¤">æ“ä½œæ­¥éª¤</a><ul>
                        
                <li>
                    <a href="#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9call" aria-label="å‡†å¤‡å·¥ä½œ(ALL)">å‡†å¤‡å·¥ä½œ(ALL)</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2containerdall" aria-label="éƒ¨ç½²Containerd(ALL)">éƒ¨ç½²Containerd(ALL)</a></li>
                <li>
                    <a href="#%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%8c%85%e5%92%8c%e8%af%81%e4%b9%a6" aria-label="äºŒè¿›åˆ¶åŒ…å’Œè¯ä¹¦">äºŒè¿›åˆ¶åŒ…å’Œè¯ä¹¦</a></li>
                <li>
                    <a href="#etcd%e9%9b%86%e7%be%a4master" aria-label="ETCDé›†ç¾¤(Master)">ETCDé›†ç¾¤(Master)</a></li>
                <li>
                    <a href="#%e9%ab%98%e5%8f%af%e7%94%a8%e7%bb%84%e4%bb%b6master" aria-label="é«˜å¯ç”¨ç»„ä»¶(Master)">é«˜å¯ç”¨ç»„ä»¶(Master)</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e9%9b%86%e7%be%a4%e7%bb%84%e4%bb%b6" aria-label="é…ç½®é›†ç¾¤ç»„ä»¶">é…ç½®é›†ç¾¤ç»„ä»¶</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aetls-bootstrapping" aria-label="é…ç½®TLS Bootstrapping">é…ç½®TLS Bootstrapping</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aekubelet" aria-label="é…ç½®Kubelet">é…ç½®Kubelet</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aekube-proxy" aria-label="é…ç½®Kube-proxy">é…ç½®Kube-proxy</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aecalico" aria-label="é…ç½®Calico">é…ç½®Calico</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aecoredns" aria-label="é…ç½®CoreDNS">é…ç½®CoreDNS</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aemetrics" aria-label="é…ç½®Metrics">é…ç½®Metrics</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aedashboard" aria-label="é…ç½®Dashboard">é…ç½®Dashboard</a></li>
                <li>
                    <a href="#%e9%9b%86%e7%be%a4%e4%bc%98%e5%8c%96%e5%8f%af%e9%80%89" aria-label="é›†ç¾¤ä¼˜åŒ–(å¯é€‰)">é›†ç¾¤ä¼˜åŒ–(å¯é€‰)</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e9%9b%86%e7%be%a4" aria-label="æµ‹è¯•é›†ç¾¤">æµ‹è¯•é›†ç¾¤</a>
                </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h2 id="ç¯å¢ƒè¯´æ˜">ç¯å¢ƒè¯´æ˜<a hidden class="anchor" aria-hidden="true" href="#ç¯å¢ƒè¯´æ˜">#</a></h2>
<ul>
<li>å®¿ä¸»æœºç³»ç»Ÿï¼šWindows 10</li>
<li>è™šæ‹Ÿæœºç‰ˆæœ¬ï¼šVMwareÂ® Workstation 16 Pro</li>
<li>IOSé•œåƒç‰ˆæœ¬ï¼šCentOS Linux release 7.9.2009</li>
<li>Kubernetesç‰ˆæœ¬ï¼š1.26.4</li>
<li>Runtimeï¼šContainerd v1.6.20</li>
<li>Etcdç‰ˆæœ¬ï¼š3.5.6</li>
<li>é›†ç¾¤æ“ä½œç”¨æˆ·ï¼šroot</li>
<li>æ›´æ–°æ—¶é—´ï¼š2023-04-21</li>
</ul>
<p>CentOS7å®‰è£…è¯·å‚è€ƒåšå®¢æ–‡ç« ï¼š<a href="https://www.deemo.dev/linux/centos7install/"  target="_blank" rel="noopener" style="color:#42b983" ;>LINUXä¹‹VMWARE WORKSTATIONå®‰è£…CENTOS-7</a></p>
<h2 id="èµ„æºåˆ†é…">èµ„æºåˆ†é…<a hidden class="anchor" aria-hidden="true" href="#èµ„æºåˆ†é…">#</a></h2>
<p><strong>ç½‘æ®µåˆ’åˆ†</strong></p>
<p>Kubernetesé›†ç¾¤éœ€è¦è§„åˆ’ä¸‰ä¸ªç½‘æ®µï¼š</p>
<ul>
<li>å®¿ä¸»æœºç½‘æ®µï¼šKubernetesé›†ç¾¤èŠ‚ç‚¹çš„ç½‘æ®µ</li>
<li>Podç½‘æ®µï¼šé›†ç¾¤å†…Podçš„ç½‘æ®µï¼Œç›¸å½“äºå®¹å™¨çš„IP</li>
<li>Serviceç½‘æ®µï¼šé›†ç¾¤å†…æœåŠ¡å‘ç°ä½¿ç”¨çš„ç½‘æ®µï¼Œserviceç”¨äºé›†ç¾¤å®¹å™¨é€šä¿¡</li>
</ul>
<p>ç”Ÿäº§ç¯å¢ƒæ ¹æ®ç”³è¯·åˆ°çš„IPèµ„æºè¿›è¡Œåˆ†é…å³å¯ï¼ŒåŸåˆ™æ˜¯ä¸‰ä¸ªç½‘æ®µä¸å…è®¸æœ‰é‡åˆIPã€‚IPç½‘æ®µè®¡ç®—å¯ä»¥å‚è€ƒï¼š<a href="http://tools.jb51.net/aideddesign/ip_net_calc/"  target="_blank" rel="noopener" style="color:#42b983" ;>åœ¨çº¿IPåœ°å€è®¡ç®—</a>ã€‚æœ¬æ–‡è™šæ‹Ÿæœºç»ƒä¹ ç¯å¢ƒIPåœ°å€ç½‘æ®µåˆ†é…å¦‚ä¸‹ï¼š</p>
<ul>
<li>å®¿ä¸»æœºç½‘æ®µï¼š<code>192.168.43.1/24</code></li>
<li>Podç½‘æ®µï¼š<code>172.16.0.0/12</code></li>
<li>Serviceï¼š<code>10.96.0.0/12</code></li>
</ul>
<p><strong>èŠ‚ç‚¹åˆ†é…</strong></p>
<p>é‡‡ç”¨<code>3ç®¡ç†èŠ‚ç‚¹2å·¥ä½œèŠ‚ç‚¹</code>çš„é«˜å¯ç”¨Kubernetesé›†ç¾¤æ¨¡å¼ï¼š</p>
<ul>
<li>k8s-master01/k8s-master02/k8s-master03 é›†ç¾¤çš„MasterèŠ‚ç‚¹</li>
<li>ä¸‰ä¸ªmasterèŠ‚ç‚¹åŒæ—¶åšetcdé›†ç¾¤</li>
<li>k8s-node01/k8s-node02 é›†ç¾¤çš„NodeèŠ‚ç‚¹</li>
<li>k8s-master-vipåšé«˜å¯ç”¨k8s-master01~03çš„VIPï¼Œä¸å ç”¨ç‰©ç†èµ„æº</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">ä¸»æœºèŠ‚ç‚¹åç§°</th>
<th style="text-align:center">IP</th>
<th style="text-align:center">CPUæ ¸å¿ƒæ•°</th>
<th style="text-align:center">å†…å­˜å¤§å°</th>
<th style="text-align:center">ç£ç›˜å¤§å°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">k8s-master-vip</td>
<td style="text-align:center">192.168.43.200</td>
<td style="text-align:center">/</td>
<td style="text-align:center">/</td>
<td style="text-align:center">/</td>
</tr>
<tr>
<td style="text-align:left">k8s-master01</td>
<td style="text-align:center">192.168.43.201</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-master02</td>
<td style="text-align:center">192.168.43.202</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-master03</td>
<td style="text-align:center">192.168.43.203</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-node01</td>
<td style="text-align:center">192.168.43.204</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-node02</td>
<td style="text-align:center">192.168.43.205</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
</tbody>
</table>
<h2 id="æ“ä½œæ­¥éª¤">æ“ä½œæ­¥éª¤<a hidden class="anchor" aria-hidden="true" href="#æ“ä½œæ­¥éª¤">#</a></h2>
<p>æ ‡é¢˜åå°æ‹¬å·æ³¨é‡Šè¡¨æ˜æ“ä½œèŒƒå›´ï¼š</p>
<ul>
<li>ALL æ‰€æœ‰èŠ‚ç‚¹ï¼ˆk8s-master01/k8s-master02/k8s-master03/k8s-node01/k9s-node02ï¼‰æ‰§è¡Œ</li>
<li>Master åªéœ€è¦åœ¨masterèŠ‚ç‚¹ï¼ˆk8s-master01/k8s-master02/k8s-master03ï¼‰æ‰§è¡Œ</li>
<li>Node åªéœ€è¦åœ¨nodeèŠ‚ç‚¹ï¼ˆk8s-node01/k8s-node02ï¼‰æ‰§è¡Œ</li>
<li>å·²æ ‡æ³¨çš„ä¸ªåˆ«å‘½ä»¤åªéœ€è¦åœ¨æŸä¸€å°æœºå™¨æ‰§è¡Œï¼Œä¼šåœ¨æ“ä½œå‰è¯´æ˜</li>
<li>æœªæ ‡æ³¨çš„ä¼šåœ¨æ“ä½œæ—¶è¯´æ˜</li>
</ul>
<p>ä½¿ç”¨<code>cat &lt;&lt; &quot;EOF&quot; &gt;&gt; file</code>æˆ–<code>cat &gt;&gt; file &lt;&lt; &quot;EOF&quot;</code>æ·»åŠ æ–‡ä»¶å†…å®¹æ³¨æ„catåé¢çš„EOFä¸€å®šè¦åŠ ä¸ŠåŒå¼•å·ï¼ˆæ ‡å‡†è¾“å…¥çš„ï¼‰ï¼Œå¦åˆ™ä¸ä¼šä¿ç•™è¾“å…¥æ—¶çš„ç¼©è¿›æ ¼å¼è€Œä¸”ä¼šç›´æ¥è§£æè¾“å…¥æ—¶çš„å˜é‡ï¼Œè¿›è€Œé€ æˆæ–‡ä»¶å¯è¯»æ€§å·®ç”šè‡³ä¸å¯ç”¨ï¼›åŒæ—¶æ³¨æ„æ–‡ä»¶çš„<code>&gt;</code>é‡å†™ä¸<code>&gt;&gt;</code>è¿½åŠ ã€‚è™½ç„¶å•ç‹¬è½¬ä¹‰è¾“å…¥æ—¶çš„å˜é‡ä¹Ÿèƒ½é¿å…å˜é‡è¢«è§£æï¼Œä½†æ˜¯ä¸æ¨èï¼Œæ¼è½¬ä¹‰ä¼šé€ æˆä¸å¿…è¦çš„éº»çƒ¦ã€‚</p>
<h3 id="å‡†å¤‡å·¥ä½œall">å‡†å¤‡å·¥ä½œ(ALL)<a hidden class="anchor" aria-hidden="true" href="#å‡†å¤‡å·¥ä½œall">#</a></h3>
<p>æ·»åŠ ä¸»æœºä¿¡æ¯ã€å…³é—­é˜²ç«å¢™ã€å…³é—­swapã€å…³é—­SELinuxã€dnsmasqã€NetworkManager</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æ·»åŠ ä¸»æœºä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;&gt; /etc/hosts
</span></span><span style="display:flex;"><span>192.168.43.200    k8s-master-vip
</span></span><span style="display:flex;"><span>192.168.43.201    k8s-master01
</span></span><span style="display:flex;"><span>192.168.43.202    k8s-master02
</span></span><span style="display:flex;"><span>192.168.43.203    k8s-master03
</span></span><span style="display:flex;"><span>192.168.43.204    k8s-node01
</span></span><span style="display:flex;"><span>192.168.43.205    k8s-node02
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…³é—­é˜²ç«å¢™ã€dnsmasqã€NetworkManagerï¼Œ--nowå‚æ•°è¡¨ç¤ºå…³é—­æœåŠ¡å¹¶ç§»é™¤å¼€æœºè‡ªå¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿™äº›æœåŠ¡æ˜¯å¦å¯ä»¥å…³é—­è§†æƒ…å†µè€Œå®šï¼Œæœ¬æ–‡æ˜¯è™šæ‹Ÿæœºå®è·µï¼Œæ²¡æœ‰ç”¨åˆ°è¿™äº›æœåŠ¡</span>
</span></span><span style="display:flex;"><span>systemctl disable --now firewalld
</span></span><span style="display:flex;"><span>systemctl disable --now dnsmasq
</span></span><span style="display:flex;"><span>systemctl disable --now NetworkManager
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…³é—­swapï¼Œå¹¶æ³¨é‡Šfstabæ–‡ä»¶swapæ‰€åœ¨è¡Œ</span>
</span></span><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;/swap/s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…³é—­SELinuxï¼Œå¹¶æ›´æ”¹selinuxé…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>setenforce <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s/=enforcing/=disabled/g&#34;</span> /etc/selinux/config
</span></span></code></pre></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯<code>/etc/sysconfig/selinux</code>æ–‡ä»¶æ˜¯<code>/etc/selinux/config</code>æ–‡ä»¶çš„è½¯è¿æ¥ï¼Œç”¨<code>sed -i</code>å‘½ä»¤ä¿®æ”¹è½¯è¿æ¥æ–‡ä»¶ä¼šç ´åè½¯è¿æ¥å±æ€§ï¼Œå°†<code>/etc/sysconfig/selinux</code>å˜ä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼Œå³ä½¿è¯¥æ–‡ä»¶è¢«ä¿®æ”¹äº†ï¼Œä½†æºæ–‡ä»¶<code>/etc/selinux/config</code>é…ç½®æ˜¯æ²¡å˜çš„ã€‚æ­¤å¤–ï¼Œä½¿ç”¨vimç­‰ç¼–è¾‘å™¨ç¼–è¾‘æºæ–‡ä»¶æˆ–é“¾æ¥æ–‡ä»¶ï¼ˆç¼–è¾‘æ¨¡å¼ä¸ä¼šä¿®æ”¹æ–‡ä»¶å±æ€§ï¼‰ä¿®æ”¹ä¹Ÿå¯ä»¥ã€‚è½¯é“¾æ¥åŸç†å¯å‚è€ƒåšå®¢ï¼š<a href="http://www.deemoprobe.com/yunv/inode/"  target="_blank" rel="noopener" style="color:#42b983" ;>LINUXä¹‹INODEè¯¦è§£</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># é»˜è®¤çš„yumæºå¤ªæ…¢ï¼Œæ›´æ–°ä¸ºé˜¿é‡Œæºï¼ŒåŒæ—¶ç”¨sedå‘½ä»¤åˆ é™¤æ–‡ä»¶ä¸­ä¸éœ€è¦çš„ä¸¤ä¸ªURLçš„è¡Œ</span>
</span></span><span style="display:flex;"><span>curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
</span></span><span style="display:flex;"><span>sed -i -e <span style="color:#e6db74">&#39;/mirrors.cloud.aliyuncs.com/d&#39;</span> -e <span style="color:#e6db74">&#39;/mirrors.aliyuncs.com/d&#39;</span> /etc/yum.repos.d/CentOS-Base.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…å¸¸ç”¨å·¥å…·åŒ…</span>
</span></span><span style="display:flex;"><span>yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®ntpdateï¼ŒåŒæ­¥æœåŠ¡å™¨æ—¶é—´</span>
</span></span><span style="display:flex;"><span>rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm
</span></span><span style="display:flex;"><span>yum install ntpdate -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŒæ­¥æ—¶åŒºå’Œæ—¶é—´</span>
</span></span><span style="display:flex;"><span>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span> &gt;/etc/timezone
</span></span><span style="display:flex;"><span>ntpdate time2.aliyun.com
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥åŠ å…¥è®¡åˆ’ä»»åŠ¡ï¼Œä¿è¯é›†ç¾¤æ—¶é’Ÿæ˜¯ä¸€è‡´çš„</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /var/spool/cron/rootæ–‡ä»¶ä¹Ÿæ˜¯crontab -eå†™å…¥çš„æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># crontabæ‰§è¡Œæ—¥å¿—æŸ¥çœ‹å¯ç”¨ï¼štail -f /var/log/cron</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;&gt; /var/spool/cron/root
</span></span><span style="display:flex;"><span>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é¡»çŸ¥ï¼šå¦‚æœè®¾ç½®äº†å®šæ—¶ä»»åŠ¡ï¼Œä¼šç»å¸¸æ”¶åˆ°æç¤ºâ€œYou have new mail in /var/spool/mail/rootâ€</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ï¼ˆå¯é€‰ï¼‰ç¦ç”¨æç¤ºï¼šecho &#34;unset MAILCHECK&#34; &gt;&gt; ~/.bashrc;source ~/.bashrc</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¦ç”¨æç¤ºå/var/spool/mail/rootæ–‡ä»¶ä¾æ—§ä¼šè®°å½•rootæ“ä½œæ—¥å¿—ï¼Œå¯éšæ—¶æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿è¯æ–‡ä»¶å¥æŸ„ä¸ä¼šé™åˆ¶é›†ç¾¤çš„å¯æŒç»­å‘å±•ï¼Œé…ç½®limits</span>
</span></span><span style="display:flex;"><span>ulimit -SHn <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;&gt; /etc/security/limits.conf
</span></span><span style="display:flex;"><span>* soft nofile <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* hard nofile <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* soft nproc <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* hard nproc <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* soft memlock unlimited
</span></span><span style="display:flex;"><span>* hard memlock unlimited
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®å…å¯†ç™»å½•ï¼Œk8s-master01åˆ°å…¶ä»–èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆå¯†é’¥å¯¹ï¼ˆåœ¨k8s-master01èŠ‚ç‚¹é…ç½®å³å¯ï¼‰</span>
</span></span><span style="display:flex;"><span>ssh-keygen -t rsa
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‹·è´å…¬é’¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œé¦–æ¬¡éœ€è¦è®¤è¯ä¸€ä¸‹å„ä¸ªèŠ‚ç‚¹çš„rootå¯†ç ï¼Œä»¥åå°±å¯ä»¥å…å¯†sshåˆ°å…¶ä»–èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span style="color:#66d9ef">do</span> ssh-copy-id -i .ssh/id_rsa.pub $i;<span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…‹éš†äºŒè¿›åˆ¶ä»“åº“1.26åˆ†æ”¯çš„æ–‡ä»¶ï¼ˆk8s-master01ä¸Šæ“ä½œå³å¯ï¼‰</span>
</span></span><span style="display:flex;"><span>cd /root;git clone https://gitee.com/deemoprobe/k8s-ha-install.git -b manual-installation-v1.26.x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹ç³»ç»Ÿå‡çº§</span>
</span></span><span style="display:flex;"><span>yum update --exclude<span style="color:#f92672">=</span>kernel* -y
</span></span></code></pre></div><p>å‡çº§å†…æ ¸ï¼Œ4.17ä»¥ä¸‹çš„å†…æ ¸cgroupå­˜åœ¨å†…å­˜æ³„æ¼çš„BUGï¼Œå…·ä½“åˆ†æè¿‡ç¨‹æµè§ˆå™¨æœ<code>Kubernetesé›†ç¾¤ä¸ºä»€ä¹ˆè¦å‡çº§å†…æ ¸</code>ä¼šæœ‰å¾ˆå¤šæ–‡ç« è®²è§£</p>
<p>å†…æ ¸å¤‡ç”¨ä¸‹è½½ï¼ˆä¸‹è½½åˆ°æœ¬åœ°åä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå°½é‡ä¸è¦ç”¨<code>wget</code>ï¼‰ï¼š</p>
<ul>
<li><a href="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/repo/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm?versionId=CAEQNBiBgMDJiNbj.hciIDUyMDZlYjU5YzIwMzQ0MmNhNzBmNjBiMDY3Yjc0Y2Jl"  target="_blank" rel="noopener" style="color:#42b983" ;>kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm</a></li>
<li><a href="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/repo/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm?versionId=CAEQNBiBgMDNiNbj.hciIGQ0M2RmZDAwNDhlNjQyNjE5MTE4MDk1OGU4OThiNWY4"  target="_blank" rel="noopener" style="color:#42b983" ;>kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ä¸‹è½½4.19ç‰ˆæœ¬å†…æ ¸ï¼Œå¦‚æœæ— æ³•ä¸‹è½½ï¼Œå¯ä»¥ç”¨ä¸Šé¢æä¾›çš„å¤‡ç”¨ä¸‹è½½</span>
</span></span><span style="display:flex;"><span>cd /root
</span></span><span style="display:flex;"><span>wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm
</span></span><span style="display:flex;"><span>wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥åœ¨k8s-master01èŠ‚ç‚¹ä¸‹è½½åï¼Œå…å¯†ä¼ åˆ°å…¶ä»–èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span style="color:#66d9ef">do</span> scp kernel-ml-* $i:/root;<span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹å®‰è£…å†…æ ¸</span>
</span></span><span style="display:flex;"><span>cd /root <span style="color:#f92672">&amp;&amp;</span> yum localinstall -y kernel-ml*
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹æ›´æ”¹å†…æ ¸å¯åŠ¨é¡ºåº</span>
</span></span><span style="display:flex;"><span>grub2-set-default  <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> grub2-mkconfig -o /etc/grub2.cfg
</span></span><span style="display:flex;"><span>grubby --args<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user_namespace.enable=1&#34;</span> --update-kernel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>grubby --default-kernel<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹é»˜è®¤å†…æ ¸ï¼Œå¹¶é‡å¯èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>grubby --default-kernel
</span></span><span style="display:flex;"><span>reboot
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¡®è®¤å†…æ ¸ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>uname -a
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ï¼ˆå¯é€‰ï¼‰åˆ é™¤è€ç‰ˆæœ¬çš„å†…æ ¸ï¼Œé¿å…ä»¥åè¢«å‡çº§å–ä»£é»˜è®¤çš„å¼€æœº4.19å†…æ ¸</span>
</span></span><span style="display:flex;"><span>rpm -qa | grep kernel
</span></span><span style="display:flex;"><span>yum remove -y kernel-3*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å‡çº§ç³»ç»Ÿè½¯ä»¶åŒ…ï¼ˆå¦‚æœè·³è¿‡å†…æ ¸å‡çº§åŠ å‚æ•° --exclude=kernel*ï¼‰</span>
</span></span><span style="display:flex;"><span>yum update -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…IPVSç›¸å…³å·¥å…·ï¼Œç”±äºIPVSåœ¨èµ„æºæ¶ˆè€—å’Œæ€§èƒ½ä¸Šå‡å·²æ˜æ˜¾ä¼˜äºiptablesï¼Œæ‰€ä»¥æ¨èå¼€å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…·ä½“åŸå› å¯å‚è€ƒå®˜ç½‘ä»‹ç» https://kubernetes.io/zh/blog/2018/07/09/ipvs-based-in-cluster-load-balancing-deep-dive/</span>
</span></span><span style="display:flex;"><span>yum install ipvsadm ipset sysstat conntrack libseccomp -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŠ è½½æ¨¡å—ï¼Œæœ€åä¸€æ¡4.18åŠä»¥ä¸‹å†…æ ¸ä½¿ç”¨nf_conntrack_ipv4ï¼Œ4.19å·²æ”¹ä¸ºnf_conntrack</span>
</span></span><span style="display:flex;"><span>modprobe -- ip_vs
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_rr
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_wrr
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_sh
</span></span><span style="display:flex;"><span>modprobe -- nf_conntrack
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¼–å†™å‚æ•°æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/modules-load.d/ipvs.conf 
</span></span><span style="display:flex;"><span>ip_vs
</span></span><span style="display:flex;"><span>ip_vs_lc
</span></span><span style="display:flex;"><span>ip_vs_wlc
</span></span><span style="display:flex;"><span>ip_vs_rr
</span></span><span style="display:flex;"><span>ip_vs_wrr
</span></span><span style="display:flex;"><span>ip_vs_lblc
</span></span><span style="display:flex;"><span>ip_vs_lblcr
</span></span><span style="display:flex;"><span>ip_vs_dh
</span></span><span style="display:flex;"><span>ip_vs_sh
</span></span><span style="display:flex;"><span>ip_vs_fo
</span></span><span style="display:flex;"><span>ip_vs_nq
</span></span><span style="display:flex;"><span>ip_vs_sed
</span></span><span style="display:flex;"><span>ip_vs_ftp
</span></span><span style="display:flex;"><span>ip_vs_sh
</span></span><span style="display:flex;"><span>nf_conntrack
</span></span><span style="display:flex;"><span>ip_tables
</span></span><span style="display:flex;"><span>ip_set
</span></span><span style="display:flex;"><span>xt_set
</span></span><span style="display:flex;"><span>ipt_set
</span></span><span style="display:flex;"><span>ipt_rpfilter
</span></span><span style="display:flex;"><span>ipt_REJECT
</span></span><span style="display:flex;"><span>ipip
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># systemd-modules-loadåŠ å…¥å¼€æœºè‡ªå¯</span>
</span></span><span style="display:flex;"><span>systemctl enable --now systemd-modules-load
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è‡ªå®šä¹‰å†…æ ¸å‚æ•°ä¼˜åŒ–é…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/sysctl.d/kubernetes.conf
</span></span><span style="display:flex;"><span>net.ipv4.ip_forward <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-iptables <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-ip6tables <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>fs.may_detach_mounts <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.conf.all.route_localnet <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>vm.overcommit_memory<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>vm.panic_on_oom<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>fs.inotify.max_user_watches<span style="color:#f92672">=</span><span style="color:#ae81ff">89100</span>
</span></span><span style="display:flex;"><span>fs.file-max<span style="color:#f92672">=</span><span style="color:#ae81ff">52706963</span>
</span></span><span style="display:flex;"><span>fs.nr_open<span style="color:#f92672">=</span><span style="color:#ae81ff">52706963</span>
</span></span><span style="display:flex;"><span>net.netfilter.nf_conntrack_max<span style="color:#f92672">=</span><span style="color:#ae81ff">2310720</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_keepalive_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_keepalive_probes <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_keepalive_intvl <span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_tw_buckets <span style="color:#f92672">=</span> <span style="color:#ae81ff">36000</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_tw_reuse <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_orphans <span style="color:#f92672">=</span> <span style="color:#ae81ff">327680</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_orphan_retries <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_syncookies <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_syn_backlog <span style="color:#f92672">=</span> <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>net.ipv4.ip_conntrack_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">65536</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_syn_backlog <span style="color:#f92672">=</span> <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_timestamps <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>net.core.somaxconn <span style="color:#f92672">=</span> <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŠ è½½</span>
</span></span><span style="display:flex;"><span>sysctl --system
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é‡å¯æŸ¥çœ‹IPVSæ¨¡å—æ˜¯å¦ä¾æ—§åŠ è½½</span>
</span></span><span style="display:flex;"><span>reboot
</span></span><span style="display:flex;"><span>lsmod | grep -e ip_vs -e nf_conntrack
</span></span></code></pre></div><ul>
<li>ä¿è¯æ¯å°æœåŠ¡å™¨ä¸­IPVSåŠ è½½æˆåŠŸï¼Œä»¥k8s-master01ä¸ºä¾‹ï¼Œå¦‚å›¾ï¼š</li>
</ul>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20220305153926.png" alt="20220305153926"  />
</p>
<h3 id="éƒ¨ç½²containerdall">éƒ¨ç½²Containerd(ALL)<a hidden class="anchor" aria-hidden="true" href="#éƒ¨ç½²containerdall">#</a></h3>
<p>Kubernetes1.24ç‰ˆæœ¬ä»¥åå°†ä¸å†æ”¯æŒDockerä½œä¸ºRuntimeï¼Œæœ¬æ–‡å®‰è£…ä½¿ç”¨Containerdä½œä¸ºRuntimeã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®é˜¿é‡Œdockeræº</span>
</span></span><span style="display:flex;"><span>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…æœ€æ–°ç‰ˆæœ¬dockerå’Œcontainerd.ioï¼Œå®‰è£…dockeræ˜¯ä¸ºäº†ä½¿ç”¨docker CLI</span>
</span></span><span style="display:flex;"><span>yum install docker-ce docker-ce-cli containerd.io -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ï¼ˆå¯é€‰ï¼‰ä¹Ÿå¯ä»¥æŒ‰éœ€å®‰è£…æŒ‡å®šç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>yum install docker-ce-20.10.* docker-ce-cli-20.10.* containerd -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®Containerdæ¨¡å—</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/modules-load.d/containerd.conf
</span></span><span style="display:flex;"><span>overlay
</span></span><span style="display:flex;"><span>br_netfilter
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŠ è½½æ¨¡å—</span>
</span></span><span style="display:flex;"><span>modprobe -- overlay
</span></span><span style="display:flex;"><span>modprobe -- br_netfilter
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®å†…æ ¸å‚æ•°</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/sysctl.d/containerd.conf
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-iptables  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.ip_forward                 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-ip6tables <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŠ è½½å†…æ ¸å‚æ•°</span>
</span></span><span style="display:flex;"><span>sysctl --system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/containerd
</span></span><span style="display:flex;"><span>containerd config default | tee /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ›´æ”¹Cgroupä¸ºSystemdï¼Œåœ¨containerd.runtimes.runc.optionsè¡Œåçš„SystemdCgroup = falseä¿®æ”¹ä¸ºtrueï¼Œå¦‚æœé…ç½®é¡¹ä¸å­˜åœ¨å°±è‡ªè¡Œæ·»åŠ ï¼Œç¼©è¿›ä¿©ç©ºæ ¼æ·»åŠ SystemdCgroup = trueä¸€è¡Œ</span>
</span></span><span style="display:flex;"><span>vim /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>          ...
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">[</span>plugins.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc.options<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            SystemdCgroup <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>          ...
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å°†sandbox_imageçš„Pauseé•œåƒåœ°å€æ”¹æˆå›½å†…ï¼šregistry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7</span>
</span></span><span style="display:flex;"><span>vim /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>    sandbox_image <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ï¼ˆå¯é€‰ï¼‰ä¹Ÿå¯ä»¥åœ¨k8s-master01ç¼–è¾‘/etc/containerd/config.tomlæ–‡ä»¶åï¼Œå°†ç¼–è¾‘ååŒåæ–‡ä»¶åŒæ­¥åˆ°å…¶ä»–æœåŠ¡å™¨ï¼Œè‡ªåŠ¨è¦†ç›–</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span style="color:#66d9ef">do</span> scp /etc/containerd/config.toml $i:/etc/containerd/config.toml;<span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ç¡®è®¤æ˜¯å¦é…ç½®æˆåŠŸ</span>
</span></span><span style="display:flex;"><span>cat /etc/containerd/config.toml | grep -e Systemd -e sandbox_image
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable --now containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># containerdè¿è¡Œæ—¶çš„CLIæ˜¯ctr</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ctr images ls</span>
</span></span><span style="display:flex;"><span>REF TYPE DIGEST SIZE PLATFORMS LABELS 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ctr version</span>
</span></span><span style="display:flex;"><span>Client:
</span></span><span style="display:flex;"><span>  Version:  1.6.20
</span></span><span style="display:flex;"><span>  Revision: 2806fc1057397dbaeefbea0e4e17bddfbd388f38
</span></span><span style="display:flex;"><span>  Go version: go1.19.7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Server:
</span></span><span style="display:flex;"><span>  Version:  1.6.20
</span></span><span style="display:flex;"><span>  Revision: 2806fc1057397dbaeefbea0e4e17bddfbd388f38
</span></span><span style="display:flex;"><span>  UUID: 9958928e-300c-4778-b83c-6c0073414f3e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®crictlè¿æ¥çš„è¿è¡Œæ—¶socketæ¥å£ï¼ˆæŒ‡å‘containerd&#39;s GRPC serverï¼š/run/containerd/containerd.sockï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># crictl é»˜è®¤è¿æ¥åˆ°unix:///var/run/dockershim.sock</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/crictl.yaml 
</span></span><span style="display:flex;"><span>runtime-endpoint: unix:///run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>image-endpoint: unix:///run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>timeout: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>debug: false
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># crictlæŒ‰éœ€é€‰æ‹©ï¼Œhttps://github.com/kubernetes-sigs/cri-tools/releases</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># containerdå®¹å™¨ç®¡ç†CLIæ˜¯crictlï¼Œè¯¥å‘½ä»¤ä½¿ç”¨å’Œdockerå‘½ä»¤ç±»ä¼¼ï¼Œä¸‹è½½åŒ…ä¸Šä¼ åˆ°k8s-master01</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># tar -zxvf crictl-v1.27.0-linux-amd64.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># mv crictl /usr/local/bin/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># crictl version</span>
</span></span><span style="display:flex;"><span>Version:  0.1.0
</span></span><span style="display:flex;"><span>RuntimeName:  containerd
</span></span><span style="display:flex;"><span>RuntimeVersion:  1.6.20
</span></span><span style="display:flex;"><span>RuntimeApiVersion:  v1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å‘é€åˆ°å…¶ä»–èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp /usr/local/bin/crictl $i:/usr/local/bin/;done</span>
</span></span></code></pre></div><blockquote>
<p>crictl æ˜¯CRIï¼ˆContainer Runtime Interfaceï¼‰å…¼å®¹çš„å®¹å™¨è¿è¡Œæ—¶çš„CLIï¼ˆCommand-Line Interfaceï¼‰ã€‚å¯ä»¥è¿™ä¸ªå‘½ä»¤æ¥æ£€æŸ¥å’Œè°ƒè¯• Kubernetes èŠ‚ç‚¹ä¸Šçš„å®¹å™¨è¿è¡Œæ—¶å’Œåº”ç”¨ç¨‹åºã€‚ä»‹ç»å’Œå®‰è£…æ–¹å¼å¯è§ï¼š<a href="https://github.com/kubernetes-sigs/cri-tools"  target="_blank" rel="noopener" style="color:#42b983" ;>critools</a>æˆ–<a href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/crictl/"  target="_blank" rel="noopener" style="color:#42b983" ;>Kuberneteså®˜æ–¹ä»‹ç»</a></p>
</blockquote>
<h3 id="äºŒè¿›åˆ¶åŒ…å’Œè¯ä¹¦">äºŒè¿›åˆ¶åŒ…å’Œè¯ä¹¦<a hidden class="anchor" aria-hidden="true" href="#äºŒè¿›åˆ¶åŒ…å’Œè¯ä¹¦">#</a></h3>
<p>k8s-master01èŠ‚ç‚¹ä¸Šä¸‹è½½å¹¶å®‰è£…KubernetesäºŒè¿›åˆ¶å®‰è£…åŒ…ï¼ˆserver-binariesï¼Œé€‰æ‹©å¯¹åº”çš„æ¶æ„å³å¯ï¼‰å’ŒETCDäºŒè¿›åˆ¶å®‰è£…åŒ…ï¼Œå¯åœ¨GitHubä¸ŠæŸ¥çœ‹Kubernetes1.23.xç‰ˆæœ¬çš„ä¿¡æ¯ï¼Œ<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.23.md"  target="_blank" rel="noopener" style="color:#42b983" ;>å®˜æ–¹GitHub-Kubernetes1.23ç‰ˆæœ¬é“¾æ¥</a>ï¼Œ<a href="https://github.com/etcd-io/etcd/releases"  target="_blank" rel="noopener" style="color:#42b983" ;>ETCDå®˜æ–¹é“¾æ¥</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ä»¥ä¸‹åœ¨k8s-master01æ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸‹è½½å¤ªæ…¢çš„è¯å¯ä»¥åœ¨ç›¸åº”é“¾æ¥ç½‘é¡µä¸Šä¸‹è½½å¥½ä¼ åˆ°æœåŠ¡å™¨</span>
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/v1.26.4/kubernetes-server-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>wget https://github.com/etcd-io/etcd/releases/download/v3.5.6/etcd-v3.5.6-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è§£å‹å®‰è£…ï¼Œ--strip-components=Nè¡¨ç¤ºè§£å‹æ—¶å¿½ç•¥è§£å‹åçš„Nå±‚ç›®å½•ï¼Œç›´æ¥è·å–Nå±‚ç›®å½•åçš„ç›®æ ‡æ–‡ä»¶ã€‚kubernetes/server/bin/æ˜¯ä¸‰å±‚ï¼Œetcd-v3.5.6-linux-amd64/æ˜¯ä¸€å±‚</span>
</span></span><span style="display:flex;"><span>tar -zxvf kubernetes-server-linux-amd64.tar.gz --strip-components<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> -C /usr/local/bin kubernetes/server/bin/kube<span style="color:#f92672">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>tar -zxvf etcd-v3.5.6-linux-amd64.tar.gz --strip-components<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -C /usr/local/bin etcd-v3.5.6-linux-amd64/etcd<span style="color:#f92672">{</span>,ctl<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¡®è®¤ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>kubectl version
</span></span><span style="display:flex;"><span>kubelet --version
</span></span><span style="display:flex;"><span>etcdctl version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‹·è´ç»„ä»¶åˆ°å…¶ä»–èŠ‚ç‚¹ï¼ŒNodeèŠ‚ç‚¹åªéœ€è¦kubeletå’Œkube-proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03; <span style="color:#66d9ef">do</span> scp /usr/local/bin/kube<span style="color:#f92672">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span style="color:#f92672">}</span> $i:/usr/local/bin/; scp /usr/local/bin/etcd* $i:/usr/local/bin/; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-node01 k8s-node02; <span style="color:#66d9ef">do</span> scp /usr/local/bin/kube<span style="color:#f92672">{</span>let,-proxy<span style="color:#f92672">}</span> $i:/usr/local/bin/; <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><ul>
<li>é…ç½®è¯ä¹¦</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># masterèŠ‚ç‚¹åˆ›å»ºetcdè¯ä¹¦ç›®å½•</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/etcd/ssl
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºpkiè¯ä¹¦ç›®å½•å’ŒCNIç›®å½•ï¼ˆåé¢calicoä½¿ç”¨ï¼‰</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä»¥ä¸‹åœ¨k8s-master01æ“ä½œ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…è¯ä¹¦ç”Ÿæˆå·¥å…·ï¼Œå¦‚æœé€Ÿåº¦æ…¢å¯ä»¥æµè§ˆå™¨ä¸‹è½½åä¸Šä¼ è‡³æœåŠ¡å™¨æ”¹åå³å¯</span>
</span></span><span style="display:flex;"><span>wget <span style="color:#e6db74">&#34;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&#34;</span> -O /usr/local/bin/cfssl
</span></span><span style="display:flex;"><span>wget <span style="color:#e6db74">&#34;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&#34;</span> -O /usr/local/bin/cfssljson
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨master01èŠ‚ç‚¹ç”Ÿæˆetcdè¯ä¹¦</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install/pki
</span></span><span style="display:flex;"><span>cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca
</span></span><span style="display:flex;"><span>cfssl gencert <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca-key<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -config<span style="color:#f92672">=</span>ca-config.json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -hostname<span style="color:#f92672">=</span>127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.43.201,192.168.43.202,192.168.43.203 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -profile<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¤åˆ¶etcdè¯ä¹¦åˆ°å…¶ä»–masterèŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      scp /etc/etcd/ssl/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span> $i:/etc/etcd/ssl/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”ŸæˆKubernetesé›†ç¾¤caè¯ä¹¦</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install/pki
</span></span><span style="display:flex;"><span>cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s serviceç½‘æ®µ10.96.0.0/12ï¼Œå¡«å…¥ç½‘æ®µç¬¬ä¸€ä¸ªIPï¼›é›†ç¾¤VIPåœ°å€192.168.43.200</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem -ca-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -hostname<span style="color:#f92672">=</span>10.96.0.1,192.168.43.200,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.43.201,192.168.43.202,192.168.43.203 -profile<span style="color:#f92672">=</span>kubernetes apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆapiserverçš„ç¬¬ä¸‰æ–¹ç»„ä»¶ä½¿ç”¨çš„èšåˆè¯ä¹¦ï¼Œå‘Šè­¦å¯ä»¥å¿½ç•¥</span>
</span></span><span style="display:flex;"><span>cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca 
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca.pem -ca-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆcontroller-managerè¯ä¹¦</span>
</span></span><span style="display:flex;"><span>cfssl gencert <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -config<span style="color:#f92672">=</span>ca-config.json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -profile<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¾ç½®é›†ç¾¤ä¿¡æ¯ï¼Œé›†ç¾¤åï¼škubernetes  serverï¼šhttps://192.168.43.200:8443</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦‚æœä¸æ˜¯é«˜å¯ç”¨é›†ç¾¤ï¼Œ192.168.43.200:8443æ”¹ä¸ºmaster01çš„åœ°å€ï¼Œ8443æ”¹ä¸ºapiserverçš„ç«¯å£ï¼Œé»˜è®¤æ˜¯6443</span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --server<span style="color:#f92672">=</span>https://192.168.43.200:8443 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œcontextä¸ºsystem:kube-controller-manager@kubernetes</span>
</span></span><span style="display:flex;"><span>kubectl config set-context system:kube-controller-manager@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --user<span style="color:#f92672">=</span>system:kube-controller-manager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¾ç½®ç”¨æˆ·è®¤è¯ä¿¡æ¯ï¼Œç”¨æˆ·ä¸ºsystem:kube-controller-manager</span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials system:kube-controller-manager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/controller-manager.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¾ç½®é»˜è®¤é›†ç¾¤ç¯å¢ƒ</span>
</span></span><span style="display:flex;"><span>kubectl config use-context system:kube-controller-manager@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆschedulerè¯ä¹¦</span>
</span></span><span style="display:flex;"><span>cfssl gencert <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -config<span style="color:#f92672">=</span>ca-config.json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -profile<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŒæ ·çš„ï¼Œscheduleréœ€è¦å’Œcontroller-managerè®¾ç½®ç›¸åŒçš„é›†ç¾¤ä¸Šä¸‹æ–‡ç­‰ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --server<span style="color:#f92672">=</span>https://192.168.43.200:8443 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials system:kube-scheduler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/scheduler.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/scheduler-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-context system:kube-scheduler@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --user<span style="color:#f92672">=</span>system:kube-scheduler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config use-context system:kube-scheduler@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®adminè¯ä¹¦ï¼Œä»¥åŠé›†ç¾¤ä¸Šä¸‹æ–‡ç­‰ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>cfssl gencert <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -config<span style="color:#f92672">=</span>ca-config.json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -profile<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem --embed-certs<span style="color:#f92672">=</span>true --server<span style="color:#f92672">=</span>https://192.168.43.200:8443 --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials kubernetes-admin --client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/admin.pem --client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/admin-key.pem --embed-certs<span style="color:#f92672">=</span>true --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-context kubernetes-admin@kubernetes --cluster<span style="color:#f92672">=</span>kubernetes --user<span style="color:#f92672">=</span>kubernetes-admin --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config use-context kubernetes-admin@kubernetes --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºServiceAccountå¯†é’¥å¯¹</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out /etc/kubernetes/pki/sa.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‹·è´è¯ä¹¦åˆ°å…¶ä»–masterèŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03; <span style="color:#66d9ef">do</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> FILE in <span style="color:#66d9ef">$(</span>ls /etc/kubernetes/pki | grep -v etcd<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span> 
</span></span><span style="display:flex;"><span>        scp /etc/kubernetes/pki/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span> $i:/etc/kubernetes/pki/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; <span style="color:#66d9ef">do</span> 
</span></span><span style="display:flex;"><span>        scp /etc/kubernetes/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span> $i:/etc/kubernetes/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹è¯ä¹¦æ•°é‡æ˜¯å¦ä¸º23</span>
</span></span><span style="display:flex;"><span>ls /etc/kubernetes/pki/ | wc -l
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">23</span>
</span></span></code></pre></div><h3 id="etcdé›†ç¾¤master">ETCDé›†ç¾¤(Master)<a hidden class="anchor" aria-hidden="true" href="#etcdé›†ç¾¤master">#</a></h3>
<blockquote>
<p>å¦‚æœEtcdé›†ç¾¤æœåŠ¡å™¨å’ŒKubernetesé›†ç¾¤æœåŠ¡å™¨ä¸é‡åˆï¼ˆå³ç‹¬ç«‹çš„Etcdé›†ç¾¤ï¼‰ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µé…ç½®é›†ç¾¤IPã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># master01</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/etcd/etcd.config.yml
</span></span><span style="display:flex;"><span>name: <span style="color:#e6db74">&#39;k8s-master01&#39;</span>
</span></span><span style="display:flex;"><span>data-dir: /var/lib/etcd
</span></span><span style="display:flex;"><span>wal-dir: /var/lib/etcd/wal
</span></span><span style="display:flex;"><span>snapshot-count: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>heartbeat-interval: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>election-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>quota-backend-bytes: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>listen-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.201:2380&#39;</span>
</span></span><span style="display:flex;"><span>listen-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.201:2379,http://127.0.0.1:2379&#39;</span>
</span></span><span style="display:flex;"><span>max-snapshots: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>max-wals: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>cors:
</span></span><span style="display:flex;"><span>initial-advertise-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.201:2380&#39;</span>
</span></span><span style="display:flex;"><span>advertise-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.201:2379&#39;</span>
</span></span><span style="display:flex;"><span>discovery:
</span></span><span style="display:flex;"><span>discovery-fallback: <span style="color:#e6db74">&#39;proxy&#39;</span>
</span></span><span style="display:flex;"><span>discovery-proxy:
</span></span><span style="display:flex;"><span>discovery-srv:
</span></span><span style="display:flex;"><span>initial-cluster: <span style="color:#e6db74">&#39;k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-token: <span style="color:#e6db74">&#39;etcd-k8s-cluster&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-state: <span style="color:#e6db74">&#39;new&#39;</span>
</span></span><span style="display:flex;"><span>strict-reconfig-check: false
</span></span><span style="display:flex;"><span>enable-v2: true
</span></span><span style="display:flex;"><span>enable-pprof: true
</span></span><span style="display:flex;"><span>proxy: <span style="color:#e6db74">&#39;off&#39;</span>
</span></span><span style="display:flex;"><span>proxy-failure-wait: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-refresh-interval: <span style="color:#ae81ff">30000</span>
</span></span><span style="display:flex;"><span>proxy-dial-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>proxy-write-timeout: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-read-timeout: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>client-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>peer-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  peer-client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>debug: false
</span></span><span style="display:flex;"><span>log-package-levels:
</span></span><span style="display:flex;"><span>log-outputs: <span style="color:#f92672">[</span>default<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>force-new-cluster: false
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master02</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/etcd/etcd.config.yml
</span></span><span style="display:flex;"><span>name: <span style="color:#e6db74">&#39;k8s-master02&#39;</span>
</span></span><span style="display:flex;"><span>data-dir: /var/lib/etcd
</span></span><span style="display:flex;"><span>wal-dir: /var/lib/etcd/wal
</span></span><span style="display:flex;"><span>snapshot-count: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>heartbeat-interval: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>election-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>quota-backend-bytes: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>listen-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.202:2380&#39;</span>
</span></span><span style="display:flex;"><span>listen-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.202:2379,http://127.0.0.1:2379&#39;</span>
</span></span><span style="display:flex;"><span>max-snapshots: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>max-wals: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>cors:
</span></span><span style="display:flex;"><span>initial-advertise-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.202:2380&#39;</span>
</span></span><span style="display:flex;"><span>advertise-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.202:2379&#39;</span>
</span></span><span style="display:flex;"><span>discovery:
</span></span><span style="display:flex;"><span>discovery-fallback: <span style="color:#e6db74">&#39;proxy&#39;</span>
</span></span><span style="display:flex;"><span>discovery-proxy:
</span></span><span style="display:flex;"><span>discovery-srv:
</span></span><span style="display:flex;"><span>initial-cluster: <span style="color:#e6db74">&#39;k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-token: <span style="color:#e6db74">&#39;etcd-k8s-cluster&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-state: <span style="color:#e6db74">&#39;new&#39;</span>
</span></span><span style="display:flex;"><span>strict-reconfig-check: false
</span></span><span style="display:flex;"><span>enable-v2: true
</span></span><span style="display:flex;"><span>enable-pprof: true
</span></span><span style="display:flex;"><span>proxy: <span style="color:#e6db74">&#39;off&#39;</span>
</span></span><span style="display:flex;"><span>proxy-failure-wait: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-refresh-interval: <span style="color:#ae81ff">30000</span>
</span></span><span style="display:flex;"><span>proxy-dial-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>proxy-write-timeout: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-read-timeout: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>client-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>peer-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  peer-client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>debug: false
</span></span><span style="display:flex;"><span>log-package-levels:
</span></span><span style="display:flex;"><span>log-outputs: <span style="color:#f92672">[</span>default<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>force-new-cluster: false
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master03</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/etcd/etcd.config.yml
</span></span><span style="display:flex;"><span>name: <span style="color:#e6db74">&#39;k8s-master03&#39;</span>
</span></span><span style="display:flex;"><span>data-dir: /var/lib/etcd
</span></span><span style="display:flex;"><span>wal-dir: /var/lib/etcd/wal
</span></span><span style="display:flex;"><span>snapshot-count: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>heartbeat-interval: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>election-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>quota-backend-bytes: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>listen-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.203:2380&#39;</span>
</span></span><span style="display:flex;"><span>listen-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.203:2379,http://127.0.0.1:2379&#39;</span>
</span></span><span style="display:flex;"><span>max-snapshots: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>max-wals: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>cors:
</span></span><span style="display:flex;"><span>initial-advertise-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.203:2380&#39;</span>
</span></span><span style="display:flex;"><span>advertise-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.203:2379&#39;</span>
</span></span><span style="display:flex;"><span>discovery:
</span></span><span style="display:flex;"><span>discovery-fallback: <span style="color:#e6db74">&#39;proxy&#39;</span>
</span></span><span style="display:flex;"><span>discovery-proxy:
</span></span><span style="display:flex;"><span>discovery-srv:
</span></span><span style="display:flex;"><span>initial-cluster: <span style="color:#e6db74">&#39;k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-token: <span style="color:#e6db74">&#39;etcd-k8s-cluster&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-state: <span style="color:#e6db74">&#39;new&#39;</span>
</span></span><span style="display:flex;"><span>strict-reconfig-check: false
</span></span><span style="display:flex;"><span>enable-v2: true
</span></span><span style="display:flex;"><span>enable-pprof: true
</span></span><span style="display:flex;"><span>proxy: <span style="color:#e6db74">&#39;off&#39;</span>
</span></span><span style="display:flex;"><span>proxy-failure-wait: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-refresh-interval: <span style="color:#ae81ff">30000</span>
</span></span><span style="display:flex;"><span>proxy-dial-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>proxy-write-timeout: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-read-timeout: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>client-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>peer-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  peer-client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>debug: false
</span></span><span style="display:flex;"><span>log-package-levels:
</span></span><span style="display:flex;"><span>log-outputs: <span style="color:#f92672">[</span>default<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>force-new-cluster: false
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨æ‰€æœ‰masterèŠ‚ç‚¹åˆ›å»ºetcdæœåŠ¡å¹¶å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/etcd.service
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Etcd Service
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://coreos.com/etcd/docs/latest/
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Type<span style="color:#f92672">=</span>notify
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/etcd --config-file<span style="color:#f92672">=</span>/etc/etcd/etcd.config.yml
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>on-failure
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>LimitNOFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">65536</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>Alias<span style="color:#f92672">=</span>etcd3.service
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰MasterèŠ‚ç‚¹åˆ›å»ºetcdè¯ä¹¦ç›®å½•å¹¶é“¾æ¥è¯ä¹¦ï¼Œå¦åˆ™å¯åŠ¨ä¼šå¤±è´¥</span>
</span></span><span style="display:flex;"><span>mkdir /etc/kubernetes/pki/etcd
</span></span><span style="display:flex;"><span>ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹etcdé›†ç¾¤çŠ¶æ€å¦‚ä¸‹å³å¯</span>
</span></span><span style="display:flex;"><span>ETCDCTL_API<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> etcdctl --endpoints<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;192.168.43.203:2379,192.168.43.202:2379,192.168.43.201:2379&#34;</span> --cacert<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem --cert<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/etcd.pem --key<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out<span style="color:#f92672">=</span>table
</span></span><span style="display:flex;"><span>+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span style="display:flex;"><span>|      ENDPOINT       |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
</span></span><span style="display:flex;"><span>+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span style="display:flex;"><span>| 192.168.43.203:2379 |   fd1372a073304e |   3.5.1 |   <span style="color:#ae81ff">20</span> kB |     false |      false |         <span style="color:#ae81ff">2</span> |          <span style="color:#ae81ff">9</span> |                  <span style="color:#ae81ff">9</span> |        |
</span></span><span style="display:flex;"><span>| 192.168.43.202:2379 | 837ce9c47e0719eb |   3.5.1 |   <span style="color:#ae81ff">20</span> kB |     false |      false |         <span style="color:#ae81ff">2</span> |          <span style="color:#ae81ff">9</span> |                  <span style="color:#ae81ff">9</span> |        |
</span></span><span style="display:flex;"><span>| 192.168.43.201:2379 | e9bf8d99824c9061 |   3.5.1 |   <span style="color:#ae81ff">20</span> kB |      true |      false |         <span style="color:#ae81ff">2</span> |          <span style="color:#ae81ff">9</span> |                  <span style="color:#ae81ff">9</span> |        |
</span></span><span style="display:flex;"><span>+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></code></pre></div><h3 id="é«˜å¯ç”¨ç»„ä»¶master">é«˜å¯ç”¨ç»„ä»¶(Master)<a hidden class="anchor" aria-hidden="true" href="#é«˜å¯ç”¨ç»„ä»¶master">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰masterèŠ‚ç‚¹å®‰è£…Keepalivedå’Œhaproxyï¼Œå¹¶åˆ›å»ºé…ç½®æ–‡ä»¶ç›®å½•</span>
</span></span><span style="display:flex;"><span>yum install keepalived haproxy -y
</span></span><span style="display:flex;"><span>mkdir /etc/haproxy
</span></span><span style="display:flex;"><span>mkdir /etc/keepalived
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºæ‰€æœ‰masterèŠ‚ç‚¹æ·»åŠ haproxyé…ç½®ï¼Œé…ç½®éƒ½ä¸€æ ·ï¼Œæ£€æŸ¥æœ€åä¸‰è¡Œä¸»æœºåå’ŒIPåœ°å€å¯¹åº”ä¸Šå°±è¡Œ</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/haproxy/haproxy.cfg
</span></span><span style="display:flex;"><span>global
</span></span><span style="display:flex;"><span>  maxconn  <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>  ulimit-n  <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>  log  127.0.0.1 local0 err
</span></span><span style="display:flex;"><span>  stats timeout 30s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>defaults
</span></span><span style="display:flex;"><span>  log global
</span></span><span style="display:flex;"><span>  mode  http
</span></span><span style="display:flex;"><span>  option  httplog
</span></span><span style="display:flex;"><span>  timeout connect <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>  timeout client  <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>  timeout server  <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>  timeout http-request 15s
</span></span><span style="display:flex;"><span>  timeout http-keep-alive 15s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend monitor-in
</span></span><span style="display:flex;"><span>  bind *:33305
</span></span><span style="display:flex;"><span>  mode http
</span></span><span style="display:flex;"><span>  option httplog
</span></span><span style="display:flex;"><span>  monitor-uri /monitor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend k8s-master
</span></span><span style="display:flex;"><span>  bind 0.0.0.0:8443
</span></span><span style="display:flex;"><span>  bind 127.0.0.1:8443
</span></span><span style="display:flex;"><span>  mode tcp
</span></span><span style="display:flex;"><span>  option tcplog
</span></span><span style="display:flex;"><span>  tcp-request inspect-delay 5s
</span></span><span style="display:flex;"><span>  default_backend k8s-master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend k8s-master
</span></span><span style="display:flex;"><span>  mode tcp
</span></span><span style="display:flex;"><span>  option tcplog
</span></span><span style="display:flex;"><span>  option tcp-check
</span></span><span style="display:flex;"><span>  balance roundrobin
</span></span><span style="display:flex;"><span>  default-server inter 10s downinter 5s rise <span style="color:#ae81ff">2</span> fall <span style="color:#ae81ff">2</span> slowstart 60s maxconn <span style="color:#ae81ff">250</span> maxqueue <span style="color:#ae81ff">256</span> weight <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>  server k8s-master01  192.168.43.201:6443  check
</span></span><span style="display:flex;"><span>  server k8s-master02  192.168.43.202:6443  check
</span></span><span style="display:flex;"><span>  server k8s-master03  192.168.43.203:6443  check
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># keepalivedé…ç½®ä¸ä¸€æ ·ï¼Œæ³¨æ„åŒºåˆ†ç½‘å¡åã€IPåœ°å€å’Œè™šæ‹ŸIPåœ°å€</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ£€æŸ¥æœåŠ¡å™¨ç½‘å¡å</span>
</span></span><span style="display:flex;"><span>ip a æˆ– ifconfig
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master01 Keepalivedé…ç½®</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    router_id LVS_DEVEL
</span></span><span style="display:flex;"><span>    script_user root
</span></span><span style="display:flex;"><span>    enable_script_security
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_apiserver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#e6db74">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    weight -5
</span></span><span style="display:flex;"><span>    fall <span style="color:#ae81ff">2</span>  
</span></span><span style="display:flex;"><span>    rise <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state MASTER
</span></span><span style="display:flex;"><span>    interface ens33
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.43.201
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">101</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass K8SHA_KA_AUTH
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        192.168.43.200
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       chk_apiserver
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master02 Keepalivedé…ç½®</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    router_id LVS_DEVEL
</span></span><span style="display:flex;"><span>    script_user root
</span></span><span style="display:flex;"><span>    enable_script_security
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_apiserver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#e6db74">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    weight -5
</span></span><span style="display:flex;"><span>    fall <span style="color:#ae81ff">2</span>  
</span></span><span style="display:flex;"><span>    rise <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state BACKUP
</span></span><span style="display:flex;"><span>    interface ens33
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.43.202
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass K8SHA_KA_AUTH
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        192.168.43.200
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       chk_apiserver
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master03 Keepalivedé…ç½®</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    router_id LVS_DEVEL
</span></span><span style="display:flex;"><span>    script_user root
</span></span><span style="display:flex;"><span>    enable_script_security
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_apiserver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#e6db74">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    weight -5
</span></span><span style="display:flex;"><span>    fall <span style="color:#ae81ff">2</span>  
</span></span><span style="display:flex;"><span>    rise <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state BACKUP
</span></span><span style="display:flex;"><span>    interface ens33
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.43.203
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass K8SHA_KA_AUTH
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        192.168.43.200
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       chk_apiserver
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰masterèŠ‚ç‚¹é…ç½®Keepalivedå¥åº·æ£€æŸ¥è„šæœ¬</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/check_apiserver.sh 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>err<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> k in <span style="color:#66d9ef">$(</span>seq <span style="color:#ae81ff">1</span> 3<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    check_code<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pgrep haproxy<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $check_code <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        err<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>expr $err + 1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        sleep <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        err<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        break
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $err !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;systemctl stop keepalived&#34;</span>
</span></span><span style="display:flex;"><span>    /usr/bin/systemctl stop keepalived
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># èµ‹äºˆå¯æ‰§è¡Œæƒé™</span>
</span></span><span style="display:flex;"><span>chmod +x /etc/keepalived/check_apiserver.sh
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨haproxyå’ŒKeepalivedå¹¶åŠ å…¥å¼€æœºå¯åŠ¨</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now haproxy <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿™ç§å‘Šè­¦å¯ä»¥å¿½ç•¥ï¼šMar 06 14:03:35 k8s-master01 haproxy-systemd-wrapper[1981]: [WARNING] 064/140335 (1982) : config : frontend &#39;GLOBAL&#39; has no &#39;bind&#39;</span>
</span></span><span style="display:flex;"><span>systemctl status haproxy
</span></span><span style="display:flex;"><span>systemctl status keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æµ‹è¯•ä¸€æ³¢</span>
</span></span><span style="display:flex;"><span>telnet k8s-master-vip <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>ping k8s-master-vip
</span></span></code></pre></div><h3 id="é…ç½®é›†ç¾¤ç»„ä»¶">é…ç½®é›†ç¾¤ç»„ä»¶<a hidden class="anchor" aria-hidden="true" href="#é…ç½®é›†ç¾¤ç»„ä»¶">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºä»¥ä¸‹é›†ç¾¤èµ„æºç›®å½•</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes
</span></span></code></pre></div><p><strong>Apiserver(Master)</strong></p>
<ul>
<li>æ‰€æœ‰masterèŠ‚ç‚¹é…ç½®kube-apiserveræœåŠ¡</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># serviceç½‘æ®µä¸º10.96.0.0/12ï¼Œå¯è‡ªè¡Œè®¾ç½®ï¼Œå…¶ä»–å‚æ•°æŒ‰éœ€é…ç½®å³å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master01é…ç½®</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kube-apiserver.service 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes API Server
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-apiserver <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --allow-privileged<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --bind-address<span style="color:#f92672">=</span>0.0.0.0  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --secure-port<span style="color:#f92672">=</span><span style="color:#ae81ff">6443</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --advertise-address<span style="color:#f92672">=</span>192.168.43.201 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-cluster-ip-range<span style="color:#f92672">=</span>10.96.0.0/12  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-node-port-range<span style="color:#f92672">=</span>30000-32767  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-servers<span style="color:#f92672">=</span>https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-cafile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-certfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-keyfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-private-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.pub  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-signing-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.key  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-issuer<span style="color:#f92672">=</span>https://kubernetes.default.svc.cluster.local <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-preferred-address-types<span style="color:#f92672">=</span>InternalIP,ExternalIP,Hostname  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-admission-plugins<span style="color:#f92672">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --authorization-mode<span style="color:#f92672">=</span>Node,RBAC  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-bootstrap-token-auth<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-allowed-names<span style="color:#f92672">=</span>aggregator  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-group-headers<span style="color:#f92672">=</span>X-Remote-Group  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-extra-headers-prefix<span style="color:#f92672">=</span>X-Remote-Extra-  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-username-headers<span style="color:#f92672">=</span>X-Remote-User
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># --token-auth-file=/etc/kubernetes/token.csv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>on-failure
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>LimitNOFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master02é…ç½®</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;  /usr/lib/systemd/system/kube-apiserver.service 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes API Server
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-apiserver <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --allow-privileged<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --bind-address<span style="color:#f92672">=</span>0.0.0.0  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --secure-port<span style="color:#f92672">=</span><span style="color:#ae81ff">6443</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --advertise-address<span style="color:#f92672">=</span>192.168.43.202 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-cluster-ip-range<span style="color:#f92672">=</span>10.96.0.0/12  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-node-port-range<span style="color:#f92672">=</span>30000-32767  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-servers<span style="color:#f92672">=</span>https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-cafile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-certfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-keyfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-private-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.pub  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-signing-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.key  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-issuer<span style="color:#f92672">=</span>https://kubernetes.default.svc.cluster.local <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-preferred-address-types<span style="color:#f92672">=</span>InternalIP,ExternalIP,Hostname  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-admission-plugins<span style="color:#f92672">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --authorization-mode<span style="color:#f92672">=</span>Node,RBAC  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-bootstrap-token-auth<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-allowed-names<span style="color:#f92672">=</span>aggregator  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-group-headers<span style="color:#f92672">=</span>X-Remote-Group  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-extra-headers-prefix<span style="color:#f92672">=</span>X-Remote-Extra-  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-username-headers<span style="color:#f92672">=</span>X-Remote-User
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># --token-auth-file=/etc/kubernetes/token.csv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>on-failure
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>LimitNOFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master03é…ç½®</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kube-apiserver.service 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes API Server
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-apiserver <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --allow-privileged<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --bind-address<span style="color:#f92672">=</span>0.0.0.0  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --secure-port<span style="color:#f92672">=</span><span style="color:#ae81ff">6443</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --advertise-address<span style="color:#f92672">=</span>192.168.43.203 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-cluster-ip-range<span style="color:#f92672">=</span>10.96.0.0/12  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-node-port-range<span style="color:#f92672">=</span>30000-32767  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-servers<span style="color:#f92672">=</span>https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-cafile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-certfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-keyfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-private-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.pub  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-signing-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.key  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-issuer<span style="color:#f92672">=</span>https://kubernetes.default.svc.cluster.local <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-preferred-address-types<span style="color:#f92672">=</span>InternalIP,ExternalIP,Hostname  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-admission-plugins<span style="color:#f92672">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --authorization-mode<span style="color:#f92672">=</span>Node,RBAC  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-bootstrap-token-auth<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-allowed-names<span style="color:#f92672">=</span>aggregator  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-group-headers<span style="color:#f92672">=</span>X-Remote-Group  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-extra-headers-prefix<span style="color:#f92672">=</span>X-Remote-Extra-  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-username-headers<span style="color:#f92672">=</span>X-Remote-User
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># --token-auth-file=/etc/kubernetes/token.csv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>on-failure
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>LimitNOFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨kube-apiserver</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now kube-apiserver
</span></span></code></pre></div><p><strong>ControllerManager(Master)</strong></p>
<p>æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®kube-controller-manageræœåŠ¡ï¼Œé…ç½®éƒ½ä¸€æ ·</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Podç½‘æ®µæ˜¯172.16.0.0/12ï¼Œå¯æŒ‰éœ€æ›´æ”¹ï¼Œä¸è¦å’Œå…¶ä»–åœ¨ç”¨ç½‘æ®µå†²çªå³å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç»™æ‰€æœ‰masterèŠ‚ç‚¹é…ç½®æœåŠ¡</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kube-controller-manager.service
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes Controller Manager
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-controller-manager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --root-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --cluster-signing-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --cluster-signing-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-private-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/controller-manager.kubeconfig <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --feature-gates<span style="color:#f92672">=</span>LegacyServiceAccountTokenNoAutoGeneration<span style="color:#f92672">=</span>false <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --leader-elect<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --use-service-account-credentials<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --node-monitor-grace-period<span style="color:#f92672">=</span>40s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --node-monitor-period<span style="color:#f92672">=</span>5s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --pod-eviction-timeout<span style="color:#f92672">=</span>2m0s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --controllers<span style="color:#f92672">=</span>*,bootstrapsigner,tokencleaner <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --allocate-node-cidrs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --cluster-cidr<span style="color:#f92672">=</span>172.16.0.0/12 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --node-cidr-mask-size<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now kube-controller-manager
</span></span></code></pre></div><p><strong>Scheduler(Master)</strong></p>
<p>æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®kube-scheduleræœåŠ¡ï¼Œé…ç½®éƒ½ä¸€æ ·</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kube-scheduler.service 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes Scheduler
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-scheduler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --leader-elect<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --authentication-kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --authorization-kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now kube-scheduler
</span></span></code></pre></div><p><strong>ç¡®è®¤é›†ç¾¤ç»„ä»¶çŠ¶æ€</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰MasterèŠ‚ç‚¹å‡æ£€æŸ¥ï¼Œ-lå‚æ•°è¾“å‡ºå®Œæ•´ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦‚æœæœ‰Eå¼€å¤´çš„æŠ¥é”™ï¼Œéœ€è¦æ’æŸ¥è§£å†³ä¸€ä¸‹ï¼Œå¸¸è§é—®é¢˜æ˜¯IPå†²çªã€è¯ä¹¦é”™è¯¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wå‘Šè­¦å¯æš‚æ—¶å¿½ç•¥</span>
</span></span><span style="display:flex;"><span>systemctl status kube-apiserver -l
</span></span><span style="display:flex;"><span>systemctl status kube-controller-manager -l
</span></span><span style="display:flex;"><span>systemctl status kube-scheduler -l
</span></span></code></pre></div><h3 id="é…ç½®tls-bootstrapping">é…ç½®TLS Bootstrapping<a hidden class="anchor" aria-hidden="true" href="#é…ç½®tls-bootstrapping">#</a></h3>
<p>åªéœ€åœ¨master01èŠ‚ç‚¹é…ç½®ï¼ŒTLS Bootstrappingçš„å®˜æ–¹è¯´æ˜è¯·è§ï¼š<a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/"  target="_blank" rel="noopener" style="color:#42b983" ;>TLS Bootstrapping</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /root/k8s-ha-install/bootstrap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ä¸€ä¸‹secretï¼Œnameåè¦å’Œtoken-idä¸€è‡´ï¼Œtoken-id.token-secretå’Œé›†ç¾¤è®¾ç½®--token=å¯¹åº”ä¸Š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 bootstrap<span style="color:#f92672">]</span><span style="color:#75715e"># cat bootstrap.secret.yaml </span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Secret
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: bootstrap-token-c8ad9c
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>type: bootstrap.kubernetes.io/token
</span></span><span style="display:flex;"><span>stringData:
</span></span><span style="display:flex;"><span>  description: <span style="color:#e6db74">&#34;The default bootstrap token generated by &#39;kubelet &#39;.&#34;</span>
</span></span><span style="display:flex;"><span>  token-id: c8ad9c
</span></span><span style="display:flex;"><span>  token-secret: 2e4d610cf3e7426e
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem --embed-certs<span style="color:#f92672">=</span>true --server<span style="color:#f92672">=</span>https://192.168.43.200:8443 --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials tls-bootstrap-token-user --token<span style="color:#f92672">=</span>c8ad9c.2e4d610cf3e7426e --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-context tls-bootstrap-token-user@kubernetes --cluster<span style="color:#f92672">=</span>kubernetes --user<span style="color:#f92672">=</span>tls-bootstrap-token-user --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config use-context tls-bootstrap-token-user@kubernetes --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºé…ç½®ç›®å½•ï¼Œæ‹·è´admin.kubeconfigæ–‡ä»¶ä¸ºconfigï¼Œæˆæƒkubectlï¼Œä½¿å¾—å½“å‰ç”¨æˆ·å¯ä»¥ä½¿ç”¨kubectlåˆ›å»ºèµ„æº</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…¶ä»–masterèŠ‚ç‚¹å¦‚æœéœ€è¦ä½¿ç”¨kubectlå‘½ä»¤åˆ›å»ºèµ„æºï¼Œä¹Ÿå¯ä»¥æ‹·è´æ–‡ä»¶è¿‡å»</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸‹é¢æ˜¯æ²¡æœ‰æˆæƒçš„æƒ…å†µ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [root@k8s-master01 bootstrap]# kubectl get cs</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The connection to the server localhost:8080 was refused - did you specify the right host or port?</span>
</span></span><span style="display:flex;"><span>mkdir -p /root/.kube;cp /etc/kubernetes/admin.kubeconfig /root/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æˆæƒåæŸ¥çœ‹é›†ç¾¤çŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 bootstrap<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get cs</span>
</span></span><span style="display:flex;"><span>Warning: v1 ComponentStatus is deprecated in v1.19+
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE                         ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span>,<span style="color:#e6db74">&#34;reason&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span>,<span style="color:#e6db74">&#34;reason&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span>,<span style="color:#e6db74">&#34;reason&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºbootstrap-secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 bootstrap<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f bootstrap.secret.yaml </span>
</span></span><span style="display:flex;"><span>secret/bootstrap-token-c8ad9c created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</span></span></code></pre></div><h3 id="é…ç½®kubelet">é…ç½®Kubelet<a hidden class="anchor" aria-hidden="true" href="#é…ç½®kubelet">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ä»master01æ‹·è´è¯ä¹¦æ–‡ä»¶åˆ°å…¶ä»–èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>cd /etc/kubernetes/
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    ssh $i mkdir -p /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      scp /etc/kubernetes/$FILE $i:/etc/kubernetes/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹é…ç½®kubeletæœåŠ¡</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kubelet.service
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes Kubelet
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>StartLimitInterval<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Runtimeä¸ºContainerdï¼ŒkubeletæœåŠ¡çš„é…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/systemd/system/kubelet.service.d/10-kubelet.conf
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_SYSTEM_ARGS=--container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock&#34;</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml&#34;</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node=&#39;&#39; &#34;</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_SYSTEM_ARGS $KUBELET_EXTRA_ARGS
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºkubeleté…ç½®æ–‡ä»¶ï¼Œå¯¹åº”ä¸Šé¢Environmenté…ç½®KUBELET_CONFIG_ARGS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># clusterDNSé…ç½®ä¸ºserviceç½‘æ®µçš„ç¬¬åä¸ªåœ°å€</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/kubernetes/kubelet-conf.yml
</span></span><span style="display:flex;"><span>apiVersion: kubelet.config.k8s.io/v1beta1
</span></span><span style="display:flex;"><span>kind: KubeletConfiguration
</span></span><span style="display:flex;"><span>address: 0.0.0.0
</span></span><span style="display:flex;"><span>port: <span style="color:#ae81ff">10250</span>
</span></span><span style="display:flex;"><span>readOnlyPort: <span style="color:#ae81ff">10255</span>
</span></span><span style="display:flex;"><span>authentication:
</span></span><span style="display:flex;"><span>  anonymous:
</span></span><span style="display:flex;"><span>    enabled: false
</span></span><span style="display:flex;"><span>  webhook:
</span></span><span style="display:flex;"><span>    cacheTTL: 2m0s
</span></span><span style="display:flex;"><span>    enabled: true
</span></span><span style="display:flex;"><span>  x509:
</span></span><span style="display:flex;"><span>    clientCAFile: /etc/kubernetes/pki/ca.pem
</span></span><span style="display:flex;"><span>authorization:
</span></span><span style="display:flex;"><span>  mode: Webhook
</span></span><span style="display:flex;"><span>  webhook:
</span></span><span style="display:flex;"><span>    cacheAuthorizedTTL: 5m0s
</span></span><span style="display:flex;"><span>    cacheUnauthorizedTTL: 30s
</span></span><span style="display:flex;"><span>cgroupDriver: systemd
</span></span><span style="display:flex;"><span>cgroupsPerQOS: true
</span></span><span style="display:flex;"><span>clusterDNS:
</span></span><span style="display:flex;"><span>- 10.96.0.10
</span></span><span style="display:flex;"><span>clusterDomain: cluster.local
</span></span><span style="display:flex;"><span>containerLogMaxFiles: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>containerLogMaxSize: 10Mi
</span></span><span style="display:flex;"><span>contentType: application/vnd.kubernetes.protobuf
</span></span><span style="display:flex;"><span>cpuCFSQuota: true
</span></span><span style="display:flex;"><span>cpuManagerPolicy: none
</span></span><span style="display:flex;"><span>cpuManagerReconcilePeriod: 10s
</span></span><span style="display:flex;"><span>enableControllerAttachDetach: true
</span></span><span style="display:flex;"><span>enableDebuggingHandlers: true
</span></span><span style="display:flex;"><span>enforceNodeAllocatable:
</span></span><span style="display:flex;"><span>- pods
</span></span><span style="display:flex;"><span>eventBurst: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>eventRecordQPS: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>evictionHard:
</span></span><span style="display:flex;"><span>  imagefs.available: 15%
</span></span><span style="display:flex;"><span>  memory.available: 100Mi
</span></span><span style="display:flex;"><span>  nodefs.available: 10%
</span></span><span style="display:flex;"><span>  nodefs.inodesFree: 5%
</span></span><span style="display:flex;"><span>evictionPressureTransitionPeriod: 5m0s
</span></span><span style="display:flex;"><span>failSwapOn: true
</span></span><span style="display:flex;"><span>fileCheckFrequency: 20s
</span></span><span style="display:flex;"><span>hairpinMode: promiscuous-bridge
</span></span><span style="display:flex;"><span>healthzBindAddress: 127.0.0.1
</span></span><span style="display:flex;"><span>healthzPort: <span style="color:#ae81ff">10248</span>
</span></span><span style="display:flex;"><span>httpCheckFrequency: 20s
</span></span><span style="display:flex;"><span>imageGCHighThresholdPercent: <span style="color:#ae81ff">85</span>
</span></span><span style="display:flex;"><span>imageGCLowThresholdPercent: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>imageMinimumGCAge: 2m0s
</span></span><span style="display:flex;"><span>iptablesDropBit: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>iptablesMasqueradeBit: <span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>kubeAPIBurst: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>kubeAPIQPS: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>makeIPTablesUtilChains: true
</span></span><span style="display:flex;"><span>maxOpenFiles: <span style="color:#ae81ff">1000000</span>
</span></span><span style="display:flex;"><span>maxPods: <span style="color:#ae81ff">110</span>
</span></span><span style="display:flex;"><span>nodeStatusUpdateFrequency: 10s
</span></span><span style="display:flex;"><span>oomScoreAdj: -999
</span></span><span style="display:flex;"><span>podPidsLimit: -1
</span></span><span style="display:flex;"><span>registryBurst: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>registryPullQPS: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>resolvConf: /etc/resolv.conf
</span></span><span style="display:flex;"><span>rotateCertificates: true
</span></span><span style="display:flex;"><span>runtimeRequestTimeout: 2m0s
</span></span><span style="display:flex;"><span>serializeImagePulls: true
</span></span><span style="display:flex;"><span>staticPodPath: /etc/kubernetes/manifests
</span></span><span style="display:flex;"><span>streamingConnectionIdleTimeout: 4h0m0s
</span></span><span style="display:flex;"><span>syncFrequency: 1m0s
</span></span><span style="display:flex;"><span>volumeStatsAggPeriod: 1m0s
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨æœåŠ¡</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä»¥k8s-master01ä¸ºä¾‹æŸ¥çœ‹è¿è¡Œæ—¥å¿—å’ŒçŠ¶æ€ï¼Œåªæœ‰CNIä¸€å¤„æŠ¥é”™è¡¨ç¤ºé…ç½®æ­£ç¡®ï¼Œåé¢CNIé…ç½®å¥½åå°±ä¼šæ­£å¸¸</span>
</span></span><span style="display:flex;"><span>tail -f /var/log/messages
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Apr <span style="color:#ae81ff">21</span> 16:15:56 k8s-master01 kubelet: E0421 16:15:56.608747    <span style="color:#ae81ff">7169</span> kubelet.go:2475<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Container runtime network not ready&#34;</span> networkReady<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl status kubelet</span>
</span></span><span style="display:flex;"><span>â— kubelet.service - Kubernetes Kubelet
</span></span><span style="display:flex;"><span>   Loaded: loaded <span style="color:#f92672">(</span>/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  Drop-In: /etc/systemd/system/kubelet.service.d
</span></span><span style="display:flex;"><span>           â””â”€10-kubelet.conf
</span></span><span style="display:flex;"><span>   Active: active <span style="color:#f92672">(</span>running<span style="color:#f92672">)</span> since äº” 2023-04-21 16:09:00 CST; 6min ago
</span></span><span style="display:flex;"><span>     Docs: https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span> Main PID: <span style="color:#ae81ff">7169</span> <span style="color:#f92672">(</span>kubelet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Tasks: <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>   Memory: 40.6M
</span></span><span style="display:flex;"><span>   CGroup: /system.slice/kubelet.service
</span></span><span style="display:flex;"><span>           â””â”€7169 /usr/local/bin/kubelet --bootstrap-kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig<span style="color:#f92672">=</span>/etc/kuberne...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>4æœˆ <span style="color:#ae81ff">21</span> 16:14:26 k8s-master01 kubelet<span style="color:#f92672">[</span>7169<span style="color:#f92672">]</span>: E0421 16:14:26.578931    <span style="color:#ae81ff">7169</span> kubelet.go:2475<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Container runtime network not read...alized&#34;</span>
</span></span><span style="display:flex;"><span>4æœˆ <span style="color:#ae81ff">21</span> 16:14:31 k8s-master01 kubelet<span style="color:#f92672">[</span>7169<span style="color:#f92672">]</span>: E0421 16:14:31.580077    <span style="color:#ae81ff">7169</span> kubelet.go:2475<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Container runtime network not read...alized&#34;</span>
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¹¶ä¸”æ­¤æ—¶èŠ‚ç‚¹çŠ¶æ€åº”è¯¥æ˜¯å¯æŸ¥è¯¢ä¸”å¤„äºNotReadyï¼ŒCNIé…ç½®åå°±ä¼šready</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME           STATUS     ROLES    AGE     VERSION
</span></span><span style="display:flex;"><span>k8s-master01   NotReady   &lt;none&gt;   7m12s   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master02   NotReady   &lt;none&gt;   7m11s   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master03   NotReady   &lt;none&gt;   7m10s   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node01     NotReady   &lt;none&gt;   7m24s   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node02     NotReady   &lt;none&gt;   7m12s   v1.26.4
</span></span></code></pre></div><h3 id="é…ç½®kube-proxy">é…ç½®Kube-proxy<a hidden class="anchor" aria-hidden="true" href="#é…ç½®kube-proxy">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># åªéœ€åœ¨k8s-master01ä¸Šæ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install
</span></span><span style="display:flex;"><span>kubectl -n kube-system create serviceaccount kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create clusterrolebinding system:kube-proxy --clusterrole system:node-proxier --serviceaccount kube-system:kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SECRET<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl -n kube-system get sa/kube-proxy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.secrets[0].name}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JWT_TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl -n kube-system get secret/$SECRET <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.data.token}&#39;</span> | base64 -d<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PKI_DIR<span style="color:#f92672">=</span>/etc/kubernetes/pki
</span></span><span style="display:flex;"><span>K8S_DIR<span style="color:#f92672">=</span>/etc/kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem --embed-certs<span style="color:#f92672">=</span>true     --server<span style="color:#f92672">=</span>https://192.168.43.200:8443 --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>K8S_DIR<span style="color:#e6db74">}</span>/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials kubernetes --token<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>JWT_TOKEN<span style="color:#e6db74">}</span> --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-context kubernetes --cluster<span style="color:#f92672">=</span>kubernetes --user<span style="color:#f92672">=</span>kubernetes --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config use-context kubernetes --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä»k8s-master01å°†kubeconfigæ‹·è´åˆ°å…¶ä»–èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>     scp /etc/kubernetes/kube-proxy.kubeconfig $i:/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹é…ç½®kube-proxyæœåŠ¡</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kube-proxy.service
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes Kube Proxy
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-proxy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --config<span style="color:#f92672">=</span>/etc/kubernetes/kube-proxy.yaml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹é…ç½®kube-proxy.yaml,clusterCIDRä¸ºpodç½‘æ®µ</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/kubernetes/kube-proxy.yaml
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>bindAddress: 0.0.0.0
</span></span><span style="display:flex;"><span>clientConnection:
</span></span><span style="display:flex;"><span>  acceptContentTypes: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  burst: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  contentType: application/vnd.kubernetes.protobuf
</span></span><span style="display:flex;"><span>  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>  qps: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>clusterCIDR: 172.16.0.0/12 
</span></span><span style="display:flex;"><span>configSyncPeriod: 15m0s
</span></span><span style="display:flex;"><span>conntrack:
</span></span><span style="display:flex;"><span>  max: null
</span></span><span style="display:flex;"><span>  maxPerCore: <span style="color:#ae81ff">32768</span>
</span></span><span style="display:flex;"><span>  min: <span style="color:#ae81ff">131072</span>
</span></span><span style="display:flex;"><span>  tcpCloseWaitTimeout: 1h0m0s
</span></span><span style="display:flex;"><span>  tcpEstablishedTimeout: 24h0m0s
</span></span><span style="display:flex;"><span>enableProfiling: false
</span></span><span style="display:flex;"><span>healthzBindAddress: 0.0.0.0:10256
</span></span><span style="display:flex;"><span>hostnameOverride: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>iptables:
</span></span><span style="display:flex;"><span>  masqueradeAll: false
</span></span><span style="display:flex;"><span>  masqueradeBit: <span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>  minSyncPeriod: 0s
</span></span><span style="display:flex;"><span>  syncPeriod: 30s
</span></span><span style="display:flex;"><span>ipvs:
</span></span><span style="display:flex;"><span>  masqueradeAll: true
</span></span><span style="display:flex;"><span>  minSyncPeriod: 5s
</span></span><span style="display:flex;"><span>  scheduler: <span style="color:#e6db74">&#34;rr&#34;</span>
</span></span><span style="display:flex;"><span>  syncPeriod: 30s
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>metricsBindAddress: 127.0.0.1:10249
</span></span><span style="display:flex;"><span>mode: <span style="color:#e6db74">&#34;ipvs&#34;</span>
</span></span><span style="display:flex;"><span>nodePortAddresses: null
</span></span><span style="display:flex;"><span>oomScoreAdj: -999
</span></span><span style="display:flex;"><span>portRange: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>udpIdleTimeout: 250ms
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now kube-proxy
</span></span></code></pre></div><h3 id="é…ç½®calico">é…ç½®Calico<a hidden class="anchor" aria-hidden="true" href="#é…ç½®calico">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># k8s-master01ä¸Šæ‰§è¡Œï¼Œæ›´æ”¹calicoä¸­Podç½‘æ®µä¸ºè‡ªå·±çš„</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install/calico/
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#POD_CIDR#172.16.0.0/12#g&#34;</span> calico.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ£€æŸ¥æ˜¯å¦æ›´æ”¹æˆåŠŸ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># grep &#34;IPV4POOL_CIDR&#34; calico.yaml  -A 1</span>
</span></span><span style="display:flex;"><span>            - name: CALICO_IPV4POOL_CIDR
</span></span><span style="display:flex;"><span>              value: <span style="color:#e6db74">&#34;172.16.0.0/12&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åº”ç”¨calico</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f calico.yaml</span>
</span></span><span style="display:flex;"><span>poddisruptionbudget.policy/calico-kube-controllers created
</span></span><span style="display:flex;"><span>poddisruptionbudget.policy/calico-typha created
</span></span><span style="display:flex;"><span>serviceaccount/calico-kube-controllers created
</span></span><span style="display:flex;"><span>serviceaccount/calico-node created
</span></span><span style="display:flex;"><span>configmap/calico-config created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/calico-node created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/calico-node created
</span></span><span style="display:flex;"><span>service/calico-typha created
</span></span><span style="display:flex;"><span>daemonset.apps/calico-node created
</span></span><span style="display:flex;"><span>deployment.apps/calico-kube-controllers created
</span></span><span style="display:flex;"><span>deployment.apps/calico-typha created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ï¼ˆä¸­é—´çŠ¶æ€ï¼‰åœ¨calicoç”Ÿæ•ˆè¿‡ç¨‹ä¸­æŸ¥çœ‹å„èŠ‚ç‚¹æ±¡ç‚¹çŠ¶æ€ï¼Œå‘ç°å‡æœ‰ä¸å¯è°ƒåº¦æ±¡ç‚¹ï¼Œä¸å¿…ç®¡ä»–ï¼Œç­‰å¾…calicoç”Ÿæ•ˆå³å¯ï¼Œè¿™ç§æ±¡ç‚¹æ˜¯kubernetesé›†ç¾¤ä¿æŠ¤æœºåˆ¶ï¼Œåœ¨èŠ‚ç‚¹å¤„äºnot readyçŠ¶æ€æ—¶ï¼ŒèŠ‚ç‚¹ä¸å¯è°ƒåº¦</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe node| grep Taints:</span>
</span></span><span style="display:flex;"><span>Taints:             node.kubernetes.io/not-ready:NoSchedule
</span></span><span style="display:flex;"><span>Taints:             node.kubernetes.io/not-ready:NoSchedule
</span></span><span style="display:flex;"><span>Taints:             node.kubernetes.io/not-ready:NoSchedule
</span></span><span style="display:flex;"><span>Taints:             node.kubernetes.io/not-ready:NoSchedule
</span></span><span style="display:flex;"><span>Taints:             node.kubernetes.io/not-ready:NoSchedule
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># calico Podå¤„äºRunningåé›†ç¾¤ç½‘ç»œå°†å»ºç«‹ï¼Œnodeå°†å¤„äºReadyçŠ¶æ€ï¼Œcalicoå»ºç«‹ç½‘ç»œå–å†³äºç”µè„‘æ€§èƒ½ï¼ˆç¡¬ä»¶å’Œç½‘ç»œç¯å¢ƒï¼‰ï¼Œä¸€èˆ¬å‡ åˆ†é’Ÿå³å¯å®Œæˆï¼Œæ€§èƒ½å·®çš„å¯èƒ½ä¼šèŠ±è´¹æ›´é•¿æ—¶é—´</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po -A</span>
</span></span><span style="display:flex;"><span>NAMESPACE     NAME                                       READY   STATUS    RESTARTS      AGE
</span></span><span style="display:flex;"><span>kube-system   calico-kube-controllers-6bd6b69df9-5nwkl   1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>kube-system   calico-node-8cvcd                          1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>kube-system   calico-node-96mx8                          1/1     Running   <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>36s ago<span style="color:#f92672">)</span>   10m
</span></span><span style="display:flex;"><span>kube-system   calico-node-f49rb                          1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>kube-system   calico-node-rgs7f                          1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>kube-system   calico-node-vzrls                          1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>kube-system   calico-typha-77fc8866f5-h9bsj              1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹é›†ç¾¤çŠ¶æ€å’Œèµ„æº</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME           STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master01   Ready    &lt;none&gt;   23m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master02   Ready    &lt;none&gt;   23m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master03   Ready    &lt;none&gt;   23m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node01     Ready    &lt;none&gt;   23m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node02     Ready    &lt;none&gt;   23m   v1.26.4
</span></span></code></pre></div><h3 id="é…ç½®coredns">é…ç½®CoreDNS<a hidden class="anchor" aria-hidden="true" href="#é…ç½®coredns">#</a></h3>
<ul>
<li>åœ¨k8s-master01æ“ä½œ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å¦‚æœæ›´æ”¹äº†k8s serviceçš„ç½‘æ®µéœ€è¦å°†corednsçš„serviceIPæ”¹æˆk8s serviceç½‘æ®µçš„ç¬¬åä¸ªIP</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install/
</span></span><span style="display:flex;"><span>COREDNS_SERVICE_IP<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>kubectl get svc | grep kubernetes | awk <span style="color:#e6db74">&#39;{print $3}&#39;</span><span style="color:#e6db74">`</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#KUBEDNS_SERVICE_IP#</span><span style="color:#e6db74">${</span>COREDNS_SERVICE_IP<span style="color:#e6db74">}</span><span style="color:#e6db74">#g&#34;</span> CoreDNS/coredns.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f CoreDNS/coredns.yaml 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 k8s-ha-install<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -A | grep coredns</span>
</span></span><span style="display:flex;"><span>kube-system   coredns-5db5696c7-tsqts                    1/1     Running   <span style="color:#ae81ff">0</span>          80s
</span></span></code></pre></div><h2 id="é…ç½®metrics">é…ç½®Metrics<a hidden class="anchor" aria-hidden="true" href="#é…ç½®metrics">#</a></h2>
<ul>
<li>åœ¨k8s-master01æ“ä½œ</li>
</ul>
<p>åœ¨æ–°ç‰ˆçš„Kubernetesä¸­ç³»ç»Ÿèµ„æºçš„é‡‡é›†å‡ä½¿ç”¨Metrics-serverï¼Œå¯ä»¥é€šè¿‡Metricsé‡‡é›†èŠ‚ç‚¹å’ŒPodçš„å†…å­˜ã€ç£ç›˜ã€CPUå’Œç½‘ç»œçš„ä½¿ç”¨ç‡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /root/k8s-ha-install/metrics-server
</span></span><span style="display:flex;"><span>kubectl  create -f . 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç­‰å¾…metrics-serveréƒ¨ç½²å¥½åï¼Œä¾¿å¯ä½¿ç”¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 metrics-server<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl top nodes</span>
</span></span><span style="display:flex;"><span>NAME           CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   CPU%   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   MEMORY%   
</span></span><span style="display:flex;"><span>k8s-master01   186m         9%     1094Mi          58%       
</span></span><span style="display:flex;"><span>k8s-master02   192m         9%     1176Mi          62%       
</span></span><span style="display:flex;"><span>k8s-master03   176m         8%     1123Mi          60%       
</span></span><span style="display:flex;"><span>k8s-node01     72m          3%     463Mi           24%       
</span></span><span style="display:flex;"><span>k8s-node02     66m          3%     472Mi           25%  
</span></span></code></pre></div><h2 id="é…ç½®dashboard">é…ç½®Dashboard<a hidden class="anchor" aria-hidden="true" href="#é…ç½®dashboard">#</a></h2>
<p>Dashboardæ˜¯ä¸€ä¸ªå±•ç¤ºKubernetesé›†ç¾¤èµ„æºå’ŒPodæ—¥å¿—ï¼Œç”šè‡³å¯ä»¥æ‰§è¡Œå®¹å™¨å‘½ä»¤çš„webæ§åˆ¶å°ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ç›´æ¥éƒ¨ç½²å³å¯</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install/dashboard/
</span></span><span style="display:flex;"><span>kubectl apply -f .
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹dashboardç«¯å£ï¼Œé»˜è®¤æ˜¯NodePortæ¨¡å¼ï¼Œè®¿é—®é›†ç¾¤å†…ä»»æ„èŠ‚ç‚¹çš„32486ç«¯å£å³å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -A | grep dash</span>
</span></span><span style="display:flex;"><span>kubernetes-dashboard   dashboard-metrics-scraper   ClusterIP   10.111.39.8      &lt;none&gt;        8000/TCP                 12m
</span></span><span style="display:flex;"><span>kubernetes-dashboard   kubernetes-dashboard        NodePort    10.98.143.126    &lt;none&gt;        443:32486/TCP            12m
</span></span></code></pre></div><p>è®¿é—®dashboardï¼š<a href="https://%e9%9b%86%e7%be%a4%e5%86%85%e4%bb%bb%e6%84%8f%e8%8a%82%e7%82%b9IP:32486"  target="_blank" rel="noopener" style="color:#42b983" ;>https://é›†ç¾¤å†…ä»»æ„èŠ‚ç‚¹IP:32486</a></p>
<p>å‘ç°æç¤ºéšç§è®¾ç½®é”™è¯¯çš„é—®é¢˜ï¼Œè§£å†³æ–¹æ³•æ˜¯åœ¨Chromeæµè§ˆå™¨å¯åŠ¨å‚æ•°åŠ å…¥<code>--test-type --ignore-certificate-errors</code>ï¼Œå†è®¿é—®å°±æ²¡æœ‰è¿™ä¸ªæç¤º</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20211213154024.png" alt="20211213154024"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># è·å–ç™»é™†ä»¤ç‰Œï¼ˆtokenï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 dashboard<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk &#39;{print $1}&#39;)</span>
</span></span><span style="display:flex;"><span>Name:         admin-user-token-cj2kt
</span></span><span style="display:flex;"><span>Namespace:    kube-system
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  kubernetes.io/service-account.name: admin-user
</span></span><span style="display:flex;"><span>              kubernetes.io/service-account.uid: c86fbde2-36ea-4dd3-94fd-8ce8012fdf22
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Type:  kubernetes.io/service-account-token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Data
</span></span><span style="display:flex;"><span><span style="color:#f92672">====</span>
</span></span><span style="display:flex;"><span>ca.crt:     <span style="color:#ae81ff">1411</span> bytes
</span></span><span style="display:flex;"><span>namespace:  <span style="color:#ae81ff">11</span> bytes
</span></span><span style="display:flex;"><span>token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImFPeklobHBkNVRzZzZYVF9nbG5BMTgwOHdvMUNkV2FGbW1wdmUzZzdJRXcifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWNqMmt0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJjODZmYmRlMi0zNmVhLTRkZDMtOTRmZC04Y2U4MDEyZmRmMjIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.YgxIsaxR-hfyT9YLGdszggQ0Rvoc4SvyqswgvHz2ySc27q8lAQ7EJxhze3bhrdTL79z3J30T6vmuA5Be3kq_c2r42r2Iy-pC92t8xTISlPWEl7JfSg8GSbX2-UxUM_wqCmbMO3RWGYW5FpzrJ2pSVaeIGlu2JmYTugtS50LCFi87DmP2tDAKLQfh1NRylpEPI1AJPbl41E2wyDBUlS86YF_glUnQxyDCyrf2wJ2Akjqe7If2b9tAXHbSZBcQJFGHENymYhdBW6QObmTRxUsaOX9wdTToFcoHr-FaE4LcP9KuXhxP-gNNyVN7HN0k0WbhAp6CBIoypFCVLIN96EvNIg
</span></span></code></pre></div><ul>
<li>é€‰æ‹©<code>ALL namespace</code>ï¼Œå¯ä»¥æŸ¥çœ‹å¦‚ä¸‹å›¾</li>
</ul>
<p><a href="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20230421165240.png"  target="_blank" rel="noopener" style="color:#42b983" ;><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20230421165240.png" alt="1"  />
</a></p>
<h2 id="é›†ç¾¤ä¼˜åŒ–å¯é€‰">é›†ç¾¤ä¼˜åŒ–(å¯é€‰)<a hidden class="anchor" aria-hidden="true" href="#é›†ç¾¤ä¼˜åŒ–å¯é€‰">#</a></h2>
<p>Dockerå¯åœ¨<code>/etc/docker/daemon.json</code>è‡ªå®šä¹‰ä¼˜åŒ–é…ç½®ï¼Œæ‰€æœ‰é…ç½®å¯è§ï¼š<a href="https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file"  target="_blank" rel="noopener" style="color:#42b983" ;>å®˜æ–¹docker configuration</a>ï¼Œdockerå¸¸ç”¨ä¼˜åŒ–é…ç½®è§ä¸‹æ–¹æ³¨é‡Šè¯´æ˜ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ï¼ˆï¼ï¼ï¼å¦‚æœä½¿ç”¨dockerä½œä¸ºRuntimeçš„è¯ï¼‰ä¼˜åŒ–dockeré…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/docker/daemon.jsonæ–‡ä»¶ï¼ŒæŒ‰éœ€é…ç½®ï¼Œä¸éœ€è¦å…¨éƒ¨éƒ½ç…§æŠ„ï¼Œä½¿ç”¨æ—¶åˆ é™¤æ³¨é‡Šï¼Œå› ä¸ºJSONæ–‡ä»¶ä¸æ”¯æŒæ³¨é‡Š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>, <span style="color:#75715e"># cgroupsé©±åŠ¨</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;registry-mirrors&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;https://ynirk4k5.mirror.aliyuncs.com&#34;</span><span style="color:#f92672">]</span>, <span style="color:#75715e"># é•œåƒåŠ é€Ÿå™¨åœ°å€</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;allow-nondistributable-artifacts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;api-cors-header&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;authorization-plugins&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;bip&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;bridge&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cgroup-parent&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cluster-advertise&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cluster-store&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cluster-store-opts&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;containerd&#34;</span>: <span style="color:#e6db74">&#34;/run/containerd/containerd.sock&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;containerd-namespace&#34;</span>: <span style="color:#e6db74">&#34;docker&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;data-root&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#75715e"># æ•°æ®æ ¹ç›®å½•ï¼Œå¤§é‡dockeré•œåƒå¯èƒ½ä¼šå ç”¨è¾ƒå¤§å­˜å‚¨ï¼Œå¯ä»¥è®¾ç½®ç³»ç»Ÿç›˜å¤–çš„æŒ‚è½½ç›˜</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;debug&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-address-pools&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;base&#34;</span>: <span style="color:#e6db74">&#34;172.30.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;size&#34;</span>: <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;base&#34;</span>: <span style="color:#e6db74">&#34;172.31.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;size&#34;</span>: <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-cgroupns-mode&#34;</span>: <span style="color:#e6db74">&#34;private&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway-v6&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-runtime&#34;</span>: <span style="color:#e6db74">&#34;runc&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-shm-size&#34;</span>: <span style="color:#e6db74">&#34;64M&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-ulimits&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;nofile&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Hard&#34;</span>: 64000,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;nofile&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Soft&#34;</span>: <span style="color:#ae81ff">64000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dns&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dns-opts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dns-search&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-root&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;experimental&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;features&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fixed-cidr&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fixed-cidr-v6&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;group&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;hosts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;icc&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;init&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;init-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-init&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;insecure-registries&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip-forward&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip-masq&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;iptables&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip6tables&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ipv6&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;labels&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;live-restore&#34;</span>: true, <span style="color:#75715e"># dockerè¿›ç¨‹å®•æœºæ—¶å®¹å™¨ä¾ç„¶ä¿æŒå­˜æ´»</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-driver&#34;</span>: <span style="color:#e6db74">&#34;json-file&#34;</span>, <span style="color:#75715e"># æ—¥å¿—æ ¼å¼</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-level&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#75715e"># æ—¥å¿—çº§åˆ«</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-opts&#34;</span>: <span style="color:#f92672">{</span> <span style="color:#75715e"># æ—¥å¿—ä¼˜åŒ–</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-disabled&#34;</span>: <span style="color:#e6db74">&#34;false&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-size&#34;</span>: <span style="color:#e6db74">&#34;20m&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-compress&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;env&#34;</span>: <span style="color:#e6db74">&#34;os,customer&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;labels&#34;</span>: <span style="color:#e6db74">&#34;somelabel&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>, <span style="color:#75715e"># æœ€å¤§æ—¥å¿—æ•°é‡</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-size&#34;</span>: <span style="color:#e6db74">&#34;10m&#34;</span> <span style="color:#75715e"># ä¿å­˜çš„æœ€å¤§æ—¥å¿—å¤§å°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-downloads&#34;</span>: 3, <span style="color:#75715e"># pullä¸‹è½½å¹¶å‘æ•°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-uploads&#34;</span>: 5, <span style="color:#75715e"># pushä¸Šä¼ å¹¶å‘æ•°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-download-attempts&#34;</span>: 5,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;mtu&#34;</span>: 0,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;no-new-privileges&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;node-generic-resources&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;NVIDIA-GPU=UUID1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;NVIDIA-GPU=UUID2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;oom-score-adjust&#34;</span>: -500,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;pidfile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;raw-logs&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;runtimes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cc-runtime&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/bin/cc-runtime&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;custom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/local/bin/my-runc-replacement&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;runtimeArgs&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;--debug&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;seccomp-profile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;selinux-enabled&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;shutdown-timeout&#34;</span>: 15,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-driver&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-opts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;swarm-default-advertise-addr&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tls&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlscacert&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlscert&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlskey&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlsverify&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userland-proxy&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userland-proxy-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-proxy&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userns-remap&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ— æ³¨é‡Šç‰ˆ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;registry-mirrors&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;https://ynirk4k5.mirror.aliyuncs.com&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;containerd-namespace&#34;</span>: <span style="color:#e6db74">&#34;docker&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;data-root&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;debug&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-cgroupns-mode&#34;</span>: <span style="color:#e6db74">&#34;private&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway-v6&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-runtime&#34;</span>: <span style="color:#e6db74">&#34;runc&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-shm-size&#34;</span>: <span style="color:#e6db74">&#34;64M&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-ulimits&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;nofile&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Hard&#34;</span>: 64000,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;nofile&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Soft&#34;</span>: <span style="color:#ae81ff">64000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;init-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-init&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;live-restore&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-driver&#34;</span>: <span style="color:#e6db74">&#34;json-file&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-level&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-opts&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-disabled&#34;</span>: <span style="color:#e6db74">&#34;false&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-size&#34;</span>: <span style="color:#e6db74">&#34;20m&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-compress&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;env&#34;</span>: <span style="color:#e6db74">&#34;os,customer&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;labels&#34;</span>: <span style="color:#e6db74">&#34;somelabel&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-size&#34;</span>: <span style="color:#e6db74">&#34;10m&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-downloads&#34;</span>: 3,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-uploads&#34;</span>: 5,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-download-attempts&#34;</span>: 5,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;mtu&#34;</span>: 0,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;no-new-privileges&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;oom-score-adjust&#34;</span>: -500,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;pidfile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;raw-logs&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;runtimes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cc-runtime&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/bin/cc-runtime&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;custom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/local/bin/my-runc-replacement&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;runtimeArgs&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;--debug&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;seccomp-profile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;selinux-enabled&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;shutdown-timeout&#34;</span>: 15,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-driver&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-opts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;swarm-default-advertise-addr&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userland-proxy-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-proxy&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userns-remap&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¾ç½®è¯ä¹¦æœ‰æ•ˆæœŸ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /usr/lib/systemd/system/kube-controller-manager.service</span>
</span></span><span style="display:flex;"><span>... <span style="color:#75715e"># åŠ å…¥ä¸‹é¢é…ç½®</span>
</span></span><span style="display:flex;"><span>--experimental-cluster-signing-duration<span style="color:#f92672">=</span>876000h0m0s
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl daemon-reload</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl restart kube-controller-manager</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeletä¼˜åŒ–åŠ å¯†ç®—æ³•ï¼Œé»˜è®¤çš„ç®—æ³•å®¹æ˜“è¢«æ¼æ´æ‰«æï¼›å¢é•¿é•œåƒä¸‹è½½å‘¨æœŸï¼Œé¿å…æœ‰äº›å¤§é•œåƒæœªä¸‹è½½å®Œæˆå°±è¢«åŠ¨æ­»äº¡é€€å‡º</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --image-pull-progress-deadline=30m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span>
</span></span><span style="display:flex;"><span>... <span style="color:#75715e"># ä¸‹é¢è¿™è¡Œä¸­KUBELET_EXTRA_ARGS=ååŠ å…¥é…ç½®</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_EXTRA_ARGS=--tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 --image-pull-progress-deadline=30m&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é›†ç¾¤é…ç½®ä¼˜åŒ–ï¼Œè¯¦è§https://kubernetes.io/zh/docs/tasks/administer-cluster/reserve-compute-resources/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /etc/kubernetes/kubelet-conf.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®</span>
</span></span><span style="display:flex;"><span>rotateServerCertificates: true
</span></span><span style="display:flex;"><span>allowedUnsafeSysctls: <span style="color:#75715e"># å…è®¸åœ¨ä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œæ­¤æ“ä½œæŒ‰æƒ…å†µé€‰æ‹©ï¼Œç”¨ä¸åˆ°å°±ä¸ç”¨è®¾ç½®</span>
</span></span><span style="display:flex;"><span> - <span style="color:#e6db74">&#34;net.core*&#34;</span>
</span></span><span style="display:flex;"><span> - <span style="color:#e6db74">&#34;net.ipv4.*&#34;</span>
</span></span><span style="display:flex;"><span>kubeReserved: <span style="color:#75715e"># ä¸ºKubernetesé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹ç»„ä»¶é¢„ç•™èµ„æºï¼Œä¾‹å¦‚ï¼škubeletã€Runtimeç­‰</span>
</span></span><span style="display:flex;"><span>  cpu: <span style="color:#e6db74">&#34;100m&#34;</span>
</span></span><span style="display:flex;"><span>  memory: 100Mi
</span></span><span style="display:flex;"><span>  ephemeral-storage: 1Gi
</span></span><span style="display:flex;"><span>systemReserved: <span style="color:#75715e"># ä¸ºç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹é¢„ç•™èµ„æºï¼Œä¾‹å¦‚ï¼šsshdã€cronç­‰</span>
</span></span><span style="display:flex;"><span>  cpu: <span style="color:#e6db74">&#34;100m&#34;</span>
</span></span><span style="display:flex;"><span>  memory: 100Mi
</span></span><span style="display:flex;"><span>  ephemeral-storage: 1Gi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºé›†ç¾¤èŠ‚ç‚¹æ‰“æ ‡ç­¾ï¼Œåˆ é™¤æ ‡ç­¾æŠŠ = æ¢æˆ - å³å¯</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node01 node-role.kubernetes.io/node<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node02 node-role.kubernetes.io/node<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-master01 node-role.kubernetes.io/master<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-master02 node-role.kubernetes.io/master<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-master03 node-role.kubernetes.io/master<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ·»åŠ æ ‡ç­¾åæŸ¥çœ‹é›†ç¾¤çŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME           STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master01   Ready    master   35m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master02   Ready    master   35m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master03   Ready    master   35m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node01     Ready    node     35m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node02     Ready    node     35m   v1.26.4
</span></span></code></pre></div><p>ç”Ÿäº§ç¯å¢ƒå»ºè®®ETCDé›†ç¾¤å’ŒKubernetesé›†ç¾¤åˆ†ç¦»ï¼Œè€Œä¸”ä½¿ç”¨é«˜æ€§èƒ½æ•°æ®ç›˜å­˜å‚¨æ•°æ®ï¼Œæ ¹æ®æƒ…å†µå†³å®šæ˜¯å¦å°†MasterèŠ‚ç‚¹ä¹Ÿä½œä¸ºPodè°ƒåº¦èŠ‚ç‚¹ã€‚</p>
<h2 id="æµ‹è¯•é›†ç¾¤">æµ‹è¯•é›†ç¾¤<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•é›†ç¾¤">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æµ‹è¯•namespace</span>
</span></span><span style="display:flex;"><span>kubectl get namespace
</span></span><span style="display:flex;"><span>kubectl create namespace test
</span></span><span style="display:flex;"><span>kubectl get namespace
</span></span><span style="display:flex;"><span>kubectl delete namespace test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºnginxå®ä¾‹å¹¶å¼€æ”¾ç«¯å£</span>
</span></span><span style="display:flex;"><span>kubectl create deployment nginx --image<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>kubectl expose deployment nginx --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --type<span style="color:#f92672">=</span>NodePort
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹è°ƒåº¦çŠ¶æ€å’Œç«¯å£å·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po,svc -o wide</span>
</span></span><span style="display:flex;"><span>NAME                         READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>pod/nginx-748c667d99-dmtn6   1/1     Running   <span style="color:#ae81ff">0</span>          9m55s   172.25.244.194   k8s-master01   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE   SELECTOR
</span></span><span style="display:flex;"><span>service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        69m   &lt;none&gt;
</span></span><span style="display:flex;"><span>service/nginx        NodePort    10.110.18.105   &lt;none&gt;        80:31687/TCP   9s    app<span style="color:#f92672">=</span>nginx
</span></span></code></pre></div><p>åœ¨æµè§ˆå™¨è¾“å…¥<a href="http://%e4%bb%bb%e6%84%8f%e8%8a%82%e7%82%b9IP:31687/"  target="_blank" rel="noopener" style="color:#42b983" ;>http://ä»»æ„èŠ‚ç‚¹IP:31687/</a> è®¿é—®nginxï¼Œè®¿é—®ç»“æœå¦‚å›¾</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20230421165824.png" alt="20230421165824"  />
</p>
<p>è‡³æ­¤ï¼ŒåŸºäºäºŒè¿›åˆ¶æ–¹å¼çš„Kubernetesé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²å¹¶éªŒè¯æˆåŠŸã€‚</p>


        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetescli/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Kuberntes CLI</span>
  </a>
  <a class="next" href="https://deemoprobe.github.io/posts/tech/kubernetes/kuberneteskubeadminstallation-ha/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>KubernetesKubeadmInstallation HA</span>
  </a>
</nav>

        </footer>
    </div>
</article>
</main>

<footer class="footer">
    
        <span id="runtime_span"></span>
        <script
            type="text/javascript">function show_runtime() { window.setTimeout("show_runtime()", 1000); X = new Date("1/1/2023 1:00:00"); Y = new Date(); T = (Y.getTime() - X.getTime()); M = 24 * 60 * 60 * 1000; a = T / M; A = Math.floor(a); b = (a - A) * 24; B = Math.floor(b); c = (b - B) * 60; C = Math.floor((b - B) * 60); D = Math.floor((c - C) * 60); runtime_span.innerHTML = "ç½‘ç«™å·²è¿è¡Œ" + A + "å¤©" + B + "å°æ—¶" + C + "åˆ†" + D + "ç§’" } show_runtime();</script>
    
    
    <br>
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="https://deemoprobe.github.io/" style="color:#939393;">William&#39;s Blog</a>
        All Rights Reserved
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>

<script>
    $("code[class^=language] ").on("mouseover", function () {
        if (this.clientWidth < this.scrollWidth) {
            $(this).css("width", "135%")
            $(this).css("border-top-right-radius", "var(--radius)")
        }
    }).on("mouseout", function () {
        $(this).css("width", "100%")
        $(this).css("border-top-right-radius", "unset")
    })
</script>
</body>

</html>
