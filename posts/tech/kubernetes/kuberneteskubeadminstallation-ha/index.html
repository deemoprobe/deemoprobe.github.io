<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>KubernetesKubeadmInstallation HA | William&#39;s Blog</title>
<meta name="keywords" content="kubernetes">
<meta name="description" content="kubeadmæ–¹å¼éƒ¨ç½²kubernetesé«˜å¯ç”¨é›†ç¾¤">
<meta name="author" content="deemoprobe">
<link rel="canonical" href="https://deemoprobe.github.io/posts/tech/kubernetes/kuberneteskubeadminstallation-ha/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.437c6a2af4fc60ed76299fc9cd9077545ae1b4ff1cc6481716ecd767dee77e57.css" integrity="sha256-Q3xqKvT8YO12KZ/JzZB3VFrhtP8cxkgXFuzXZ97nflc=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.89eeec8f36cd08246c59f8970019c7295c6a548ff3bdfb632a7ae687603dd4f5.js" integrity="sha256-ie7sjzbNCCRsWfiXABnHKVxqVI/zvftjKnrmh2A91PU="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://deemoprobe.github.io/img/favicon/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://deemoprobe.github.io/img/favicon/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://deemoprobe.github.io/img/favicon/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://deemoprobe.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://deemoprobe.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="KubernetesKubeadmInstallation HA" />
<meta property="og:description" content="kubeadmæ–¹å¼éƒ¨ç½²kubernetesé«˜å¯ç”¨é›†ç¾¤" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://deemoprobe.github.io/posts/tech/kubernetes/kuberneteskubeadminstallation-ha/" />
<meta property="og:image" content="https://deemoprobe.github.io/img/kubernetes.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-29T14:12:14+08:00" />
<meta property="article:modified_time" content="2023-04-29T14:12:14+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://deemoprobe.github.io/img/kubernetes.png" />
<meta name="twitter:title" content="KubernetesKubeadmInstallation HA"/>
<meta name="twitter:description" content="kubeadmæ–¹å¼éƒ¨ç½²kubernetesé«˜å¯ç”¨é›†ç¾¤"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://deemoprobe.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
          "item": "https://deemoprobe.github.io/posts/tech/"
        },

        {
          "@type": "ListItem",
          "position":  3 ,
          "name": "Kubernetes",
          "item": "https://deemoprobe.github.io/posts/tech/kubernetes/"
        }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "KubernetesKubeadmInstallation HA",
      "item": "https://deemoprobe.github.io/posts/tech/kubernetes/kuberneteskubeadminstallation-ha/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "KubernetesKubeadmInstallation HA",
  "name": "KubernetesKubeadmInstallation HA",
  "description": "kubeadmæ–¹å¼éƒ¨ç½²kubernetesé«˜å¯ç”¨é›†ç¾¤",
  "keywords": [
    "kubernetes"
  ],
  "articleBody": "ç¯å¢ƒè¯´æ˜ å®¿ä¸»æœºç³»ç»Ÿï¼šWindows 10 è™šæ‹Ÿæœºç‰ˆæœ¬ï¼šVMwareÂ® Workstation 16 Pro IOSé•œåƒç‰ˆæœ¬ï¼šCentOS Linux release 7.9.2009 é›†ç¾¤æ“ä½œç”¨æˆ·ï¼šroot Kubernetesç‰ˆæœ¬ï¼š1.23.0 Etcdç‰ˆæœ¬ï¼š3.5.1 Runtimeï¼šDocker 20.10 CentOS7å®‰è£…è¯·å‚è€ƒåšå®¢æ–‡ç« ï¼šLINUXä¹‹VMWARE WORKSTATIONå®‰è£…CENTOS-7\nèµ„æºåˆ†é… ç½‘æ®µåˆ’åˆ† Kubernetesé›†ç¾¤éœ€è¦è§„åˆ’ä¸‰ä¸ªç½‘æ®µï¼š\nå®¿ä¸»æœºç½‘æ®µï¼šKubernetesé›†ç¾¤èŠ‚ç‚¹çš„ç½‘æ®µ Podç½‘æ®µï¼šé›†ç¾¤å†…Podçš„ç½‘æ®µï¼Œç›¸å½“äºå®¹å™¨çš„IP Serviceç½‘æ®µï¼šé›†ç¾¤å†…æœåŠ¡å‘ç°ä½¿ç”¨çš„ç½‘æ®µï¼Œserviceç”¨äºé›†ç¾¤å®¹å™¨é€šä¿¡ ç”Ÿäº§ç¯å¢ƒæ ¹æ®ç”³è¯·åˆ°çš„IPèµ„æºè¿›è¡Œåˆ†é…å³å¯ï¼ŒåŸåˆ™æ˜¯ä¸‰ä¸ªç½‘æ®µä¸å…è®¸æœ‰é‡åˆIPã€‚IPç½‘æ®µè®¡ç®—å¯ä»¥å‚è€ƒï¼šåœ¨çº¿IPåœ°å€è®¡ç®—ã€‚æœ¬æ–‡è™šæ‹Ÿæœºç»ƒä¹ ç¯å¢ƒIPåœ°å€ç½‘æ®µåˆ†é…å¦‚ä¸‹ï¼š\nå®¿ä¸»æœºç½‘æ®µï¼š192.168.43.1/24 Podç½‘æ®µï¼š172.16.0.0/12 Serviceï¼š10.96.0.0/12 èŠ‚ç‚¹åˆ†é… é‡‡ç”¨3ç®¡ç†èŠ‚ç‚¹2å·¥ä½œèŠ‚ç‚¹çš„é«˜å¯ç”¨Kubernetesé›†ç¾¤æ¨¡å¼ï¼š\nk8s-master01/k8s-master02/k8s-master03 é›†ç¾¤çš„MasterèŠ‚ç‚¹ ä¸‰ä¸ªmasterèŠ‚ç‚¹åŒæ—¶åšetcdé›†ç¾¤ k8s-node01/k8s-node02 é›†ç¾¤çš„NodeèŠ‚ç‚¹ k8s-master-vipåšé«˜å¯ç”¨k8s-master01~03çš„VIPï¼Œä¸å ç”¨ç‰©ç†èµ„æº ä¸»æœºèŠ‚ç‚¹åç§° IP CPUæ ¸å¿ƒæ•° å†…å­˜å¤§å° ç£ç›˜å¤§å° k8s-master-vip 192.168.43.182 / / / k8s-master01 192.168.43.183 2 2G 40G k8s-master02 192.168.43.184 2 2G 40G k8s-master03 192.168.43.185 2 2G 40G k8s-node01 192.168.43.186 2 2G 40G k8s-node02 192.168.43.187 2 2G 40G æ“ä½œæ­¥éª¤ æ ‡é¢˜åå°æ‹¬å·æ³¨é‡Šè¡¨æ˜æ“ä½œèŒƒå›´ï¼š\nALL æ‰€æœ‰èŠ‚ç‚¹ï¼ˆk8s-master01/k8s-master02/k8s-master03/k8s-node01/k9s-node02ï¼‰æ‰§è¡Œ Master åªéœ€è¦åœ¨masterèŠ‚ç‚¹ï¼ˆk8s-master01/k8s-master02/k8s-master03ï¼‰æ‰§è¡Œ Node åªéœ€è¦åœ¨nodeèŠ‚ç‚¹ï¼ˆk8s-node01/k8s-node02ï¼‰æ‰§è¡Œ å·²æ ‡æ³¨çš„ä¸ªåˆ«å‘½ä»¤åªéœ€è¦åœ¨æŸä¸€å°æœºå™¨æ‰§è¡Œï¼Œä¼šåœ¨æ“ä½œå‰è¯´æ˜ æœªæ ‡æ³¨çš„ä¼šåœ¨æ“ä½œæ—¶è¯´æ˜ ä½¿ç”¨cat \u003c\u003c \"EOF\" \u003e\u003e fileæˆ–cat \u003e\u003e file \u003c\u003c \"EOF\"æ·»åŠ æ–‡ä»¶å†…å®¹æ³¨æ„catåé¢çš„EOFä¸€å®šè¦åŠ ä¸ŠåŒå¼•å·ï¼ˆæ ‡å‡†è¾“å…¥çš„ï¼‰ï¼Œå¦åˆ™ä¸ä¼šä¿ç•™è¾“å…¥æ—¶çš„ç¼©è¿›æ ¼å¼è€Œä¸”ä¼šç›´æ¥è§£æè¾“å…¥æ—¶çš„å˜é‡ï¼Œè¿›è€Œé€ æˆæ–‡ä»¶å¯è¯»æ€§å·®ç”šè‡³ä¸å¯ç”¨ï¼›åŒæ—¶æ³¨æ„æ–‡ä»¶çš„\u003eé‡å†™ä¸\u003e\u003eè¿½åŠ ã€‚è™½ç„¶å•ç‹¬è½¬ä¹‰è¾“å…¥æ—¶çš„å˜é‡ä¹Ÿèƒ½é¿å…å˜é‡è¢«è§£æï¼Œä½†æ˜¯ä¸æ¨èï¼Œæ¼è½¬ä¹‰ä¼šé€ æˆä¸å¿…è¦çš„éº»çƒ¦ã€‚\nå‡†å¤‡å·¥ä½œ(ALL) æ·»åŠ ä¸»æœºä¿¡æ¯ã€å…³é—­é˜²ç«å¢™ã€å…³é—­swapã€å…³é—­SELinuxã€dnsmasqã€NetworkManager\n# æ·»åŠ ä¸»æœºä¿¡æ¯ cat \u003c\u003c \"EOF\" \u003e\u003e /etc/hosts 192.168.43.182 k8s-master-vip 192.168.43.183 k8s-master01 192.168.43.184 k8s-master02 192.168.43.185 k8s-master03 192.168.43.186 k8s-node01 192.168.43.187 k8s-node02 EOF # å…³é—­é˜²ç«å¢™ã€dnsmasqã€NetworkManagerï¼Œ--nowå‚æ•°è¡¨ç¤ºå…³é—­æœåŠ¡å¹¶ç§»é™¤å¼€æœºè‡ªå¯ # è¿™äº›æœåŠ¡æ˜¯å¦å¯ä»¥å…³é—­è§†æƒ…å†µè€Œå®šï¼Œæœ¬æ–‡æ˜¯è™šæ‹Ÿæœºå®è·µï¼Œæ²¡æœ‰ç”¨åˆ°è¿™äº›æœåŠ¡ systemctl disable --now firewalld systemctl disable --now dnsmasq systemctl disable --now NetworkManager # å…³é—­swapï¼Œå¹¶æ³¨é‡Šfstabæ–‡ä»¶swapæ‰€åœ¨è¡Œ swapoff -a sed -i '/swap/s/^\\(.*\\)$/#\\1/g' /etc/fstab # å…³é—­SELinuxï¼Œå¹¶æ›´æ”¹selinuxé…ç½®æ–‡ä»¶ setenforce 0 sed -i \"s/=enforcing/=disabled/g\" /etc/selinux/config å€¼å¾—æ³¨æ„çš„æ˜¯/etc/sysconfig/selinuxæ–‡ä»¶æ˜¯/etc/selinux/configæ–‡ä»¶çš„è½¯è¿æ¥ï¼Œç”¨sed -iå‘½ä»¤ä¿®æ”¹è½¯è¿æ¥æ–‡ä»¶ä¼šç ´åè½¯è¿æ¥å±æ€§ï¼Œå°†/etc/sysconfig/selinuxå˜ä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼Œå³ä½¿è¯¥æ–‡ä»¶è¢«ä¿®æ”¹äº†ï¼Œä½†æºæ–‡ä»¶/etc/selinux/configé…ç½®æ˜¯æ²¡å˜çš„ã€‚æ­¤å¤–ï¼Œä½¿ç”¨vimç­‰ç¼–è¾‘å™¨ç¼–è¾‘æºæ–‡ä»¶æˆ–é“¾æ¥æ–‡ä»¶ï¼ˆç¼–è¾‘æ¨¡å¼ä¸ä¼šä¿®æ”¹æ–‡ä»¶å±æ€§ï¼‰ä¿®æ”¹ä¹Ÿå¯ä»¥ã€‚è½¯é“¾æ¥åŸç†å¯å‚è€ƒåšå®¢ï¼šLINUXä¹‹INODEè¯¦è§£\nå¿…è¦æ“ä½œ(ALL) # é»˜è®¤çš„yumæºå¤ªæ…¢ï¼Œæ›´æ–°ä¸ºé˜¿é‡Œæºï¼ŒåŒæ—¶ç”¨sedå‘½ä»¤åˆ é™¤æ–‡ä»¶ä¸­ä¸éœ€è¦çš„ä¸¤ä¸ªURLçš„è¡Œ curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo # å®‰è£…å¸¸ç”¨å·¥å…·åŒ… yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y # é…ç½®é˜¿é‡ŒKubernetesæºï¼Œå¦‚æœæç¤ºgpgæ–‡ä»¶æœ‰é—®é¢˜ï¼Œå¯ä»¥æ”¹ä¸ºgpgcheck=0ï¼Œå¹¶æŠŠåä¸‰è¡Œåˆ é™¤ï¼ˆä»…é™æµ‹è¯•ç¯å¢ƒä½¿ç”¨ï¼‰ cat \u003c /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF # é…ç½®ntpdateï¼ŒåŒæ­¥æœåŠ¡å™¨æ—¶é—´ rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm yum install ntpdate -y # åŒæ­¥æ—¶åŒºå’Œæ—¶é—´ ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime echo 'Asia/Shanghai' \u003e/etc/timezone ntpdate time2.aliyun.com # å¯ä»¥åŠ å…¥è®¡åˆ’ä»»åŠ¡ï¼Œä¿è¯é›†ç¾¤æ—¶é’Ÿæ˜¯ä¸€è‡´çš„ # /var/spool/cron/rootæ–‡ä»¶ä¹Ÿæ˜¯crontab -eå†™å…¥çš„æ–‡ä»¶ # crontabæ‰§è¡Œæ—¥å¿—æŸ¥çœ‹å¯ç”¨ï¼štail -f /var/log/cron cat \u003c\u003c \"EOF\" \u003e\u003e /var/spool/cron/root */5 * * * * /usr/sbin/ntpdate time2.aliyun.com EOF # ä¿è¯æ–‡ä»¶å¥æŸ„ä¸ä¼šé™åˆ¶é›†ç¾¤çš„å¯æŒç»­å‘å±•ï¼Œé…ç½®limits ulimit -SHn 65500 cat \u003c\u003c \"EOF\" \u003e\u003e /etc/security/limits.conf * soft nofile 65500 * hard nofile 65500 * soft nproc 65500 * hard nproc 65500 * soft memlock unlimited * hard memlock unlimited EOF # é…ç½®å…å¯†ç™»å½•ï¼Œk8s-master01åˆ°å…¶ä»–èŠ‚ç‚¹ # ç”Ÿæˆå¯†é’¥å¯¹ï¼ˆåœ¨k8s-master01èŠ‚ç‚¹é…ç½®å³å¯ï¼‰ ssh-keygen -t rsa # æ‹·è´å…¬é’¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œé¦–æ¬¡éœ€è¦è®¤è¯ä¸€ä¸‹å„ä¸ªèŠ‚ç‚¹çš„rootå¯†ç ï¼Œä»¥åå°±å¯ä»¥å…å¯†sshåˆ°å…¶ä»–èŠ‚ç‚¹ for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do ssh-copy-id -i .ssh/id_rsa.pub $i;done # å…‹éš†äºŒè¿›åˆ¶ä»“åº“æ–‡ä»¶ï¼ˆk8s-master01ä¸Šæ“ä½œå³å¯ï¼‰ cd root;git clone https://gitee.com/deemoprobe/k8s-ha-install.git cd k8s-ha-install;git branch -a * master remotes/origin/HEAD -\u003e origin/master remotes/origin/manual-installation remotes/origin/manual-installation-v1.16.x remotes/origin/manual-installation-v1.17.x remotes/origin/manual-installation-v1.18.x remotes/origin/manual-installation-v1.19.x remotes/origin/manual-installation-v1.20.x remotes/origin/manual-installation-v1.20.x-csi-hostpath remotes/origin/manual-installation-v1.21.x remotes/origin/manual-installation-v1.22.x remotes/origin/manual-installation-v1.23.x remotes/origin/master # å¯ä»¥åˆ‡æ¢åˆ°éœ€è¦ç‰ˆæœ¬çš„åˆ†æ”¯ä¸­è·å–é…ç½®æ–‡ä»¶ git checkout manual-installation-v1.22.x # æ‰€æœ‰èŠ‚ç‚¹ç³»ç»Ÿå‡çº§ yum update --exclude=kernel* -y å‡çº§å†…æ ¸ï¼Œ4.17ä»¥ä¸‹çš„å†…æ ¸cgroupå­˜åœ¨å†…å­˜æ³„æ¼çš„BUGï¼Œå…·ä½“åˆ†æè¿‡ç¨‹æµè§ˆå™¨æœKubernetesé›†ç¾¤ä¸ºä»€ä¹ˆè¦å‡çº§å†…æ ¸ä¼šæœ‰å¾ˆå¤šæ–‡ç« è®²è§£\nå†…æ ¸å¤‡ç”¨ä¸‹è½½ï¼ˆå»ºè®®ä¸‹è½½åˆ°æœ¬åœ°åä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå°½é‡ä¸ç”¨wgetï¼‰ï¼š\nkernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm # ä¸‹è½½4.19ç‰ˆæœ¬å†…æ ¸ï¼Œå¦‚æœæ— æ³•ä¸‹è½½ï¼Œå¯ä»¥ç”¨ä¸Šé¢æä¾›çš„å¤‡ç”¨ä¸‹è½½ cd /root wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm # å¯ä»¥åœ¨k8s-master01èŠ‚ç‚¹ä¸‹è½½åï¼Œå…å¯†ä¼ åˆ°å…¶ä»–èŠ‚ç‚¹ for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp kernel-ml-* $i:/root;done # æ‰€æœ‰èŠ‚ç‚¹å®‰è£…å†…æ ¸ cd /root \u0026\u0026 yum localinstall -y kernel-ml* # æ‰€æœ‰èŠ‚ç‚¹æ›´æ”¹å†…æ ¸å¯åŠ¨é¡ºåº grub2-set-default 0 \u0026\u0026 grub2-mkconfig -o /etc/grub2.cfg grubby --args=\"user_namespace.enable=1\" --update-kernel=\"$(grubby --default-kernel)\" # æŸ¥çœ‹é»˜è®¤å†…æ ¸ï¼Œå¹¶é‡å¯èŠ‚ç‚¹ grubby --default-kernel reboot # ç¡®è®¤å†…æ ¸ç‰ˆæœ¬ uname -a # ï¼ˆå¯é€‰ï¼‰åˆ é™¤è€ç‰ˆæœ¬çš„å†…æ ¸ï¼Œé¿å…ä»¥åè¢«å‡çº§å–ä»£é»˜è®¤çš„å¼€æœº4.19å†…æ ¸ rpm -qa | grep kernel yum remove -y kernel-3* # å‡çº§ç³»ç»Ÿè½¯ä»¶åŒ…ï¼ˆå¦‚æœè·³è¿‡å†…æ ¸å‡çº§åŠ å‚æ•° --exclude=kernel*ï¼‰ yum update -y # å®‰è£…IPVSç›¸å…³å·¥å…·ï¼Œç”±äºIPVSåœ¨èµ„æºæ¶ˆè€—å’Œæ€§èƒ½ä¸Šå‡å·²æ˜æ˜¾ä¼˜äºiptablesï¼Œæ‰€ä»¥æ¨èå¼€å¯ # å…·ä½“åŸå› å¯å‚è€ƒå®˜ç½‘ä»‹ç» https://kubernetes.io/zh/blog/2018/07/09/ipvs-based-in-cluster-load-balancing-deep-dive/ yum install ipvsadm ipset sysstat conntrack libseccomp -y # åŠ è½½æ¨¡å—ï¼Œæœ€åä¸€æ¡4.18åŠä»¥ä¸‹å†…æ ¸ä½¿ç”¨nf_conntrack_ipv4ï¼Œ4.19å·²æ”¹ä¸ºnf_conntrack modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack # ç¼–å†™å‚æ•°æ–‡ä»¶ cat \u003c\u003c \"EOF\" \u003e /etc/modules-load.d/ipvs.conf ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp ip_vs_sh nf_conntrack ip_tables ip_set xt_set ipt_set ipt_rpfilter ipt_REJECT ipip EOF # systemd-modules-loadåŠ å…¥å¼€æœºè‡ªå¯ systemctl enable --now systemd-modules-load # è‡ªå®šä¹‰å†…æ ¸å‚æ•°ä¼˜åŒ–é…ç½®æ–‡ä»¶ cat \u003c\u003c \"EOF\" \u003e /etc/sysctl.d/kubernetes.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-ip6tables = 1 fs.may_detach_mounts = 1 net.ipv4.conf.all.route_localnet = 1 vm.overcommit_memory=1 vm.panic_on_oom=0 fs.inotify.max_user_watches=89100 fs.file-max=52706963 fs.nr_open=52706963 net.netfilter.nf_conntrack_max=2310720 net.ipv4.tcp_keepalive_time = 600 net.ipv4.tcp_keepalive_probes = 3 net.ipv4.tcp_keepalive_intvl =15 net.ipv4.tcp_max_tw_buckets = 36000 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_max_orphans = 327680 net.ipv4.tcp_orphan_retries = 3 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.ip_conntrack_max = 65536 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.tcp_timestamps = 0 net.core.somaxconn = 16384 EOF # åŠ è½½ sysctl --system # é‡å¯æŸ¥çœ‹IPVSæ¨¡å—æ˜¯å¦ä¾æ—§åŠ è½½ reboot lsmod | grep -e ip_vs -e nf_conntrack ä¿è¯æ¯å°æœåŠ¡å™¨ä¸­IPVSåŠ è½½æˆåŠŸï¼Œä»¥k8s-master01ä¸ºä¾‹ï¼Œå¦‚å›¾ï¼š éƒ¨ç½²Docker(ALL) # å¸è½½å·²å­˜åœ¨dockerï¼Œæ–°æœºå™¨çš„è¯è¿™æ­¥å¯ä»¥å¿½ç•¥ yum remove -y docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-engine yum remove -y docker-ce docker-ce-cli containerd.io # é…ç½®é˜¿é‡Œdockeræº yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo # å®‰è£…æœ€æ–°ç‰ˆæœ¬docker yum install docker-ce docker-ce-cli containerd.io -y # ï¼ˆå¯é€‰ï¼‰å¦‚æœæƒ³è¦å®‰è£…æŒ‡å®šç‰ˆæœ¬dockerï¼Œå…ˆæŸ¥è¯¢ä¸€ä¸‹ã€‚å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼Œä¾‹å¦‚20.10.9-3.el7 yum list docker-ce docker-ce-cli --showduplicates | grep \"^doc\" | sort -r yum install docker-ce-20.10.9-3.el7 docker-ce-cli-20.10.9-3.el7 containerd.io -y # åŠ å…¥å¼€æœºå¯åŠ¨å¹¶å¯åŠ¨ systemctl enable docker systemctl start docker # æµ‹è¯•è¿è¡Œhello-worldé•œåƒå¹¶æŸ¥çœ‹dockerç‰ˆæœ¬ä¿¡æ¯ docker run hello-world docker version # é…ç½®é˜¿é‡Œdockeré•œåƒåŠ é€Ÿå™¨ï¼Œé˜¿é‡Œäº‘(ç™»å½•è´¦å·--\u003eç‚¹å‡»ç®¡ç†æ§åˆ¶å°--\u003eæœç´¢å®¹å™¨é•œåƒæœåŠ¡--\u003eé•œåƒå·¥å…·--\u003eé•œåƒåŠ é€Ÿå™¨--\u003eå¤åˆ¶åŠ é€Ÿå™¨åœ°å€) # dockeræ–‡ä»¶é©±åŠ¨æ”¹æˆ systemd cat \u003c /etc/docker/daemon.json { \"exec-opts\": [\"native.cgroupdriver=systemd\"], \"registry-mirrors\": [\"https://ynirk4k5.mirror.aliyuncs.com\"] } EOF # é‡å¯docker systemctl restart docker # å¦‚æœå¯åŠ¨å¤±è´¥,å¼ºåˆ¶åŠ è½½å†å¯åŠ¨è¯•è¯• systemctl reset-failed docker systemctl restart docker # æŸ¥çœ‹dockeré…ç½®ä¿¡æ¯ docker info docker info | grep Driver å®‰è£…kubernetes(ALL) ä¸€èˆ¬kubectlåœ¨masterèŠ‚ç‚¹å®‰è£…å³å¯,nodeèŠ‚ç‚¹è£…ä¸è£…å‡å¯\n# æŸ¥çœ‹å¯ä»¥å®‰è£…çš„ç‰ˆæœ¬å· yum list kubeadm --showduplicates | sort -r # ä¸æŒ‡å®šç‰ˆæœ¬çš„è¯é»˜è®¤å®‰è£…æœ€æ–°ç‰ˆæœ¬å®‰è£… yum install -y kubelet kubeadm kubectl # ï¼ˆå¯é€‰ï¼‰æŒ‡å®šç‰ˆæœ¬è¿›è¡Œå®‰è£…ï¼Œå¦‚1.23.0 yum install -y kubelet-1.23.0 kubeadm-1.23.0 kubectl-1.23.0 # é…ç½®pauseé•œåƒä»“åº“ï¼Œé»˜è®¤çš„gcr.ioå›½å†…æ— æ³•è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨é˜¿é‡Œä»“åº“ cat \u003c\u003c \"EOF\" \u003e /etc/sysconfig/kubelet KUBELET_EXTRA_ARGS=\"--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5\" EOF # åŠ å…¥å¼€æœºå¯åŠ¨å¹¶å¯åŠ¨ï¼Œæ­¤å¤„å¯åŠ¨å¤±è´¥ä¸å¿…æ’æŸ¥ï¼Œå¾…åˆå§‹åŒ–å®Œæˆkubeletä¼šè‡ªåŠ¨æ¢å¤æ­£å¸¸ systemctl enable --now kubelet é«˜å¯ç”¨ç»„ä»¶å®‰è£…(Master) # æ‰€æœ‰masterèŠ‚ç‚¹å®‰è£…Keepalivedå’Œhaproxy yum install keepalived haproxy -y # ä¸ºæ‰€æœ‰masterèŠ‚ç‚¹æ·»åŠ haproxyé…ç½®ï¼Œé…ç½®éƒ½ä¸€æ ·ï¼Œæ£€æŸ¥æœ€åä¸‰è¡Œä¸»æœºåå’ŒIPåœ°å€å¯¹åº”ä¸Šå°±è¡Œ mkdir /etc/haproxy cat \u003c\u003c \"EOF\" \u003e /etc/haproxy/haproxy.cfg global maxconn 2000 ulimit-n 16384 log 127.0.0.1 local0 err stats timeout 30s defaults log global mode http option httplog timeout connect 5000 timeout client 50000 timeout server 50000 timeout http-request 15s timeout http-keep-alive 15s frontend monitor-in bind *:33305 mode http option httplog monitor-uri /monitor frontend k8s-master bind 0.0.0.0:16443 bind 127.0.0.1:16443 mode tcp option tcplog tcp-request inspect-delay 5s default_backend k8s-master backend k8s-master mode tcp option tcplog option tcp-check balance roundrobin default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100 server k8s-master01 192.168.43.183:6443 check server k8s-master02 192.168.43.184:6443 check server k8s-master03 192.168.43.185:6443 check EOF # keepalivedé…ç½®ä¸ä¸€æ ·ï¼Œæ³¨æ„åŒºåˆ†ç½‘å¡åã€IPåœ°å€å’Œè™šæ‹ŸIPåœ°å€ # æ£€æŸ¥æœåŠ¡å™¨ç½‘å¡å ip a æˆ– ifconfig # k8s-master01 Keepalivedé…ç½® mkdir /etc/keepalived cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state MASTER interface ens33 mcast_src_ip 192.168.43.183 virtual_router_id 51 priority 101 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.43.182 } track_script { chk_apiserver } } EOF # k8s-master02 Keepalivedé…ç½® mkdir /etc/keepalived cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state BACKUP interface ens33 mcast_src_ip 192.168.43.184 virtual_router_id 51 priority 100 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.43.182 } track_script { chk_apiserver } } EOF # k8s-master03 Keepalivedé…ç½® mkdir /etc/keepalived cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state BACKUP interface ens33 mcast_src_ip 192.168.43.185 virtual_router_id 51 priority 100 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.43.182 } track_script { chk_apiserver } } EOF # æ‰€æœ‰masterèŠ‚ç‚¹é…ç½®Keepalivedå¥åº·æ£€æŸ¥è„šæœ¬ cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/check_apiserver.sh #!/bin/bash err=0 for k in $(seq 1 3) do check_code=$(pgrep haproxy) if [[ $check_code == \"\" ]]; then err=$(expr $err + 1) sleep 1 continue else err=0 break fi done if [[ $err != \"0\" ]]; then echo \"systemctl stop keepalived\" /usr/bin/systemctl stop keepalived exit 1 else exit 0 fi EOF # èµ‹äºˆå¯æ‰§è¡Œæƒé™ chmod +x /etc/keepalived/check_apiserver.sh # å¯åŠ¨haproxyå’ŒKeepalivedå¹¶åŠ å…¥å¼€æœºå¯åŠ¨ systemctl start haproxy systemctl start keepalived systemctl enable haproxy systemctl enable keepalived # æµ‹è¯•ä¸€æ³¢ telnet k8s-master-vip 16443 ping k8s-master-vip éƒ¨ç½²k8s-master(k8s-master01) åœ¨k8s-master01èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œä¸ªåˆ«æ­¥éª¤åœ¨æ‰€æœ‰masterèŠ‚ç‚¹æ‰§è¡Œï¼Œå·²å¦è¡Œè¯´æ˜ï¼Œæ²¡è¯´æ˜çš„å‡æ˜¯åœ¨k8s-master01æ‰§è¡Œã€‚\n# åˆ›å»ºåˆå§‹åŒ–æ–‡ä»¶ï¼Œæ³¨æ„ç‰ˆæœ¬å·å’ŒIPå¯¹åº”ä¸Š cat \u003c\u003c \"EOF\" \u003e kubeadm-config.yaml apiVersion: kubeadm.k8s.io/v1beta2 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: 7t2weq.bjbawausm0jaxury ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 192.168.43.183 # APIé€šçŸ¥åœ°å€ï¼Œè®¾ç½®ä¸ºåˆå§‹åŒ–IPå³å¯ bindPort: 6443 nodeRegistration: criSocket: /var/run/dockershim.sock # dockerä½œä¸ºContainer Runtime # criSocket: /run/containerd/containerd.sock # containerdä½œä¸ºContainer Runtime name: k8s-master01 # åˆå§‹åŒ–èŠ‚ç‚¹å taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiServer: certSANs: - 192.168.43.182 timeoutForControlPlane: 4m0s # åˆå§‹åŒ–è¶…æ—¶æ—¶é—´ apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controlPlaneEndpoint: 192.168.43.182:16443 # å¦‚æœä¸æ˜¯é«˜å¯ç”¨é›†ç¾¤ï¼Œåˆ™ä¸º6443 controllerManager: {} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers # å›½å†…åœ°å€ kind: ClusterConfiguration kubernetesVersion: v1.23.0 # éœ€ä¸kubeadm versionç‰ˆæœ¬å·ä¿æŒä¸€è‡´ networking: dnsDomain: cluster.local podSubnet: 172.16.0.0/12 # ä¸å¯ä¸å…¶ä»–IPæ®µå†²çª serviceSubnet: 10.96.0.0/12 # ä¸å¯ä¸å…¶ä»–IPæ®µå†²çª scheduler: {} EOF # æ›´æ–°åˆå§‹åŒ–æ–‡ä»¶ kubeadm config migrate --old-config kubeadm-config.yaml --new-config new.yaml # å°†new.yamlå¤åˆ¶åˆ°å…¶ä»–masterèŠ‚ç‚¹ä¸Š for i in k8s-master02 k8s-master03;do scp new.yaml $i:/root/;done # é•œåƒé¢„ä¸‹è½½ï¼ŒèŠ‚çœé›†ç¾¤åˆå§‹åŒ–çš„æ—¶é—´ï¼ˆè¿™ä¸€æ­¥åœ¨æ‰€æœ‰masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼‰ kubeadm config images pull --config /root/new.yaml # æ‰§è¡Œç»“æœå¦‚ä¸‹ [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.23.0 [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.23.0 [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.23.0 [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.23.0 [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6 [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.1-0 [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.6 # master01åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆåï¼ŒåŠ å…¥å…¶ä»–èŠ‚ç‚¹å³å¯ kubeadm init --config /root/new.yaml --upload-certs # åˆå§‹åŒ–å¦‚æœå¤±è´¥ï¼Œå¯ç”¨ä¸‹é¢å‘½ä»¤æ¸…é™¤åˆå§‹åŒ–ä¿¡æ¯ï¼Œç„¶åå†æ¬¡å°è¯•åˆå§‹åŒ– kubeadm reset -f ; ipvsadm --clear ; rm -rf ~/.kube # åˆå§‹åŒ–æˆåŠŸç±»ä¼¼äºä¸‹é¢è¾“å‡ºï¼Œä¿å­˜å¥½è¿™äº›ä¿¡æ¯ ... Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Alternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.conf You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ You can now join any number of the control-plane node running the following command on each as root: kubeadm join 192.168.43.182:16443 --token 7t2weq.bjbawausm0jaxury \\ --discovery-token-ca-cert-hash sha256:5257d44118ab035adc5af89dd7d5a24ca4c31c33e1918b3453ea9aa32597121b \\ --control-plane --certificate-key 9a2e86718fceba001c96e503e9df47db3a645d4917bf783decaea9c5d0a726ed Please note that the certificate-key gives access to cluster sensitive data, keep it secret! As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use \"kubeadm init phase upload-certs --upload-certs\" to reload certs afterward. Then you can join any number of worker nodes by running the following on each as root: kubeadm join 192.168.43.182:16443 --token 7t2weq.bjbawausm0jaxury \\ --discovery-token-ca-cert-hash sha256:5257d44118ab035adc5af89dd7d5a24ca4c31c33e1918b3453ea9aa32597121b # æŒ‰ç…§æç¤ºï¼Œå¦‚æœä½ æ˜¯æ™®é€šç”¨æˆ·åœ¨æ“ä½œï¼Œæ‰§è¡Œä¸€ä¸‹ä¸‹é¢å‡ æ¡ mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config # å¦‚æœæ˜¯rootç”¨æˆ·åœ¨æ“ä½œåˆå§‹åŒ–ï¼Œæ‰§è¡Œä¸‹é¢ä¸€æ¡å³å¯ export KUBECONFIG=/etc/kubernetes/admin.conf # æŸ¥çœ‹dockeré•œåƒ,å¯ä»¥çœ‹åˆ°kube..å’Œetcdç­‰é•œåƒ docker images # Tokenè¿‡æœŸåç”Ÿæˆæ–°çš„tokenï¼ˆæ²¡æç¤ºè¿‡æœŸä¸‹é¢ä¸¤æ­¥å°±ä¸ç”¨ç®¡äº†ï¼‰ kubeadm token create --print-join-command # Masteréœ€è¦ç”Ÿæˆ--certificate-key kubeadm init phase upload-certs --upload-certs å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ å…¶ä»–masterèŠ‚ç‚¹åŠ å…¥k8s-master01\n# æ ¹æ®kubeadm initæç¤ºçš„token kubeadm join 192.168.43.182:16443 --token 7t2weq.bjbawausm0jaxury \\ --discovery-token-ca-cert-hash sha256:5257d44118ab035adc5af89dd7d5a24ca4c31c33e1918b3453ea9aa32597121b \\ --control-plane --certificate-key 9a2e86718fceba001c96e503e9df47db3a645d4917bf783decaea9c5d0a726ed nodeèŠ‚ç‚¹åŠ å…¥k8s-master01\n# æ ¹æ®kubeadm initæç¤ºçš„token kubeadm join 192.168.43.182:16443 --token 7t2weq.bjbawausm0jaxury \\ --discovery-token-ca-cert-hash sha256:5257d44118ab035adc5af89dd7d5a24ca4c31c33e1918b3453ea9aa32597121b # master01ä¸ŠæŸ¥çœ‹åŠ å…¥åçš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œå› ä¸ºè¿˜æœªé…ç½®CNIæ’ä»¶ï¼Œæ‰€ä»¥nodeä¹‹é—´é€šä¿¡è¿˜æœªæ‰“é€š [root@k8s-master01 ~]# kubectl get no NAME STATUS ROLES AGE VERSION k8s-master01 NotReady control-plane,master 19m v1.23.0 k8s-master02 NotReady control-plane,master 3m39s v1.23.0 k8s-master03 NotReady control-plane,master 3m35s v1.23.0 k8s-node01 NotReady 2m21s v1.23.0 k8s-node02 NotReady 2m21s v1.23.0 é…ç½®calicoç½‘ç»œ åœ¨k8s-master01èŠ‚ç‚¹ä¸Šæ‰§è¡Œ\nç½‘ç»œæ–¹æ¡ˆä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–(ä¾‹å¦‚ï¼šflannelç­‰)\n# å…ˆæŠŠæ‰€éœ€çš„é…ç½®æ–‡ä»¶ä»GitHubæ‹‰ä¸‹æ¥ git clone https://github.com/deemoprobe/k8s-ha-install.git # åˆ‡æ¢åˆ°1.23åˆ†æ”¯å¹¶è¿›å…¥calicoæ–‡ä»¶å¤¹ cd /root/k8s-ha-install \u0026\u0026 git checkout manual-installation-v1.23.x \u0026\u0026 cd calico/ # æ›¿æ¢ä¸€ä¸‹PODç½‘æ®µ POD_SUBNET=`cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr= | awk -F= '{print $NF}'` sed -i \"s#POD_CIDR#${POD_SUBNET}#g\" calico.yaml # åº”ç”¨calicoæ’ä»¶ kubectl apply -f calico.yaml # é›†ç¾¤èŠ‚ç‚¹å‡å·²å¤„äºReadyçŠ¶æ€ [root@k8s-master01 calico]# kubectl get no NAME STATUS ROLES AGE VERSION k8s-master01 Ready control-plane,master 29m v1.23.0 k8s-master02 Ready control-plane,master 13m v1.23.0 k8s-master03 Ready control-plane,master 13m v1.23.0 k8s-node01 Ready 11m v1.23.0 k8s-node02 Ready 11m v1.23.0 # æŸ¥çœ‹calico Podæ˜¯å¦éƒ½æ­£å¸¸ kubectl get pod -A # å¦‚æœä¸æ­£å¸¸ï¼Œå¯ä»¥æ’æŸ¥ä¸€ä¸‹ï¼Œä¸€èˆ¬æ˜¯é•œåƒæ‹‰å–é—®é¢˜ï¼Œå¤šç­‰å¾…å‡ åˆ†é’Ÿå³å¯ï¼Œä¹Ÿå¯ä»¥æ ¹æ®æŠ¥é”™ç®€å•å¤„ç†ä¸€ä¸‹ kubectl describe pod XXX -n kube-system # æ¯”å¦‚æˆ‘è¿™é‡Œæœ‰ä¸ªpodå¤„äºpendingçŠ¶æ€ï¼ŒæŸ¥çœ‹ä¸€ä¸‹åŸå›  [root@k8s-master01 calico]# kubectl get pod -A NAMESPACE NAME READY STATUS RESTARTS AGE ... kube-system calico-typha-8445487f56-hx8w9 1/1 Running 0 11m kube-system calico-typha-8445487f56-mh6tp 0/1 Pending 0 11m kube-system calico-typha-8445487f56-pxthb 1/1 Running 0 11m ... # å¯ä»¥çœ‹åˆ°æç¤ºè¯´2ä¸ªnodeèŠ‚ç‚¹æ— æ³•æä¾›è¶³é‡çš„podç«¯å£åˆ†é…éœ€æ±‚ï¼Œè€Œä¸”æç¤ºmasterèŠ‚ç‚¹è®¾ç½®äº†æ±¡ç‚¹ [root@k8s-master01 calico]# kubectl describe pod calico-typha-8445487f56-mh6tp -n kube-system ... Events: Type Reason Age From Message ---- ------ ---- ---- ------- Warning FailedScheduling 11m default-scheduler 0/5 nodes are available: 2 node(s) had taint {node.kubernetes.io/not-ready: }, that the pod didn't tolerate, 3 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn't tolerate. Warning FailedScheduling 10m default-scheduler 0/5 nodes are available: 1 node(s) didn't have free ports for the requested pod ports, 1 node(s) had taint {node.kubernetes.io/not-ready: }, that the pod didn't tolerate, 3 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn't tolerate. Warning FailedScheduling 10m default-scheduler 0/5 nodes are available: 2 node(s) didn't have free ports for the requested pod ports, 3 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn't tolerate. Warning FailedScheduling 8m24s (x1 over 9m24s) default-scheduler 0/5 nodes are available: 2 node(s) didn't have free ports for the requested pod ports, 3 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn't tolerate.' # ç¡®è®¤ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªmasterèŠ‚ç‚¹æ‰“ä¸Šäº†ä¸å¯è°ƒåº¦podçš„æ±¡ç‚¹ [root@k8s-master01 calico]# for i in k8s-master01 k8s-master02 k8s-master03;do kubectl describe node $i | grep -i taint;done Taints: node-role.kubernetes.io/master:NoSchedule Taints: node-role.kubernetes.io/master:NoSchedule Taints: node-role.kubernetes.io/master:NoSchedule # ç”±äºæ˜¯ç»ƒä¹ ç¯å¢ƒï¼Œæˆ‘å°±æŠŠä¸å¯è°ƒåº¦çš„æ±¡ç‚¹å–æ¶ˆäº†ï¼Œå¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®æ‰©å®¹nodeå·¥ä½œèŠ‚ç‚¹æ¥å®ç°è¶³é‡çš„ç«¯å£åˆ†é… [root@k8s-master01 calico]# for i in k8s-master01 k8s-master02 k8s-master03;do kubectl taint node $i node-role.kubernetes.io/master:NoSchedule-;done node/k8s-master01 untainted node/k8s-master02 untainted node/k8s-master03 untainted # æ±¡ç‚¹æˆåŠŸå–æ¶ˆ [root@k8s-master01 calico]# for i in k8s-master01 k8s-master02 k8s-master03;do kubectl describe node $i | grep -i taint;done Taints: Taints: Taints: # å†æŸ¥çœ‹åˆšæ‰å¤„äºpendingçš„podå‘ç°å·²ç»å¤„äºrunningçŠ¶æ€äº† [root@k8s-master01 calico]# kubectl get po -A | grep calico-typha-8445487f56-mh6tp kube-system calico-typha-8445487f56-mh6tp 1/1 Running 0 23m éƒ¨ç½²Metrics åœ¨æ–°ç‰ˆçš„Kubernetesä¸­ç³»ç»Ÿèµ„æºçš„é‡‡é›†å‡ä½¿ç”¨Metrics-serverï¼Œå¯ä»¥é€šè¿‡Metricsé‡‡é›†èŠ‚ç‚¹å’ŒPodçš„å†…å­˜ã€ç£ç›˜ã€CPUå’Œç½‘ç»œçš„ä½¿ç”¨ç‡ã€‚\n# å°†Master01èŠ‚ç‚¹çš„front-proxy-ca.crtå¤åˆ¶åˆ°æ‰€æœ‰NodeèŠ‚ç‚¹ [root@k8s-master01 calico]# for i in k8s-node01 k8s-node02;do scp /etc/kubernetes/pki/front-proxy-ca.crt $i:/etc/kubernetes/pki/front-proxy-ca.crt;done front-proxy-ca.crt 100% 1115 593.4KB/s 00:00 front-proxy-ca.crt 100% 1115 1.4MB/s 00:00 # å®‰è£…metrics server [root@k8s-master01 calico]# cd /root/k8s-ha-install/kubeadm-metrics-server [root@k8s-master01 kubeadm-metrics-server]# kubectl apply -f comp.yaml serviceaccount/metrics-server created clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created clusterrole.rbac.authorization.k8s.io/system:metrics-server created rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created service/metrics-server created deployment.apps/metrics-server created apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created # æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ [root@k8s-master01 kubeadm-metrics-server]# kubectl get po -A | grep metrics kube-system metrics-server-5cf8885b66-2nnb6 1/1 Running 0 68s # éƒ¨ç½²åä¾¿å¯ä»¥æŸ¥çœ‹æŒ‡æ ‡äº† [root@k8s-master01 kubeadm-metrics-server]# kubectl top node NAME CPU(cores) CPU% MEMORY(bytes) MEMORY% k8s-master01 177m 8% 1196Mi 64% k8s-master02 153m 7% 1101Mi 58% k8s-master03 163m 8% 1102Mi 58% k8s-node01 88m 4% 848Mi 45% k8s-node02 85m 4% 842Mi 45% [root@k8s-master01 kubeadm-metrics-server]# kubectl top po NAME CPU(cores) MEMORY(bytes) nginx-85b98978db-7mn6r 0m 3Mi éƒ¨ç½²Dashboard Dashboardæ˜¯ä¸€ä¸ªå±•ç¤ºKubernetesé›†ç¾¤èµ„æºå’ŒPodæ—¥å¿—ï¼Œç”šè‡³å¯ä»¥æ‰§è¡Œå®¹å™¨å‘½ä»¤çš„webæ§åˆ¶å°ã€‚\n# ç›´æ¥éƒ¨ç½²å³å¯ [root@k8s-master01 kubeadm-metrics-server]# cd /root/k8s-ha-install/dashboard/ [root@k8s-master01 dashboard]# ls dashboard-user.yaml dashboard.yaml [root@k8s-master01 dashboard]# kubectl apply -f . serviceaccount/admin-user created clusterrolebinding.rbac.authorization.k8s.io/admin-user created namespace/kubernetes-dashboard created serviceaccount/kubernetes-dashboard created service/kubernetes-dashboard created secret/kubernetes-dashboard-certs created secret/kubernetes-dashboard-csrf created secret/kubernetes-dashboard-key-holder created configmap/kubernetes-dashboard-settings created role.rbac.authorization.k8s.io/kubernetes-dashboard created clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created deployment.apps/kubernetes-dashboard created service/dashboard-metrics-scraper created deployment.apps/dashboard-metrics-scraper created # æŸ¥çœ‹dashboardç«¯å£ï¼Œé»˜è®¤æ˜¯NodePortæ¨¡å¼ï¼Œè®¿é—®é›†ç¾¤å†…ä»»æ„èŠ‚ç‚¹çš„31073ç«¯å£å³å¯ [root@k8s-master01 dashboard]# kubectl get svc -owide -A | grep dash kubernetes-dashboard dashboard-metrics-scraper ClusterIP 10.105.172.8 8000/TCP 19m k8s-app=dashboard-metrics-scraper kubernetes-dashboard kubernetes-dashboard NodePort 10.99.148.159 443:31073/TCP 19m k8s-app=kubernetes-dashboard è®¿é—®dashboardï¼šhttps://é›†ç¾¤å†…ä»»æ„èŠ‚ç‚¹IP:31073\nå‘ç°æç¤ºéšç§è®¾ç½®é”™è¯¯çš„é—®é¢˜ï¼Œå¦‚å›¾ï¼š\nåœ¨Chromeæµè§ˆå™¨å¯åŠ¨å‚æ•°åŠ å…¥--test-type --ignore-certificate-errorsï¼Œç„¶åå†è®¿é—®å°±æ²¡æœ‰è¿™ä¸ªå®‰å…¨æç¤ºäº†\n# è·å–ç™»é™†ä»¤ç‰Œï¼ˆtokenï¼‰ [root@k8s-master01 dashboard]# kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}') Name: admin-user-token-mwnfs Namespace: kube-system Labels: Annotations: kubernetes.io/service-account.name: admin-user kubernetes.io/service-account.uid: 29584392-1cbd-4d5c-91af-9dd4703008aa Type: kubernetes.io/service-account-token Data ==== ca.crt: 1099 bytes namespace: 11 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6IjRyZlh6Ukxta0FlajlHREF5ei1mdl8tZmR6ekwteV9fVEIwalQtejRwUk0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLW13bmZzIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiIyOTU4NDM5Mi0xY2JkLTRkNWMtOTFhZi05ZGQ0NzAzMDA4YWEiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.pMBMkLAP2AoymIXJC7H47IPu3avdBWPYSZfvjRME7lEQAnbe-SM-yrTFGPzcsJQC3O9gPDvXgIZ1x1tQUtQhc_333GtDMj_VL9oEZxYiOdd578CnBiFmF0BWVX06pAzONgKbguamMD8XEPAvKt4mnlDUr7WCeQJZf_juXKdl7ZOBtrM5Zae0UQHFG6juKLmFP-XxIgoDVIPhcxeAH1ktOHM9Fk1M831hywL1SL2OLHiN52wGLT4WuYrP2iUbJkNpt2PYitSp3iNuh7rESL4Ur7lmFQkLZa9e5vNMCc1wTwOAWvaW4P5TbxtfI_ng4NK_avquiXJY-67D77G-8WKzWg é›†ç¾¤ä¼˜åŒ–(å¯é€‰) Dockerå¯åœ¨/etc/docker/daemon.jsonè‡ªå®šä¹‰ä¼˜åŒ–é…ç½®ï¼Œæ‰€æœ‰é…ç½®å¯è§ï¼šå®˜æ–¹docker configurationï¼Œdockerå¸¸ç”¨ä¼˜åŒ–é…ç½®è§ä¸‹æ–¹æ³¨é‡Šè¯´æ˜ã€‚\n# ä¼˜åŒ–dockeré…ç½® # /etc/docker/daemon.jsonæ–‡ä»¶ï¼ŒæŒ‰éœ€é…ç½®ï¼Œä¸éœ€è¦å…¨éƒ¨éƒ½ç…§æŠ„ï¼Œä½¿ç”¨æ—¶åˆ é™¤æ³¨é‡Šï¼Œå› ä¸ºJSONæ–‡ä»¶ä¸æ”¯æŒæ³¨é‡Š { \"exec-opts\": [\"native.cgroupdriver=systemd\"], # cgroupsé©±åŠ¨ \"registry-mirrors\": [\"https://ynirk4k5.mirror.aliyuncs.com\"], # é•œåƒåŠ é€Ÿå™¨åœ°å€ \"allow-nondistributable-artifacts\": [], \"api-cors-header\": \"\", \"authorization-plugins\": [], \"bip\": \"\", \"bridge\": \"\", \"cgroup-parent\": \"\", \"cluster-advertise\": \"\", \"cluster-store\": \"\", \"cluster-store-opts\": {}, \"containerd\": \"/run/containerd/containerd.sock\", \"containerd-namespace\": \"docker\", \"data-root\": \"\", # æ•°æ®æ ¹ç›®å½•ï¼Œå¤§é‡dockeré•œåƒå¯èƒ½ä¼šå ç”¨è¾ƒå¤§å­˜å‚¨ï¼Œå¯ä»¥è®¾ç½®ç³»ç»Ÿç›˜å¤–çš„æŒ‚è½½ç›˜ \"debug\": true, \"default-address-pools\": [ { \"base\": \"172.30.0.0/16\", \"size\": 24 }, { \"base\": \"172.31.0.0/16\", \"size\": 24 } ], \"default-cgroupns-mode\": \"private\", \"default-gateway\": \"\", \"default-gateway-v6\": \"\", \"default-runtime\": \"runc\", \"default-shm-size\": \"64M\", \"default-ulimits\": { \"nofile\": { \"Hard\": 64000, \"Name\": \"nofile\", \"Soft\": 64000 } }, \"dns\": [], \"dns-opts\": [], \"dns-search\": [], \"exec-root\": \"\", \"experimental\": false, \"features\": {}, \"fixed-cidr\": \"\", \"fixed-cidr-v6\": \"\", \"group\": \"\", \"hosts\": [], \"icc\": false, \"init\": false, \"init-path\": \"/usr/libexec/docker-init\", \"insecure-registries\": [], \"ip\": \"0.0.0.0\", \"ip-forward\": false, \"ip-masq\": false, \"iptables\": false, \"ip6tables\": false, \"ipv6\": false, \"labels\": [], \"live-restore\": true, # dockerè¿›ç¨‹å®•æœºæ—¶å®¹å™¨ä¾ç„¶ä¿æŒå­˜æ´» \"log-driver\": \"json-file\", # æ—¥å¿—æ ¼å¼ \"log-level\": \"\", # æ—¥å¿—çº§åˆ« \"log-opts\": { # æ—¥å¿—ä¼˜åŒ– \"cache-disabled\": \"false\", \"cache-max-file\": \"5\", \"cache-max-size\": \"20m\", \"cache-compress\": \"true\", \"env\": \"os,customer\", \"labels\": \"somelabel\", \"max-file\": \"5\", # æœ€å¤§æ—¥å¿—æ•°é‡ \"max-size\": \"10m\" # ä¿å­˜çš„æœ€å¤§æ—¥å¿—å¤§å° }, \"max-concurrent-downloads\": 3, # pullä¸‹è½½å¹¶å‘æ•° \"max-concurrent-uploads\": 5, # pushä¸Šä¼ å¹¶å‘æ•° \"max-download-attempts\": 5, \"mtu\": 0, \"no-new-privileges\": false, \"node-generic-resources\": [ \"NVIDIA-GPU=UUID1\", \"NVIDIA-GPU=UUID2\" ], \"oom-score-adjust\": -500, \"pidfile\": \"\", \"raw-logs\": false, \"runtimes\": { \"cc-runtime\": { \"path\": \"/usr/bin/cc-runtime\" }, \"custom\": { \"path\": \"/usr/local/bin/my-runc-replacement\", \"runtimeArgs\": [ \"--debug\" ] } }, \"seccomp-profile\": \"\", \"selinux-enabled\": false, \"shutdown-timeout\": 15, \"storage-driver\": \"\", \"storage-opts\": [], \"swarm-default-advertise-addr\": \"\", \"tls\": true, \"tlscacert\": \"\", \"tlscert\": \"\", \"tlskey\": \"\", \"tlsverify\": true, \"userland-proxy\": false, \"userland-proxy-path\": \"/usr/libexec/docker-proxy\", \"userns-remap\": \"\" } # æ— æ³¨é‡Šç‰ˆ { \"exec-opts\": [\"native.cgroupdriver=systemd\"], \"registry-mirrors\": [\"https://ynirk4k5.mirror.aliyuncs.com\"], \"containerd-namespace\": \"docker\", \"data-root\": \"\", \"debug\": true, \"default-cgroupns-mode\": \"private\", \"default-gateway\": \"\", \"default-gateway-v6\": \"\", \"default-runtime\": \"runc\", \"default-shm-size\": \"64M\", \"default-ulimits\": { \"nofile\": { \"Hard\": 64000, \"Name\": \"nofile\", \"Soft\": 64000 } }, \"init-path\": \"/usr/libexec/docker-init\", \"live-restore\": true, \"log-driver\": \"json-file\", \"log-level\": \"\", \"log-opts\": { \"cache-disabled\": \"false\", \"cache-max-file\": \"5\", \"cache-max-size\": \"20m\", \"cache-compress\": \"true\", \"env\": \"os,customer\", \"labels\": \"somelabel\", \"max-file\": \"5\", \"max-size\": \"10m\" }, \"max-concurrent-downloads\": 3, \"max-concurrent-uploads\": 5, \"max-download-attempts\": 5, \"mtu\": 0, \"no-new-privileges\": false, \"oom-score-adjust\": -500, \"pidfile\": \"\", \"raw-logs\": false, \"runtimes\": { \"cc-runtime\": { \"path\": \"/usr/bin/cc-runtime\" }, \"custom\": { \"path\": \"/usr/local/bin/my-runc-replacement\", \"runtimeArgs\": [ \"--debug\" ] } }, \"seccomp-profile\": \"\", \"selinux-enabled\": false, \"shutdown-timeout\": 15, \"storage-driver\": \"\", \"storage-opts\": [], \"swarm-default-advertise-addr\": \"\", \"userland-proxy-path\": \"/usr/libexec/docker-proxy\", \"userns-remap\": \"\" } # è®¾ç½®è¯ä¹¦æœ‰æ•ˆæœŸ [root@k8s-master01 ~]# vim /usr/lib/systemd/system/kube-controller-manager.service ... # åŠ å…¥ä¸‹é¢é…ç½® --experimental-cluster-signing-duration=876000h0m0s ... [root@k8s-master01 ~]# systemctl daemon-reload [root@k8s-master01 ~]# systemctl restart kube-controller-manager # kubeletä¼˜åŒ–åŠ å¯†ç®—æ³•ï¼Œé»˜è®¤çš„ç®—æ³•å®¹æ˜“è¢«æ¼æ´æ‰«æï¼›å¢é•¿é•œåƒä¸‹è½½å‘¨æœŸï¼Œé¿å…æœ‰äº›å¤§é•œåƒæœªä¸‹è½½å®Œæˆå°±è¢«åŠ¨æ­»äº¡é€€å‡º # --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 # --image-pull-progress-deadline=30m [root@k8s-master01 ~]# vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf ... # ä¸‹é¢è¿™è¡Œä¸­KUBELET_EXTRA_ARGS=ååŠ å…¥é…ç½® Environment=\"KUBELET_EXTRA_ARGS=--tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 --image-pull-progress-deadline=30m\" ... # é›†ç¾¤é…ç½®ä¼˜åŒ–ï¼Œè¯¦è§https://kubernetes.io/zh/docs/tasks/administer-cluster/reserve-compute-resources/ [root@k8s-master01 ~]# vim /etc/kubernetes/kubelet-conf.yml # æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½® rotateServerCertificates: true allowedUnsafeSysctls: # å…è®¸åœ¨ä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œæ­¤æ“ä½œæŒ‰æƒ…å†µé€‰æ‹©ï¼Œç”¨ä¸åˆ°å°±ä¸ç”¨è®¾ç½® - \"net.core*\" - \"net.ipv4.*\" kubeReserved: # ä¸ºKubernetesé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹ç»„ä»¶é¢„ç•™èµ„æºï¼Œä¾‹å¦‚ï¼škubeletã€Runtimeç­‰ cpu: \"100m\" memory: 100Mi ephemeral-storage: 1Gi systemReserved: # ä¸ºç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹é¢„ç•™èµ„æºï¼Œä¾‹å¦‚ï¼šsshdã€cronç­‰ cpu: \"100m\" memory: 100Mi ephemeral-storage: 1Gi # æ›´æ”¹kube-proxyæ¨¡å¼ä¸ºipvs [root@k8s-master01 dashboard]# kubectl edit cm kube-proxy -n kube-system mode: \"ipvs\" # æ›´æ–°kube-proxyçš„pod [root@k8s-master01 dashboard]# kubectl patch daemonset kube-proxy -p \"{\\\"spec\\\":{\\\"template\\\":{\\\"metadata\\\":{\\\"annotations\\\":{\\\"date\\\":\\\"`date +'%s'`\\\"}}}}}\" -n kube-system daemonset.apps/kube-proxy patched # éªŒè¯ [root@k8s-master01 dashboard]# curl 127.0.0.1:10249/proxyMode ipvs # ä¸ºé›†ç¾¤èŠ‚ç‚¹æ‰“æ ‡ç­¾ï¼Œåˆ é™¤æ ‡ç­¾æŠŠ = æ¢æˆ - å³å¯ kubectl label nodes k8s-node01 node-role.kubernetes.io/node= kubectl label nodes k8s-node02 node-role.kubernetes.io/node= kubectl label nodes k8s-master01 node-role.kubernetes.io/master= kubectl label nodes k8s-master02 node-role.kubernetes.io/master= kubectl label nodes k8s-master03 node-role.kubernetes.io/master= # æ·»åŠ æ ‡ç­¾åæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ [root@k8s-master01 ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master01 Ready master 100m v1.23.0 k8s-master02 Ready master 100m v1.23.0 k8s-master03 Ready master 100m v1.23.0 k8s-node01 Ready node 100m v1.23.0 k8s-node02 Ready node 100m v1.23.0 ç”Ÿäº§ç¯å¢ƒå»ºè®®ETCDé›†ç¾¤å’ŒKubernetesé›†ç¾¤åˆ†ç¦»ï¼Œè€Œä¸”ä½¿ç”¨é«˜æ€§èƒ½æ•°æ®ç›˜å­˜å‚¨æ•°æ®ï¼Œæ ¹æ®æƒ…å†µå†³å®šæ˜¯å¦å°†MasterèŠ‚ç‚¹ä¹Ÿä½œä¸ºPodè°ƒåº¦èŠ‚ç‚¹ã€‚\næµ‹è¯•é›†ç¾¤ # æµ‹è¯•namespace kubectl get namespace kubectl create namespace test kubectl get namespace kubectl delete namespace test # åˆ›å»ºnginxå®ä¾‹å¹¶å¼€æ”¾ç«¯å£ kubectl create deployment nginx --image=nginx kubectl expose deployment nginx --port=80 --type=NodePort # æŸ¥çœ‹è°ƒåº¦çŠ¶æ€å’Œç«¯å£å· [root@k8s-master01 calico]# kubectl get pod,svc -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/nginx-85b98978db-7mn6r 1/1 Running 0 2m16s 172.27.14.193 k8s-master02 NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR service/kubernetes ClusterIP 10.96.0.1 443/TCP 59m service/nginx NodePort 10.104.33.99 80:31720/TCP 2m6s app=nginx å¯è§è°ƒåº¦åˆ°äº†k8s-master02ï¼ˆIPåœ°å€æ˜¯192.168.43.184ï¼‰ä¸Šï¼Œå¯¹åº”çš„NodePortä¸º31720\nåœ¨æµè§ˆå™¨è¾“å…¥http://192.168.43.184:31720/ è®¿é—®nginxï¼Œè®¿é—®ç»“æœå¦‚å›¾\nè‡³æ­¤ï¼ŒåŸºäºkubeadmçš„Kubernetesé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²å¹¶éªŒè¯æˆåŠŸã€‚\n",
  "wordCount" : "7824",
  "inLanguage": "en",
  "image":"https://deemoprobe.github.io/img/kubernetes.png","datePublished": "2023-04-29T14:12:14+08:00",
  "dateModified": "2023-04-29T14:12:14+08:00",
  "author":[{
    "@type": "Person",
    "name": "deemoprobe"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://deemoprobe.github.io/posts/tech/kubernetes/kuberneteskubeadminstallation-ha/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "William's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://deemoprobe.github.io/img/favicon/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://deemoprobe.github.io/" accesskey="h" title="Background (Alt + H)">Background</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://deemoprobe.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tags" title="ğŸ¨ æ ‡ç­¾">
                <span>ğŸ¨ æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/archives/" title="ğŸ“ˆ å½’æ¡£">
                <span>ğŸ“ˆ å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tools" title="ğŸª å·¥å…·">
                <span>ğŸª å·¥å…·</span>
                </a>
            </li>
            <li>
                <a href="https://wangchujiang.com/linux-command/" title="ğŸ§ å‘½ä»¤">
                <span>ğŸ§ å‘½ä»¤</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            
            <h1 class="post-title">
                KubernetesKubeadmInstallation HA
            </h1>
            <div class="post-description">
                kubeadmæ–¹å¼éƒ¨ç½²kubernetesé«˜å¯ç”¨é›†ç¾¤
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-04-29
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>7824å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>16åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>deemoprobe
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://deemoprobe.github.io/tags/kubernetes/" style="color: var(--secondary)!important;">kubernetes</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="https://deemoprobe.github.io/img/kubernetes.png" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e8%af%b4%e6%98%8e" aria-label="ç¯å¢ƒè¯´æ˜">ç¯å¢ƒè¯´æ˜</a></li>
                <li>
                    <a href="#%e8%b5%84%e6%ba%90%e5%88%86%e9%85%8d" aria-label="èµ„æºåˆ†é…">èµ„æºåˆ†é…</a><ul>
                        
                <li>
                    <a href="#%e7%bd%91%e6%ae%b5%e5%88%92%e5%88%86" aria-label="ç½‘æ®µåˆ’åˆ†">ç½‘æ®µåˆ’åˆ†</a></li>
                <li>
                    <a href="#%e8%8a%82%e7%82%b9%e5%88%86%e9%85%8d" aria-label="èŠ‚ç‚¹åˆ†é…">èŠ‚ç‚¹åˆ†é…</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%93%8d%e4%bd%9c%e6%ad%a5%e9%aa%a4" aria-label="æ“ä½œæ­¥éª¤">æ“ä½œæ­¥éª¤</a><ul>
                        
                <li>
                    <a href="#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9call" aria-label="å‡†å¤‡å·¥ä½œ(ALL)">å‡†å¤‡å·¥ä½œ(ALL)</a></li>
                <li>
                    <a href="#%e5%bf%85%e8%a6%81%e6%93%8d%e4%bd%9call" aria-label="å¿…è¦æ“ä½œ(ALL)">å¿…è¦æ“ä½œ(ALL)</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2dockerall" aria-label="éƒ¨ç½²Docker(ALL)">éƒ¨ç½²Docker(ALL)</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85kubernetesall" aria-label="å®‰è£…kubernetes(ALL)">å®‰è£…kubernetes(ALL)</a></li>
                <li>
                    <a href="#%e9%ab%98%e5%8f%af%e7%94%a8%e7%bb%84%e4%bb%b6%e5%ae%89%e8%a3%85master" aria-label="é«˜å¯ç”¨ç»„ä»¶å®‰è£…(Master)">é«˜å¯ç”¨ç»„ä»¶å®‰è£…(Master)</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2k8s-masterk8s-master01" aria-label="éƒ¨ç½²k8s-master(k8s-master01)">éƒ¨ç½²k8s-master(k8s-master01)</a></li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e8%8a%82%e7%82%b9%e5%8a%a0%e5%85%a5%e9%9b%86%e7%be%a4" aria-label="å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤">å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aecalico%e7%bd%91%e7%bb%9c" aria-label="é…ç½®calicoç½‘ç»œ">é…ç½®calicoç½‘ç»œ</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2metrics" aria-label="éƒ¨ç½²Metrics">éƒ¨ç½²Metrics</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2dashboard" aria-label="éƒ¨ç½²Dashboard">éƒ¨ç½²Dashboard</a></li>
                <li>
                    <a href="#%e9%9b%86%e7%be%a4%e4%bc%98%e5%8c%96%e5%8f%af%e9%80%89" aria-label="é›†ç¾¤ä¼˜åŒ–(å¯é€‰)">é›†ç¾¤ä¼˜åŒ–(å¯é€‰)</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e9%9b%86%e7%be%a4" aria-label="æµ‹è¯•é›†ç¾¤">æµ‹è¯•é›†ç¾¤</a>
                </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h2 id="ç¯å¢ƒè¯´æ˜">ç¯å¢ƒè¯´æ˜<a hidden class="anchor" aria-hidden="true" href="#ç¯å¢ƒè¯´æ˜">#</a></h2>
<ul>
<li>å®¿ä¸»æœºç³»ç»Ÿï¼šWindows 10</li>
<li>è™šæ‹Ÿæœºç‰ˆæœ¬ï¼šVMwareÂ® Workstation 16 Pro</li>
<li>IOSé•œåƒç‰ˆæœ¬ï¼šCentOS Linux release 7.9.2009</li>
<li>é›†ç¾¤æ“ä½œç”¨æˆ·ï¼šroot</li>
<li>Kubernetesç‰ˆæœ¬ï¼š1.23.0</li>
<li>Etcdç‰ˆæœ¬ï¼š3.5.1</li>
<li>Runtimeï¼šDocker 20.10</li>
</ul>
<p>CentOS7å®‰è£…è¯·å‚è€ƒåšå®¢æ–‡ç« ï¼š<a href="https://www.deemo.dev/linux/centos7install/"  target="_blank" rel="noopener" style="color:#42b983" ;>LINUXä¹‹VMWARE WORKSTATIONå®‰è£…CENTOS-7</a></p>
<h2 id="èµ„æºåˆ†é…">èµ„æºåˆ†é…<a hidden class="anchor" aria-hidden="true" href="#èµ„æºåˆ†é…">#</a></h2>
<h3 id="ç½‘æ®µåˆ’åˆ†">ç½‘æ®µåˆ’åˆ†<a hidden class="anchor" aria-hidden="true" href="#ç½‘æ®µåˆ’åˆ†">#</a></h3>
<p>Kubernetesé›†ç¾¤éœ€è¦è§„åˆ’ä¸‰ä¸ªç½‘æ®µï¼š</p>
<ul>
<li>å®¿ä¸»æœºç½‘æ®µï¼šKubernetesé›†ç¾¤èŠ‚ç‚¹çš„ç½‘æ®µ</li>
<li>Podç½‘æ®µï¼šé›†ç¾¤å†…Podçš„ç½‘æ®µï¼Œç›¸å½“äºå®¹å™¨çš„IP</li>
<li>Serviceç½‘æ®µï¼šé›†ç¾¤å†…æœåŠ¡å‘ç°ä½¿ç”¨çš„ç½‘æ®µï¼Œserviceç”¨äºé›†ç¾¤å®¹å™¨é€šä¿¡</li>
</ul>
<p>ç”Ÿäº§ç¯å¢ƒæ ¹æ®ç”³è¯·åˆ°çš„IPèµ„æºè¿›è¡Œåˆ†é…å³å¯ï¼ŒåŸåˆ™æ˜¯ä¸‰ä¸ªç½‘æ®µä¸å…è®¸æœ‰é‡åˆIPã€‚IPç½‘æ®µè®¡ç®—å¯ä»¥å‚è€ƒï¼š<a href="http://tools.jb51.net/aideddesign/ip_net_calc/"  target="_blank" rel="noopener" style="color:#42b983" ;>åœ¨çº¿IPåœ°å€è®¡ç®—</a>ã€‚æœ¬æ–‡è™šæ‹Ÿæœºç»ƒä¹ ç¯å¢ƒIPåœ°å€ç½‘æ®µåˆ†é…å¦‚ä¸‹ï¼š</p>
<ul>
<li>å®¿ä¸»æœºç½‘æ®µï¼š<code>192.168.43.1/24</code></li>
<li>Podç½‘æ®µï¼š<code>172.16.0.0/12</code></li>
<li>Serviceï¼š<code>10.96.0.0/12</code></li>
</ul>
<h3 id="èŠ‚ç‚¹åˆ†é…">èŠ‚ç‚¹åˆ†é…<a hidden class="anchor" aria-hidden="true" href="#èŠ‚ç‚¹åˆ†é…">#</a></h3>
<p>é‡‡ç”¨<code>3ç®¡ç†èŠ‚ç‚¹2å·¥ä½œèŠ‚ç‚¹</code>çš„é«˜å¯ç”¨Kubernetesé›†ç¾¤æ¨¡å¼ï¼š</p>
<ul>
<li>k8s-master01/k8s-master02/k8s-master03 é›†ç¾¤çš„MasterèŠ‚ç‚¹</li>
<li>ä¸‰ä¸ªmasterèŠ‚ç‚¹åŒæ—¶åšetcdé›†ç¾¤</li>
<li>k8s-node01/k8s-node02 é›†ç¾¤çš„NodeèŠ‚ç‚¹</li>
<li>k8s-master-vipåšé«˜å¯ç”¨k8s-master01~03çš„VIPï¼Œä¸å ç”¨ç‰©ç†èµ„æº</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">ä¸»æœºèŠ‚ç‚¹åç§°</th>
<th style="text-align:center">IP</th>
<th style="text-align:center">CPUæ ¸å¿ƒæ•°</th>
<th style="text-align:center">å†…å­˜å¤§å°</th>
<th style="text-align:center">ç£ç›˜å¤§å°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">k8s-master-vip</td>
<td style="text-align:center">192.168.43.182</td>
<td style="text-align:center">/</td>
<td style="text-align:center">/</td>
<td style="text-align:center">/</td>
</tr>
<tr>
<td style="text-align:left">k8s-master01</td>
<td style="text-align:center">192.168.43.183</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-master02</td>
<td style="text-align:center">192.168.43.184</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-master03</td>
<td style="text-align:center">192.168.43.185</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-node01</td>
<td style="text-align:center">192.168.43.186</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-node02</td>
<td style="text-align:center">192.168.43.187</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
</tbody>
</table>
<h2 id="æ“ä½œæ­¥éª¤">æ“ä½œæ­¥éª¤<a hidden class="anchor" aria-hidden="true" href="#æ“ä½œæ­¥éª¤">#</a></h2>
<p>æ ‡é¢˜åå°æ‹¬å·æ³¨é‡Šè¡¨æ˜æ“ä½œèŒƒå›´ï¼š</p>
<ul>
<li>ALL æ‰€æœ‰èŠ‚ç‚¹ï¼ˆk8s-master01/k8s-master02/k8s-master03/k8s-node01/k9s-node02ï¼‰æ‰§è¡Œ</li>
<li>Master åªéœ€è¦åœ¨masterèŠ‚ç‚¹ï¼ˆk8s-master01/k8s-master02/k8s-master03ï¼‰æ‰§è¡Œ</li>
<li>Node åªéœ€è¦åœ¨nodeèŠ‚ç‚¹ï¼ˆk8s-node01/k8s-node02ï¼‰æ‰§è¡Œ</li>
<li>å·²æ ‡æ³¨çš„ä¸ªåˆ«å‘½ä»¤åªéœ€è¦åœ¨æŸä¸€å°æœºå™¨æ‰§è¡Œï¼Œä¼šåœ¨æ“ä½œå‰è¯´æ˜</li>
<li>æœªæ ‡æ³¨çš„ä¼šåœ¨æ“ä½œæ—¶è¯´æ˜</li>
</ul>
<p>ä½¿ç”¨<code>cat &lt;&lt; &quot;EOF&quot; &gt;&gt; file</code>æˆ–<code>cat &gt;&gt; file &lt;&lt; &quot;EOF&quot;</code>æ·»åŠ æ–‡ä»¶å†…å®¹æ³¨æ„catåé¢çš„EOFä¸€å®šè¦åŠ ä¸ŠåŒå¼•å·ï¼ˆæ ‡å‡†è¾“å…¥çš„ï¼‰ï¼Œå¦åˆ™ä¸ä¼šä¿ç•™è¾“å…¥æ—¶çš„ç¼©è¿›æ ¼å¼è€Œä¸”ä¼šç›´æ¥è§£æè¾“å…¥æ—¶çš„å˜é‡ï¼Œè¿›è€Œé€ æˆæ–‡ä»¶å¯è¯»æ€§å·®ç”šè‡³ä¸å¯ç”¨ï¼›åŒæ—¶æ³¨æ„æ–‡ä»¶çš„<code>&gt;</code>é‡å†™ä¸<code>&gt;&gt;</code>è¿½åŠ ã€‚è™½ç„¶å•ç‹¬è½¬ä¹‰è¾“å…¥æ—¶çš„å˜é‡ä¹Ÿèƒ½é¿å…å˜é‡è¢«è§£æï¼Œä½†æ˜¯ä¸æ¨èï¼Œæ¼è½¬ä¹‰ä¼šé€ æˆä¸å¿…è¦çš„éº»çƒ¦ã€‚</p>
<h3 id="å‡†å¤‡å·¥ä½œall">å‡†å¤‡å·¥ä½œ(ALL)<a hidden class="anchor" aria-hidden="true" href="#å‡†å¤‡å·¥ä½œall">#</a></h3>
<p>æ·»åŠ ä¸»æœºä¿¡æ¯ã€å…³é—­é˜²ç«å¢™ã€å…³é—­swapã€å…³é—­SELinuxã€dnsmasqã€NetworkManager</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æ·»åŠ ä¸»æœºä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;&gt; /etc/hosts
</span></span><span style="display:flex;"><span>192.168.43.182    k8s-master-vip
</span></span><span style="display:flex;"><span>192.168.43.183    k8s-master01
</span></span><span style="display:flex;"><span>192.168.43.184    k8s-master02
</span></span><span style="display:flex;"><span>192.168.43.185    k8s-master03
</span></span><span style="display:flex;"><span>192.168.43.186    k8s-node01
</span></span><span style="display:flex;"><span>192.168.43.187    k8s-node02
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…³é—­é˜²ç«å¢™ã€dnsmasqã€NetworkManagerï¼Œ--nowå‚æ•°è¡¨ç¤ºå…³é—­æœåŠ¡å¹¶ç§»é™¤å¼€æœºè‡ªå¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿™äº›æœåŠ¡æ˜¯å¦å¯ä»¥å…³é—­è§†æƒ…å†µè€Œå®šï¼Œæœ¬æ–‡æ˜¯è™šæ‹Ÿæœºå®è·µï¼Œæ²¡æœ‰ç”¨åˆ°è¿™äº›æœåŠ¡</span>
</span></span><span style="display:flex;"><span>systemctl disable --now firewalld
</span></span><span style="display:flex;"><span>systemctl disable --now dnsmasq
</span></span><span style="display:flex;"><span>systemctl disable --now NetworkManager
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…³é—­swapï¼Œå¹¶æ³¨é‡Šfstabæ–‡ä»¶swapæ‰€åœ¨è¡Œ</span>
</span></span><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;/swap/s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…³é—­SELinuxï¼Œå¹¶æ›´æ”¹selinuxé…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>setenforce <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s/=enforcing/=disabled/g&#34;</span> /etc/selinux/config
</span></span></code></pre></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯<code>/etc/sysconfig/selinux</code>æ–‡ä»¶æ˜¯<code>/etc/selinux/config</code>æ–‡ä»¶çš„è½¯è¿æ¥ï¼Œç”¨<code>sed -i</code>å‘½ä»¤ä¿®æ”¹è½¯è¿æ¥æ–‡ä»¶ä¼šç ´åè½¯è¿æ¥å±æ€§ï¼Œå°†<code>/etc/sysconfig/selinux</code>å˜ä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼Œå³ä½¿è¯¥æ–‡ä»¶è¢«ä¿®æ”¹äº†ï¼Œä½†æºæ–‡ä»¶<code>/etc/selinux/config</code>é…ç½®æ˜¯æ²¡å˜çš„ã€‚æ­¤å¤–ï¼Œä½¿ç”¨vimç­‰ç¼–è¾‘å™¨ç¼–è¾‘æºæ–‡ä»¶æˆ–é“¾æ¥æ–‡ä»¶ï¼ˆç¼–è¾‘æ¨¡å¼ä¸ä¼šä¿®æ”¹æ–‡ä»¶å±æ€§ï¼‰ä¿®æ”¹ä¹Ÿå¯ä»¥ã€‚è½¯é“¾æ¥åŸç†å¯å‚è€ƒåšå®¢ï¼š<a href="http://www.deemoprobe.com/yunv/inode/"  target="_blank" rel="noopener" style="color:#42b983" ;>LINUXä¹‹INODEè¯¦è§£</a></p>
<h3 id="å¿…è¦æ“ä½œall">å¿…è¦æ“ä½œ(ALL)<a hidden class="anchor" aria-hidden="true" href="#å¿…è¦æ“ä½œall">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># é»˜è®¤çš„yumæºå¤ªæ…¢ï¼Œæ›´æ–°ä¸ºé˜¿é‡Œæºï¼ŒåŒæ—¶ç”¨sedå‘½ä»¤åˆ é™¤æ–‡ä»¶ä¸­ä¸éœ€è¦çš„ä¸¤ä¸ªURLçš„è¡Œ</span>
</span></span><span style="display:flex;"><span>curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
</span></span><span style="display:flex;"><span>sed -i -e <span style="color:#e6db74">&#39;/mirrors.cloud.aliyuncs.com/d&#39;</span> -e <span style="color:#e6db74">&#39;/mirrors.aliyuncs.com/d&#39;</span> /etc/yum.repos.d/CentOS-Base.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…å¸¸ç”¨å·¥å…·åŒ…</span>
</span></span><span style="display:flex;"><span>yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®é˜¿é‡ŒKubernetesæºï¼Œå¦‚æœæç¤ºgpgæ–‡ä»¶æœ‰é—®é¢˜ï¼Œå¯ä»¥æ”¹ä¸ºgpgcheck=0ï¼Œå¹¶æŠŠåä¸‰è¡Œåˆ é™¤ï¼ˆä»…é™æµ‹è¯•ç¯å¢ƒä½¿ç”¨ï¼‰</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®ntpdateï¼ŒåŒæ­¥æœåŠ¡å™¨æ—¶é—´</span>
</span></span><span style="display:flex;"><span>rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm
</span></span><span style="display:flex;"><span>yum install ntpdate -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŒæ­¥æ—¶åŒºå’Œæ—¶é—´</span>
</span></span><span style="display:flex;"><span>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span> &gt;/etc/timezone
</span></span><span style="display:flex;"><span>ntpdate time2.aliyun.com
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥åŠ å…¥è®¡åˆ’ä»»åŠ¡ï¼Œä¿è¯é›†ç¾¤æ—¶é’Ÿæ˜¯ä¸€è‡´çš„</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /var/spool/cron/rootæ–‡ä»¶ä¹Ÿæ˜¯crontab -eå†™å…¥çš„æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># crontabæ‰§è¡Œæ—¥å¿—æŸ¥çœ‹å¯ç”¨ï¼štail -f /var/log/cron</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;&gt; /var/spool/cron/root
</span></span><span style="display:flex;"><span>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿è¯æ–‡ä»¶å¥æŸ„ä¸ä¼šé™åˆ¶é›†ç¾¤çš„å¯æŒç»­å‘å±•ï¼Œé…ç½®limits</span>
</span></span><span style="display:flex;"><span>ulimit -SHn <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;&gt; /etc/security/limits.conf
</span></span><span style="display:flex;"><span>* soft nofile <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* hard nofile <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* soft nproc <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* hard nproc <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* soft memlock unlimited
</span></span><span style="display:flex;"><span>* hard memlock unlimited
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®å…å¯†ç™»å½•ï¼Œk8s-master01åˆ°å…¶ä»–èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆå¯†é’¥å¯¹ï¼ˆåœ¨k8s-master01èŠ‚ç‚¹é…ç½®å³å¯ï¼‰</span>
</span></span><span style="display:flex;"><span>ssh-keygen -t rsa
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‹·è´å…¬é’¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œé¦–æ¬¡éœ€è¦è®¤è¯ä¸€ä¸‹å„ä¸ªèŠ‚ç‚¹çš„rootå¯†ç ï¼Œä»¥åå°±å¯ä»¥å…å¯†sshåˆ°å…¶ä»–èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span style="color:#66d9ef">do</span> ssh-copy-id -i .ssh/id_rsa.pub $i;<span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…‹éš†äºŒè¿›åˆ¶ä»“åº“æ–‡ä»¶ï¼ˆk8s-master01ä¸Šæ“ä½œå³å¯ï¼‰</span>
</span></span><span style="display:flex;"><span>cd root;git clone https://gitee.com/deemoprobe/k8s-ha-install.git
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cd k8s-ha-install;git branch -a
</span></span><span style="display:flex;"><span>* master
</span></span><span style="display:flex;"><span>  remotes/origin/HEAD -&gt; origin/master
</span></span><span style="display:flex;"><span>  remotes/origin/manual-installation
</span></span><span style="display:flex;"><span>  remotes/origin/manual-installation-v1.16.x
</span></span><span style="display:flex;"><span>  remotes/origin/manual-installation-v1.17.x
</span></span><span style="display:flex;"><span>  remotes/origin/manual-installation-v1.18.x
</span></span><span style="display:flex;"><span>  remotes/origin/manual-installation-v1.19.x
</span></span><span style="display:flex;"><span>  remotes/origin/manual-installation-v1.20.x
</span></span><span style="display:flex;"><span>  remotes/origin/manual-installation-v1.20.x-csi-hostpath
</span></span><span style="display:flex;"><span>  remotes/origin/manual-installation-v1.21.x
</span></span><span style="display:flex;"><span>  remotes/origin/manual-installation-v1.22.x
</span></span><span style="display:flex;"><span>  remotes/origin/manual-installation-v1.23.x
</span></span><span style="display:flex;"><span>  remotes/origin/master
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥åˆ‡æ¢åˆ°éœ€è¦ç‰ˆæœ¬çš„åˆ†æ”¯ä¸­è·å–é…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>git checkout manual-installation-v1.22.x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹ç³»ç»Ÿå‡çº§</span>
</span></span><span style="display:flex;"><span>yum update --exclude<span style="color:#f92672">=</span>kernel* -y
</span></span></code></pre></div><p>å‡çº§å†…æ ¸ï¼Œ4.17ä»¥ä¸‹çš„å†…æ ¸cgroupå­˜åœ¨å†…å­˜æ³„æ¼çš„BUGï¼Œå…·ä½“åˆ†æè¿‡ç¨‹æµè§ˆå™¨æœ<code>Kubernetesé›†ç¾¤ä¸ºä»€ä¹ˆè¦å‡çº§å†…æ ¸</code>ä¼šæœ‰å¾ˆå¤šæ–‡ç« è®²è§£</p>
<p>å†…æ ¸å¤‡ç”¨ä¸‹è½½ï¼ˆå»ºè®®ä¸‹è½½åˆ°æœ¬åœ°åä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå°½é‡ä¸ç”¨<code>wget</code>ï¼‰ï¼š</p>
<ul>
<li><a href="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/repo/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm?versionId=CAEQNBiBgMDJiNbj.hciIDUyMDZlYjU5YzIwMzQ0MmNhNzBmNjBiMDY3Yjc0Y2Jl"  target="_blank" rel="noopener" style="color:#42b983" ;>kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm</a></li>
<li><a href="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/repo/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm?versionId=CAEQNBiBgMDNiNbj.hciIGQ0M2RmZDAwNDhlNjQyNjE5MTE4MDk1OGU4OThiNWY4"  target="_blank" rel="noopener" style="color:#42b983" ;>kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ä¸‹è½½4.19ç‰ˆæœ¬å†…æ ¸ï¼Œå¦‚æœæ— æ³•ä¸‹è½½ï¼Œå¯ä»¥ç”¨ä¸Šé¢æä¾›çš„å¤‡ç”¨ä¸‹è½½</span>
</span></span><span style="display:flex;"><span>cd /root
</span></span><span style="display:flex;"><span>wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm
</span></span><span style="display:flex;"><span>wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥åœ¨k8s-master01èŠ‚ç‚¹ä¸‹è½½åï¼Œå…å¯†ä¼ åˆ°å…¶ä»–èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span style="color:#66d9ef">do</span> scp kernel-ml-* $i:/root;<span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹å®‰è£…å†…æ ¸</span>
</span></span><span style="display:flex;"><span>cd /root <span style="color:#f92672">&amp;&amp;</span> yum localinstall -y kernel-ml*
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰èŠ‚ç‚¹æ›´æ”¹å†…æ ¸å¯åŠ¨é¡ºåº</span>
</span></span><span style="display:flex;"><span>grub2-set-default  <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> grub2-mkconfig -o /etc/grub2.cfg
</span></span><span style="display:flex;"><span>grubby --args<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user_namespace.enable=1&#34;</span> --update-kernel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>grubby --default-kernel<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹é»˜è®¤å†…æ ¸ï¼Œå¹¶é‡å¯èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>grubby --default-kernel
</span></span><span style="display:flex;"><span>reboot
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¡®è®¤å†…æ ¸ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>uname -a
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ï¼ˆå¯é€‰ï¼‰åˆ é™¤è€ç‰ˆæœ¬çš„å†…æ ¸ï¼Œé¿å…ä»¥åè¢«å‡çº§å–ä»£é»˜è®¤çš„å¼€æœº4.19å†…æ ¸</span>
</span></span><span style="display:flex;"><span>rpm -qa | grep kernel
</span></span><span style="display:flex;"><span>yum remove -y kernel-3*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å‡çº§ç³»ç»Ÿè½¯ä»¶åŒ…ï¼ˆå¦‚æœè·³è¿‡å†…æ ¸å‡çº§åŠ å‚æ•° --exclude=kernel*ï¼‰</span>
</span></span><span style="display:flex;"><span>yum update -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…IPVSç›¸å…³å·¥å…·ï¼Œç”±äºIPVSåœ¨èµ„æºæ¶ˆè€—å’Œæ€§èƒ½ä¸Šå‡å·²æ˜æ˜¾ä¼˜äºiptablesï¼Œæ‰€ä»¥æ¨èå¼€å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…·ä½“åŸå› å¯å‚è€ƒå®˜ç½‘ä»‹ç» https://kubernetes.io/zh/blog/2018/07/09/ipvs-based-in-cluster-load-balancing-deep-dive/</span>
</span></span><span style="display:flex;"><span>yum install ipvsadm ipset sysstat conntrack libseccomp -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŠ è½½æ¨¡å—ï¼Œæœ€åä¸€æ¡4.18åŠä»¥ä¸‹å†…æ ¸ä½¿ç”¨nf_conntrack_ipv4ï¼Œ4.19å·²æ”¹ä¸ºnf_conntrack</span>
</span></span><span style="display:flex;"><span>modprobe -- ip_vs
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_rr
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_wrr
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_sh
</span></span><span style="display:flex;"><span>modprobe -- nf_conntrack
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¼–å†™å‚æ•°æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/modules-load.d/ipvs.conf 
</span></span><span style="display:flex;"><span>ip_vs
</span></span><span style="display:flex;"><span>ip_vs_lc
</span></span><span style="display:flex;"><span>ip_vs_wlc
</span></span><span style="display:flex;"><span>ip_vs_rr
</span></span><span style="display:flex;"><span>ip_vs_wrr
</span></span><span style="display:flex;"><span>ip_vs_lblc
</span></span><span style="display:flex;"><span>ip_vs_lblcr
</span></span><span style="display:flex;"><span>ip_vs_dh
</span></span><span style="display:flex;"><span>ip_vs_sh
</span></span><span style="display:flex;"><span>ip_vs_fo
</span></span><span style="display:flex;"><span>ip_vs_nq
</span></span><span style="display:flex;"><span>ip_vs_sed
</span></span><span style="display:flex;"><span>ip_vs_ftp
</span></span><span style="display:flex;"><span>ip_vs_sh
</span></span><span style="display:flex;"><span>nf_conntrack
</span></span><span style="display:flex;"><span>ip_tables
</span></span><span style="display:flex;"><span>ip_set
</span></span><span style="display:flex;"><span>xt_set
</span></span><span style="display:flex;"><span>ipt_set
</span></span><span style="display:flex;"><span>ipt_rpfilter
</span></span><span style="display:flex;"><span>ipt_REJECT
</span></span><span style="display:flex;"><span>ipip
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># systemd-modules-loadåŠ å…¥å¼€æœºè‡ªå¯</span>
</span></span><span style="display:flex;"><span>systemctl enable --now systemd-modules-load
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è‡ªå®šä¹‰å†…æ ¸å‚æ•°ä¼˜åŒ–é…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/sysctl.d/kubernetes.conf
</span></span><span style="display:flex;"><span>net.ipv4.ip_forward <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-iptables <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-ip6tables <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>fs.may_detach_mounts <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.conf.all.route_localnet <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>vm.overcommit_memory<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>vm.panic_on_oom<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>fs.inotify.max_user_watches<span style="color:#f92672">=</span><span style="color:#ae81ff">89100</span>
</span></span><span style="display:flex;"><span>fs.file-max<span style="color:#f92672">=</span><span style="color:#ae81ff">52706963</span>
</span></span><span style="display:flex;"><span>fs.nr_open<span style="color:#f92672">=</span><span style="color:#ae81ff">52706963</span>
</span></span><span style="display:flex;"><span>net.netfilter.nf_conntrack_max<span style="color:#f92672">=</span><span style="color:#ae81ff">2310720</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_keepalive_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_keepalive_probes <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_keepalive_intvl <span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_tw_buckets <span style="color:#f92672">=</span> <span style="color:#ae81ff">36000</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_tw_reuse <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_orphans <span style="color:#f92672">=</span> <span style="color:#ae81ff">327680</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_orphan_retries <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_syncookies <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_syn_backlog <span style="color:#f92672">=</span> <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>net.ipv4.ip_conntrack_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">65536</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_syn_backlog <span style="color:#f92672">=</span> <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_timestamps <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>net.core.somaxconn <span style="color:#f92672">=</span> <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŠ è½½</span>
</span></span><span style="display:flex;"><span>sysctl --system
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é‡å¯æŸ¥çœ‹IPVSæ¨¡å—æ˜¯å¦ä¾æ—§åŠ è½½</span>
</span></span><span style="display:flex;"><span>reboot
</span></span><span style="display:flex;"><span>lsmod | grep -e ip_vs -e nf_conntrack
</span></span></code></pre></div><ul>
<li>ä¿è¯æ¯å°æœåŠ¡å™¨ä¸­IPVSåŠ è½½æˆåŠŸï¼Œä»¥k8s-master01ä¸ºä¾‹ï¼Œå¦‚å›¾ï¼š</li>
</ul>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20220305153926.png" alt="20220305153926"  />
</p>
<h3 id="éƒ¨ç½²dockerall">éƒ¨ç½²Docker(ALL)<a hidden class="anchor" aria-hidden="true" href="#éƒ¨ç½²dockerall">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å¸è½½å·²å­˜åœ¨dockerï¼Œæ–°æœºå™¨çš„è¯è¿™æ­¥å¯ä»¥å¿½ç•¥</span>
</span></span><span style="display:flex;"><span>yum remove -y docker <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              docker-client <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              docker-client-latest <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              docker-common <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              docker-latest <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              docker-latest-logrotate <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              docker-logrotate <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>              docker-engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>yum remove -y docker-ce docker-ce-cli containerd.io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®é˜¿é‡Œdockeræº</span>
</span></span><span style="display:flex;"><span>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…æœ€æ–°ç‰ˆæœ¬docker</span>
</span></span><span style="display:flex;"><span>yum install docker-ce docker-ce-cli containerd.io -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ï¼ˆå¯é€‰ï¼‰å¦‚æœæƒ³è¦å®‰è£…æŒ‡å®šç‰ˆæœ¬dockerï¼Œå…ˆæŸ¥è¯¢ä¸€ä¸‹ã€‚å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼Œä¾‹å¦‚20.10.9-3.el7</span>
</span></span><span style="display:flex;"><span>yum list docker-ce docker-ce-cli --showduplicates | grep <span style="color:#e6db74">&#34;^doc&#34;</span> | sort -r
</span></span><span style="display:flex;"><span>yum install docker-ce-20.10.9-3.el7 docker-ce-cli-20.10.9-3.el7 containerd.io -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŠ å…¥å¼€æœºå¯åŠ¨å¹¶å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>systemctl enable docker
</span></span><span style="display:flex;"><span>systemctl start docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æµ‹è¯•è¿è¡Œhello-worldé•œåƒå¹¶æŸ¥çœ‹dockerç‰ˆæœ¬ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>docker run hello-world
</span></span><span style="display:flex;"><span>docker version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®é˜¿é‡Œdockeré•œåƒåŠ é€Ÿå™¨ï¼Œé˜¿é‡Œäº‘(ç™»å½•è´¦å·--&gt;ç‚¹å‡»ç®¡ç†æ§åˆ¶å°--&gt;æœç´¢å®¹å™¨é•œåƒæœåŠ¡--&gt;é•œåƒå·¥å…·--&gt;é•œåƒåŠ é€Ÿå™¨--&gt;å¤åˆ¶åŠ é€Ÿå™¨åœ°å€)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># dockeræ–‡ä»¶é©±åŠ¨æ”¹æˆ systemd</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/docker/daemon.json
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;registry-mirrors&#34;: [&#34;https://ynirk4k5.mirror.aliyuncs.com&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é‡å¯docker</span>
</span></span><span style="display:flex;"><span>systemctl restart docker
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦‚æœå¯åŠ¨å¤±è´¥,å¼ºåˆ¶åŠ è½½å†å¯åŠ¨è¯•è¯•</span>
</span></span><span style="display:flex;"><span>systemctl reset-failed docker
</span></span><span style="display:flex;"><span>systemctl restart docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹dockeré…ç½®ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>docker info
</span></span><span style="display:flex;"><span>docker info | grep Driver
</span></span></code></pre></div><h3 id="å®‰è£…kubernetesall">å®‰è£…kubernetes(ALL)<a hidden class="anchor" aria-hidden="true" href="#å®‰è£…kubernetesall">#</a></h3>
<p>ä¸€èˆ¬kubectlåœ¨masterèŠ‚ç‚¹å®‰è£…å³å¯,nodeèŠ‚ç‚¹è£…ä¸è£…å‡å¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹å¯ä»¥å®‰è£…çš„ç‰ˆæœ¬å·</span>
</span></span><span style="display:flex;"><span>yum list kubeadm --showduplicates | sort -r
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸æŒ‡å®šç‰ˆæœ¬çš„è¯é»˜è®¤å®‰è£…æœ€æ–°ç‰ˆæœ¬å®‰è£…</span>
</span></span><span style="display:flex;"><span>yum install -y kubelet kubeadm kubectl
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ï¼ˆå¯é€‰ï¼‰æŒ‡å®šç‰ˆæœ¬è¿›è¡Œå®‰è£…ï¼Œå¦‚1.23.0</span>
</span></span><span style="display:flex;"><span>yum install -y kubelet-1.23.0 kubeadm-1.23.0 kubectl-1.23.0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®pauseé•œåƒä»“åº“ï¼Œé»˜è®¤çš„gcr.ioå›½å†…æ— æ³•è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨é˜¿é‡Œä»“åº“</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/sysconfig/kubelet
</span></span><span style="display:flex;"><span>KUBELET_EXTRA_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5&#34;</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŠ å…¥å¼€æœºå¯åŠ¨å¹¶å¯åŠ¨ï¼Œæ­¤å¤„å¯åŠ¨å¤±è´¥ä¸å¿…æ’æŸ¥ï¼Œå¾…åˆå§‹åŒ–å®Œæˆkubeletä¼šè‡ªåŠ¨æ¢å¤æ­£å¸¸</span>
</span></span><span style="display:flex;"><span>systemctl enable --now kubelet
</span></span></code></pre></div><h3 id="é«˜å¯ç”¨ç»„ä»¶å®‰è£…master">é«˜å¯ç”¨ç»„ä»¶å®‰è£…(Master)<a hidden class="anchor" aria-hidden="true" href="#é«˜å¯ç”¨ç»„ä»¶å®‰è£…master">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰masterèŠ‚ç‚¹å®‰è£…Keepalivedå’Œhaproxy</span>
</span></span><span style="display:flex;"><span>yum install keepalived haproxy -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºæ‰€æœ‰masterèŠ‚ç‚¹æ·»åŠ haproxyé…ç½®ï¼Œé…ç½®éƒ½ä¸€æ ·ï¼Œæ£€æŸ¥æœ€åä¸‰è¡Œä¸»æœºåå’ŒIPåœ°å€å¯¹åº”ä¸Šå°±è¡Œ</span>
</span></span><span style="display:flex;"><span>mkdir /etc/haproxy
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/haproxy/haproxy.cfg
</span></span><span style="display:flex;"><span>global
</span></span><span style="display:flex;"><span>  maxconn  <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>  ulimit-n  <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>  log  127.0.0.1 local0 err
</span></span><span style="display:flex;"><span>  stats timeout 30s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>defaults
</span></span><span style="display:flex;"><span>  log global
</span></span><span style="display:flex;"><span>  mode  http
</span></span><span style="display:flex;"><span>  option  httplog
</span></span><span style="display:flex;"><span>  timeout connect <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>  timeout client  <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>  timeout server  <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>  timeout http-request 15s
</span></span><span style="display:flex;"><span>  timeout http-keep-alive 15s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend monitor-in
</span></span><span style="display:flex;"><span>  bind *:33305
</span></span><span style="display:flex;"><span>  mode http
</span></span><span style="display:flex;"><span>  option httplog
</span></span><span style="display:flex;"><span>  monitor-uri /monitor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend k8s-master
</span></span><span style="display:flex;"><span>  bind 0.0.0.0:16443
</span></span><span style="display:flex;"><span>  bind 127.0.0.1:16443
</span></span><span style="display:flex;"><span>  mode tcp
</span></span><span style="display:flex;"><span>  option tcplog
</span></span><span style="display:flex;"><span>  tcp-request inspect-delay 5s
</span></span><span style="display:flex;"><span>  default_backend k8s-master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend k8s-master
</span></span><span style="display:flex;"><span>  mode tcp
</span></span><span style="display:flex;"><span>  option tcplog
</span></span><span style="display:flex;"><span>  option tcp-check
</span></span><span style="display:flex;"><span>  balance roundrobin
</span></span><span style="display:flex;"><span>  default-server inter 10s downinter 5s rise <span style="color:#ae81ff">2</span> fall <span style="color:#ae81ff">2</span> slowstart 60s maxconn <span style="color:#ae81ff">250</span> maxqueue <span style="color:#ae81ff">256</span> weight <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>  server k8s-master01  192.168.43.183:6443  check
</span></span><span style="display:flex;"><span>  server k8s-master02  192.168.43.184:6443  check
</span></span><span style="display:flex;"><span>  server k8s-master03  192.168.43.185:6443  check
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># keepalivedé…ç½®ä¸ä¸€æ ·ï¼Œæ³¨æ„åŒºåˆ†ç½‘å¡åã€IPåœ°å€å’Œè™šæ‹ŸIPåœ°å€</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ£€æŸ¥æœåŠ¡å™¨ç½‘å¡å</span>
</span></span><span style="display:flex;"><span>ip a æˆ– ifconfig
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master01 Keepalivedé…ç½®</span>
</span></span><span style="display:flex;"><span>mkdir /etc/keepalived
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    router_id LVS_DEVEL
</span></span><span style="display:flex;"><span>    script_user root
</span></span><span style="display:flex;"><span>    enable_script_security
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_apiserver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#e6db74">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    weight -5
</span></span><span style="display:flex;"><span>    fall <span style="color:#ae81ff">2</span>  
</span></span><span style="display:flex;"><span>    rise <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state MASTER
</span></span><span style="display:flex;"><span>    interface ens33
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.43.183
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">101</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass K8SHA_KA_AUTH
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        192.168.43.182
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       chk_apiserver
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master02 Keepalivedé…ç½®</span>
</span></span><span style="display:flex;"><span>mkdir /etc/keepalived
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    router_id LVS_DEVEL
</span></span><span style="display:flex;"><span>    script_user root
</span></span><span style="display:flex;"><span>    enable_script_security
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_apiserver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#e6db74">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    weight -5
</span></span><span style="display:flex;"><span>    fall <span style="color:#ae81ff">2</span>  
</span></span><span style="display:flex;"><span>    rise <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state BACKUP
</span></span><span style="display:flex;"><span>    interface ens33
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.43.184
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass K8SHA_KA_AUTH
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        192.168.43.182
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       chk_apiserver
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master03 Keepalivedé…ç½®</span>
</span></span><span style="display:flex;"><span>mkdir /etc/keepalived
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    router_id LVS_DEVEL
</span></span><span style="display:flex;"><span>    script_user root
</span></span><span style="display:flex;"><span>    enable_script_security
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_apiserver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#e6db74">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    weight -5
</span></span><span style="display:flex;"><span>    fall <span style="color:#ae81ff">2</span>  
</span></span><span style="display:flex;"><span>    rise <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state BACKUP
</span></span><span style="display:flex;"><span>    interface ens33
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.43.185
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass K8SHA_KA_AUTH
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        192.168.43.182
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       chk_apiserver
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰masterèŠ‚ç‚¹é…ç½®Keepalivedå¥åº·æ£€æŸ¥è„šæœ¬</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/check_apiserver.sh 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>err<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> k in <span style="color:#66d9ef">$(</span>seq <span style="color:#ae81ff">1</span> 3<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    check_code<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pgrep haproxy<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $check_code <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        err<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>expr $err + 1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        sleep <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        err<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        break
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $err !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;systemctl stop keepalived&#34;</span>
</span></span><span style="display:flex;"><span>    /usr/bin/systemctl stop keepalived
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># èµ‹äºˆå¯æ‰§è¡Œæƒé™</span>
</span></span><span style="display:flex;"><span>chmod +x /etc/keepalived/check_apiserver.sh
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨haproxyå’ŒKeepalivedå¹¶åŠ å…¥å¼€æœºå¯åŠ¨</span>
</span></span><span style="display:flex;"><span>systemctl start haproxy
</span></span><span style="display:flex;"><span>systemctl start keepalived
</span></span><span style="display:flex;"><span>systemctl enable haproxy
</span></span><span style="display:flex;"><span>systemctl enable keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æµ‹è¯•ä¸€æ³¢</span>
</span></span><span style="display:flex;"><span>telnet k8s-master-vip <span style="color:#ae81ff">16443</span>
</span></span><span style="display:flex;"><span>ping k8s-master-vip
</span></span></code></pre></div><h3 id="éƒ¨ç½²k8s-masterk8s-master01">éƒ¨ç½²k8s-master(k8s-master01)<a hidden class="anchor" aria-hidden="true" href="#éƒ¨ç½²k8s-masterk8s-master01">#</a></h3>
<p>åœ¨k8s-master01èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œä¸ªåˆ«æ­¥éª¤åœ¨æ‰€æœ‰masterèŠ‚ç‚¹æ‰§è¡Œï¼Œå·²å¦è¡Œè¯´æ˜ï¼Œæ²¡è¯´æ˜çš„å‡æ˜¯åœ¨k8s-master01æ‰§è¡Œã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºåˆå§‹åŒ–æ–‡ä»¶ï¼Œæ³¨æ„ç‰ˆæœ¬å·å’ŒIPå¯¹åº”ä¸Š</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; kubeadm-config.yaml
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta2
</span></span><span style="display:flex;"><span>bootstrapTokens:
</span></span><span style="display:flex;"><span>- groups:
</span></span><span style="display:flex;"><span>  - system:bootstrappers:kubeadm:default-node-token
</span></span><span style="display:flex;"><span>  token: 7t2weq.bjbawausm0jaxury
</span></span><span style="display:flex;"><span>  ttl: 24h0m0s
</span></span><span style="display:flex;"><span>  usages:
</span></span><span style="display:flex;"><span>  - signing
</span></span><span style="display:flex;"><span>  - authentication
</span></span><span style="display:flex;"><span>kind: InitConfiguration
</span></span><span style="display:flex;"><span>localAPIEndpoint:
</span></span><span style="display:flex;"><span>  advertiseAddress: 192.168.43.183 <span style="color:#75715e"># APIé€šçŸ¥åœ°å€ï¼Œè®¾ç½®ä¸ºåˆå§‹åŒ–IPå³å¯</span>
</span></span><span style="display:flex;"><span>  bindPort: <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>nodeRegistration:
</span></span><span style="display:flex;"><span>  criSocket: /var/run/dockershim.sock <span style="color:#75715e"># dockerä½œä¸ºContainer Runtime</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># criSocket: /run/containerd/containerd.sock # containerdä½œä¸ºContainer Runtime</span>
</span></span><span style="display:flex;"><span>  name: k8s-master01 <span style="color:#75715e"># åˆå§‹åŒ–èŠ‚ç‚¹å</span>
</span></span><span style="display:flex;"><span>  taints:
</span></span><span style="display:flex;"><span>  - effect: NoSchedule
</span></span><span style="display:flex;"><span>    key: node-role.kubernetes.io/master
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiServer:
</span></span><span style="display:flex;"><span>  certSANs:
</span></span><span style="display:flex;"><span>  - 192.168.43.182
</span></span><span style="display:flex;"><span>  timeoutForControlPlane: 4m0s <span style="color:#75715e"># åˆå§‹åŒ–è¶…æ—¶æ—¶é—´</span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta2
</span></span><span style="display:flex;"><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>clusterName: kubernetes
</span></span><span style="display:flex;"><span>controlPlaneEndpoint: 192.168.43.182:16443 <span style="color:#75715e"># å¦‚æœä¸æ˜¯é«˜å¯ç”¨é›†ç¾¤ï¼Œåˆ™ä¸º6443</span>
</span></span><span style="display:flex;"><span>controllerManager: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>dns:
</span></span><span style="display:flex;"><span>  type: CoreDNS
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>  local:
</span></span><span style="display:flex;"><span>    dataDir: /var/lib/etcd
</span></span><span style="display:flex;"><span>imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers <span style="color:#75715e"># å›½å†…åœ°å€</span>
</span></span><span style="display:flex;"><span>kind: ClusterConfiguration
</span></span><span style="display:flex;"><span>kubernetesVersion: v1.23.0 <span style="color:#75715e"># éœ€ä¸kubeadm versionç‰ˆæœ¬å·ä¿æŒä¸€è‡´</span>
</span></span><span style="display:flex;"><span>networking:
</span></span><span style="display:flex;"><span>  dnsDomain: cluster.local
</span></span><span style="display:flex;"><span>  podSubnet: 172.16.0.0/12 <span style="color:#75715e"># ä¸å¯ä¸å…¶ä»–IPæ®µå†²çª</span>
</span></span><span style="display:flex;"><span>  serviceSubnet: 10.96.0.0/12 <span style="color:#75715e"># ä¸å¯ä¸å…¶ä»–IPæ®µå†²çª</span>
</span></span><span style="display:flex;"><span>scheduler: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ›´æ–°åˆå§‹åŒ–æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>kubeadm config migrate --old-config kubeadm-config.yaml --new-config new.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å°†new.yamlå¤åˆ¶åˆ°å…¶ä»–masterèŠ‚ç‚¹ä¸Š</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03;<span style="color:#66d9ef">do</span> scp new.yaml $i:/root/;<span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é•œåƒé¢„ä¸‹è½½ï¼ŒèŠ‚çœé›†ç¾¤åˆå§‹åŒ–çš„æ—¶é—´ï¼ˆè¿™ä¸€æ­¥åœ¨æ‰€æœ‰masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼‰</span>
</span></span><span style="display:flex;"><span>kubeadm config images pull --config /root/new.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰§è¡Œç»“æœå¦‚ä¸‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.23.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.23.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.23.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.23.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.1-0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master01åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆåï¼ŒåŠ å…¥å…¶ä»–èŠ‚ç‚¹å³å¯</span>
</span></span><span style="display:flex;"><span>kubeadm init --config /root/new.yaml  --upload-certs
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆå§‹åŒ–å¦‚æœå¤±è´¥ï¼Œå¯ç”¨ä¸‹é¢å‘½ä»¤æ¸…é™¤åˆå§‹åŒ–ä¿¡æ¯ï¼Œç„¶åå†æ¬¡å°è¯•åˆå§‹åŒ–</span>
</span></span><span style="display:flex;"><span>kubeadm reset -f ; ipvsadm --clear  ; rm -rf ~/.kube
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆå§‹åŒ–æˆåŠŸç±»ä¼¼äºä¸‹é¢è¾“å‡ºï¼Œä¿å­˜å¥½è¿™äº›ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Alternatively, <span style="color:#66d9ef">if</span> you are the root user, you can run:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You can now join any number of the control-plane node running the following command on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  kubeadm join 192.168.43.182:16443 --token 7t2weq.bjbawausm0jaxury <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --discovery-token-ca-cert-hash sha256:5257d44118ab035adc5af89dd7d5a24ca4c31c33e1918b3453ea9aa32597121b <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --control-plane --certificate-key 9a2e86718fceba001c96e503e9df47db3a645d4917bf783decaea9c5d0a726ed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style="display:flex;"><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.43.182:16443 --token 7t2weq.bjbawausm0jaxury <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --discovery-token-ca-cert-hash sha256:5257d44118ab035adc5af89dd7d5a24ca4c31c33e1918b3453ea9aa32597121b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŒ‰ç…§æç¤ºï¼Œå¦‚æœä½ æ˜¯æ™®é€šç”¨æˆ·åœ¨æ“ä½œï¼Œæ‰§è¡Œä¸€ä¸‹ä¸‹é¢å‡ æ¡</span>
</span></span><span style="display:flex;"><span>mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦‚æœæ˜¯rootç”¨æˆ·åœ¨æ“ä½œåˆå§‹åŒ–ï¼Œæ‰§è¡Œä¸‹é¢ä¸€æ¡å³å¯</span>
</span></span><span style="display:flex;"><span>export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹dockeré•œåƒ,å¯ä»¥çœ‹åˆ°kube..å’Œetcdç­‰é•œåƒ</span>
</span></span><span style="display:flex;"><span>docker images
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tokenè¿‡æœŸåç”Ÿæˆæ–°çš„tokenï¼ˆæ²¡æç¤ºè¿‡æœŸä¸‹é¢ä¸¤æ­¥å°±ä¸ç”¨ç®¡äº†ï¼‰</span>
</span></span><span style="display:flex;"><span>kubeadm token create --print-join-command
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Masteréœ€è¦ç”Ÿæˆ--certificate-key</span>
</span></span><span style="display:flex;"><span>kubeadm init phase upload-certs  --upload-certs
</span></span></code></pre></div><h3 id="å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤">å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤<a hidden class="anchor" aria-hidden="true" href="#å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤">#</a></h3>
<p>å…¶ä»–masterèŠ‚ç‚¹åŠ å…¥k8s-master01</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æ ¹æ®kubeadm initæç¤ºçš„token</span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.43.182:16443 --token 7t2weq.bjbawausm0jaxury <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --discovery-token-ca-cert-hash sha256:5257d44118ab035adc5af89dd7d5a24ca4c31c33e1918b3453ea9aa32597121b <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --control-plane --certificate-key 9a2e86718fceba001c96e503e9df47db3a645d4917bf783decaea9c5d0a726ed
</span></span></code></pre></div><p>nodeèŠ‚ç‚¹åŠ å…¥k8s-master01</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æ ¹æ®kubeadm initæç¤ºçš„token</span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.43.182:16443 --token 7t2weq.bjbawausm0jaxury <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --discovery-token-ca-cert-hash sha256:5257d44118ab035adc5af89dd7d5a24ca4c31c33e1918b3453ea9aa32597121b
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># master01ä¸ŠæŸ¥çœ‹åŠ å…¥åçš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œå› ä¸ºè¿˜æœªé…ç½®CNIæ’ä»¶ï¼Œæ‰€ä»¥nodeä¹‹é—´é€šä¿¡è¿˜æœªæ‰“é€š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get no</span>
</span></span><span style="display:flex;"><span>NAME           STATUS     ROLES                  AGE     VERSION
</span></span><span style="display:flex;"><span>k8s-master01   NotReady   control-plane,master   19m     v1.23.0
</span></span><span style="display:flex;"><span>k8s-master02   NotReady   control-plane,master   3m39s   v1.23.0
</span></span><span style="display:flex;"><span>k8s-master03   NotReady   control-plane,master   3m35s   v1.23.0
</span></span><span style="display:flex;"><span>k8s-node01     NotReady   &lt;none&gt;                 2m21s   v1.23.0
</span></span><span style="display:flex;"><span>k8s-node02     NotReady   &lt;none&gt;                 2m21s   v1.23.0
</span></span></code></pre></div><h3 id="é…ç½®calicoç½‘ç»œ">é…ç½®calicoç½‘ç»œ<a hidden class="anchor" aria-hidden="true" href="#é…ç½®calicoç½‘ç»œ">#</a></h3>
<p>åœ¨k8s-master01èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</p>
<p>ç½‘ç»œæ–¹æ¡ˆä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–(ä¾‹å¦‚ï¼šflannelç­‰)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å…ˆæŠŠæ‰€éœ€çš„é…ç½®æ–‡ä»¶ä»GitHubæ‹‰ä¸‹æ¥</span>
</span></span><span style="display:flex;"><span>git clone https://github.com/deemoprobe/k8s-ha-install.git
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ‡æ¢åˆ°1.23åˆ†æ”¯å¹¶è¿›å…¥calicoæ–‡ä»¶å¤¹</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install <span style="color:#f92672">&amp;&amp;</span> git checkout manual-installation-v1.23.x <span style="color:#f92672">&amp;&amp;</span> cd calico/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ›¿æ¢ä¸€ä¸‹PODç½‘æ®µ</span>
</span></span><span style="display:flex;"><span>POD_SUBNET<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr<span style="color:#f92672">=</span> | awk -F<span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{print $NF}&#39;</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#POD_CIDR#</span><span style="color:#e6db74">${</span>POD_SUBNET<span style="color:#e6db74">}</span><span style="color:#e6db74">#g&#34;</span> calico.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åº”ç”¨calicoæ’ä»¶</span>
</span></span><span style="display:flex;"><span>kubectl apply -f calico.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é›†ç¾¤èŠ‚ç‚¹å‡å·²å¤„äºReadyçŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get no</span>
</span></span><span style="display:flex;"><span>NAME           STATUS   ROLES                  AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master01   Ready    control-plane,master   29m   v1.23.0
</span></span><span style="display:flex;"><span>k8s-master02   Ready    control-plane,master   13m   v1.23.0
</span></span><span style="display:flex;"><span>k8s-master03   Ready    control-plane,master   13m   v1.23.0
</span></span><span style="display:flex;"><span>k8s-node01     Ready    &lt;none&gt;                 11m   v1.23.0
</span></span><span style="display:flex;"><span>k8s-node02     Ready    &lt;none&gt;                 11m   v1.23.0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹calico Podæ˜¯å¦éƒ½æ­£å¸¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod -A
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦‚æœä¸æ­£å¸¸ï¼Œå¯ä»¥æ’æŸ¥ä¸€ä¸‹ï¼Œä¸€èˆ¬æ˜¯é•œåƒæ‹‰å–é—®é¢˜ï¼Œå¤šç­‰å¾…å‡ åˆ†é’Ÿå³å¯ï¼Œä¹Ÿå¯ä»¥æ ¹æ®æŠ¥é”™ç®€å•å¤„ç†ä¸€ä¸‹</span>
</span></span><span style="display:flex;"><span>kubectl describe pod XXX -n kube-system
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¯”å¦‚æˆ‘è¿™é‡Œæœ‰ä¸ªpodå¤„äºpendingçŠ¶æ€ï¼ŒæŸ¥çœ‹ä¸€ä¸‹åŸå› </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -A</span>
</span></span><span style="display:flex;"><span>NAMESPACE     NAME                                       READY   STATUS    RESTARTS      AGE
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>kube-system   calico-typha-8445487f56-hx8w9              1/1     Running   <span style="color:#ae81ff">0</span>             11m
</span></span><span style="display:flex;"><span>kube-system   calico-typha-8445487f56-mh6tp              0/1     Pending   <span style="color:#ae81ff">0</span>             11m
</span></span><span style="display:flex;"><span>kube-system   calico-typha-8445487f56-pxthb              1/1     Running   <span style="color:#ae81ff">0</span>             11m
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥çœ‹åˆ°æç¤ºè¯´2ä¸ªnodeèŠ‚ç‚¹æ— æ³•æä¾›è¶³é‡çš„podç«¯å£åˆ†é…éœ€æ±‚ï¼Œè€Œä¸”æç¤ºmasterèŠ‚ç‚¹è®¾ç½®äº†æ±¡ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pod calico-typha-8445487f56-mh6tp -n kube-system</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason            Age                    From               Message
</span></span><span style="display:flex;"><span>  ----     ------            ----                   ----               -------
</span></span><span style="display:flex;"><span>  Warning  FailedScheduling  11m                    default-scheduler  0/5 nodes are available: <span style="color:#ae81ff">2</span> node<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> had taint <span style="color:#f92672">{</span>node.kubernetes.io/not-ready: <span style="color:#f92672">}</span>, that the pod didn<span style="color:#e6db74">&#39;t tolerate, 3 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn&#39;</span>t tolerate.
</span></span><span style="display:flex;"><span>  Warning  FailedScheduling  10m                    default-scheduler  0/5 nodes are available: <span style="color:#ae81ff">1</span> node<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> didn<span style="color:#e6db74">&#39;t have free ports for the requested pod ports, 1 node(s) had taint {node.kubernetes.io/not-ready: }, that the pod didn&#39;</span>t tolerate, <span style="color:#ae81ff">3</span> node<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> had taint <span style="color:#f92672">{</span>node-role.kubernetes.io/master: <span style="color:#f92672">}</span>, that the pod didn<span style="color:#e6db74">&#39;t tolerate.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Warning  FailedScheduling  10m                    default-scheduler  0/5 nodes are available: 2 node(s) didn&#39;</span>t have free ports <span style="color:#66d9ef">for</span> the requested pod ports, <span style="color:#ae81ff">3</span> node<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> had taint <span style="color:#f92672">{</span>node-role.kubernetes.io/master: <span style="color:#f92672">}</span>, that the pod didn<span style="color:#e6db74">&#39;t tolerate.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Warning  FailedScheduling  8m24s (x1 over 9m24s)  default-scheduler  0/5 nodes are available: 2 node(s) didn&#39;</span>t have free ports <span style="color:#66d9ef">for</span> the requested pod ports, <span style="color:#ae81ff">3</span> node<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> had taint <span style="color:#f92672">{</span>node-role.kubernetes.io/master: <span style="color:#f92672">}</span>, that the pod didn<span style="color:#e6db74">&#39;t tolerate.&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¡®è®¤ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªmasterèŠ‚ç‚¹æ‰“ä¸Šäº†ä¸å¯è°ƒåº¦podçš„æ±¡ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># for i in k8s-master01 k8s-master02 k8s-master03;do kubectl describe node $i | grep -i taint;done</span>
</span></span><span style="display:flex;"><span>Taints:             node-role.kubernetes.io/master:NoSchedule
</span></span><span style="display:flex;"><span>Taints:             node-role.kubernetes.io/master:NoSchedule
</span></span><span style="display:flex;"><span>Taints:             node-role.kubernetes.io/master:NoSchedule
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”±äºæ˜¯ç»ƒä¹ ç¯å¢ƒï¼Œæˆ‘å°±æŠŠä¸å¯è°ƒåº¦çš„æ±¡ç‚¹å–æ¶ˆäº†ï¼Œå¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®æ‰©å®¹nodeå·¥ä½œèŠ‚ç‚¹æ¥å®ç°è¶³é‡çš„ç«¯å£åˆ†é…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># for i in k8s-master01 k8s-master02 k8s-master03;do kubectl taint node $i node-role.kubernetes.io/master:NoSchedule-;done</span>
</span></span><span style="display:flex;"><span>node/k8s-master01 untainted
</span></span><span style="display:flex;"><span>node/k8s-master02 untainted
</span></span><span style="display:flex;"><span>node/k8s-master03 untainted
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ±¡ç‚¹æˆåŠŸå–æ¶ˆ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># for i in k8s-master01 k8s-master02 k8s-master03;do kubectl describe node $i | grep -i taint;done</span>
</span></span><span style="display:flex;"><span>Taints:             &lt;none&gt;
</span></span><span style="display:flex;"><span>Taints:             &lt;none&gt;
</span></span><span style="display:flex;"><span>Taints:             &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å†æŸ¥çœ‹åˆšæ‰å¤„äºpendingçš„podå‘ç°å·²ç»å¤„äºrunningçŠ¶æ€äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po -A | grep calico-typha-8445487f56-mh6tp</span>
</span></span><span style="display:flex;"><span>kube-system   calico-typha-8445487f56-mh6tp              1/1     Running   <span style="color:#ae81ff">0</span>             23m
</span></span></code></pre></div><h2 id="éƒ¨ç½²metrics">éƒ¨ç½²Metrics<a hidden class="anchor" aria-hidden="true" href="#éƒ¨ç½²metrics">#</a></h2>
<p>åœ¨æ–°ç‰ˆçš„Kubernetesä¸­ç³»ç»Ÿèµ„æºçš„é‡‡é›†å‡ä½¿ç”¨Metrics-serverï¼Œå¯ä»¥é€šè¿‡Metricsé‡‡é›†èŠ‚ç‚¹å’ŒPodçš„å†…å­˜ã€ç£ç›˜ã€CPUå’Œç½‘ç»œçš„ä½¿ç”¨ç‡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å°†Master01èŠ‚ç‚¹çš„front-proxy-ca.crtå¤åˆ¶åˆ°æ‰€æœ‰NodeèŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># for i in k8s-node01 k8s-node02;do scp /etc/kubernetes/pki/front-proxy-ca.crt $i:/etc/kubernetes/pki/front-proxy-ca.crt;done</span>
</span></span><span style="display:flex;"><span>front-proxy-ca.crt                                                                                                   100% <span style="color:#ae81ff">1115</span>   593.4KB/s   00:00    
</span></span><span style="display:flex;"><span>front-proxy-ca.crt                                                                                                   100% <span style="color:#ae81ff">1115</span>     1.4MB/s   00:00  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…metrics server</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># cd /root/k8s-ha-install/kubeadm-metrics-server</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 kubeadm-metrics-server<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f comp.yaml </span>
</span></span><span style="display:flex;"><span>serviceaccount/metrics-server created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/system:metrics-server created
</span></span><span style="display:flex;"><span>rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
</span></span><span style="display:flex;"><span>service/metrics-server created
</span></span><span style="display:flex;"><span>deployment.apps/metrics-server created
</span></span><span style="display:flex;"><span>apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹è¿è¡ŒçŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 kubeadm-metrics-server<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po -A | grep metrics</span>
</span></span><span style="display:flex;"><span>kube-system   metrics-server-5cf8885b66-2nnb6            1/1     Running   <span style="color:#ae81ff">0</span>             68s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># éƒ¨ç½²åä¾¿å¯ä»¥æŸ¥çœ‹æŒ‡æ ‡äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 kubeadm-metrics-server<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl top node</span>
</span></span><span style="display:flex;"><span>NAME           CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   CPU%   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   MEMORY%   
</span></span><span style="display:flex;"><span>k8s-master01   177m         8%     1196Mi          64%       
</span></span><span style="display:flex;"><span>k8s-master02   153m         7%     1101Mi          58%       
</span></span><span style="display:flex;"><span>k8s-master03   163m         8%     1102Mi          58%       
</span></span><span style="display:flex;"><span>k8s-node01     88m          4%     848Mi           45%       
</span></span><span style="display:flex;"><span>k8s-node02     85m          4%     842Mi           45%       
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 kubeadm-metrics-server<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl top po</span>
</span></span><span style="display:flex;"><span>NAME                     CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   
</span></span><span style="display:flex;"><span>nginx-85b98978db-7mn6r   0m           3Mi
</span></span></code></pre></div><h2 id="éƒ¨ç½²dashboard">éƒ¨ç½²Dashboard<a hidden class="anchor" aria-hidden="true" href="#éƒ¨ç½²dashboard">#</a></h2>
<p>Dashboardæ˜¯ä¸€ä¸ªå±•ç¤ºKubernetesé›†ç¾¤èµ„æºå’ŒPodæ—¥å¿—ï¼Œç”šè‡³å¯ä»¥æ‰§è¡Œå®¹å™¨å‘½ä»¤çš„webæ§åˆ¶å°ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ç›´æ¥éƒ¨ç½²å³å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 kubeadm-metrics-server<span style="color:#f92672">]</span><span style="color:#75715e"># cd /root/k8s-ha-install/dashboard/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 dashboard<span style="color:#f92672">]</span><span style="color:#75715e"># ls</span>
</span></span><span style="display:flex;"><span>dashboard-user.yaml  dashboard.yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 dashboard<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f .</span>
</span></span><span style="display:flex;"><span>serviceaccount/admin-user created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/admin-user created
</span></span><span style="display:flex;"><span>namespace/kubernetes-dashboard created
</span></span><span style="display:flex;"><span>serviceaccount/kubernetes-dashboard created
</span></span><span style="display:flex;"><span>service/kubernetes-dashboard created
</span></span><span style="display:flex;"><span>secret/kubernetes-dashboard-certs created
</span></span><span style="display:flex;"><span>secret/kubernetes-dashboard-csrf created
</span></span><span style="display:flex;"><span>secret/kubernetes-dashboard-key-holder created
</span></span><span style="display:flex;"><span>configmap/kubernetes-dashboard-settings created
</span></span><span style="display:flex;"><span>role.rbac.authorization.k8s.io/kubernetes-dashboard created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
</span></span><span style="display:flex;"><span>rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
</span></span><span style="display:flex;"><span>deployment.apps/kubernetes-dashboard created
</span></span><span style="display:flex;"><span>service/dashboard-metrics-scraper created
</span></span><span style="display:flex;"><span>deployment.apps/dashboard-metrics-scraper created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹dashboardç«¯å£ï¼Œé»˜è®¤æ˜¯NodePortæ¨¡å¼ï¼Œè®¿é—®é›†ç¾¤å†…ä»»æ„èŠ‚ç‚¹çš„31073ç«¯å£å³å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 dashboard<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -owide -A | grep dash</span>
</span></span><span style="display:flex;"><span>kubernetes-dashboard   dashboard-metrics-scraper   ClusterIP   10.105.172.8    &lt;none&gt;        8000/TCP                 19m    k8s-app<span style="color:#f92672">=</span>dashboard-metrics-scraper
</span></span><span style="display:flex;"><span>kubernetes-dashboard   kubernetes-dashboard        NodePort    10.99.148.159   &lt;none&gt;        443:31073/TCP            19m    k8s-app<span style="color:#f92672">=</span>kubernetes-dashboard
</span></span></code></pre></div><p>è®¿é—®dashboardï¼š<a href="https://%e9%9b%86%e7%be%a4%e5%86%85%e4%bb%bb%e6%84%8f%e8%8a%82%e7%82%b9IP:31073"  target="_blank" rel="noopener" style="color:#42b983" ;>https://é›†ç¾¤å†…ä»»æ„èŠ‚ç‚¹IP:31073</a></p>
<p>å‘ç°æç¤ºéšç§è®¾ç½®é”™è¯¯çš„é—®é¢˜ï¼Œå¦‚å›¾ï¼š</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20211213153948.png" alt="20211213153948"  />
</p>
<p>åœ¨Chromeæµè§ˆå™¨å¯åŠ¨å‚æ•°åŠ å…¥<code>--test-type --ignore-certificate-errors</code>ï¼Œç„¶åå†è®¿é—®å°±æ²¡æœ‰è¿™ä¸ªå®‰å…¨æç¤ºäº†</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20211213154024.png" alt="20211213154024"  />
</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20211213154133.png" alt="20211213154133"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># è·å–ç™»é™†ä»¤ç‰Œï¼ˆtokenï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 dashboard<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk &#39;{print $1}&#39;)</span>
</span></span><span style="display:flex;"><span>Name:         admin-user-token-mwnfs
</span></span><span style="display:flex;"><span>Namespace:    kube-system
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  kubernetes.io/service-account.name: admin-user
</span></span><span style="display:flex;"><span>              kubernetes.io/service-account.uid: 29584392-1cbd-4d5c-91af-9dd4703008aa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Type:  kubernetes.io/service-account-token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Data
</span></span><span style="display:flex;"><span><span style="color:#f92672">====</span>
</span></span><span style="display:flex;"><span>ca.crt:     <span style="color:#ae81ff">1099</span> bytes
</span></span><span style="display:flex;"><span>namespace:  <span style="color:#ae81ff">11</span> bytes
</span></span><span style="display:flex;"><span>token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IjRyZlh6Ukxta0FlajlHREF5ei1mdl8tZmR6ekwteV9fVEIwalQtejRwUk0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLW13bmZzIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiIyOTU4NDM5Mi0xY2JkLTRkNWMtOTFhZi05ZGQ0NzAzMDA4YWEiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.pMBMkLAP2AoymIXJC7H47IPu3avdBWPYSZfvjRME7lEQAnbe-SM-yrTFGPzcsJQC3O9gPDvXgIZ1x1tQUtQhc_333GtDMj_VL9oEZxYiOdd578CnBiFmF0BWVX06pAzONgKbguamMD8XEPAvKt4mnlDUr7WCeQJZf_juXKdl7ZOBtrM5Zae0UQHFG6juKLmFP-XxIgoDVIPhcxeAH1ktOHM9Fk1M831hywL1SL2OLHiN52wGLT4WuYrP2iUbJkNpt2PYitSp3iNuh7rESL4Ur7lmFQkLZa9e5vNMCc1wTwOAWvaW4P5TbxtfI_ng4NK_avquiXJY-67D77G-8WKzWg
</span></span></code></pre></div><p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20211213154451.png" alt="20211213154451"  />
</p>
<h2 id="é›†ç¾¤ä¼˜åŒ–å¯é€‰">é›†ç¾¤ä¼˜åŒ–(å¯é€‰)<a hidden class="anchor" aria-hidden="true" href="#é›†ç¾¤ä¼˜åŒ–å¯é€‰">#</a></h2>
<p>Dockerå¯åœ¨<code>/etc/docker/daemon.json</code>è‡ªå®šä¹‰ä¼˜åŒ–é…ç½®ï¼Œæ‰€æœ‰é…ç½®å¯è§ï¼š<a href="https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file"  target="_blank" rel="noopener" style="color:#42b983" ;>å®˜æ–¹docker configuration</a>ï¼Œdockerå¸¸ç”¨ä¼˜åŒ–é…ç½®è§ä¸‹æ–¹æ³¨é‡Šè¯´æ˜ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ä¼˜åŒ–dockeré…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/docker/daemon.jsonæ–‡ä»¶ï¼ŒæŒ‰éœ€é…ç½®ï¼Œä¸éœ€è¦å…¨éƒ¨éƒ½ç…§æŠ„ï¼Œä½¿ç”¨æ—¶åˆ é™¤æ³¨é‡Šï¼Œå› ä¸ºJSONæ–‡ä»¶ä¸æ”¯æŒæ³¨é‡Š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>, <span style="color:#75715e"># cgroupsé©±åŠ¨</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;registry-mirrors&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;https://ynirk4k5.mirror.aliyuncs.com&#34;</span><span style="color:#f92672">]</span>, <span style="color:#75715e"># é•œåƒåŠ é€Ÿå™¨åœ°å€</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;allow-nondistributable-artifacts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;api-cors-header&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;authorization-plugins&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;bip&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;bridge&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cgroup-parent&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cluster-advertise&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cluster-store&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cluster-store-opts&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;containerd&#34;</span>: <span style="color:#e6db74">&#34;/run/containerd/containerd.sock&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;containerd-namespace&#34;</span>: <span style="color:#e6db74">&#34;docker&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;data-root&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#75715e"># æ•°æ®æ ¹ç›®å½•ï¼Œå¤§é‡dockeré•œåƒå¯èƒ½ä¼šå ç”¨è¾ƒå¤§å­˜å‚¨ï¼Œå¯ä»¥è®¾ç½®ç³»ç»Ÿç›˜å¤–çš„æŒ‚è½½ç›˜</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;debug&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-address-pools&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;base&#34;</span>: <span style="color:#e6db74">&#34;172.30.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;size&#34;</span>: <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;base&#34;</span>: <span style="color:#e6db74">&#34;172.31.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;size&#34;</span>: <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-cgroupns-mode&#34;</span>: <span style="color:#e6db74">&#34;private&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway-v6&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-runtime&#34;</span>: <span style="color:#e6db74">&#34;runc&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-shm-size&#34;</span>: <span style="color:#e6db74">&#34;64M&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-ulimits&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;nofile&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Hard&#34;</span>: 64000,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;nofile&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Soft&#34;</span>: <span style="color:#ae81ff">64000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dns&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dns-opts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dns-search&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-root&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;experimental&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;features&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fixed-cidr&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fixed-cidr-v6&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;group&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;hosts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;icc&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;init&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;init-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-init&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;insecure-registries&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip-forward&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip-masq&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;iptables&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip6tables&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ipv6&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;labels&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;live-restore&#34;</span>: true, <span style="color:#75715e"># dockerè¿›ç¨‹å®•æœºæ—¶å®¹å™¨ä¾ç„¶ä¿æŒå­˜æ´»</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-driver&#34;</span>: <span style="color:#e6db74">&#34;json-file&#34;</span>, <span style="color:#75715e"># æ—¥å¿—æ ¼å¼</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-level&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#75715e"># æ—¥å¿—çº§åˆ«</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-opts&#34;</span>: <span style="color:#f92672">{</span> <span style="color:#75715e"># æ—¥å¿—ä¼˜åŒ–</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-disabled&#34;</span>: <span style="color:#e6db74">&#34;false&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-size&#34;</span>: <span style="color:#e6db74">&#34;20m&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-compress&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;env&#34;</span>: <span style="color:#e6db74">&#34;os,customer&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;labels&#34;</span>: <span style="color:#e6db74">&#34;somelabel&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>, <span style="color:#75715e"># æœ€å¤§æ—¥å¿—æ•°é‡</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-size&#34;</span>: <span style="color:#e6db74">&#34;10m&#34;</span> <span style="color:#75715e"># ä¿å­˜çš„æœ€å¤§æ—¥å¿—å¤§å°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-downloads&#34;</span>: 3, <span style="color:#75715e"># pullä¸‹è½½å¹¶å‘æ•°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-uploads&#34;</span>: 5, <span style="color:#75715e"># pushä¸Šä¼ å¹¶å‘æ•°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-download-attempts&#34;</span>: 5,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;mtu&#34;</span>: 0,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;no-new-privileges&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;node-generic-resources&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;NVIDIA-GPU=UUID1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;NVIDIA-GPU=UUID2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;oom-score-adjust&#34;</span>: -500,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;pidfile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;raw-logs&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;runtimes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cc-runtime&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/bin/cc-runtime&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;custom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/local/bin/my-runc-replacement&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;runtimeArgs&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;--debug&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;seccomp-profile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;selinux-enabled&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;shutdown-timeout&#34;</span>: 15,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-driver&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-opts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;swarm-default-advertise-addr&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tls&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlscacert&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlscert&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlskey&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlsverify&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userland-proxy&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userland-proxy-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-proxy&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userns-remap&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ— æ³¨é‡Šç‰ˆ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;registry-mirrors&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;https://ynirk4k5.mirror.aliyuncs.com&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;containerd-namespace&#34;</span>: <span style="color:#e6db74">&#34;docker&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;data-root&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;debug&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-cgroupns-mode&#34;</span>: <span style="color:#e6db74">&#34;private&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway-v6&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-runtime&#34;</span>: <span style="color:#e6db74">&#34;runc&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-shm-size&#34;</span>: <span style="color:#e6db74">&#34;64M&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-ulimits&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;nofile&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Hard&#34;</span>: 64000,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;nofile&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Soft&#34;</span>: <span style="color:#ae81ff">64000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;init-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-init&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;live-restore&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-driver&#34;</span>: <span style="color:#e6db74">&#34;json-file&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-level&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-opts&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-disabled&#34;</span>: <span style="color:#e6db74">&#34;false&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-size&#34;</span>: <span style="color:#e6db74">&#34;20m&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-compress&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;env&#34;</span>: <span style="color:#e6db74">&#34;os,customer&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;labels&#34;</span>: <span style="color:#e6db74">&#34;somelabel&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-size&#34;</span>: <span style="color:#e6db74">&#34;10m&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-downloads&#34;</span>: 3,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-uploads&#34;</span>: 5,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-download-attempts&#34;</span>: 5,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;mtu&#34;</span>: 0,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;no-new-privileges&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;oom-score-adjust&#34;</span>: -500,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;pidfile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;raw-logs&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;runtimes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cc-runtime&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/bin/cc-runtime&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;custom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/local/bin/my-runc-replacement&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;runtimeArgs&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;--debug&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;seccomp-profile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;selinux-enabled&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;shutdown-timeout&#34;</span>: 15,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-driver&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-opts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;swarm-default-advertise-addr&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userland-proxy-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-proxy&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userns-remap&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¾ç½®è¯ä¹¦æœ‰æ•ˆæœŸ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /usr/lib/systemd/system/kube-controller-manager.service</span>
</span></span><span style="display:flex;"><span>... <span style="color:#75715e"># åŠ å…¥ä¸‹é¢é…ç½®</span>
</span></span><span style="display:flex;"><span>--experimental-cluster-signing-duration<span style="color:#f92672">=</span>876000h0m0s
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl daemon-reload</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl restart kube-controller-manager</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeletä¼˜åŒ–åŠ å¯†ç®—æ³•ï¼Œé»˜è®¤çš„ç®—æ³•å®¹æ˜“è¢«æ¼æ´æ‰«æï¼›å¢é•¿é•œåƒä¸‹è½½å‘¨æœŸï¼Œé¿å…æœ‰äº›å¤§é•œåƒæœªä¸‹è½½å®Œæˆå°±è¢«åŠ¨æ­»äº¡é€€å‡º</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --image-pull-progress-deadline=30m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span>
</span></span><span style="display:flex;"><span>... <span style="color:#75715e"># ä¸‹é¢è¿™è¡Œä¸­KUBELET_EXTRA_ARGS=ååŠ å…¥é…ç½®</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_EXTRA_ARGS=--tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 --image-pull-progress-deadline=30m&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é›†ç¾¤é…ç½®ä¼˜åŒ–ï¼Œè¯¦è§https://kubernetes.io/zh/docs/tasks/administer-cluster/reserve-compute-resources/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /etc/kubernetes/kubelet-conf.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®</span>
</span></span><span style="display:flex;"><span>rotateServerCertificates: true
</span></span><span style="display:flex;"><span>allowedUnsafeSysctls: <span style="color:#75715e"># å…è®¸åœ¨ä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œæ­¤æ“ä½œæŒ‰æƒ…å†µé€‰æ‹©ï¼Œç”¨ä¸åˆ°å°±ä¸ç”¨è®¾ç½®</span>
</span></span><span style="display:flex;"><span> - <span style="color:#e6db74">&#34;net.core*&#34;</span>
</span></span><span style="display:flex;"><span> - <span style="color:#e6db74">&#34;net.ipv4.*&#34;</span>
</span></span><span style="display:flex;"><span>kubeReserved: <span style="color:#75715e"># ä¸ºKubernetesé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹ç»„ä»¶é¢„ç•™èµ„æºï¼Œä¾‹å¦‚ï¼škubeletã€Runtimeç­‰</span>
</span></span><span style="display:flex;"><span>  cpu: <span style="color:#e6db74">&#34;100m&#34;</span>
</span></span><span style="display:flex;"><span>  memory: 100Mi
</span></span><span style="display:flex;"><span>  ephemeral-storage: 1Gi
</span></span><span style="display:flex;"><span>systemReserved: <span style="color:#75715e"># ä¸ºç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹é¢„ç•™èµ„æºï¼Œä¾‹å¦‚ï¼šsshdã€cronç­‰</span>
</span></span><span style="display:flex;"><span>  cpu: <span style="color:#e6db74">&#34;100m&#34;</span>
</span></span><span style="display:flex;"><span>  memory: 100Mi
</span></span><span style="display:flex;"><span>  ephemeral-storage: 1Gi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ›´æ”¹kube-proxyæ¨¡å¼ä¸ºipvs</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 dashboard<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl edit cm kube-proxy -n kube-system</span>
</span></span><span style="display:flex;"><span>mode: <span style="color:#e6db74">&#34;ipvs&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ›´æ–°kube-proxyçš„pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 dashboard<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl patch daemonset kube-proxy -p &#34;{\&#34;spec\&#34;:{\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;date\&#34;:\&#34;`date +&#39;%s&#39;`\&#34;}}}}}&#34; -n kube-system</span>
</span></span><span style="display:flex;"><span>daemonset.apps/kube-proxy patched
</span></span><span style="display:flex;"><span><span style="color:#75715e"># éªŒè¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 dashboard<span style="color:#f92672">]</span><span style="color:#75715e"># curl 127.0.0.1:10249/proxyMode</span>
</span></span><span style="display:flex;"><span>ipvs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºé›†ç¾¤èŠ‚ç‚¹æ‰“æ ‡ç­¾ï¼Œåˆ é™¤æ ‡ç­¾æŠŠ = æ¢æˆ - å³å¯</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node01 node-role.kubernetes.io/node<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node02 node-role.kubernetes.io/node<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-master01 node-role.kubernetes.io/master<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-master02 node-role.kubernetes.io/master<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-master03 node-role.kubernetes.io/master<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ·»åŠ æ ‡ç­¾åæŸ¥çœ‹é›†ç¾¤çŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME           STATUS   ROLES    AGE    VERSION
</span></span><span style="display:flex;"><span>k8s-master01   Ready    master   100m   v1.23.0
</span></span><span style="display:flex;"><span>k8s-master02   Ready    master   100m   v1.23.0
</span></span><span style="display:flex;"><span>k8s-master03   Ready    master   100m   v1.23.0
</span></span><span style="display:flex;"><span>k8s-node01     Ready    node     100m   v1.23.0
</span></span><span style="display:flex;"><span>k8s-node02     Ready    node     100m   v1.23.0
</span></span></code></pre></div><p>ç”Ÿäº§ç¯å¢ƒå»ºè®®ETCDé›†ç¾¤å’ŒKubernetesé›†ç¾¤åˆ†ç¦»ï¼Œè€Œä¸”ä½¿ç”¨é«˜æ€§èƒ½æ•°æ®ç›˜å­˜å‚¨æ•°æ®ï¼Œæ ¹æ®æƒ…å†µå†³å®šæ˜¯å¦å°†MasterèŠ‚ç‚¹ä¹Ÿä½œä¸ºPodè°ƒåº¦èŠ‚ç‚¹ã€‚</p>
<h2 id="æµ‹è¯•é›†ç¾¤">æµ‹è¯•é›†ç¾¤<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•é›†ç¾¤">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æµ‹è¯•namespace</span>
</span></span><span style="display:flex;"><span>kubectl get namespace
</span></span><span style="display:flex;"><span>kubectl create namespace test
</span></span><span style="display:flex;"><span>kubectl get namespace
</span></span><span style="display:flex;"><span>kubectl delete namespace test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºnginxå®ä¾‹å¹¶å¼€æ”¾ç«¯å£</span>
</span></span><span style="display:flex;"><span>kubectl create deployment nginx --image<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>kubectl expose deployment nginx --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --type<span style="color:#f92672">=</span>NodePort
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹è°ƒåº¦çŠ¶æ€å’Œç«¯å£å·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod,svc -owide</span>
</span></span><span style="display:flex;"><span>NAME                         READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>pod/nginx-85b98978db-7mn6r   1/1     Running   <span style="color:#ae81ff">0</span>          2m16s   172.27.14.193   k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE    SELECTOR
</span></span><span style="display:flex;"><span>service/kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        59m    &lt;none&gt;
</span></span><span style="display:flex;"><span>service/nginx        NodePort    10.104.33.99   &lt;none&gt;        80:31720/TCP   2m6s   app<span style="color:#f92672">=</span>nginx
</span></span></code></pre></div><p>å¯è§è°ƒåº¦åˆ°äº†k8s-master02ï¼ˆIPåœ°å€æ˜¯192.168.43.184ï¼‰ä¸Šï¼Œå¯¹åº”çš„NodePortä¸º31720</p>
<p>åœ¨æµè§ˆå™¨è¾“å…¥<a href="http://192.168.43.184:31720/"  target="_blank" rel="noopener" style="color:#42b983" ;>http://192.168.43.184:31720/</a> è®¿é—®nginxï¼Œè®¿é—®ç»“æœå¦‚å›¾</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20211213143124.png" alt="20211213143124"  />
</p>
<p>è‡³æ­¤ï¼ŒåŸºäºkubeadmçš„Kubernetesé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²å¹¶éªŒè¯æˆåŠŸã€‚</p>


        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesbinaryinstallation-ha/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>KubernetesBinaryInstallation HA</span>
  </a>
  <a class="next" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesarchitecture-ha/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>KubernetesArchitecture HA</span>
  </a>
</nav>

        </footer>
    </div>
</article>
</main>

<footer class="footer">
    
        <span id="runtime_span"></span>
        <script
            type="text/javascript">function show_runtime() { window.setTimeout("show_runtime()", 1000); X = new Date("1/1/2023 1:00:00"); Y = new Date(); T = (Y.getTime() - X.getTime()); M = 24 * 60 * 60 * 1000; a = T / M; A = Math.floor(a); b = (a - A) * 24; B = Math.floor(b); c = (b - B) * 60; C = Math.floor((b - B) * 60); D = Math.floor((c - C) * 60); runtime_span.innerHTML = "ç½‘ç«™å·²è¿è¡Œ" + A + "å¤©" + B + "å°æ—¶" + C + "åˆ†" + D + "ç§’" } show_runtime();</script>
    
    
    <br>
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="https://deemoprobe.github.io/" style="color:#939393;">William&#39;s Blog</a>
        All Rights Reserved
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>

<script>
    $("code[class^=language] ").on("mouseover", function () {
        if (this.clientWidth < this.scrollWidth) {
            $(this).css("width", "135%")
            $(this).css("border-top-right-radius", "var(--radius)")
        }
    }).on("mouseout", function () {
        $(this).css("width", "100%")
        $(this).css("border-top-right-radius", "unset")
    })
</script>
</body>

</html>
