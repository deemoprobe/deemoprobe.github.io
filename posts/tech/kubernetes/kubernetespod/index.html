<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>KubernetesPod | William&#39;s Blog</title>
<meta name="keywords" content="kubernetes">
<meta name="description" content="Kubernetes Pod">
<meta name="author" content="deemoprobe">
<link rel="canonical" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetespod/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.86a98c52ea686f5031e49bb9626478e3e3886f043822229977ef4042e6f8bbb3.css" integrity="sha256-hqmMUupob1Ax5Ju5YmR44&#43;OIbwQ4IiKZd&#43;9AQub4u7M=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://deemoprobe.github.io/img/bear.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://deemoprobe.github.io/img/bear.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://deemoprobe.github.io/img/bear.png">
<link rel="apple-touch-icon" href="https://deemoprobe.github.io/img/bear.png">
<link rel="mask-icon" href="https://deemoprobe.github.io/img/bear.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="KubernetesPod" />
<meta property="og:description" content="Kubernetes Pod" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetespod/" />
<meta property="og:image" content="https://deemoprobe.github.io/img/kubernetes.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-29T14:23:11+08:00" />
<meta property="article:modified_time" content="2023-04-29T14:23:11+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://deemoprobe.github.io/img/kubernetes.png" />
<meta name="twitter:title" content="KubernetesPod"/>
<meta name="twitter:description" content="Kubernetes Pod"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://deemoprobe.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
          "item": "https://deemoprobe.github.io/posts/tech/"
        },

        {
          "@type": "ListItem",
          "position":  3 ,
          "name": "Kubernetes",
          "item": "https://deemoprobe.github.io/posts/tech/kubernetes/"
        }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "KubernetesPod",
      "item": "https://deemoprobe.github.io/posts/tech/kubernetes/kubernetespod/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "KubernetesPod",
  "name": "KubernetesPod",
  "description": "Kubernetes Pod",
  "keywords": [
    "kubernetes"
  ],
  "articleBody": "æ¦‚å¿µ Podæ˜¯Kubernetesä¸­åˆ›å»ºç®¡ç†å’Œå¯éƒ¨ç½²çš„æœ€å°è®¡ç®—å•å…ƒï¼Œå®ƒç”±ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ç»„æˆï¼Œæ¯ä¸ªPodåŒ…å«äº†ä¸€ä¸ªPauseå®¹å™¨ï¼ŒPauseå®¹å™¨æ˜¯Podçš„çˆ¶å®¹å™¨ï¼Œè´Ÿè´£åƒµå°¸è¿›ç¨‹çš„å›æ”¶ç®¡ç†ï¼Œé€šè¿‡Pauseå®¹å™¨å¯ä»¥ä½¿åŒä¸€ä¸ªPodé‡Œé¢çš„å¤šä¸ªå®¹å™¨å…±äº«å­˜å‚¨ã€ç½‘ç»œã€PIDã€IPCç­‰ã€‚\nå®šä¹‰Pod Pod ä¸­çš„å®¹å™¨ä¼šè¢«è°ƒåº¦åˆ°é›†ç¾¤ä¸­çš„åŒä¸€è®¡ç®—èŠ‚ç‚¹ä¸Šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¾ˆå°‘å»ç›´æ¥åˆ›å»ºPodå•å®ä¾‹ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡Podæ§åˆ¶å™¨ï¼ˆDeploymentã€DaemonSetã€StatefulSetã€CronJobç­‰ï¼‰è¿›è¡Œåˆ›å»ºå’Œç®¡ç†ï¼Œå¹¶ä¸”è¿™äº›é«˜çº§èµ„æºå…·æœ‰Podæ‰€ä¸å…·å¤‡çš„å¾ˆå¤šç‰¹æ€§ï¼ˆå¦‚æ— çŠ¶æ€æœåŠ¡æ§åˆ¶å™¨deploymentçš„ä¼¸ç¼©å›æ»šï¼Œæœ‰çŠ¶æ€æœåŠ¡æ§åˆ¶å™¨StatefulSetçš„å®ä¾‹ç»‘å®šï¼‰ã€‚æ§åˆ¶å™¨åˆ›å»ºPodåScheduleræ ¹æ®é¢„è®¾æ¡ä»¶å’Œè°ƒåº¦ç®—æ³•å°†Podè°ƒåº¦åˆ°é›†ç¾¤åˆé€‚çš„èŠ‚ç‚¹ä¸Šï¼ŒPodä¼šä¿æŒåœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç›´åˆ°Podç»“æŸæ‰§è¡Œã€Podå¯¹è±¡è¢«åˆ é™¤ã€Podå› èµ„æºä¸è¶³è€Œè¢«é©±é€æˆ–è€…èŠ‚ç‚¹å¤±æ•ˆä¸ºæ­¢ã€‚\nè¯´æ˜ï¼šé‡å¯ Pod ä¸­çš„å®¹å™¨ä¸åº”ä¸é‡å¯ Pod æ··æ·†ã€‚ Pod ä¸æ˜¯è¿›ç¨‹ï¼Œè€Œæ˜¯å®¹å™¨è¿è¡Œçš„ç¯å¢ƒã€‚åœ¨è¢«åˆ é™¤ä¹‹å‰ï¼ŒPod ä¼šä¸€ç›´å­˜åœ¨ã€‚\nPod yamlæ–‡ä»¶ç¤ºä¾‹\n[root@k8s-master01 ~]# kubectl explain pod | egrep -v \"^$|^\\s*http\"|sed s/\"More info:\"// KIND: Pod VERSION: v1 DESCRIPTION: Pod is a collection of containers that can run on a host. This resource is created by clients and scheduled onto hosts. FIELDS: apiVersion APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. kind Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. metadata Standard object's metadata. spec Specification of the desired behavior of the pod. status Most recently observed status of the pod. This data may not be up to date. Populated by the system. Read-only. # yamlæ–‡ä»¶ç¤ºä¾‹ apiVersion: v1 # å¿…é€‰ï¼ŒAPIçš„ç‰ˆæœ¬å· kind: Pod # å¿…é€‰ï¼Œç±»å‹Pod metadata: # å¿…é€‰ï¼Œå…ƒæ•°æ® name: nginx # å¿…é€‰ï¼Œç¬¦åˆRFC1035è§„èŒƒçš„Podåç§° namespace: default # å¯é€‰ï¼ŒPodæ‰€åœ¨çš„å‘½åç©ºé—´ï¼Œé»˜è®¤ä¸ºdefault labels: # å¯é€‰ï¼Œæ ‡ç­¾é€‰æ‹©å™¨ï¼Œä¸€èˆ¬ç”¨äºè¿‡æ»¤å’ŒåŒºåˆ†Pod app: nginx role: frontend # å¯ä»¥å†™å¤šä¸ª annotations: # å¯é€‰ï¼Œæ³¨é‡Šé”®å€¼å¯¹åˆ—è¡¨ï¼Œå¯ä»¥å†™å¤šä¸ª app: nginx spec: # å¿…é€‰ï¼Œç”¨äºå®šä¹‰å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯ initContainers: # åˆå§‹åŒ–å®¹å™¨ï¼Œåœ¨å®¹å™¨å¯åŠ¨ä¹‹å‰æ‰§è¡Œçš„ä¸€äº›åˆå§‹åŒ–æ“ä½œ - command: - sh - -c - echo \"I am InitContainer for init some configuration\" image: busybox imagePullPolicy: IfNotPresent name: init-container containers: # å¿…é€‰ï¼Œå®¹å™¨åˆ—è¡¨ - name: nginx # å¿…é€‰ï¼Œç¬¦åˆRFC 1035è§„èŒƒçš„å®¹å™¨åç§° image: nginx:latest # å¿…é€‰ï¼Œå®¹å™¨æ‰€ç”¨çš„é•œåƒçš„åœ°å€ imagePullPolicy: Always # å¯é€‰ï¼Œé•œåƒæ‹‰å–ç­–ç•¥ command: # å¯é€‰ï¼Œå®¹å™¨å¯åŠ¨æ‰§è¡Œçš„å‘½ä»¤ - nginx - -g - \"daemon off;\" workingDir: /usr/share/nginx/html # å¯é€‰ï¼Œå®¹å™¨çš„å·¥ä½œç›®å½• volumeMounts: # å¯é€‰ï¼Œå­˜å‚¨å·é…ç½®ï¼Œå¯ä»¥é…ç½®å¤šä¸ª - name: webroot # å­˜å‚¨å·åç§° mountPath: /usr/share/nginx/html # æŒ‚è½½ç›®å½• readOnly: true # åªè¯» ports: # å¯é€‰ï¼Œå®¹å™¨éœ€è¦æš´éœ²çš„ç«¯å£å·åˆ—è¡¨ - name: http # ç«¯å£åç§° containerPort: 80 # ç«¯å£å· protocol: TCP # ç«¯å£åè®®ï¼Œé»˜è®¤TCP env: # å¯é€‰ï¼Œç¯å¢ƒå˜é‡é…ç½®åˆ—è¡¨ - name: TZ # å˜é‡å value: Asia/Shanghai # å˜é‡çš„å€¼ - name: LANG value: en_US.utf8 resources: # å¯é€‰ï¼Œèµ„æºé™åˆ¶å’Œèµ„æºè¯·æ±‚é™åˆ¶ limits: # æœ€å¤§é™åˆ¶è®¾ç½® cpu: 1000m memory: 1024Mi requests: # å¯åŠ¨æ‰€éœ€çš„èµ„æº cpu: 100m memory: 512Mi # startupProbe: # å¯é€‰ï¼Œæ£€æµ‹å®¹å™¨å†…è¿›ç¨‹æ˜¯å¦å®Œæˆå¯åŠ¨ã€‚æ³¨æ„ä¸‰ç§æ£€æŸ¥æ–¹å¼åŒæ—¶åªèƒ½ä½¿ç”¨ä¸€ç§ã€‚ # httpGet: # httpGetæ£€æµ‹æ–¹å¼ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨httpGetå®ç°æ¥å£çº§å¥åº·æ£€æŸ¥ï¼Œå¥åº·æ£€æŸ¥ç”±åº”ç”¨ç¨‹åºæä¾›ã€‚ # path: /api/successStart # æ£€æŸ¥è·¯å¾„ # port: 80 readinessProbe: # å¯é€‰ï¼Œå¥åº·æ£€æŸ¥ã€‚æ³¨æ„ä¸‰ç§æ£€æŸ¥æ–¹å¼åŒæ—¶åªèƒ½ä½¿ç”¨ä¸€ç§ã€‚ httpGet: # httpGetæ£€æµ‹æ–¹å¼ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨httpGetå®ç°æ¥å£çº§å¥åº·æ£€æŸ¥ï¼Œå¥åº·æ£€æŸ¥ç”±åº”ç”¨ç¨‹åºæä¾›ã€‚ path: / # æ£€æŸ¥è·¯å¾„ port: 80 # ç›‘æ§ç«¯å£ #livenessProbe: # å¯é€‰ï¼Œå¥åº·æ£€æŸ¥ #exec: # æ‰§è¡Œå®¹å™¨å‘½ä»¤æ£€æµ‹æ–¹å¼ #command: #- cat #- /health #httpGet: # httpGetæ£€æµ‹æ–¹å¼ # path: /_health # æ£€æŸ¥è·¯å¾„ # port: 8080 # httpHeaders: # æ£€æŸ¥çš„è¯·æ±‚å¤´ # - name: end-user # value: Jason tcpSocket: # ç«¯å£æ£€æµ‹æ–¹å¼ port: 80 initialDelaySeconds: 60 # åˆå§‹åŒ–æ—¶é—´ timeoutSeconds: 2 # è¶…æ—¶æ—¶é—´ periodSeconds: 20 # æ£€æµ‹é—´éš” successThreshold: 2 # æ£€æŸ¥æˆåŠŸä¸º2æ¬¡è¡¨ç¤ºå°±ç»ª failureThreshold: 1 # æ£€æµ‹å¤±è´¥1æ¬¡è¡¨ç¤ºæœªå°±ç»ª lifecycle: postStart: # å®¹å™¨åˆ›å»ºå®Œæˆåæ‰§è¡Œçš„æŒ‡ä»¤, å¯ä»¥æ˜¯exec httpGet TCPSocket exec: command: - sh - -c - 'mkdir /data/' preStop: httpGet: path: / port: 80 # exec: # command: # - sh # - -c # - sleep 9 restartPolicy: Always # å¯é€‰ï¼Œé»˜è®¤ä¸ºAlways #nodeSelector: # å¯é€‰ï¼ŒæŒ‡å®šNodeèŠ‚ç‚¹ # region: subnet7 imagePullSecrets: # å¯é€‰ï¼Œæ‹‰å–é•œåƒä½¿ç”¨çš„secretï¼Œå¯ä»¥é…ç½®å¤šä¸ª - name: default-dockercfg-86258 hostNetwork: false # å¯é€‰ï¼Œæ˜¯å¦ä¸ºä¸»æœºæ¨¡å¼ï¼Œå¦‚æ˜¯ï¼Œä¼šå ç”¨ä¸»æœºç«¯å£ volumes: # å…±äº«å­˜å‚¨å·åˆ—è¡¨ - name: webroot # åç§°ï¼Œä¸ä¸Šé¢volumeMountså¯¹åº” emptyDir: {} # æŒ‚è½½ç›®å½• #hostPath: # æŒ‚è½½æœ¬æœºç›®å½• # path: /etc/hosts åœ¨é«˜çº§èµ„æºä¸­åˆ›å»ºPodæ˜¯é€šè¿‡æ–‡ä»¶ä¸­template Podæ¨¡æ¿å­—æ®µæ¥åˆ›å»ºPod\n# ä¾‹å¦‚åˆ›å»ºJobï¼Œ apiVersion: batch/v1 kind: Job metadata: name: hello spec: template: # è¿™é‡Œæ˜¯Podå¯¹è±¡æ¨¡ç‰ˆ spec: containers: - name: hello image: busybox command: ['sh', '-c', 'echo \"Hello, Kubernetes!\" \u0026\u0026 sleep 3600'] restartPolicy: OnFailure ... é›¶å®•æœºéƒ¨ç½² Podçš„é›¶å®•æœºä¸Šä¸‹çº¿ï¼Œå¯ä»¥é€šè¿‡åŠ å…¥åˆå§‹åŒ–å®¹å™¨ï¼ˆInitContainersï¼‰ã€Podä¸Šçº¿æ¥æ”¶æµé‡å‰çš„**å¥åº·æ£€æŸ¥ï¼ˆæ¢é’ˆStartupProbe/LivenessProbe/ReadinessProbeï¼‰å’ŒPodç”Ÿå‘½å‘¨æœŸå›è°ƒ(postStart/preStop)**æ¥å®ç°ã€‚å€Ÿæ­¤å¯ä»¥å®ç°deploymenté›¶å®•æœºæ»šåŠ¨æ›´æ–°ã€‚\nåˆå§‹åŒ–å®¹å™¨ åˆå§‹åŒ–å®¹å™¨å³InitContainerï¼Œä¸»è¦ä½œç”¨æ˜¯åœ¨ä¸»åº”ç”¨å®¹å™¨å¯åŠ¨ä¹‹å‰ï¼Œåšä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œæ¯”å¦‚åˆ›å»ºæ–‡ä»¶ã€ä¿®æ”¹å†…æ ¸å‚æ•°ã€ç­‰å¾…ä¾èµ–ç¨‹åºå¯åŠ¨æˆ–å…¶ä»–éœ€è¦åœ¨ä¸»ç¨‹åºå¯åŠ¨ä¹‹å‰éœ€è¦åšçš„å·¥ä½œã€‚å¸¸è§ç”¨é€”æœ‰ï¼š\nå®‰è£…åº”ç”¨å®¹å™¨ä¸­ä¸å­˜åœ¨çš„å®ç”¨å·¥å…·æˆ–ä¸ªæ€§åŒ–ä»£ç  å®‰å…¨åœ°è¿è¡Œè¿™äº›å·¥å…·ï¼Œé¿å…è¿™äº›å·¥å…·å¯¼è‡´åº”ç”¨é•œåƒçš„å®‰å…¨æ€§é™ä½ rootèº«ä»½æ‰§è¡Œä¸€äº›é«˜æƒé™å‘½ä»¤ åˆå§‹åŒ–å®¹å™¨ç›¸å…³æ“ä½œæ‰§è¡Œå®Œæˆåé€€å‡ºï¼Œä¸ä¼šç»™ä¸šåŠ¡å®¹å™¨å¸¦æ¥å®‰å…¨éšæ‚£\nInitContainerä¸postStartçš„åŒºåˆ«ï¼š\nInitContainerï¼šä¸ä¾èµ–ä¸»å®¹å™¨ï¼Œå¯ä»¥æœ‰æ›´é«˜çš„æƒé™ï¼Œä¸€å®šä¼šåœ¨ä¸»å®¹å™¨å¯åŠ¨ä¹‹å‰å®Œæˆ postStartï¼šä¾èµ–ä¸»å®¹å™¨ï¼Œè¿™ä¸ªå›è°ƒåœ¨ä¸»å®¹å™¨è¢«åˆ›å»ºä¹‹åç«‹å³æ‰§è¡Œã€‚ä½†æ˜¯ä¸èƒ½ä¿è¯ä¼šåœ¨å®¹å™¨å¯åŠ¨å‰æ‰§è¡Œï¼Œå³å…¥å£ç‚¹ï¼ˆENTRYPOINTï¼‰ä¹‹å‰æ‰§è¡Œã€‚ InitContainerä¸æ™®é€šå®¹å™¨çš„åŒºåˆ«ï¼š\næ™®é€šå®¹å™¨è€ƒè™‘åˆ°å®‰å…¨æ€§ï¼Œé€šå¸¸æƒé™ä¸ä¼šç»™å¾ˆå¤§ï¼ŒInitContainerå¯ä»¥æ‰§è¡Œé«˜æƒé™çš„æ“ä½œï¼Œæ“ä½œå®Œæˆç«‹å³é€€å‡º æ€»æ˜¯è¿è¡Œåˆ°å®Œæˆï¼Œä¸å®Œæˆä¸ä¼šå¯åŠ¨ä¸»å®¹å™¨ å¤šä¸ªåˆå§‹åŒ–å®¹å™¨ï¼Œä¸Šä¸€ä¸ªè¿è¡Œå®Œæˆæ‰ä¼šè¿è¡Œä¸‹ä¸€ä¸ª å¦‚æœPodçš„InitContainerå¤±è´¥ï¼ŒKubernetesä¼šä¸æ–­åœ°é‡å¯è¯¥Podï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼Œé™¤éPodçš„restartPolicyå€¼ä¸ºNever ä¸æ”¯æŒ lifecycleã€livenessProbeã€readinessProbe å’Œ startupProbe # å®ä¾‹ [root@k8s-master01 yamls]# vim initcontainer.yml apiVersion: apps/v1 kind: Deployment metadata: labels: app: test-init name: test-init namespace: kube-public spec: replicas: 1 selector: matchLabels: app: test-init template: # podé…ç½® metadata: labels: app: test-init spec: volumes: - name: data emptyDir: {} initContainers: # åœ¨åº”ç”¨å®¹å™¨å¯åŠ¨å‰ä½¿ç”¨rootæƒé™åˆ›å»ºç›¸å…³æ–‡ä»¶ - command: - sh - -c - touch /mnt/test-init.txt image: nginx imagePullPolicy: IfNotPresent name: init-touch volumeMounts: - name: data mountPath: /mnt containers: - image: nginx imagePullPolicy: IfNotPresent name: test-init volumeMounts: - name: data mountPath: /mnt [root@k8s-master01 yamls]# kubectl apply -f initcontainer.yml [root@k8s-master01 yamls]# kubectl get deploy,po -n kube-public NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/test-init 1/1 1 1 5m5s NAME READY STATUS RESTARTS AGE pod/test-init-6d4c45d5b7-4qnl8 1/1 Running 0 5m5s [root@k8s-master01 yamls]# kubectl exec -it -n kube-public test-init-6d4c45d5b7-4qnl8 -- ls /mnt Defaulted container \"test-init\" out of: test-init, init-touch (init) test-init.txt Podæ¢é’ˆ ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”ç”¨å®¹å™¨èƒ½æ­£å¸¸å¯åŠ¨å¹¶ä¸ä»£è¡¨èƒ½æ­£å¸¸å¤„ç†è¯·æ±‚ï¼Œæ‰€ä»¥è¦åˆç†é…ç½®å¥åº·æ£€æŸ¥ã€‚Podå¥åº·æ£€æŸ¥æœ‰ä¸‰ç§æ¢é’ˆï¼š\nstartupProbeï¼ˆ1.16ç‰ˆæœ¬åï¼‰ï¼šç”¨äºåˆ¤æ–­å®¹å™¨å†…åº”ç”¨ç¨‹åºæ˜¯å¦å·²ç»å¯åŠ¨ã€‚å¦‚æœé…ç½®äº†startupProbeï¼Œä¼šå…ˆç¦æ­¢å…¶ä»–çš„æ¢æµ‹ï¼Œç›´åˆ°å®¹å™¨æˆåŠŸå†…ç¨‹åºå¯åŠ¨ä¸ºæ­¢ã€‚å¦‚æœæ¢æµ‹å¤±è´¥ï¼Œkubeletä¼šæ€æ­»å®¹å™¨å¹¶æ ¹æ®é‡å¯ç­–ç•¥å¤„ç†ï¼›å¦‚æœæ¢æµ‹æˆåŠŸï¼Œæˆ–æœªé…ç½®startupProbeæ¢é’ˆï¼Œåˆ™æ ‡è®°ä¸ºsuccess livenessProbeï¼šç”¨äºæ¢æµ‹å®¹å™¨æ˜¯å¦åœ¨è¿è¡Œï¼ˆå­˜æ´»ï¼‰ï¼Œå¦‚æœæ¢æµ‹å¤±è´¥ï¼Œkubeletä¼šæ€æ­»å®¹å™¨æ ¹æ®é‡å¯ç­–ç•¥å¤„ç†ã€‚è‹¥æ²¡æœ‰é…ç½®è¯¥æ¢é’ˆï¼Œåˆ™æ ‡è®°ä¸ºsuccess readinessProbeï¼šä¸€èˆ¬ç”¨äºæ¢æµ‹å®¹å™¨å†…çš„ç¨‹åºæ˜¯å¦å‡†å¤‡å°±ç»ªï¼ˆæ¥æ”¶å¤„ç†è¯·æ±‚ï¼‰ï¼Œå¦‚æœæ¢æµ‹å¤±è´¥ï¼ŒEndpoint Controllerå°†ä»Serviceçš„Endpointsä¸­åˆ é™¤è¯¥Podçš„IPåœ°å€ã€‚è‹¥æœªé…ç½®è¯¥æ¢é’ˆåˆ™é»˜è®¤æ ‡è®°ä¸ºsuccess Podæ¢é’ˆçš„å®ç°æ–¹å¼ ExecActionï¼šåœ¨å®¹å™¨å†…æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œå¦‚æœè¿”å›å€¼ä¸º0ï¼Œåˆ™è®¤ä¸ºå®¹å™¨å¥åº· TCPSocketActionï¼šé€šè¿‡TCPè¿æ¥æ£€æŸ¥å®¹å™¨å†…çš„ç«¯å£æ˜¯å¦æ˜¯é€šçš„ï¼Œå¦‚æœæ˜¯é€šçš„å°±è®¤ä¸ºå®¹å™¨å¥åº· HTTPGetActionï¼šé€šè¿‡åº”ç”¨ç¨‹åºæš´éœ²çš„APIåœ°å€æ¥æ£€æŸ¥ç¨‹åºæ˜¯å¦æ˜¯æ­£å¸¸çš„ï¼Œå¦‚æœçŠ¶æ€ç ä¸º200~400ä¹‹é—´ï¼Œåˆ™è®¤ä¸ºå®¹å™¨å¥åº· Podå¥åº·æ£€æŸ¥ç»“æœï¼š\nSuccessï¼šæ£€æŸ¥é€šè¿‡ Failedï¼šæ£€æŸ¥å¤±è´¥ï¼Œkubeletæ ¹æ®Podé‡å¯ç­–ç•¥è¿›ä¸€æ­¥å¤„ç† Unknownï¼šæ£€æŸ¥å¤±è´¥ï¼ŒçŠ¶æ€æœªçŸ¥ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç† Podé•œåƒæ‹‰å–ç­–ç•¥ï¼ˆimagePullPolicyï¼‰ï¼š\nAlwaysï¼šæ€»æ˜¯æ‹‰å–ç›´è‡³æˆåŠŸï¼Œé•œåƒtagæœªæŒ‡å®šæ—¶ï¼ˆå³latestï¼‰ï¼Œé»˜è®¤ä¸ºAlways Neverï¼šæ— è®ºé•œåƒæ˜¯å¦å­˜åœ¨éƒ½ä¸æ‹‰å– IfNotPresentï¼šé•œåƒä¸å­˜åœ¨æ—¶æ‹‰å– Podé‡å¯ç­–ç•¥ï¼ˆrestartPolicyï¼‰ï¼š\nAlwaysï¼šé»˜è®¤ç­–ç•¥ï¼Œå®¹å™¨å¤±æ•ˆæ—¶ï¼Œè‡ªåŠ¨é‡å¯ OnFailureï¼šå®¹å™¨ä»¥ä¸ä¸º0çš„çŠ¶æ€ç ç»ˆæ­¢ï¼Œè‡ªåŠ¨é‡å¯ Neverï¼šæ— è®ºä½•ç§çŠ¶æ€ï¼Œéƒ½ä¸é‡å¯ ä¸‹é¢æ¡ˆä¾‹corednsçš„å¥åº·æ£€æŸ¥é…ç½®ä¸­livenessProbeé€šè¿‡httpGetçš„æ–¹å¼æ£€æµ‹æä¾›8080/healthæ¥å£ï¼Œæ£€æŸ¥å®¹å™¨æ˜¯å¦å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ£€æŸ¥é€šè¿‡åæ¥ç€è¿›è¡ŒReadinessProbeæ¢é’ˆæ£€æµ‹ï¼ŒhttpGetæ–¹å¼æ£€æµ‹æä¾›çš„8181/readyæ¥å£ï¼Œæ£€æµ‹é€šè¿‡åˆ™è¡¨ç¤ºå®¹å™¨å†…ç¨‹åºè¿è¡Œæ­£å¸¸ï¼Œå¯ä»¥æ¥æ”¶æµé‡ã€‚å¥åº·æ£€æŸ¥æ¥å£éœ€è¦åœ¨é•œåƒä¸­é¢„å®šç¨‹åºæºç ä¸­å†™å¥½ï¼Œä¸ºåç»­æ¥å…¥å¥åº·æ£€æŸ¥åšå‡†å¤‡ã€‚\n# ä»¥corednsä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°å¥åº·æ£€æŸ¥é…ç½®äº†LivenessProbeå’ŒReadinessProbe [root@k8s-master01 ~]# kubectl get deploy -n kube-system coredns -oyaml ... spec: containers: ... livenessProbe: failureThreshold: 5 httpGet: path: /health port: 8080 scheme: HTTP initialDelaySeconds: 60 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 5 ... readinessProbe: failureThreshold: 3 httpGet: path: /ready port: 8181 scheme: HTTP periodSeconds: 10 successThreshold: 1 timeoutSeconds: 11 ... ç‰¹æ®Šæƒ…å†µï¼šå¦‚æœé‡åˆ°å®¹å™¨å†…ç¨‹åºå¯åŠ¨æ—¶é—´å¤ªé•¿ï¼Œè¶…è¿‡äº†initialDelaySecondsè®¾å®šçš„å®¹å™¨åˆå§‹åŒ–æ—¶é—´ï¼Œé‚£ä¹ˆå¥åº·æ£€æŸ¥ä¹Ÿä¸ä¼šé€šè¿‡ï¼Œå®¹å™¨ä¼šä¸æ–­è¢«æ€æ‰é‡å¯ï¼Œé€ æˆæœåŠ¡æ— æ³•æ­£å¸¸è¿è¡Œã€‚åƒä¸Šé¢è¿™äº›æƒ…å†µå°±éœ€è¦æ£€æµ‹å®¹å™¨å†…ç¨‹åºæ˜¯å¦å¥åº·ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨startupProbeã€‚\næ¢é’ˆæ£€æŸ¥å‚æ•°é…ç½® initialDelaySeconds: 10 # å®¹å™¨å¯åŠ¨ä¸”å­˜æ´»ï¼Œç­‰å¾…10såå¼€å§‹æ£€æµ‹ã€‚è‹¥ä¸é…ç½®ï¼Œé»˜è®¤ä¸º0s timeoutSeconds: 2 # æ£€æµ‹è¶…æ—¶åçš„ç­‰å¾…æ—¶é—´ï¼Œé»˜è®¤ä¸º1s periodSeconds: 20 # æ£€æµ‹é—´éš”æ—¶é—´ï¼Œé»˜è®¤ä¸º10s successThreshold: 1 # æ£€æµ‹è¿ç»­æˆåŠŸ1æ¬¡åæ ‡è®°Podå°±ç»ª failureThreshold: 2 # æ£€æµ‹è¿ç»­å¤±è´¥2æ¬¡åæ ‡è®°Podå¤±è´¥ startupProbeå®ä¾‹ é‡‡ç”¨HTTPGetActionæ¢æµ‹æ–¹å¼\nå®ä¾‹ä½¿ç”¨çš„nginx:latesté•œåƒå¹¶æ²¡æœ‰é¢„è®¾ä¸‹é¢æ‰€å†™çš„å¥åº·æ£€æŸ¥æ¥å£ï¼Œæ‰€ä»¥æ£€æµ‹æ˜¯ä¸ä¼šé€šè¿‡çš„ï¼Œå¯ä»¥é€šè¿‡EventsæŸ¥çœ‹ã€‚é‡å¯ç­–ç•¥å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤æ˜¯restartPolicy: Alwaysï¼Œå¤±è´¥åä¼šä¸€ç›´é‡å¯\n[root@k8s-master01 ~]# cat \u003c\u003c \"EOF\" \u003e startupprobe-httpget.yaml apiVersion: v1 kind: Pod metadata: labels: test: startupprobe-httpget name: startupprobe-httpget spec: containers: - name: nginx image: nginx ports: - containerPort: 8080 startupProbe: httpGet: path: /health port: 8080 initialDelaySeconds: 15 timeoutSeconds: 1 EOF [root@k8s-master01 ~]# kubectl apply -f startupprobe-httpget.yaml pod/startupprobe-httpget created [root@k8s-master01 ~]# kubectl describe po startupprobe-httpget ... Startup: http-get http://:8080/health delay=15s timeout=1s period=10s #success=1 #failure=3 ... Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 56s default-Scheduler Successfully assigned default/startupprobe-httpget to k8s-node02 Normal Pulling 56s kubelet Pulling image \"nginx\" Normal Pulled 40s kubelet Successfully pulled image \"nginx\" in 15.591936231s Normal Created 40s kubelet Created container nginx Normal Started 40s kubelet Started container nginx Warning Unhealthy 7s (x2 over 17s) kubelet Startup probe failed: Get \"http://172.27.14.202:8080/health\": dial tcp 172.27.14.202:8080: connect: connection refused # æŸ¥çœ‹PodçŠ¶æ€ï¼Œå¥åº·æ£€æŸ¥ä¸é€šè¿‡ï¼Œå¤„äºRunningä½†å¹¶æ²¡æœ‰Readyï¼Œå¹¶ä¸”è¿˜åœ¨ä¸æ–­é‡å¯ [root@k8s-master01 ~]# kubectl get po NAME READY STATUS RESTARTS AGE startupprobe-httpget 0/1 Running 5 (20s ago) 4m40s livenessProbeå®ä¾‹ é‡‡ç”¨ExecActionæ¢æµ‹æ–¹å¼\n# åˆ›å»ºliveness.yaml [root@k8s-master01 ~]# cat \u003c\u003c \"EOF\" \u003e livenessprobe-exec.yaml apiVersion: v1 kind: Pod metadata: labels: test: livenessprobe-exec name: livenessprobe-exec spec: containers: - name: liveness image: busybox args: - /bin/sh - -c - echo ok \u003e /tmp/healthy; sleep 10; rm -rf /tmp/healthy; sleep 60 livenessProbe: exec: command: - cat - /tmp/healthy initialDelaySeconds: 15 periodSeconds: 5 EOF [root@k8s-master01 ~]# kubectl apply -f livenessprobe-exec.yaml pod/livenessprobe-exec created [root@k8s-master01 ~]# kubectl describe po livenessprobe-exec ... Liveness: exec [cat /tmp/healthy] delay=15s timeout=1s period=5s #success=1 #failure=3 ... Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 34s default-Scheduler Successfully assigned default/livenessprobe-exec to k8s-node02 Normal Pulling 33s kubelet Pulling image \"busybox\" Normal Pulled 20s kubelet Successfully pulled image \"busybox\" in 13.224110856s Normal Created 20s kubelet Created container liveness Normal Started 20s kubelet Started container liveness Warning Unhealthy 4s kubelet Liveness probe failed: cat: can not open '/tmp/healthy': No such file or directory # è§‚å¯ŸPodçŠ¶æ€å¯ä»¥å‘ç°ä¸€å¼€å§‹æ˜¯æ­£å¸¸çš„ï¼Œåé¢å› ä¸ºå¥åº·æ£€æŸ¥å¤±è´¥é‡å¯äº† [root@k8s-master01 ~]# kubectl get po NAME READY STATUS RESTARTS AGE livenessprobe-exec 1/1 Running 0 75s [root@k8s-master01 ~]# kubectl get po NAME READY STATUS RESTARTS AGE livenessprobe-exec 1/1 Running 1 (21s ago) 91s åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼ŒPod ä¸­åªæœ‰ä¸€ä¸ªå®¹å™¨ã€‚periodSecondså­—æ®µæŒ‡å®šäº† kubelet åº”è¯¥æ¯ 5 ç§’æ‰§è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥ã€‚initialDelaySecondså­—æ®µå‘Šè¯‰ kubelet åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹å‰åº”è¯¥ç­‰å¾… 15 ç§’ã€‚ kubelet åœ¨å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤cat /tmp/healthyæ¥è¿›è¡Œæ¢æµ‹ã€‚ å¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸå¹¶ä¸”è¿”å›å€¼ä¸º 0ï¼Œkubelet å°±ä¼šè®¤ä¸ºè¿™ä¸ªå®¹å™¨æ˜¯å¥åº·å­˜æ´»çš„ã€‚ å¦‚æœè¿™ä¸ªå‘½ä»¤è¿”å›é 0 å€¼ï¼Œkubelet ä¼šæ€æ­»è¿™ä¸ªå®¹å™¨å¹¶é‡æ–°å¯åŠ¨å®ƒã€‚\nreadinessProbeå®ä¾‹ é‡‡ç”¨TCPSocketActionæ¢æµ‹æ–¹å¼\nnginxå¯åŠ¨åé»˜è®¤å¼€å¯80ç«¯å£ï¼Œä¸‹é¢å¥åº·æ£€æŸ¥ä¼šé€šè¿‡\n[root@k8s-master01 ~]# vim readinessprobe-tcpsocket.yaml apiVersion: v1 kind: Pod metadata: labels: test: readinessprobe-tcpsocket name: readinessprobe-tcpsocket spec: containers: - name: nginx image: nginx imagePullPolicy: IfNotPresent ports: - containerPort: 80 readinessProbe: tcpSocket: port: 80 initialDelaySeconds: 5 periodSeconds: 10 [root@k8s-master01 ~]# kubectl apply -f readinessprobe-tcpsocket.yaml pod/readinessprobe-tcpsocket created [root@k8s-master01 ~]# kubectl get po readinessprobe-tcpsocket NAME READY STATUS RESTARTS AGE readinessprobe-tcpsocket 1/1 Running 0 20s [root@k8s-master01 ~]# kubectl describe po readinessprobe-tcpsocket ... Readiness: tcp-socket :80 delay=5s timeout=1s period=10s #success=1 #failure=3 ... Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 112s default-Scheduler Successfully assigned default/readinessprobe-tcpsocket to k8s-node02 Normal Pulling 112s kubelet Pulling image \"nginx\" Normal Pulled 102s kubelet Successfully pulled image \"nginx\" in 9.699109421s Normal Created 102s kubelet Created container nginx Normal Started 102s kubelet Started container nginx Successfully pulled image \"nginx\" in 9.699109421sæ‹‰å–é•œåƒèŠ±æ—¶é—´çº¦9.7sï¼Œå¥åº·æ£€æŸ¥é—´éš”æ—¶é—´æ˜¯10sï¼Œæ‰€ä»¥å¤§çº¦åœ¨19.7sPodæ ‡è®°ä¸ºRunningçŠ¶æ€\nPodç”Ÿå‘½å‘¨æœŸ ä»¥ä¸‹Podåˆ›å»ºå’Œåˆ é™¤æµç¨‹å»ºç«‹åœ¨å®¹å™¨è¿è¡Œæ—¶ä¸ºcontainerdåŸºç¡€ä¸Šè¿›è¡Œ\nPodåˆ›å»ºæµç¨‹ ç”¨æˆ·é€šè¿‡kubectlã€RESTful APIæˆ–å…¶ä»–å®¢æˆ·ç«¯å‘APIServerå‘èµ·åˆ›å»ºpodè¯·æ±‚ APIServerå°†podå¯¹è±¡å†™å…¥etcdæŒä¹…åŒ–å­˜å‚¨ï¼Œå†™å…¥æˆåŠŸåï¼ŒAPIServerå°†æ”¶åˆ°etcdçš„ç¡®è®¤ä¿¡æ¯ APIServeræ ‡è®°æ–°çš„podè¢«åˆ›å»º Schedulerç›‘å¬åˆ°APIServerå¤„æœ‰æ–°çš„podè¢«åˆ›å»ºã€‚é¦–å…ˆæ£€æŸ¥podæ˜¯å¦å·²ç»è°ƒåº¦ï¼ˆæ£€æŸ¥spec.nodeNameå­—æ®µï¼‰ï¼Œå¦‚æœæœªè¢«è°ƒåº¦ï¼Œé‚£ä¹ˆSchedulerä¼šä¸ºpodåˆ†é…ä¸€ä¸ªåˆé€‚çš„è°ƒåº¦èŠ‚ç‚¹ï¼Œå¹¶å°†çŠ¶æ€å†™å…¥spec.nodeNameå­—æ®µä¸­ï¼Œå®Œæˆpodçš„ç»‘å®š Scheduleråé¦ˆpodçš„ç»‘å®šä¿¡æ¯åˆ°APIServeråå†™å…¥etcdï¼ŒåŒæ—¶Schedulerä¹ŸæŒç»­ç›‘å¬podå¯¹è±¡çš„å˜åŒ–ï¼Œè‹¥spec.nodeNameå­—æ®µä¸ä¸ºç©ºï¼Œåˆ™ä¸è¿›è¡Œä»»ä½•å¤„ç† kubeletç›‘å¬APIServerå¤„podçš„å˜åŒ–ï¼Œå½“å‘ç°podè¢«è°ƒåº¦åˆ°è‡ªå·±æ‰€åœ¨çš„èŠ‚ç‚¹æ—¶ï¼ˆå³spec.nodeNameå­—æ®µå€¼ä¸ºè‡ªå·±æ‰€åœ¨èŠ‚ç‚¹ï¼‰ï¼Œkubeletè°ƒç”¨CRI gRPCç”³è¯·å¯åŠ¨å®¹å™¨ kubeleté¦–å…ˆè°ƒç”¨RunPodSandboxæ¥å£ã€‚containerdç¡®è®¤PodSandboxçš„pauseé•œåƒæ˜¯å¦å­˜åœ¨ã€‚ç”±äºæ‰€æœ‰PodSandboxä½¿ç”¨åŒä¸€ä¸ªpauseé•œåƒï¼Œå¦‚æœèŠ‚ç‚¹ä¸­å·²æœ‰å…¶ä»–åœ¨è¿è¡Œçš„podï¼Œåˆ™pauseå°±å·²ç»å­˜åœ¨ã€‚æ¥ç€åˆ›å»ºNetwork Namespaceï¼Œè°ƒç”¨CNIæ¥å£è®¾ç½®å®¹å™¨ç½‘ç»œï¼Œcontainerdä½¿ç”¨è¿™ä¸ªç½‘ç»œå¯åŠ¨PodSandbox kubeletç”³è¯·åœ¨PodSandboxä¸‹åˆ›å»ºå®¹å™¨ï¼Œå¦‚æœé•œåƒä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨CRIçš„PullImageæ¥å£é€šè¿‡containerdæ‹‰å–é•œåƒ kubeletè°ƒç”¨CRIçš„CreateContaineræ¥å£é€šè¿‡containerdåˆ›å»ºå®¹å™¨ kubeletè°ƒç”¨StartContaineræ¥å£é€šè¿‡containerdå¯åŠ¨å®¹å™¨ æ— è®ºå®¹å™¨æ˜¯å¦å¯åŠ¨æˆåŠŸï¼Œkubeletéƒ½ä¼šå°†æœ€æ–°çš„å®¹å™¨çŠ¶æ€æ›´æ–°åˆ°podçš„statuså­—æ®µä¸­ï¼Œå…¶ä»–æ§åˆ¶å™¨ç»„ä»¶é€šè¿‡è¯¥å­—æ®µè·å–podçš„çŠ¶æ€ APIServerå°†podçŠ¶æ€å†™å…¥etcdï¼Œkubeletå°†æŒç»­ç›‘å¬APIServer Podåˆ é™¤æµç¨‹ ç”¨æˆ·é€šè¿‡kubectlã€RESTful APIæˆ–å…¶ä»–å®¢æˆ·ç«¯å‘APIServerå‘èµ·åˆ é™¤podè¯·æ±‚ podå¯¹è±¡ä¸ä¼šè¢«APIServerç«‹å³åˆ é™¤ï¼ŒAPIServeråœ¨podä¸­æ·»åŠ deletionTimestampå’ŒdeletionGracePeriodSecondsï¼ˆé»˜è®¤30sï¼‰å­—æ®µï¼Œå¹¶å†™å…¥etcdä¸­ APIServerå°†podå·²åˆ é™¤çš„ä¿¡æ¯è¿”å›ç»™ç”¨æˆ·ï¼Œç”¨æˆ·æŸ¥çœ‹podçŠ¶æ€å·²è¢«æ›´æ–°ä¸ºTerminating kubeletç›‘å¬åˆ°APIServerå¤„çš„è‡ªèº«çš„podå¯¹è±¡deletionTimestampå­—æ®µè¢«è®¾ç½®æ—¶ï¼Œå¼€å§‹å‡†å¤‡åˆ é™¤pod kubeletè°ƒç”¨StopContaineræ¥å£é€šè¿‡containerdåœæ­¢å®¹å™¨ï¼Œcontainerdé¦–å…ˆä¼šè°ƒç”¨runcå‘å®¹å™¨å‘é€SIGTERMä¿¡å·ï¼Œå®¹å™¨åœæ­¢æˆ–deletionGracePeriodSecondsè¶…æ—¶åï¼Œruncå‘é€SIGKILLä¿¡å·æ€æ­»æ‰€æœ‰å®¹å™¨è¿›ç¨‹ï¼Œå®Œæˆå®¹å™¨åœæ­¢ kubeletæ”¶åˆ°containerdçš„å®¹å™¨å·²åœæ­¢ä¿¡æ¯åï¼Œå°†çŠ¶æ€æ›´æ–°åˆ°podçš„statuså­—æ®µä¸­ APIServeræ›´æ–°podçŠ¶æ€å¹¶å†™å…¥etcd endpointç›‘å¬åˆ°podçŠ¶æ€å‘ç”Ÿæ”¹å˜åï¼Œåˆ é™¤podç›¸å…³çš„endpointå¯¹è±¡ APIServeræ›´æ–°endpointçŠ¶æ€å¹¶å†™å…¥etcd kube-proxyç›‘å¬åˆ°endpointå˜åŒ–åï¼Œç§»é™¤podç›¸å…³çš„è½¬å‘è§„åˆ™ podå†…æ‰€æœ‰å®¹å™¨è¢«åœæ­¢åï¼Œcontainerdè°ƒç”¨CNIå°†å®¹å™¨çš„ç½‘ç»œåˆ é™¤ï¼Œç„¶åé€šè¿‡StopPodSandboxæ¥å£åœæ­¢PodSandboxï¼Œåœæ­¢åï¼Œkubeletè¿›è¡Œä¸€ç³»åˆ—çš„æ¸…ç†å·¥ä½œï¼Œä¾‹å¦‚æ¸…ç†podçš„CGroup å¦‚æœpodæœ‰finalizerï¼Œå³ä½¿PodSandboxè¢«åœæ­¢ï¼Œè¿™ä¸ªpodä¹Ÿä¸ä¼šæ¶ˆå¤±ï¼Œéœ€è¦ç­‰å¾…å…¶ä»–æ§åˆ¶å™¨å®Œæˆfinalizerç›¸å…³çš„æ¸…ç†å·¥ä½œï¼Œfinalizeræ¸…ç©ºåï¼ŒcanBeDeletedæ–¹æ³•è¿”å›trueï¼Œkubeletå‘èµ·æœ€ç»ˆçš„deletionGracePeriodSeconds=0çš„åˆ é™¤è¯·æ±‚ APIServerå°†podä»etcdä¸­å½»åº•åˆ é™¤ï¼Œkubeletå®æ—¶ç›‘å¬ Podä¼˜é›…é€€å‡º Podæ­£å¸¸æƒ…å†µä¸‹é€€å‡ºï¼ˆåˆ é™¤ï¼‰æµç¨‹æœ‰ä¸¤ä¸ªæ—¶é—´çº¿ï¼šç½‘ç»œè§„åˆ™æ¸…ç†å’ŒPodæœ¬èº«çš„åˆ é™¤ã€‚è¿™ä¸¤ä¸ªæ—¶é—´çº¿æ˜¯å¹¶è¡Œçš„ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š\nç½‘ç»œè§„åˆ™æ¸…ç†æµç¨‹ï¼š\nAPIServerä¼šæ”¶åˆ°Podåˆ é™¤çš„è¯·æ±‚ï¼Œåœ¨Etcdä¸­æ›´æ–°Podçš„çŠ¶æ€ä¸ºTerminating Endpoint Controllerå°†è¯¥Podçš„ipä»Endpointå¯¹è±¡ä¸­åˆ é™¤ Kube-proxyæ ¹æ®Endpointå¯¹è±¡çš„æ”¹å˜æ›´æ–°ç½‘ç»œè§„åˆ™ï¼ˆiptablesæˆ–ipvsï¼‰ï¼Œä¸å†å°†æµé‡è·¯ç”±åˆ°è¢«åˆ é™¤çš„Pod Podåˆ é™¤æµç¨‹ï¼š\nAPIServer ä¼šæ”¶åˆ°Podåˆ é™¤çš„è¯·æ±‚ï¼Œåœ¨Etcdä¸­æ›´æ–°Podçš„çŠ¶æ€ä¸ºTerminatingï¼› kubeletåœ¨èŠ‚ç‚¹ä¸Šæ¸…ç†å®¹å™¨çš„ç›¸å…³èµ„æºï¼Œä¾‹å¦‚å­˜å‚¨ï¼Œç½‘ç»œ kubeletå‘é€SIGTERMè¿›ç¨‹ç»™å®¹å™¨ï¼Œå¦‚æœå®¹å™¨ä¸­çš„è¿›ç¨‹æœªåšä»»ä½•é…ç½®ï¼Œåˆ™å®¹å™¨ç«‹å³é€€å‡º å¦‚æœå®¹å™¨æœªåœ¨é»˜è®¤çš„30ç§’æ—¶é—´å†…é€€å‡ºï¼ŒKubeletå‘é€SIGKILLç»™å®¹å™¨ï¼Œå¼ºåˆ¶è®©å®¹å™¨é€€å‡º å®é™…ç¯å¢ƒå¯èƒ½ä¼šé‡åˆ°çš„æƒ…å†µï¼š\npodçš„è¯·æ±‚æœªå¤„ç†å®Œå°±è¢«é€€å‡º podå·²ç»é€€å‡ºè¿˜æœ‰æµé‡æµå‘podï¼ˆå³ç½‘ç»œè§„åˆ™æœªæ¸…ç†å®ŒæˆPodå·²ç»è¢«åˆ é™¤äº†ï¼‰ ä¸Šé¢è¿™ä¸¤ç§æƒ…å†µéœ€è¦è®¾ç½®podä¼˜é›…é€€å‡ºå‚æ•°æ¥ä¼˜åŒ–é€€å‡ºæµç¨‹ã€‚å¯ä»¥å¢åŠ preStopç”Ÿå‘½å‘¨æœŸå‚æ•°æˆ–ä¿®æ”¹terminationGracePeriodSecondså‚æ•°ã€‚preStopç”¨æ¥å®Œæˆpodé€€å‡ºå‰è¦æ‰§è¡Œçš„æ“ä½œï¼Œ\nå¦‚æœ preStop å›è°ƒæ‰€éœ€è¦çš„æ—¶é—´é•¿äºé»˜è®¤30sï¼Œåˆ™å¿…é¡»ä¿®æ”¹ terminationGracePeriodSeconds å±æ€§å€¼æ¥ä½¿å…¶æ­£å¸¸å·¥ä½œã€‚\n# å®ä¾‹ apiVersion: v1 kind: Pod metadata: name: lifecycle-demo spec: terminationGracePeriodSeconds: 45 # set terminationGracePeriodSeconds containers: - name: lifecycle-demo-container image: nginx lifecycle: postStart: exec: command: [\"/bin/sh\", \"-c\", \"echo Hello from the postStart \u003e /usr/share/message\"] preStop: exec: command: [\"/bin/sh\",\"-c\",\"nginx -s quit; while killall -0 nginx; do sleep 1; done\"] ",
  "wordCount" : "7386",
  "inLanguage": "en",
  "image":"https://deemoprobe.github.io/img/kubernetes.png","datePublished": "2023-04-29T14:23:11+08:00",
  "dateModified": "2023-04-29T14:23:11+08:00",
  "author":[{
    "@type": "Person",
    "name": "deemoprobe"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://deemoprobe.github.io/posts/tech/kubernetes/kubernetespod/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "William's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://deemoprobe.github.io/img/bear.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://deemoprobe.github.io/" accesskey="h" title="William&#39;s Blog (Alt + H)">
            <img src="https://deemoprobe.github.io/img/bear.png" alt="logo" aria-label="logo"
                 height="35">William&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://deemoprobe.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tags" title="ğŸ¨ æ ‡ç­¾">
                <span>ğŸ¨ æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/archives/" title="ğŸ“ˆ å½’æ¡£">
                <span>ğŸ“ˆ å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tools" title="ğŸª å·¥å…·">
                <span>ğŸª å·¥å…·</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            
            <h1 class="post-title">
                KubernetesPod
            </h1>
            <div class="post-description">
                Kubernetes Pod
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-04-29
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>7386å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>15åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>deemoprobe
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://deemoprobe.github.io/tags/kubernetes/" style="color: var(--secondary)!important;">kubernetes</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="https://deemoprobe.github.io/img/kubernetes.png" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%a6%82%e5%bf%b5" aria-label="æ¦‚å¿µ">æ¦‚å¿µ</a></li>
                <li>
                    <a href="#%e5%ae%9a%e4%b9%89pod" aria-label="å®šä¹‰Pod">å®šä¹‰Pod</a></li>
                <li>
                    <a href="#%e9%9b%b6%e5%ae%95%e6%9c%ba%e9%83%a8%e7%bd%b2" aria-label="é›¶å®•æœºéƒ¨ç½²">é›¶å®•æœºéƒ¨ç½²</a></li>
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e5%ae%b9%e5%99%a8" aria-label="åˆå§‹åŒ–å®¹å™¨">åˆå§‹åŒ–å®¹å™¨</a></li>
                <li>
                    <a href="#pod%e6%8e%a2%e9%92%88" aria-label="Podæ¢é’ˆ">Podæ¢é’ˆ</a><ul>
                        
                <li>
                    <a href="#pod%e6%8e%a2%e9%92%88%e7%9a%84%e5%ae%9e%e7%8e%b0%e6%96%b9%e5%bc%8f" aria-label="Podæ¢é’ˆçš„å®ç°æ–¹å¼">Podæ¢é’ˆçš„å®ç°æ–¹å¼</a></li>
                <li>
                    <a href="#%e6%8e%a2%e9%92%88%e6%a3%80%e6%9f%a5%e5%8f%82%e6%95%b0%e9%85%8d%e7%bd%ae" aria-label="æ¢é’ˆæ£€æŸ¥å‚æ•°é…ç½®">æ¢é’ˆæ£€æŸ¥å‚æ•°é…ç½®</a></li>
                <li>
                    <a href="#startupprobe%e5%ae%9e%e4%be%8b" aria-label="startupProbeå®ä¾‹">startupProbeå®ä¾‹</a></li>
                <li>
                    <a href="#livenessprobe%e5%ae%9e%e4%be%8b" aria-label="livenessProbeå®ä¾‹">livenessProbeå®ä¾‹</a></li>
                <li>
                    <a href="#readinessprobe%e5%ae%9e%e4%be%8b" aria-label="readinessProbeå®ä¾‹">readinessProbeå®ä¾‹</a></li></ul>
                </li>
                <li>
                    <a href="#pod%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="Podç”Ÿå‘½å‘¨æœŸ">Podç”Ÿå‘½å‘¨æœŸ</a><ul>
                        
                <li>
                    <a href="#pod%e5%88%9b%e5%bb%ba%e6%b5%81%e7%a8%8b" aria-label="Podåˆ›å»ºæµç¨‹">Podåˆ›å»ºæµç¨‹</a></li>
                <li>
                    <a href="#pod%e5%88%a0%e9%99%a4%e6%b5%81%e7%a8%8b" aria-label="Podåˆ é™¤æµç¨‹">Podåˆ é™¤æµç¨‹</a></li>
                <li>
                    <a href="#pod%e4%bc%98%e9%9b%85%e9%80%80%e5%87%ba" aria-label="Podä¼˜é›…é€€å‡º">Podä¼˜é›…é€€å‡º</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h2 id="æ¦‚å¿µ">æ¦‚å¿µ<a hidden class="anchor" aria-hidden="true" href="#æ¦‚å¿µ">#</a></h2>
<p>Podæ˜¯Kubernetesä¸­åˆ›å»ºç®¡ç†å’Œå¯éƒ¨ç½²çš„<strong>æœ€å°è®¡ç®—å•å…ƒ</strong>ï¼Œå®ƒç”±ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ç»„æˆï¼Œæ¯ä¸ªPodåŒ…å«äº†ä¸€ä¸ªPauseå®¹å™¨ï¼ŒPauseå®¹å™¨æ˜¯Podçš„çˆ¶å®¹å™¨ï¼Œè´Ÿè´£åƒµå°¸è¿›ç¨‹çš„å›æ”¶ç®¡ç†ï¼Œé€šè¿‡Pauseå®¹å™¨å¯ä»¥ä½¿åŒä¸€ä¸ªPodé‡Œé¢çš„å¤šä¸ªå®¹å™¨å…±äº«å­˜å‚¨ã€ç½‘ç»œã€PIDã€IPCç­‰ã€‚</p>
<h2 id="å®šä¹‰pod">å®šä¹‰Pod<a hidden class="anchor" aria-hidden="true" href="#å®šä¹‰pod">#</a></h2>
<p>Pod ä¸­çš„å®¹å™¨ä¼šè¢«è°ƒåº¦åˆ°é›†ç¾¤ä¸­çš„åŒä¸€è®¡ç®—èŠ‚ç‚¹ä¸Šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¾ˆå°‘å»ç›´æ¥åˆ›å»ºPodå•å®ä¾‹ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡Podæ§åˆ¶å™¨ï¼ˆDeploymentã€DaemonSetã€StatefulSetã€CronJobç­‰ï¼‰è¿›è¡Œåˆ›å»ºå’Œç®¡ç†ï¼Œå¹¶ä¸”è¿™äº›é«˜çº§èµ„æºå…·æœ‰Podæ‰€ä¸å…·å¤‡çš„å¾ˆå¤šç‰¹æ€§ï¼ˆå¦‚æ— çŠ¶æ€æœåŠ¡æ§åˆ¶å™¨deploymentçš„ä¼¸ç¼©å›æ»šï¼Œæœ‰çŠ¶æ€æœåŠ¡æ§åˆ¶å™¨StatefulSetçš„å®ä¾‹ç»‘å®šï¼‰ã€‚æ§åˆ¶å™¨åˆ›å»ºPodåScheduleræ ¹æ®é¢„è®¾æ¡ä»¶å’Œè°ƒåº¦ç®—æ³•å°†Podè°ƒåº¦åˆ°é›†ç¾¤åˆé€‚çš„èŠ‚ç‚¹ä¸Šï¼ŒPodä¼šä¿æŒåœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç›´åˆ°Podç»“æŸæ‰§è¡Œã€Podå¯¹è±¡è¢«åˆ é™¤ã€Podå› èµ„æºä¸è¶³è€Œè¢«é©±é€æˆ–è€…èŠ‚ç‚¹å¤±æ•ˆä¸ºæ­¢ã€‚</p>
<p>è¯´æ˜ï¼šé‡å¯ Pod ä¸­çš„å®¹å™¨ä¸åº”ä¸é‡å¯ Pod æ··æ·†ã€‚ Pod ä¸æ˜¯è¿›ç¨‹ï¼Œè€Œæ˜¯å®¹å™¨è¿è¡Œçš„ç¯å¢ƒã€‚åœ¨è¢«åˆ é™¤ä¹‹å‰ï¼ŒPod ä¼šä¸€ç›´å­˜åœ¨ã€‚</p>
<p><strong>Pod yamlæ–‡ä»¶ç¤ºä¾‹</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl explain pod | egrep -v &#34;^$|^\s*http&#34;|sed s/&#34;More info:&#34;//</span>
</span></span><span style="display:flex;"><span>KIND:     Pod
</span></span><span style="display:flex;"><span>VERSION:  v1
</span></span><span style="display:flex;"><span>DESCRIPTION:
</span></span><span style="display:flex;"><span>     Pod is a collection of containers that can run on a host. This resource is
</span></span><span style="display:flex;"><span>     created by clients and scheduled onto hosts.
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   apiVersion   &lt;string&gt;
</span></span><span style="display:flex;"><span>     APIVersion defines the versioned schema of this representation of an
</span></span><span style="display:flex;"><span>     object. Servers should convert recognized schemas to the latest internal
</span></span><span style="display:flex;"><span>     value, and may reject unrecognized values.
</span></span><span style="display:flex;"><span>   kind &lt;string&gt;
</span></span><span style="display:flex;"><span>     Kind is a string value representing the REST resource this object
</span></span><span style="display:flex;"><span>     represents. Servers may infer this from the endpoint the client submits
</span></span><span style="display:flex;"><span>     requests to. Cannot be updated. In CamelCase.
</span></span><span style="display:flex;"><span>   metadata     &lt;Object&gt;
</span></span><span style="display:flex;"><span>     Standard object<span style="color:#e6db74">&#39;s metadata.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   spec &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     Specification of the desired behavior of the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status       &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     Most recently observed status of the pod. This data may not be up to date.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     Populated by the system. Read-only.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># yamlæ–‡ä»¶ç¤ºä¾‹
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1       # å¿…é€‰ï¼ŒAPIçš„ç‰ˆæœ¬å·
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Pod            # å¿…é€‰ï¼Œç±»å‹Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:            # å¿…é€‰ï¼Œå…ƒæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: nginx        # å¿…é€‰ï¼Œç¬¦åˆRFC1035è§„èŒƒçš„Podåç§°
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: default # å¯é€‰ï¼ŒPodæ‰€åœ¨çš„å‘½åç©ºé—´ï¼Œé»˜è®¤ä¸ºdefault
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  labels:            # å¯é€‰ï¼Œæ ‡ç­¾é€‰æ‹©å™¨ï¼Œä¸€èˆ¬ç”¨äºè¿‡æ»¤å’ŒåŒºåˆ†Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    app: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    role: frontend   # å¯ä»¥å†™å¤šä¸ª
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  annotations:       # å¯é€‰ï¼Œæ³¨é‡Šé”®å€¼å¯¹åˆ—è¡¨ï¼Œå¯ä»¥å†™å¤šä¸ª
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    app: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:                # å¿…é€‰ï¼Œç”¨äºå®šä¹‰å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  initContainers:    # åˆå§‹åŒ–å®¹å™¨ï¼Œåœ¨å®¹å™¨å¯åŠ¨ä¹‹å‰æ‰§è¡Œçš„ä¸€äº›åˆå§‹åŒ–æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - -c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - echo &#34;I am InitContainer for init some configuration&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    image: busybox
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    imagePullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: init-container
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:                # å¿…é€‰ï¼Œå®¹å™¨åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: nginx              # å¿…é€‰ï¼Œç¬¦åˆRFC 1035è§„èŒƒçš„å®¹å™¨åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    image: nginx:latest      # å¿…é€‰ï¼Œå®¹å™¨æ‰€ç”¨çš„é•œåƒçš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    imagePullPolicy: Always  # å¯é€‰ï¼Œé•œåƒæ‹‰å–ç­–ç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    command:                 # å¯é€‰ï¼Œå®¹å™¨å¯åŠ¨æ‰§è¡Œçš„å‘½ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - nginx 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - -g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - &#34;daemon off;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    workingDir: /usr/share/nginx/html  # å¯é€‰ï¼Œå®¹å™¨çš„å·¥ä½œç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    volumeMounts:                      # å¯é€‰ï¼Œå­˜å‚¨å·é…ç½®ï¼Œå¯ä»¥é…ç½®å¤šä¸ª
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: webroot                    # å­˜å‚¨å·åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      mountPath: /usr/share/nginx/html # æŒ‚è½½ç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      readOnly: true                   # åªè¯»
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ports:                 # å¯é€‰ï¼Œå®¹å™¨éœ€è¦æš´éœ²çš„ç«¯å£å·åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: http           # ç«¯å£åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containerPort: 80    # ç«¯å£å·
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      protocol: TCP        # ç«¯å£åè®®ï¼Œé»˜è®¤TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    env:                   # å¯é€‰ï¼Œç¯å¢ƒå˜é‡é…ç½®åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: TZ             # å˜é‡å
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      value: Asia/Shanghai # å˜é‡çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: LANG
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      value: en_US.utf8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resources:      # å¯é€‰ï¼Œèµ„æºé™åˆ¶å’Œèµ„æºè¯·æ±‚é™åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      limits:       # æœ€å¤§é™åˆ¶è®¾ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cpu: 1000m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        memory: 1024Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      requests:     # å¯åŠ¨æ‰€éœ€çš„èµ„æº
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        memory: 512Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#    startupProbe:  # å¯é€‰ï¼Œæ£€æµ‹å®¹å™¨å†…è¿›ç¨‹æ˜¯å¦å®Œæˆå¯åŠ¨ã€‚æ³¨æ„ä¸‰ç§æ£€æŸ¥æ–¹å¼åŒæ—¶åªèƒ½ä½¿ç”¨ä¸€ç§ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#      httpGet:     # httpGetæ£€æµ‹æ–¹å¼ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨httpGetå®ç°æ¥å£çº§å¥åº·æ£€æŸ¥ï¼Œå¥åº·æ£€æŸ¥ç”±åº”ç”¨ç¨‹åºæä¾›ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#            path: /api/successStart # æ£€æŸ¥è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#            port: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    readinessProbe: # å¯é€‰ï¼Œå¥åº·æ£€æŸ¥ã€‚æ³¨æ„ä¸‰ç§æ£€æŸ¥æ–¹å¼åŒæ—¶åªèƒ½ä½¿ç”¨ä¸€ç§ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      httpGet:      # httpGetæ£€æµ‹æ–¹å¼ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨httpGetå®ç°æ¥å£çº§å¥åº·æ£€æŸ¥ï¼Œå¥åº·æ£€æŸ¥ç”±åº”ç”¨ç¨‹åºæä¾›ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: / # æ£€æŸ¥è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            port: 80 # ç›‘æ§ç«¯å£
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #livenessProbe: # å¯é€‰ï¼Œå¥åº·æ£€æŸ¥
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      #exec:        # æ‰§è¡Œå®¹å™¨å‘½ä»¤æ£€æµ‹æ–¹å¼
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            #command: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            #- cat
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            #- /health
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #httpGet:       # httpGetæ£€æµ‹æ–¹å¼
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #   path: /_health # æ£€æŸ¥è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #   port: 8080
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #   httpHeaders: # æ£€æŸ¥çš„è¯·æ±‚å¤´
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #   - name: end-user
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #     value: Jason 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      tcpSocket:     # ç«¯å£æ£€æµ‹æ–¹å¼
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            port: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      initialDelaySeconds: 60  # åˆå§‹åŒ–æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      timeoutSeconds: 2        # è¶…æ—¶æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      periodSeconds: 20        # æ£€æµ‹é—´éš”
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      successThreshold: 2      # æ£€æŸ¥æˆåŠŸä¸º2æ¬¡è¡¨ç¤ºå°±ç»ª
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      failureThreshold: 1      # æ£€æµ‹å¤±è´¥1æ¬¡è¡¨ç¤ºæœªå°±ç»ª
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    lifecycle:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      postStart: # å®¹å™¨åˆ›å»ºå®Œæˆåæ‰§è¡Œçš„æŒ‡ä»¤, å¯ä»¥æ˜¯exec httpGet TCPSocket
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        exec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - -c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - &#39;</span>mkdir /data/<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>      preStop:
</span></span><span style="display:flex;"><span>        httpGet:      
</span></span><span style="display:flex;"><span>              path: /
</span></span><span style="display:flex;"><span>              port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  exec:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    command:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    - sh</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    - -c</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    - sleep 9</span>
</span></span><span style="display:flex;"><span>  restartPolicy: Always   <span style="color:#75715e"># å¯é€‰ï¼Œé»˜è®¤ä¸ºAlways</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#nodeSelector: # å¯é€‰ï¼ŒæŒ‡å®šNodeèŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#      region: subnet7</span>
</span></span><span style="display:flex;"><span>  imagePullSecrets:  <span style="color:#75715e"># å¯é€‰ï¼Œæ‹‰å–é•œåƒä½¿ç”¨çš„secretï¼Œå¯ä»¥é…ç½®å¤šä¸ª</span>
</span></span><span style="display:flex;"><span>  - name: default-dockercfg-86258
</span></span><span style="display:flex;"><span>  hostNetwork: false  <span style="color:#75715e"># å¯é€‰ï¼Œæ˜¯å¦ä¸ºä¸»æœºæ¨¡å¼ï¼Œå¦‚æ˜¯ï¼Œä¼šå ç”¨ä¸»æœºç«¯å£</span>
</span></span><span style="display:flex;"><span>  volumes:            <span style="color:#75715e"># å…±äº«å­˜å‚¨å·åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>  - name: webroot     <span style="color:#75715e"># åç§°ï¼Œä¸ä¸Šé¢volumeMountså¯¹åº”</span>
</span></span><span style="display:flex;"><span>    emptyDir: <span style="color:#f92672">{}</span>      <span style="color:#75715e"># æŒ‚è½½ç›®å½•</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#hostPath:    # æŒ‚è½½æœ¬æœºç›®å½•</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#  path: /etc/hosts</span>
</span></span></code></pre></div><p>åœ¨é«˜çº§èµ„æºä¸­åˆ›å»ºPodæ˜¯é€šè¿‡æ–‡ä»¶ä¸­<code>template</code> Podæ¨¡æ¿å­—æ®µæ¥åˆ›å»ºPod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ä¾‹å¦‚åˆ›å»ºJobï¼Œ</span>
</span></span><span style="display:flex;"><span>apiVersion: batch/v1
</span></span><span style="display:flex;"><span>kind: Job
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: hello
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># è¿™é‡Œæ˜¯Podå¯¹è±¡æ¨¡ç‰ˆ</span>
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: hello
</span></span><span style="display:flex;"><span>        image: busybox
</span></span><span style="display:flex;"><span>        command: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;sh&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;echo &#34;Hello, Kubernetes!&#34; &amp;&amp; sleep 3600&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      restartPolicy: OnFailure
</span></span><span style="display:flex;"><span>      ...
</span></span></code></pre></div><h2 id="é›¶å®•æœºéƒ¨ç½²">é›¶å®•æœºéƒ¨ç½²<a hidden class="anchor" aria-hidden="true" href="#é›¶å®•æœºéƒ¨ç½²">#</a></h2>
<p>Podçš„é›¶å®•æœºä¸Šä¸‹çº¿ï¼Œå¯ä»¥é€šè¿‡åŠ å…¥<strong>åˆå§‹åŒ–å®¹å™¨ï¼ˆInitContainersï¼‰</strong>ã€Podä¸Šçº¿æ¥æ”¶æµé‡å‰çš„**å¥åº·æ£€æŸ¥ï¼ˆæ¢é’ˆStartupProbe/LivenessProbe/ReadinessProbeï¼‰<strong>å’ŒPod</strong>ç”Ÿå‘½å‘¨æœŸå›è°ƒ(postStart/preStop)**æ¥å®ç°ã€‚å€Ÿæ­¤å¯ä»¥å®ç°deploymenté›¶å®•æœºæ»šåŠ¨æ›´æ–°ã€‚</p>
<h2 id="åˆå§‹åŒ–å®¹å™¨">åˆå§‹åŒ–å®¹å™¨<a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–å®¹å™¨">#</a></h2>
<p>åˆå§‹åŒ–å®¹å™¨å³InitContainerï¼Œä¸»è¦ä½œç”¨æ˜¯åœ¨ä¸»åº”ç”¨å®¹å™¨å¯åŠ¨ä¹‹å‰ï¼Œåšä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œæ¯”å¦‚åˆ›å»ºæ–‡ä»¶ã€ä¿®æ”¹å†…æ ¸å‚æ•°ã€ç­‰å¾…ä¾èµ–ç¨‹åºå¯åŠ¨æˆ–å…¶ä»–éœ€è¦åœ¨ä¸»ç¨‹åºå¯åŠ¨ä¹‹å‰éœ€è¦åšçš„å·¥ä½œã€‚å¸¸è§ç”¨é€”æœ‰ï¼š</p>
<ul>
<li>å®‰è£…åº”ç”¨å®¹å™¨ä¸­ä¸å­˜åœ¨çš„å®ç”¨å·¥å…·æˆ–ä¸ªæ€§åŒ–ä»£ç </li>
<li>å®‰å…¨åœ°è¿è¡Œè¿™äº›å·¥å…·ï¼Œé¿å…è¿™äº›å·¥å…·å¯¼è‡´åº”ç”¨é•œåƒçš„å®‰å…¨æ€§é™ä½</li>
<li>rootèº«ä»½æ‰§è¡Œä¸€äº›é«˜æƒé™å‘½ä»¤</li>
</ul>
<blockquote>
<p>åˆå§‹åŒ–å®¹å™¨ç›¸å…³æ“ä½œæ‰§è¡Œå®Œæˆåé€€å‡ºï¼Œä¸ä¼šç»™ä¸šåŠ¡å®¹å™¨å¸¦æ¥å®‰å…¨éšæ‚£</p>
</blockquote>
<p>InitContainerä¸postStartçš„åŒºåˆ«ï¼š</p>
<ul>
<li>InitContainerï¼šä¸ä¾èµ–ä¸»å®¹å™¨ï¼Œå¯ä»¥æœ‰æ›´é«˜çš„æƒé™ï¼Œä¸€å®šä¼šåœ¨ä¸»å®¹å™¨å¯åŠ¨ä¹‹å‰å®Œæˆ</li>
<li>postStartï¼šä¾èµ–ä¸»å®¹å™¨ï¼Œè¿™ä¸ªå›è°ƒåœ¨ä¸»å®¹å™¨è¢«åˆ›å»ºä¹‹åç«‹å³æ‰§è¡Œã€‚ä½†æ˜¯ä¸èƒ½ä¿è¯ä¼šåœ¨å®¹å™¨å¯åŠ¨å‰æ‰§è¡Œï¼Œå³å…¥å£ç‚¹ï¼ˆENTRYPOINTï¼‰ä¹‹å‰æ‰§è¡Œã€‚</li>
</ul>
<p>InitContainerä¸æ™®é€šå®¹å™¨çš„åŒºåˆ«ï¼š</p>
<ul>
<li>æ™®é€šå®¹å™¨è€ƒè™‘åˆ°å®‰å…¨æ€§ï¼Œé€šå¸¸æƒé™ä¸ä¼šç»™å¾ˆå¤§ï¼ŒInitContainerå¯ä»¥æ‰§è¡Œé«˜æƒé™çš„æ“ä½œï¼Œæ“ä½œå®Œæˆç«‹å³é€€å‡º</li>
<li>æ€»æ˜¯è¿è¡Œåˆ°å®Œæˆï¼Œä¸å®Œæˆä¸ä¼šå¯åŠ¨ä¸»å®¹å™¨</li>
<li>å¤šä¸ªåˆå§‹åŒ–å®¹å™¨ï¼Œä¸Šä¸€ä¸ªè¿è¡Œå®Œæˆæ‰ä¼šè¿è¡Œä¸‹ä¸€ä¸ª</li>
<li>å¦‚æœPodçš„InitContainerå¤±è´¥ï¼ŒKubernetesä¼šä¸æ–­åœ°é‡å¯è¯¥Podï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼Œé™¤éPodçš„<code>restartPolicy</code>å€¼ä¸ºNever</li>
<li>ä¸æ”¯æŒ lifecycleã€livenessProbeã€readinessProbe å’Œ startupProbe</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å®ä¾‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># vim initcontainer.yml</span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: test-init
</span></span><span style="display:flex;"><span>  name: test-init
</span></span><span style="display:flex;"><span>  namespace: kube-public
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: test-init
</span></span><span style="display:flex;"><span>  template: <span style="color:#75715e"># podé…ç½®</span>
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: test-init
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>      - name: data
</span></span><span style="display:flex;"><span>        emptyDir: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>      initContainers: <span style="color:#75715e"># åœ¨åº”ç”¨å®¹å™¨å¯åŠ¨å‰ä½¿ç”¨rootæƒé™åˆ›å»ºç›¸å…³æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>      - command:
</span></span><span style="display:flex;"><span>        - sh
</span></span><span style="display:flex;"><span>        - -c
</span></span><span style="display:flex;"><span>        - touch /mnt/test-init.txt
</span></span><span style="display:flex;"><span>        image: nginx
</span></span><span style="display:flex;"><span>        imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>        name: init-touch
</span></span><span style="display:flex;"><span>        volumeMounts:
</span></span><span style="display:flex;"><span>        - name: data
</span></span><span style="display:flex;"><span>          mountPath: /mnt
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - image: nginx
</span></span><span style="display:flex;"><span>        imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>        name: test-init
</span></span><span style="display:flex;"><span>        volumeMounts: 
</span></span><span style="display:flex;"><span>        - name: data
</span></span><span style="display:flex;"><span>          mountPath: /mnt
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f initcontainer.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy,po -n kube-public</span>
</span></span><span style="display:flex;"><span>NAME                        READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/test-init   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           5m5s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/test-init-6d4c45d5b7-4qnl8   1/1     Running   <span style="color:#ae81ff">0</span>          5m5s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec -it -n kube-public test-init-6d4c45d5b7-4qnl8 -- ls /mnt</span>
</span></span><span style="display:flex;"><span>Defaulted container <span style="color:#e6db74">&#34;test-init&#34;</span> out of: test-init, init-touch <span style="color:#f92672">(</span>init<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>test-init.txt
</span></span></code></pre></div><h2 id="podæ¢é’ˆ">Podæ¢é’ˆ<a hidden class="anchor" aria-hidden="true" href="#podæ¢é’ˆ">#</a></h2>
<p>ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”ç”¨å®¹å™¨èƒ½æ­£å¸¸å¯åŠ¨å¹¶ä¸ä»£è¡¨èƒ½æ­£å¸¸å¤„ç†è¯·æ±‚ï¼Œæ‰€ä»¥è¦åˆç†é…ç½®å¥åº·æ£€æŸ¥ã€‚Podå¥åº·æ£€æŸ¥æœ‰ä¸‰ç§æ¢é’ˆï¼š</p>
<ul>
<li>startupProbeï¼ˆ1.16ç‰ˆæœ¬åï¼‰ï¼šç”¨äºåˆ¤æ–­å®¹å™¨å†…åº”ç”¨ç¨‹åºæ˜¯å¦å·²ç»å¯åŠ¨ã€‚å¦‚æœé…ç½®äº†startupProbeï¼Œä¼šå…ˆç¦æ­¢å…¶ä»–çš„æ¢æµ‹ï¼Œç›´åˆ°å®¹å™¨æˆåŠŸå†…ç¨‹åºå¯åŠ¨ä¸ºæ­¢ã€‚å¦‚æœæ¢æµ‹å¤±è´¥ï¼Œkubeletä¼šæ€æ­»å®¹å™¨å¹¶æ ¹æ®é‡å¯ç­–ç•¥å¤„ç†ï¼›å¦‚æœæ¢æµ‹æˆåŠŸï¼Œæˆ–æœªé…ç½®startupProbeæ¢é’ˆï¼Œåˆ™æ ‡è®°ä¸ºsuccess</li>
<li>livenessProbeï¼šç”¨äºæ¢æµ‹å®¹å™¨æ˜¯å¦åœ¨è¿è¡Œï¼ˆå­˜æ´»ï¼‰ï¼Œå¦‚æœæ¢æµ‹å¤±è´¥ï¼Œkubeletä¼šæ€æ­»å®¹å™¨æ ¹æ®é‡å¯ç­–ç•¥å¤„ç†ã€‚è‹¥æ²¡æœ‰é…ç½®è¯¥æ¢é’ˆï¼Œåˆ™æ ‡è®°ä¸ºsuccess</li>
<li>readinessProbeï¼šä¸€èˆ¬ç”¨äºæ¢æµ‹å®¹å™¨å†…çš„ç¨‹åºæ˜¯å¦å‡†å¤‡å°±ç»ªï¼ˆæ¥æ”¶å¤„ç†è¯·æ±‚ï¼‰ï¼Œå¦‚æœæ¢æµ‹å¤±è´¥ï¼ŒEndpoint Controllerå°†ä»Serviceçš„Endpointsä¸­åˆ é™¤è¯¥Podçš„IPåœ°å€ã€‚è‹¥æœªé…ç½®è¯¥æ¢é’ˆåˆ™é»˜è®¤æ ‡è®°ä¸ºsuccess</li>
</ul>
<h3 id="podæ¢é’ˆçš„å®ç°æ–¹å¼">Podæ¢é’ˆçš„å®ç°æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#podæ¢é’ˆçš„å®ç°æ–¹å¼">#</a></h3>
<ul>
<li>ExecActionï¼šåœ¨å®¹å™¨å†…æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œå¦‚æœè¿”å›å€¼ä¸º0ï¼Œåˆ™è®¤ä¸ºå®¹å™¨å¥åº·</li>
<li>TCPSocketActionï¼šé€šè¿‡TCPè¿æ¥æ£€æŸ¥å®¹å™¨å†…çš„ç«¯å£æ˜¯å¦æ˜¯é€šçš„ï¼Œå¦‚æœæ˜¯é€šçš„å°±è®¤ä¸ºå®¹å™¨å¥åº·</li>
<li>HTTPGetActionï¼šé€šè¿‡åº”ç”¨ç¨‹åºæš´éœ²çš„APIåœ°å€æ¥æ£€æŸ¥ç¨‹åºæ˜¯å¦æ˜¯æ­£å¸¸çš„ï¼Œå¦‚æœçŠ¶æ€ç ä¸º200~400ä¹‹é—´ï¼Œåˆ™è®¤ä¸ºå®¹å™¨å¥åº·</li>
</ul>
<p>Podå¥åº·æ£€æŸ¥ç»“æœï¼š</p>
<ul>
<li>Successï¼šæ£€æŸ¥é€šè¿‡</li>
<li>Failedï¼šæ£€æŸ¥å¤±è´¥ï¼Œkubeletæ ¹æ®Podé‡å¯ç­–ç•¥è¿›ä¸€æ­¥å¤„ç†</li>
<li>Unknownï¼šæ£€æŸ¥å¤±è´¥ï¼ŒçŠ¶æ€æœªçŸ¥ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†</li>
</ul>
<p>Podé•œåƒæ‹‰å–ç­–ç•¥ï¼ˆimagePullPolicyï¼‰ï¼š</p>
<ul>
<li>Alwaysï¼šæ€»æ˜¯æ‹‰å–ç›´è‡³æˆåŠŸï¼Œé•œåƒtagæœªæŒ‡å®šæ—¶ï¼ˆå³latestï¼‰ï¼Œé»˜è®¤ä¸ºAlways</li>
<li>Neverï¼šæ— è®ºé•œåƒæ˜¯å¦å­˜åœ¨éƒ½ä¸æ‹‰å–</li>
<li>IfNotPresentï¼šé•œåƒä¸å­˜åœ¨æ—¶æ‹‰å–</li>
</ul>
<p>Podé‡å¯ç­–ç•¥ï¼ˆrestartPolicyï¼‰ï¼š</p>
<ul>
<li>Alwaysï¼šé»˜è®¤ç­–ç•¥ï¼Œå®¹å™¨å¤±æ•ˆæ—¶ï¼Œè‡ªåŠ¨é‡å¯</li>
<li>OnFailureï¼šå®¹å™¨ä»¥ä¸ä¸º0çš„çŠ¶æ€ç ç»ˆæ­¢ï¼Œè‡ªåŠ¨é‡å¯</li>
<li>Neverï¼šæ— è®ºä½•ç§çŠ¶æ€ï¼Œéƒ½ä¸é‡å¯</li>
</ul>
<p>ä¸‹é¢æ¡ˆä¾‹corednsçš„å¥åº·æ£€æŸ¥é…ç½®ä¸­<code>livenessProbe</code>é€šè¿‡<code>httpGet</code>çš„æ–¹å¼æ£€æµ‹æä¾›<code>8080/health</code>æ¥å£ï¼Œæ£€æŸ¥å®¹å™¨æ˜¯å¦å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ£€æŸ¥é€šè¿‡åæ¥ç€è¿›è¡Œ<code>ReadinessProbe</code>æ¢é’ˆæ£€æµ‹ï¼Œ<code>httpGet</code>æ–¹å¼æ£€æµ‹æä¾›çš„<code>8181/ready</code>æ¥å£ï¼Œæ£€æµ‹é€šè¿‡åˆ™è¡¨ç¤ºå®¹å™¨å†…ç¨‹åºè¿è¡Œæ­£å¸¸ï¼Œå¯ä»¥æ¥æ”¶æµé‡ã€‚å¥åº·æ£€æŸ¥æ¥å£éœ€è¦åœ¨é•œåƒä¸­é¢„å®šç¨‹åºæºç ä¸­å†™å¥½ï¼Œä¸ºåç»­æ¥å…¥å¥åº·æ£€æŸ¥åšå‡†å¤‡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ä»¥corednsä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°å¥åº·æ£€æŸ¥é…ç½®äº†LivenessProbeå’ŒReadinessProbe</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy -n kube-system coredns -oyaml</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        livenessProbe:
</span></span><span style="display:flex;"><span>          failureThreshold: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>          httpGet:
</span></span><span style="display:flex;"><span>            path: /health
</span></span><span style="display:flex;"><span>            port: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>            scheme: HTTP
</span></span><span style="display:flex;"><span>          initialDelaySeconds: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>          periodSeconds: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          successThreshold: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          timeoutSeconds: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        readinessProbe:
</span></span><span style="display:flex;"><span>          failureThreshold: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>          httpGet:
</span></span><span style="display:flex;"><span>            path: /ready
</span></span><span style="display:flex;"><span>            port: <span style="color:#ae81ff">8181</span>
</span></span><span style="display:flex;"><span>            scheme: HTTP
</span></span><span style="display:flex;"><span>          periodSeconds: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          successThreshold: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          timeoutSeconds: <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>          ...
</span></span></code></pre></div><p><strong>ç‰¹æ®Šæƒ…å†µ</strong>ï¼šå¦‚æœé‡åˆ°å®¹å™¨å†…ç¨‹åºå¯åŠ¨æ—¶é—´å¤ªé•¿ï¼Œè¶…è¿‡äº†<code>initialDelaySeconds</code>è®¾å®šçš„å®¹å™¨åˆå§‹åŒ–æ—¶é—´ï¼Œé‚£ä¹ˆå¥åº·æ£€æŸ¥ä¹Ÿä¸ä¼šé€šè¿‡ï¼Œå®¹å™¨ä¼šä¸æ–­è¢«æ€æ‰é‡å¯ï¼Œé€ æˆæœåŠ¡æ— æ³•æ­£å¸¸è¿è¡Œã€‚åƒä¸Šé¢è¿™äº›æƒ…å†µå°±éœ€è¦æ£€æµ‹å®¹å™¨å†…ç¨‹åºæ˜¯å¦å¥åº·ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨<code>startupProbe</code>ã€‚</p>
<h3 id="æ¢é’ˆæ£€æŸ¥å‚æ•°é…ç½®">æ¢é’ˆæ£€æŸ¥å‚æ•°é…ç½®<a hidden class="anchor" aria-hidden="true" href="#æ¢é’ˆæ£€æŸ¥å‚æ•°é…ç½®">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>initialDelaySeconds: <span style="color:#ae81ff">10</span>   <span style="color:#75715e"># å®¹å™¨å¯åŠ¨ä¸”å­˜æ´»ï¼Œç­‰å¾…10såå¼€å§‹æ£€æµ‹ã€‚è‹¥ä¸é…ç½®ï¼Œé»˜è®¤ä¸º0s</span>
</span></span><span style="display:flex;"><span>timeoutSeconds: <span style="color:#ae81ff">2</span>         <span style="color:#75715e"># æ£€æµ‹è¶…æ—¶åçš„ç­‰å¾…æ—¶é—´ï¼Œé»˜è®¤ä¸º1s</span>
</span></span><span style="display:flex;"><span>periodSeconds: <span style="color:#ae81ff">20</span>         <span style="color:#75715e"># æ£€æµ‹é—´éš”æ—¶é—´ï¼Œé»˜è®¤ä¸º10s</span>
</span></span><span style="display:flex;"><span>successThreshold: <span style="color:#ae81ff">1</span>       <span style="color:#75715e"># æ£€æµ‹è¿ç»­æˆåŠŸ1æ¬¡åæ ‡è®°Podå°±ç»ª</span>
</span></span><span style="display:flex;"><span>failureThreshold: <span style="color:#ae81ff">2</span>       <span style="color:#75715e"># æ£€æµ‹è¿ç»­å¤±è´¥2æ¬¡åæ ‡è®°Podå¤±è´¥</span>
</span></span></code></pre></div><h3 id="startupprobeå®ä¾‹">startupProbeå®ä¾‹<a hidden class="anchor" aria-hidden="true" href="#startupprobeå®ä¾‹">#</a></h3>
<p>é‡‡ç”¨HTTPGetActionæ¢æµ‹æ–¹å¼</p>
<p>å®ä¾‹ä½¿ç”¨çš„<code>nginx:latest</code>é•œåƒå¹¶æ²¡æœ‰é¢„è®¾ä¸‹é¢æ‰€å†™çš„å¥åº·æ£€æŸ¥æ¥å£ï¼Œæ‰€ä»¥æ£€æµ‹æ˜¯ä¸ä¼šé€šè¿‡çš„ï¼Œå¯ä»¥é€šè¿‡<code>Events</code>æŸ¥çœ‹ã€‚é‡å¯ç­–ç•¥å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤æ˜¯<code>restartPolicy: Always</code>ï¼Œå¤±è´¥åä¼šä¸€ç›´é‡å¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &lt;&lt; &#34;EOF&#34; &gt; startupprobe-httpget.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    test: startupprobe-httpget
</span></span><span style="display:flex;"><span>  name: startupprobe-httpget
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: nginx
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>    ports:
</span></span><span style="display:flex;"><span>    - containerPort: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    startupProbe:
</span></span><span style="display:flex;"><span>      httpGet:
</span></span><span style="display:flex;"><span>        path: /health
</span></span><span style="display:flex;"><span>        port: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>      initialDelaySeconds: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>      timeoutSeconds: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f startupprobe-httpget.yaml </span>
</span></span><span style="display:flex;"><span>pod/startupprobe-httpget created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe po startupprobe-httpget </span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    Startup:        http-get http://:8080/health delay<span style="color:#f92672">=</span>15s timeout<span style="color:#f92672">=</span>1s period<span style="color:#f92672">=</span>10s <span style="color:#75715e">#success=1 #failure=3</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason     Age               From               Message
</span></span><span style="display:flex;"><span>  ----     ------     ----              ----               -------
</span></span><span style="display:flex;"><span>  Normal   Scheduled  56s               default-Scheduler  Successfully assigned default/startupprobe-httpget to k8s-node02
</span></span><span style="display:flex;"><span>  Normal   Pulling    56s               kubelet            Pulling image <span style="color:#e6db74">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>  Normal   Pulled     40s               kubelet            Successfully pulled image <span style="color:#e6db74">&#34;nginx&#34;</span> in 15.591936231s
</span></span><span style="display:flex;"><span>  Normal   Created    40s               kubelet            Created container nginx
</span></span><span style="display:flex;"><span>  Normal   Started    40s               kubelet            Started container nginx
</span></span><span style="display:flex;"><span>  Warning  Unhealthy  7s <span style="color:#f92672">(</span>x2 over 17s<span style="color:#f92672">)</span>  kubelet            Startup probe failed: Get <span style="color:#e6db74">&#34;http://172.27.14.202:8080/health&#34;</span>: dial tcp 172.27.14.202:8080: connect: connection refused
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹PodçŠ¶æ€ï¼Œå¥åº·æ£€æŸ¥ä¸é€šè¿‡ï¼Œå¤„äºRunningä½†å¹¶æ²¡æœ‰Readyï¼Œå¹¶ä¸”è¿˜åœ¨ä¸æ–­é‡å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po</span>
</span></span><span style="display:flex;"><span>NAME                   READY   STATUS    RESTARTS      AGE
</span></span><span style="display:flex;"><span>startupprobe-httpget   0/1     Running   <span style="color:#ae81ff">5</span> <span style="color:#f92672">(</span>20s ago<span style="color:#f92672">)</span>   4m40s
</span></span></code></pre></div><h3 id="livenessprobeå®ä¾‹">livenessProbeå®ä¾‹<a hidden class="anchor" aria-hidden="true" href="#livenessprobeå®ä¾‹">#</a></h3>
<p>é‡‡ç”¨ExecActionæ¢æµ‹æ–¹å¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºliveness.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &lt;&lt; &#34;EOF&#34; &gt; livenessprobe-exec.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    test: livenessprobe-exec
</span></span><span style="display:flex;"><span>  name: livenessprobe-exec
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: liveness
</span></span><span style="display:flex;"><span>    image: busybox
</span></span><span style="display:flex;"><span>    args:
</span></span><span style="display:flex;"><span>    - /bin/sh
</span></span><span style="display:flex;"><span>    - -c
</span></span><span style="display:flex;"><span>    - echo ok &gt; /tmp/healthy; sleep 10; rm -rf /tmp/healthy; sleep <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>    livenessProbe:
</span></span><span style="display:flex;"><span>      exec:
</span></span><span style="display:flex;"><span>        command:
</span></span><span style="display:flex;"><span>        - cat
</span></span><span style="display:flex;"><span>        - /tmp/healthy
</span></span><span style="display:flex;"><span>      initialDelaySeconds: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>      periodSeconds: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f livenessprobe-exec.yaml</span>
</span></span><span style="display:flex;"><span>pod/livenessprobe-exec created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe po livenessprobe-exec</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    Liveness:       exec <span style="color:#f92672">[</span>cat /tmp/healthy<span style="color:#f92672">]</span> delay<span style="color:#f92672">=</span>15s timeout<span style="color:#f92672">=</span>1s period<span style="color:#f92672">=</span>5s <span style="color:#75715e">#success=1 #failure=3</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason     Age   From               Message
</span></span><span style="display:flex;"><span>  ----     ------     ----  ----               -------
</span></span><span style="display:flex;"><span>  Normal   Scheduled  34s   default-Scheduler  Successfully assigned default/livenessprobe-exec to k8s-node02
</span></span><span style="display:flex;"><span>  Normal   Pulling    33s   kubelet            Pulling image <span style="color:#e6db74">&#34;busybox&#34;</span>
</span></span><span style="display:flex;"><span>  Normal   Pulled     20s   kubelet            Successfully pulled image <span style="color:#e6db74">&#34;busybox&#34;</span> in 13.224110856s
</span></span><span style="display:flex;"><span>  Normal   Created    20s   kubelet            Created container liveness
</span></span><span style="display:flex;"><span>  Normal   Started    20s   kubelet            Started container liveness
</span></span><span style="display:flex;"><span>  Warning  Unhealthy  4s    kubelet            Liveness probe failed: cat: can not open <span style="color:#e6db74">&#39;/tmp/healthy&#39;</span>: No such file or directory
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è§‚å¯ŸPodçŠ¶æ€å¯ä»¥å‘ç°ä¸€å¼€å§‹æ˜¯æ­£å¸¸çš„ï¼Œåé¢å› ä¸ºå¥åº·æ£€æŸ¥å¤±è´¥é‡å¯äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po</span>
</span></span><span style="display:flex;"><span>NAME                 READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>livenessprobe-exec   1/1     Running   <span style="color:#ae81ff">0</span>          75s
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po</span>
</span></span><span style="display:flex;"><span>NAME                 READY   STATUS    RESTARTS      AGE
</span></span><span style="display:flex;"><span>livenessprobe-exec   1/1     Running   <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>21s ago<span style="color:#f92672">)</span>   91s
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼ŒPod ä¸­åªæœ‰ä¸€ä¸ªå®¹å™¨ã€‚<code>periodSeconds</code>å­—æ®µæŒ‡å®šäº† kubelet åº”è¯¥æ¯ 5 ç§’æ‰§è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥ã€‚<code>initialDelaySeconds</code>å­—æ®µå‘Šè¯‰ kubelet åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹å‰åº”è¯¥ç­‰å¾… 15 ç§’ã€‚ kubelet åœ¨å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤<code>cat /tmp/healthy</code>æ¥è¿›è¡Œæ¢æµ‹ã€‚ å¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸå¹¶ä¸”è¿”å›å€¼ä¸º 0ï¼Œkubelet å°±ä¼šè®¤ä¸ºè¿™ä¸ªå®¹å™¨æ˜¯å¥åº·å­˜æ´»çš„ã€‚ å¦‚æœè¿™ä¸ªå‘½ä»¤è¿”å›é 0 å€¼ï¼Œkubelet ä¼šæ€æ­»è¿™ä¸ªå®¹å™¨å¹¶é‡æ–°å¯åŠ¨å®ƒã€‚</p>
<h3 id="readinessprobeå®ä¾‹">readinessProbeå®ä¾‹<a hidden class="anchor" aria-hidden="true" href="#readinessprobeå®ä¾‹">#</a></h3>
<p>é‡‡ç”¨TCPSocketActionæ¢æµ‹æ–¹å¼</p>
<p>nginxå¯åŠ¨åé»˜è®¤å¼€å¯80ç«¯å£ï¼Œä¸‹é¢å¥åº·æ£€æŸ¥ä¼šé€šè¿‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim readinessprobe-tcpsocket.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    test: readinessprobe-tcpsocket
</span></span><span style="display:flex;"><span>  name: readinessprobe-tcpsocket
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: nginx
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>    ports:
</span></span><span style="display:flex;"><span>    - containerPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    readinessProbe:
</span></span><span style="display:flex;"><span>      tcpSocket:
</span></span><span style="display:flex;"><span>        port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      initialDelaySeconds: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>      periodSeconds: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f readinessprobe-tcpsocket.yaml </span>
</span></span><span style="display:flex;"><span>pod/readinessprobe-tcpsocket created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po readinessprobe-tcpsocket </span>
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>readinessprobe-tcpsocket   1/1     Running   <span style="color:#ae81ff">0</span>          20s
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe po readinessprobe-tcpsocket </span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    Readiness:      tcp-socket :80 delay<span style="color:#f92672">=</span>5s timeout<span style="color:#f92672">=</span>1s period<span style="color:#f92672">=</span>10s <span style="color:#75715e">#success=1 #failure=3</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type    Reason     Age   From               Message
</span></span><span style="display:flex;"><span>  ----    ------     ----  ----               -------
</span></span><span style="display:flex;"><span>  Normal  Scheduled  112s  default-Scheduler  Successfully assigned default/readinessprobe-tcpsocket to k8s-node02
</span></span><span style="display:flex;"><span>  Normal  Pulling    112s  kubelet            Pulling image <span style="color:#e6db74">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>  Normal  Pulled     102s  kubelet            Successfully pulled image <span style="color:#e6db74">&#34;nginx&#34;</span> in 9.699109421s
</span></span><span style="display:flex;"><span>  Normal  Created    102s  kubelet            Created container nginx
</span></span><span style="display:flex;"><span>  Normal  Started    102s  kubelet            Started container nginx
</span></span></code></pre></div><p><code>Successfully pulled image &quot;nginx&quot; in 9.699109421s</code>æ‹‰å–é•œåƒèŠ±æ—¶é—´çº¦9.7sï¼Œå¥åº·æ£€æŸ¥é—´éš”æ—¶é—´æ˜¯10sï¼Œæ‰€ä»¥å¤§çº¦åœ¨19.7sPodæ ‡è®°ä¸ºRunningçŠ¶æ€</p>
<h2 id="podç”Ÿå‘½å‘¨æœŸ">Podç”Ÿå‘½å‘¨æœŸ<a hidden class="anchor" aria-hidden="true" href="#podç”Ÿå‘½å‘¨æœŸ">#</a></h2>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/kubernetes-pod-life-cycle.jpg" alt="kubernetes-pod-life-cycle"  />
</p>
<p>ä»¥ä¸‹Podåˆ›å»ºå’Œåˆ é™¤æµç¨‹å»ºç«‹åœ¨å®¹å™¨è¿è¡Œæ—¶ä¸ºcontainerdåŸºç¡€ä¸Šè¿›è¡Œ</p>
<h3 id="podåˆ›å»ºæµç¨‹">Podåˆ›å»ºæµç¨‹<a hidden class="anchor" aria-hidden="true" href="#podåˆ›å»ºæµç¨‹">#</a></h3>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/Pod%e5%88%9b%e5%bb%ba%e6%b5%81%e7%a8%8b.drawio.png" alt="1"  />
</p>
<ul>
<li>ç”¨æˆ·é€šè¿‡kubectlã€RESTful APIæˆ–å…¶ä»–å®¢æˆ·ç«¯å‘APIServerå‘èµ·åˆ›å»ºpodè¯·æ±‚</li>
<li>APIServerå°†podå¯¹è±¡å†™å…¥etcdæŒä¹…åŒ–å­˜å‚¨ï¼Œå†™å…¥æˆåŠŸåï¼ŒAPIServerå°†æ”¶åˆ°etcdçš„ç¡®è®¤ä¿¡æ¯</li>
<li>APIServeræ ‡è®°æ–°çš„podè¢«åˆ›å»º</li>
<li>Schedulerç›‘å¬åˆ°APIServerå¤„æœ‰æ–°çš„podè¢«åˆ›å»ºã€‚é¦–å…ˆæ£€æŸ¥podæ˜¯å¦å·²ç»è°ƒåº¦ï¼ˆæ£€æŸ¥spec.nodeNameå­—æ®µï¼‰ï¼Œå¦‚æœæœªè¢«è°ƒåº¦ï¼Œé‚£ä¹ˆSchedulerä¼šä¸ºpodåˆ†é…ä¸€ä¸ªåˆé€‚çš„è°ƒåº¦èŠ‚ç‚¹ï¼Œå¹¶å°†çŠ¶æ€å†™å…¥<code>spec.nodeName</code>å­—æ®µä¸­ï¼Œå®Œæˆpodçš„ç»‘å®š</li>
<li>Scheduleråé¦ˆpodçš„ç»‘å®šä¿¡æ¯åˆ°APIServeråå†™å…¥etcdï¼ŒåŒæ—¶Schedulerä¹ŸæŒç»­ç›‘å¬podå¯¹è±¡çš„å˜åŒ–ï¼Œè‹¥<code>spec.nodeName</code>å­—æ®µä¸ä¸ºç©ºï¼Œåˆ™ä¸è¿›è¡Œä»»ä½•å¤„ç†</li>
<li>kubeletç›‘å¬APIServerå¤„podçš„å˜åŒ–ï¼Œå½“å‘ç°podè¢«è°ƒåº¦åˆ°è‡ªå·±æ‰€åœ¨çš„èŠ‚ç‚¹æ—¶ï¼ˆå³<code>spec.nodeName</code>å­—æ®µå€¼ä¸ºè‡ªå·±æ‰€åœ¨èŠ‚ç‚¹ï¼‰ï¼Œkubeletè°ƒç”¨CRI gRPCç”³è¯·å¯åŠ¨å®¹å™¨</li>
<li>kubeleté¦–å…ˆè°ƒç”¨RunPodSandboxæ¥å£ã€‚containerdç¡®è®¤PodSandboxçš„pauseé•œåƒæ˜¯å¦å­˜åœ¨ã€‚ç”±äºæ‰€æœ‰PodSandboxä½¿ç”¨åŒä¸€ä¸ªpauseé•œåƒï¼Œå¦‚æœèŠ‚ç‚¹ä¸­å·²æœ‰å…¶ä»–åœ¨è¿è¡Œçš„podï¼Œåˆ™pauseå°±å·²ç»å­˜åœ¨ã€‚æ¥ç€åˆ›å»ºNetwork Namespaceï¼Œè°ƒç”¨CNIæ¥å£è®¾ç½®å®¹å™¨ç½‘ç»œï¼Œcontainerdä½¿ç”¨è¿™ä¸ªç½‘ç»œå¯åŠ¨PodSandbox</li>
<li>kubeletç”³è¯·åœ¨PodSandboxä¸‹åˆ›å»ºå®¹å™¨ï¼Œå¦‚æœé•œåƒä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨CRIçš„PullImageæ¥å£é€šè¿‡containerdæ‹‰å–é•œåƒ</li>
<li>kubeletè°ƒç”¨CRIçš„CreateContaineræ¥å£é€šè¿‡containerdåˆ›å»ºå®¹å™¨</li>
<li>kubeletè°ƒç”¨StartContaineræ¥å£é€šè¿‡containerdå¯åŠ¨å®¹å™¨</li>
<li>æ— è®ºå®¹å™¨æ˜¯å¦å¯åŠ¨æˆåŠŸï¼Œkubeletéƒ½ä¼šå°†æœ€æ–°çš„å®¹å™¨çŠ¶æ€æ›´æ–°åˆ°podçš„<code>status</code>å­—æ®µä¸­ï¼Œå…¶ä»–æ§åˆ¶å™¨ç»„ä»¶é€šè¿‡è¯¥å­—æ®µè·å–podçš„çŠ¶æ€</li>
<li>APIServerå°†podçŠ¶æ€å†™å…¥etcdï¼Œkubeletå°†æŒç»­ç›‘å¬APIServer</li>
</ul>
<h3 id="podåˆ é™¤æµç¨‹">Podåˆ é™¤æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#podåˆ é™¤æµç¨‹">#</a></h3>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/Pod%e5%88%a0%e9%99%a4%e6%b5%81%e7%a8%8b.drawio.png" alt="2"  />
</p>
<ul>
<li>ç”¨æˆ·é€šè¿‡kubectlã€RESTful APIæˆ–å…¶ä»–å®¢æˆ·ç«¯å‘APIServerå‘èµ·åˆ é™¤podè¯·æ±‚</li>
<li>podå¯¹è±¡ä¸ä¼šè¢«APIServerç«‹å³åˆ é™¤ï¼ŒAPIServeråœ¨podä¸­æ·»åŠ <code>deletionTimestamp</code>å’Œ<code>deletionGracePeriodSecondsï¼ˆé»˜è®¤30sï¼‰</code>å­—æ®µï¼Œå¹¶å†™å…¥etcdä¸­</li>
<li>APIServerå°†podå·²åˆ é™¤çš„ä¿¡æ¯è¿”å›ç»™ç”¨æˆ·ï¼Œç”¨æˆ·æŸ¥çœ‹podçŠ¶æ€å·²è¢«æ›´æ–°ä¸ºTerminating</li>
<li>kubeletç›‘å¬åˆ°APIServerå¤„çš„è‡ªèº«çš„podå¯¹è±¡<code>deletionTimestamp</code>å­—æ®µè¢«è®¾ç½®æ—¶ï¼Œå¼€å§‹å‡†å¤‡åˆ é™¤pod</li>
<li>kubeletè°ƒç”¨StopContaineræ¥å£é€šè¿‡containerdåœæ­¢å®¹å™¨ï¼Œcontainerdé¦–å…ˆä¼šè°ƒç”¨runcå‘å®¹å™¨å‘é€SIGTERMä¿¡å·ï¼Œå®¹å™¨åœæ­¢æˆ–<code>deletionGracePeriodSeconds</code>è¶…æ—¶åï¼Œruncå‘é€SIGKILLä¿¡å·æ€æ­»æ‰€æœ‰å®¹å™¨è¿›ç¨‹ï¼Œå®Œæˆå®¹å™¨åœæ­¢</li>
<li>kubeletæ”¶åˆ°containerdçš„å®¹å™¨å·²åœæ­¢ä¿¡æ¯åï¼Œå°†çŠ¶æ€æ›´æ–°åˆ°podçš„<code>status</code>å­—æ®µä¸­</li>
<li>APIServeræ›´æ–°podçŠ¶æ€å¹¶å†™å…¥etcd</li>
<li>endpointç›‘å¬åˆ°podçŠ¶æ€å‘ç”Ÿæ”¹å˜åï¼Œåˆ é™¤podç›¸å…³çš„endpointå¯¹è±¡</li>
<li>APIServeræ›´æ–°endpointçŠ¶æ€å¹¶å†™å…¥etcd</li>
<li>kube-proxyç›‘å¬åˆ°endpointå˜åŒ–åï¼Œç§»é™¤podç›¸å…³çš„è½¬å‘è§„åˆ™</li>
<li>podå†…æ‰€æœ‰å®¹å™¨è¢«åœæ­¢åï¼Œcontainerdè°ƒç”¨CNIå°†å®¹å™¨çš„ç½‘ç»œåˆ é™¤ï¼Œç„¶åé€šè¿‡StopPodSandboxæ¥å£åœæ­¢PodSandboxï¼Œåœæ­¢åï¼Œkubeletè¿›è¡Œä¸€ç³»åˆ—çš„æ¸…ç†å·¥ä½œï¼Œä¾‹å¦‚æ¸…ç†podçš„CGroup</li>
<li>å¦‚æœpodæœ‰<code>finalizer</code>ï¼Œå³ä½¿PodSandboxè¢«åœæ­¢ï¼Œè¿™ä¸ªpodä¹Ÿä¸ä¼šæ¶ˆå¤±ï¼Œéœ€è¦ç­‰å¾…å…¶ä»–æ§åˆ¶å™¨å®Œæˆfinalizerç›¸å…³çš„æ¸…ç†å·¥ä½œï¼Œfinalizeræ¸…ç©ºåï¼ŒcanBeDeletedæ–¹æ³•è¿”å›trueï¼Œkubeletå‘èµ·æœ€ç»ˆçš„<code>deletionGracePeriodSeconds=0</code>çš„åˆ é™¤è¯·æ±‚</li>
<li>APIServerå°†podä»etcdä¸­å½»åº•åˆ é™¤ï¼Œkubeletå®æ—¶ç›‘å¬</li>
</ul>
<h3 id="podä¼˜é›…é€€å‡º">Podä¼˜é›…é€€å‡º<a hidden class="anchor" aria-hidden="true" href="#podä¼˜é›…é€€å‡º">#</a></h3>
<p>Podæ­£å¸¸æƒ…å†µä¸‹é€€å‡ºï¼ˆåˆ é™¤ï¼‰æµç¨‹æœ‰ä¸¤ä¸ªæ—¶é—´çº¿ï¼šç½‘ç»œè§„åˆ™æ¸…ç†å’ŒPodæœ¬èº«çš„åˆ é™¤ã€‚è¿™ä¸¤ä¸ªæ—¶é—´çº¿æ˜¯å¹¶è¡Œçš„ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š</p>
<p>ç½‘ç»œè§„åˆ™æ¸…ç†æµç¨‹ï¼š</p>
<ul>
<li>APIServerä¼šæ”¶åˆ°Podåˆ é™¤çš„è¯·æ±‚ï¼Œåœ¨Etcdä¸­æ›´æ–°Podçš„çŠ¶æ€ä¸ºTerminating</li>
<li>Endpoint Controllerå°†è¯¥Podçš„ipä»Endpointå¯¹è±¡ä¸­åˆ é™¤</li>
<li>Kube-proxyæ ¹æ®Endpointå¯¹è±¡çš„æ”¹å˜æ›´æ–°ç½‘ç»œè§„åˆ™ï¼ˆiptablesæˆ–ipvsï¼‰ï¼Œä¸å†å°†æµé‡è·¯ç”±åˆ°è¢«åˆ é™¤çš„Pod</li>
</ul>
<p>Podåˆ é™¤æµç¨‹ï¼š</p>
<ul>
<li>APIServer ä¼šæ”¶åˆ°Podåˆ é™¤çš„è¯·æ±‚ï¼Œåœ¨Etcdä¸­æ›´æ–°Podçš„çŠ¶æ€ä¸ºTerminatingï¼›</li>
<li>kubeletåœ¨èŠ‚ç‚¹ä¸Šæ¸…ç†å®¹å™¨çš„ç›¸å…³èµ„æºï¼Œä¾‹å¦‚å­˜å‚¨ï¼Œç½‘ç»œ</li>
<li>kubeletå‘é€SIGTERMè¿›ç¨‹ç»™å®¹å™¨ï¼Œå¦‚æœå®¹å™¨ä¸­çš„è¿›ç¨‹æœªåšä»»ä½•é…ç½®ï¼Œåˆ™å®¹å™¨ç«‹å³é€€å‡º</li>
<li>å¦‚æœå®¹å™¨æœªåœ¨é»˜è®¤çš„30ç§’æ—¶é—´å†…é€€å‡ºï¼ŒKubeletå‘é€SIGKILLç»™å®¹å™¨ï¼Œå¼ºåˆ¶è®©å®¹å™¨é€€å‡º</li>
</ul>
<p>å®é™…ç¯å¢ƒå¯èƒ½ä¼šé‡åˆ°çš„æƒ…å†µï¼š</p>
<ul>
<li>podçš„è¯·æ±‚æœªå¤„ç†å®Œå°±è¢«é€€å‡º</li>
<li>podå·²ç»é€€å‡ºè¿˜æœ‰æµé‡æµå‘podï¼ˆå³ç½‘ç»œè§„åˆ™æœªæ¸…ç†å®ŒæˆPodå·²ç»è¢«åˆ é™¤äº†ï¼‰</li>
</ul>
<p>ä¸Šé¢è¿™ä¸¤ç§æƒ…å†µéœ€è¦è®¾ç½®podä¼˜é›…é€€å‡ºå‚æ•°æ¥ä¼˜åŒ–é€€å‡ºæµç¨‹ã€‚å¯ä»¥å¢åŠ <code>preStop</code>ç”Ÿå‘½å‘¨æœŸå‚æ•°æˆ–ä¿®æ”¹<code>terminationGracePeriodSeconds</code>å‚æ•°ã€‚<code>preStop</code>ç”¨æ¥å®Œæˆpodé€€å‡ºå‰è¦æ‰§è¡Œçš„æ“ä½œï¼Œ</p>
<blockquote>
<p>å¦‚æœ preStop å›è°ƒæ‰€éœ€è¦çš„æ—¶é—´é•¿äºé»˜è®¤30sï¼Œåˆ™å¿…é¡»ä¿®æ”¹ terminationGracePeriodSeconds å±æ€§å€¼æ¥ä½¿å…¶æ­£å¸¸å·¥ä½œã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å®ä¾‹</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: lifecycle-demo
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  terminationGracePeriodSeconds: <span style="color:#ae81ff">45</span> <span style="color:#75715e"># set terminationGracePeriodSeconds</span>
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: lifecycle-demo-container
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>    lifecycle:
</span></span><span style="display:flex;"><span>      postStart:
</span></span><span style="display:flex;"><span>        exec:
</span></span><span style="display:flex;"><span>          command: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;echo Hello from the postStart &gt; /usr/share/message&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      preStop:
</span></span><span style="display:flex;"><span>        exec:
</span></span><span style="display:flex;"><span>          command: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;nginx -s quit; while killall -0 nginx; do sleep 1; done&#34;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div>

        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetespodcontroller/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>KubernetesPodController</span>
  </a>
  <a class="next" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesnamespace/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>KubernetesNamespace</span>
  </a>
</nav>

        </footer>
    </div>
</article>
</main>

<footer class="footer">
    
        <span id="runtime_span"></span>
        <script
            type="text/javascript">function show_runtime() { window.setTimeout("show_runtime()", 1000); X = new Date("1/1/2023 1:00:00"); Y = new Date(); T = (Y.getTime() - X.getTime()); M = 24 * 60 * 60 * 1000; a = T / M; A = Math.floor(a); b = (a - A) * 24; B = Math.floor(b); c = (b - B) * 60; C = Math.floor((b - B) * 60); D = Math.floor((c - C) * 60); runtime_span.innerHTML = "ç½‘ç«™å·²è¿è¡Œ" + A + "å¤©" + B + "å°æ—¶" + C + "åˆ†" + D + "ç§’" } show_runtime();</script>
    
    
    <br>
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="https://deemoprobe.github.io/" style="color:#939393;">William&#39;s Blog</a>
        All Rights Reserved
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>

<script>
    $("code[class^=language] ").on("mouseover", function () {
        if (this.clientWidth < this.scrollWidth) {
            $(this).css("width", "135%")
            $(this).css("border-top-right-radius", "var(--radius)")
        }
    }).on("mouseout", function () {
        $(this).css("width", "100%")
        $(this).css("border-top-right-radius", "unset")
    })
</script>
</body>

</html>
