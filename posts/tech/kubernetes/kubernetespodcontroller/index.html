<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>KubernetesPodController | William&#39;s Blog</title>
<meta name="keywords" content="kubernetes">
<meta name="description" content="Kubernetes Podæ§åˆ¶å™¨">
<meta name="author" content="deemoprobe">
<link rel="canonical" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetespodcontroller/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.11a4e51227487a416fd8f8707b1c9781184164b2b97400205e95b828f6a0d948.css" integrity="sha256-EaTlEidIekFv2PhwexyXgRhBZLK5dAAgXpW4KPag2Ug=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://deemoprobe.github.io/img/bear.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://deemoprobe.github.io/img/bear.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://deemoprobe.github.io/img/bear.gif">
<link rel="apple-touch-icon" href="https://deemoprobe.github.io/img/bear.gif">
<link rel="mask-icon" href="https://deemoprobe.github.io/img/bear.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="KubernetesPodController" />
<meta property="og:description" content="Kubernetes Podæ§åˆ¶å™¨" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetespodcontroller/" />
<meta property="og:image" content="https://deemoprobe.github.io/img/kubernetes.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-29T14:23:19+08:00" />
<meta property="article:modified_time" content="2023-04-29T14:23:19+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://deemoprobe.github.io/img/kubernetes.png" />
<meta name="twitter:title" content="KubernetesPodController"/>
<meta name="twitter:description" content="Kubernetes Podæ§åˆ¶å™¨"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://deemoprobe.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
          "item": "https://deemoprobe.github.io/posts/tech/"
        },

        {
          "@type": "ListItem",
          "position":  3 ,
          "name": "Kubernetes",
          "item": "https://deemoprobe.github.io/posts/tech/kubernetes/"
        }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "KubernetesPodController",
      "item": "https://deemoprobe.github.io/posts/tech/kubernetes/kubernetespodcontroller/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "KubernetesPodController",
  "name": "KubernetesPodController",
  "description": "Kubernetes Podæ§åˆ¶å™¨",
  "keywords": [
    "kubernetes"
  ],
  "articleBody": "Kubernetes ä¸­å†…å»ºäº†å¾ˆå¤š Controller(æ§åˆ¶å™¨)ï¼Œç”¨æ¥ç¡®ä¿podèµ„æºç¬¦åˆé¢„æœŸçš„çŠ¶æ€ï¼Œæ§åˆ¶ Pod çš„çŠ¶æ€å’Œè¡Œä¸ºã€‚\næ§åˆ¶å™¨ç±»å‹ ReplicationController(rc) ReplicaSet(rs) Deployment(deploy) DaemonSet(ds) StatefulSet(sts) Job/CronJob(cj) Horizontal Pod Autoscaling(hpa) # å¯ä»¥ä½¿ç”¨kubectl explainå‘½ä»¤æŸ¥çœ‹k8s APIèµ„æºå¯¹è±¡æè¿°ä¿¡æ¯ kubectl explain | egrep -v \"^$|^\\s*http\" | sed s/\"More info:\"// # æŸ¥çœ‹APIèµ„æºåˆ—è¡¨ kubectl api-resources RSå’ŒRC ReplicationController(RC)ç”¨æ¥ç¡®ä¿å®¹å™¨åº”ç”¨çš„å‰¯æœ¬æ•°å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•°ï¼Œå³å¦‚æœæœ‰å®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ Pod æ¥æ›¿ä»£ï¼›è€Œå¦‚æœå¼‚å¸¸å¤šå‡ºæ¥çš„å®¹å™¨ä¹Ÿä¼šè‡ªåŠ¨å›æ”¶ã€‚\nåœ¨æ–°ç‰ˆæœ¬çš„Kubernetesä¸­å»ºè®®ä½¿ç”¨ReplicaSetæ¥å–ä»£ReplicationControllerï¼ŒReplicaSetè§„åˆ™è·ŸReplicationControlleræ²¡æœ‰æœ¬è´¨çš„ä¸åŒï¼Œå”¯ä¸€åŒºåˆ«æ˜¯ReplicaSetæ”¯æŒselectoré€‰æ‹©å™¨ã€‚\nReplicaSetä¹Ÿå¾ˆå°‘å•ç‹¬è¢«ä½¿ç”¨ï¼Œéƒ½æ˜¯ä½¿ç”¨æ›´é«˜çº§çš„èµ„æºDeploymentã€DaemonSetã€StatefulSetè¿›è¡Œç®¡ç†Podï¼ŒReplicaSetä¸»è¦ç”¨ä½œDeploymentåè°ƒåˆ›å»ºã€åˆ é™¤å’Œæ›´æ–°Podã€‚\n# RCå®ä¾‹ï¼Œä¹Ÿæ˜¯åé¢çš„rc-demo.yamlä¸­çš„å†…å®¹ apiVersion: v1 kind: ReplicationController metadata: name: nginx spec: replicas: 2 selector: app: nginx template: metadata: name: nginx labels: app: nginx spec: containers: - name: nginx image: nginx imagePullPolicy: IfNotPresent ports: - containerPort: 80 # RSå®ä¾‹ï¼Œå’ŒRCé…ç½®çš„ä¸»è¦åŒºåˆ«æ˜¯å¤šäº†ä¸ªselector apiVersion: apps/v1 kind: ReplicaSet metadata: name: frontend labels: app: guestbook tier: frontend spec: replicas: 2 selector: matchLabels: tier: frontend template: metadata: labels: tier: frontend spec: containers: - name: php-redis image: gcr.io/google_samples/gb-frontend:v3 # ä»¥ä¸Šé¢RCå®ä¾‹é…ç½®ä¸ºä¾‹ [root@k8s-master01 ~]# kubectl apply -f rc-demo.yaml replicationcontroller/nginx created [root@k8s-master01 ~]# kubectl get po,rc NAME READY STATUS RESTARTS AGE pod/nginx-5w6v6 1/1 Running 0 6s pod/nginx-8265c 1/1 Running 0 6s NAME DESIRED CURRENT READY AGE replicationcontroller/nginx 2 2 2 6s # RCçš„PodåŠ¨æ€ç¼©æ”¾ [root@k8s-master01 ~]# kubectl scale rc nginx --replicas=3 replicationcontroller/nginx scaled # å¯ä»¥çœ‹åˆ°æ­£åœ¨æ‰©å®¹ [root@k8s-master01 ~]# kubectl get po,rc NAME READY STATUS RESTARTS AGE pod/nginx-5w6v6 1/1 Running 0 97s pod/nginx-8265c 1/1 Running 0 97s pod/nginx-jhsjr 0/1 ContainerCreating 0 3s NAME DESIRED CURRENT READY AGE replicationcontroller/nginx 3 3 2 97s # æ‰©å®¹æˆåŠŸ [root@k8s-master01 ~]# kubectl get po,rc NAME READY STATUS RESTARTS AGE pod/nginx-5w6v6 1/1 Running 0 2m17s pod/nginx-8265c 1/1 Running 0 2m17s pod/nginx-jhsjr 1/1 Running 0 43s # ç¼©å®¹æµ‹è¯• [root@k8s-master01 ~]# kubectl scale rc nginx --replicas=1 replicationcontroller/nginx scaled [root@k8s-master01 ~]# kubectl get po,rc NAME READY STATUS RESTARTS AGE pod/nginx-5w6v6 1/1 Running 0 4m26s NAME DESIRED CURRENT READY AGE replicationcontroller/nginx 1 1 1 4m26s Deployment ç”¨äºéƒ¨ç½²æ— çŠ¶æ€çš„æœåŠ¡ï¼Œæœ€å¸¸ç”¨çš„æ§åˆ¶å™¨ã€‚ä¸€èˆ¬ç”¨äºç®¡ç†ç»´æŠ¤ä¼ä¸šå†…éƒ¨æ— çŠ¶æ€çš„å¾®æœåŠ¡ï¼Œæ¯”å¦‚configserverã€zuulã€springbootã€‚å¯ä»¥ç®¡ç†å¤šä¸ªå‰¯æœ¬çš„Podå®ç°æ— ç¼è¿ç§»ã€è‡ªåŠ¨æ‰©å®¹ç¼©å®¹ã€è‡ªåŠ¨ç¾éš¾æ¢å¤ã€ä¸€é”®å›æ»šç­‰åŠŸèƒ½ã€‚\nDeploymentæ˜¯ä¸€ç§æ›´é«˜çº§åˆ«çš„ API èµ„æºå¯¹è±¡ï¼Œä¸º Pods å’Œ ReplicaSets æä¾›å£°æ˜å¼çš„æ›´æ–°èƒ½åŠ›ã€‚å®ƒä»¥ç±»ä¼¼äº kubectl rolling-update çš„æ–¹å¼æ›´æ–°å…¶åº•å±‚ ReplicaSet åŠå…¶ Podã€‚\nDeployments çš„å…¸å‹ç”¨ä¾‹ï¼š\nåˆ›å»ºDeploymentå°†ReplicaSetä¸Šçº¿ã€‚ReplicaSet åœ¨åå°åˆ›å»º Pods.æ£€æŸ¥ ReplicaSet çš„ä¸Šçº¿çŠ¶æ€ï¼ŒæŸ¥çœ‹å…¶æ˜¯å¦æˆåŠŸ é€šè¿‡æ›´æ–° Deployment çš„ PodTemplateSpecï¼Œå£°æ˜ Pod çš„æ–°çŠ¶æ€ã€‚æ–°çš„ ReplicaSet ä¼šè¢«åˆ›å»ºï¼ŒDeployment å°† Pod ä»æ—§ ReplicaSet è¿ç§»åˆ°æ–° ReplicaSetã€‚ æ¯ä¸ªæ–°çš„ ReplicaSet éƒ½ä¼šæ›´æ–° Deployment çš„ä¿®è®¢ç‰ˆæœ¬ å¦‚æœ Deployment çš„å½“å‰çŠ¶æ€ä¸ç¨³å®šï¼Œå›æ»šåˆ°è¾ƒæ—©çš„ Deployment ç‰ˆæœ¬ã€‚æ¯æ¬¡å›æ»šéƒ½ä¼šæ›´æ–° Deployment çš„ä¿®è®¢ç‰ˆæœ¬ æ‰©å¤§ Deployment è§„æ¨¡ä»¥æ‰¿æ‹…æ›´å¤šè´Ÿè½½ æš‚åœ Deployment ä»¥åº”ç”¨å¯¹ PodTemplateSpec æ‰€ä½œçš„å¤šé¡¹ä¿®æ”¹ï¼Œç„¶åæ¢å¤å…¶æ‰§è¡Œä»¥å¯åŠ¨æ–°çš„ä¸Šçº¿ç‰ˆæœ¬ ä½¿ç”¨ Deployment çŠ¶æ€æ¥åˆ¤å®šä¸Šçº¿è¿‡ç¨‹æ˜¯å¦å‡ºç°åœæ» æ¸…ç†è¾ƒæ—§çš„ä¸å†éœ€è¦çš„ ReplicaSet åˆ›å»ºDeployment Deploymentåˆ›å»ºä¸€ä¸ªReplicaSetï¼Œè¯¥RSè´Ÿè´£å¯åŠ¨ç®¡ç†ä¸‰ä¸ªPodã€‚\n# åˆ›å»ºyamlæ–‡ä»¶ [root@k8s-master01 ~]# vim nginx-deploy.yaml apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deploy labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.16.1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 [root@k8s-master01 ~]# kubectl apply -f nginx-deploy.yaml deployment.apps/nginx-deploy created [root@k8s-master01 ~]# kubectl get deploy,rs,po NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deploy 3/3 3 3 58s NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deploy-ff6655784 3 3 3 58s NAME READY STATUS RESTARTS AGE pod/nginx-deploy-ff6655784-2jxbv 1/1 Running 0 58s pod/nginx-deploy-ff6655784-b8gq8 1/1 Running 0 58s pod/nginx-deploy-ff6655784-qj2k2 1/1 Running 0 58s # æŸ¥çœ‹æ ‡ç­¾ [root@k8s-master01 ~]# kubectl get po --show-labels NAME READY STATUS RESTARTS AGE LABELS nginx-deploy-ff6655784-2jxbv 1/1 Running 0 98s app=nginx,pod-template-hash=ff6655784 nginx-deploy-ff6655784-b8gq8 1/1 Running 0 98s app=nginx,pod-template-hash=ff6655784 nginx-deploy-ff6655784-qj2k2 1/1 Running 0 98s app=nginx,pod-template-hash=ff6655784 # æ‰©ç¼©å®¹ [root@k8s-master01 ~]# kubectl scale deployment nginx-deploy --replicas=2 deployment.apps/nginx-deploy scaled [root@k8s-master01 ~]# kubectl get deploy,rs,po NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deploy 2/2 2 2 2m18s NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deploy-ff6655784 2 2 2 2m18s NAME READY STATUS RESTARTS AGE pod/nginx-deploy-ff6655784-b8gq8 1/1 Running 0 2m18s pod/nginx-deploy-ff6655784-qj2k2 1/1 Running 0 2m18s # æŸ¥çœ‹podè¯¦æƒ… [root@k8s-master01 ~]# kubectl get po -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-deploy-ff6655784-b8gq8 1/1 Running 0 2m40s 172.25.92.66 k8s-master02 nginx-deploy-ff6655784-qj2k2 1/1 Running 0 2m40s 172.17.125.18 k8s-node01 # è®¿é—®nginx [root@k8s-master01 ~]# curl 172.25.92.66 \u003c!DOCTYPE html\u003e Welcome to nginx! ... [root@k8s-master01 ~]# curl 172.17.125.18 \u003c!DOCTYPE html\u003e Welcome to nginx! ... è¯´æ˜:\nReplicaSet çš„åç§°å§‹ç»ˆè¢«æ ¼å¼åŒ–ä¸º[DEPLOYMENT-NAME]-[RANDOM-STRING]ã€‚RANDOM-STRINGéšæœºç”Ÿæˆã€‚å¹¶ä½¿ç”¨pod-template-hash=[RANDOM-STRING]ä½œä¸ºé€‰æ‹©å™¨å’Œæ ‡ç­¾ Deployment æ§åˆ¶å™¨å°†pod-template-hash=[RANDOM-STRING]æ ‡ç­¾æ·»åŠ åˆ° Deployment åˆ›å»ºæˆ–ä½¿ç”¨çš„ReplicaSetå’ŒPodã€‚æ­¤æ ‡ç­¾å¯ç¡®ä¿ Deploymentçš„å­ReplicaSetsä¸é‡å ï¼Œå› æ­¤ä¸å¯ä¿®æ”¹ æ³¨æ„Deploymentã€ReplicaSetå’ŒPodä¸‰è€…çš„åç§°å…³ç³» [root@k8s-master01 ~]# kubectl get rs --show-labels NAME DESIRED CURRENT READY AGE LABELS nginx-deploy-ff6655784 2 2 2 6m49s app=nginx,pod-template-hash=ff6655784 [root@k8s-master01 ~]# kubectl get deploy,rs,po --show-labels NAME READY UP-TO-DATE AVAILABLE AGE LABELS deployment.apps/nginx-deploy 2/2 2 2 8m2s app=nginx NAME DESIRED CURRENT READY AGE LABELS replicaset.apps/nginx-deploy-ff6655784 2 2 2 8m2s app=nginx,pod-template-hash=ff6655784 NAME READY STATUS RESTARTS AGE LABELS pod/nginx-deploy-ff6655784-b8gq8 1/1 Running 0 8m2s app=nginx,pod-template-hash=ff6655784 pod/nginx-deploy-ff6655784-qj2k2 1/1 Running 0 8m2s app=nginx,pod-template-hash=ff6655784 æ›´æ–°Deployment Deployment å¯ç¡®ä¿åœ¨æ›´æ–°æ—¶ä»…å…³é—­ä¸€å®šæ•°é‡çš„ Pods.é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒç¡®ä¿è‡³å°‘ 75% æ‰€éœ€ Pods åœ¨è¿è¡Œ(25%ä¸ºå®¹å¿çš„æœ€å¤§ä¸å¯ç”¨é‡)ã€‚æ›´æ–°æ—¶ä¸ä¼šå…ˆåˆ é™¤æ—§çš„podï¼Œè€Œæ˜¯å…ˆæ–°å»ºä¸€ä¸ªpod.æ–°podè¿è¡Œæ—¶ï¼Œæ‰ä¼šåˆ é™¤å¯¹åº”è€çš„podã€‚ä¸€åˆ‡çš„å‰æéƒ½æ˜¯ä¸ºäº†æ»¡è¶³ä¸Šè¿°çš„æ¡ä»¶ã€‚\nå¤‡æ³¨: å¦‚æœéœ€è¦æ›´æ–°Deploymentï¼Œæœ€å¥½é€šè¿‡yamlæ–‡ä»¶æ›´æ–°ï¼Œè¿™æ ·å›æ»šåˆ°ä»»ä½•ç‰ˆæœ¬éƒ½éå¸¸ä¾¿æ·ï¼Œè€Œä¸”æ›´å®¹æ˜“è¿½æº¯ã€‚\n# æ–¹å¼ä¸€: ç›´æ¥ä¿®æ”¹é•œåƒ[ä¸æ¨è] # æ‰§è¡Œä¸‹é¢å‘½ä»¤åä¿®æ”¹å¯¹äºé•œåƒç‰ˆæœ¬å³å¯, è¯¥æ–¹æ³•ä¸ä¼šè®°å½•å‘½ä»¤,é€šè¿‡kubectl rollout history deployment/nginx-deploy æ— æ³•æŸ¥è¯¢ [root@k8s-master01 ~]# kubectl edit deploy/nginx-deploy # æ–¹å¼äºŒ: å‘½ä»¤è¡Œæ›´æ–°image[å¯ä½¿ç”¨]ï¼Œä½†ä¹Ÿæç¤º--recordå³å°†åºŸå¼ƒ [root@k8s-master01 ~]# kubectl set image deploy/nginx-deploy nginx=nginx:1.18.0 --record Flag --record has been deprecated, --record will be removed in the future deployment.apps/nginx-deploy image updated [root@k8s-master01 ~]# kubectl rollout history deployment nginx-deploy deployment.apps/nginx-deploy REVISION CHANGE-CAUSE 1 2 kubectl set image deploy/nginx-deploy nginx=nginx:1.18.0 --record=true [root@k8s-master01 ~]# kubectl get deployments.apps -owide NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR nginx-deploy 2/2 2 2 16m nginx nginx:1.18.0 app=nginx # æ–¹å¼ä¸‰: ä½¿ç”¨yamlæ–‡ä»¶æ›´æ–°ç‰ˆæœ¬ # å½“å‰nginx ç‰ˆæœ¬æ˜¯1.16.1, æ›´æ–°åˆ°1.18.0 # å…ˆåˆ é™¤ä¹‹å‰æ›´æ–°çš„deployï¼Œåœ¨é‡æ–°å¯åŠ¨ [root@k8s-master01 ~]# kubectl delete -f nginx-deploy.yaml deployment.apps \"nginx-deploy\" deleted [root@k8s-master01 ~]# kubectl apply -f nginx-deploy.yaml deployment.apps/nginx-deploy created [root@k8s-master01 ~]# kubectl get deployments.apps -owide NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR nginx-deploy 3/3 3 3 35s nginx nginx:1.16.1 app=nginx # æ‹·è´ä¸€ä»½yamlæ–‡ä»¶ï¼ŒäºŒè€…é‡å‘½åï¼ˆè€ç‰ˆä¿ç•™ä»¥ä¾¿æœ‰é—®é¢˜æ—¶å›é€€ï¼‰ï¼Œç¼–è¾‘æ–°æ–‡ä»¶é•œåƒä¸º1.18.0 [root@k8s-master01 ~]# ll total 8 -rw-r--r-- 1 root root 337 Dec 21 09:59 nginx-deploy-1161.yaml -rw-r--r-- 1 root root 337 Dec 21 11:01 nginx-deploy-1180.yaml [root@k8s-master01 ~]# cat nginx-deploy-1161.yaml apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deploy labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.16.1 ports: - containerPort: 80 [root@k8s-master01 ~]# cat nginx-deploy-1180.yaml apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deploy labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.18.0 ports: - containerPort: 80 # åº”ç”¨é•œåƒä¸º1180çš„åŒæ ·çš„é…ç½®æ–‡ä»¶ # --record å‚æ•°å¯ä»¥è®°å½•å‘½ä»¤,é€šè¿‡ kubectl rollout history deployment/nginx-deployment å¯æŸ¥è¯¢ [root@k8s-master01 ~]# kubectl apply -f nginx-deploy-1180.yaml --record deployment.apps/nginx-deploy configured # å¦‚æœæ­£åœ¨æ›´æ–°, å¯çœ‹åˆ°ä¸‹é¢æ—¥å¿— [root@k8s-master01 ~]# kubectl rollout status deploy/nginx-deploy Waiting for deployment \"nginx-deploy\" rollout to finish: 1 out of 3 new replicas have been updated... Waiting for deployment \"nginx-deploy\" rollout to finish: 1 out of 3 new replicas have been updated... Waiting for deployment \"nginx-deploy\" rollout to finish: 2 out of 3 new replicas have been updated... Waiting for deployment \"nginx-deploy\" rollout to finish: 2 out of 3 new replicas have been updated... Waiting for deployment \"nginx-deploy\" rollout to finish: 2 out of 3 new replicas have been updated... Waiting for deployment \"nginx-deploy\" rollout to finish: 2 old replicas are pending termination... Waiting for deployment \"nginx-deploy\" rollout to finish: 1 old replicas are pending termination... Waiting for deployment \"nginx-deploy\" rollout to finish: 1 old replicas are pending termination... deployment \"nginx-deploy\" successfully rolled out # æ›´æ–°ç»“æŸå, å¯çœ‹åˆ°ä¸‹é¢æ—¥å¿— [root@k8s-master01 ~]# kubectl rollout status deploy/nginx-deploy deployment \"nginx-deploy\" successfully rolled out å›æ»šDeployment # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ [root@k8s-master01 ~]# kubectl rollout undo deployment nginx-deploy deployment.apps/nginx-deploy rolled back [root@k8s-master01 ~]# kubectl get deploy,rs,po -owide NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR deployment.apps/nginx-deploy 3/3 3 3 11m nginx nginx:1.16.1 app=nginx NAME DESIRED CURRENT READY AGE CONTAINERS IMAGES SELECTOR replicaset.apps/nginx-deploy-79fccc485 0 0 0 7m46s nginx nginx:1.18.0 app=nginx,pod-template-hash=79fccc485 replicaset.apps/nginx-deploy-ff6655784 3 3 3 11m nginx nginx:1.16.1 app=nginx,pod-template-hash=ff6655784 NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/nginx-deploy-ff6655784-c9gf9 1/1 Running 0 2m7s 172.25.92.69 k8s-master02 pod/nginx-deploy-ff6655784-xl4rx 1/1 Running 0 2m12s 172.27.14.228 k8s-node02 pod/nginx-deploy-ff6655784-zzpvm 1/1 Running 0 2m9s 172.17.125.22 k8s-node01 # ç›´æ¥ç”¨Yamlæ–‡ä»¶å›é€€[æ›´æ–°]ä¸ºå¯¹åº”é•œåƒ, æ¯”å¦‚ 1180--\u003e1161 [root@k8s-master01 ~]# kubectl apply -f nginx-deploy-1161.yaml --record å›é€€å†å²ç‰ˆæœ¬ # æŸ¥çœ‹å†å²ç‰ˆæœ¬ [root@k8s-master01 ~]# kubectl rollout history deployment nginx-deploy deployment.apps/nginx-deploy REVISION CHANGE-CAUSE 2 kubectl apply --filename=nginx-deploy.yaml --record=true 3 # æŸ¥çœ‹å†å²ç‰ˆæœ¬ä¿¡æ¯ [root@k8s-master01 ~]# kubectl rollout history deployment nginx-deploy --revision=2 deployment.apps/nginx-deploy with revision #2 Pod Template: Labels: app=nginx pod-template-hash=79fccc485 Annotations: kubernetes.io/change-cause: kubectl apply --filename=nginx-deploy.yaml --record=true Containers: nginx: Image: nginx:1.18.0 Port: 80/TCP Host Port: 0/TCP Environment: Mounts: Volumes: # å¯ä»¥ä½¿ç”¨--to-revisionå‚æ•°æŒ‡å®šå›é€€åˆ°æŸä¸ªå†å²ç‰ˆæœ¬ [root@k8s-master01 ~]# kubectl rollout undo deployment nginx-deploy --to-revision=2 deployment.apps/nginx-deploy rolled back [root@k8s-master01 ~]# kubectl get deploy,rs,po -owide NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR deployment.apps/nginx-deploy 3/3 3 3 14m nginx nginx:1.18.0 app=nginx NAME DESIRED CURRENT READY AGE CONTAINERS IMAGES SELECTOR replicaset.apps/nginx-deploy-79fccc485 3 3 3 10m nginx nginx:1.18.0 app=nginx,pod-template-hash=79fccc485 replicaset.apps/nginx-deploy-ff6655784 0 0 0 14m nginx nginx:1.16.1 app=nginx,pod-template-hash=ff6655784 NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/nginx-deploy-79fccc485-dwhhr 1/1 Running 0 49s 172.25.92.70 k8s-master02 pod/nginx-deploy-79fccc485-kp2pd 1/1 Running 0 51s 172.17.125.23 k8s-node01 pod/nginx-deploy-79fccc485-z425l 1/1 Running 0 53s 172.27.14.229 k8s-node02 æ›´æ–°è¯¦æƒ… [root@k8s-master01 ~]# kubectl describe deployments.apps nginx-deploy Name: nginx-deploy Namespace: default CreationTimestamp: Wed, 12 Jan 2022 13:17:12 +0800 Labels: app=nginx Annotations: deployment.kubernetes.io/revision: 4 kubernetes.io/change-cause: kubectl apply --filename=nginx-deploy.yaml --record=true Selector: app=nginx Replicas: 3 desired | 3 updated | 3 total | 3 available | 0 unavailable StrategyType: RollingUpdate MinReadySeconds: 0 RollingUpdateStrategy: 25% max unavailable, 25% max surge # æ›´æ–°ç­–ç•¥ Pod Template: Labels: app=nginx Containers: nginx: Image: nginx:1.18.0 Port: 80/TCP Host Port: 0/TCP Environment: Mounts: Volumes: Conditions: Type Status Reason ---- ------ ------ Available True MinimumReplicasAvailable Progressing True NewReplicaSetAvailable OldReplicaSets: NewReplicaSet: nginx-deploy-79fccc485 (3/3 replicas created) Events: # å¯ä»¥çœ‹åˆ°ä¹‹å‰çš„æ“ä½œè®°å½•å’Œæ›´æ–°è®°å½• Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 7m30s deployment-controller Scaled up replica set nginx-deploy-ff6655784 to 1 Normal ScalingReplicaSet 7m27s deployment-controller Scaled down replica set nginx-deploy-79fccc485 to 2 Normal ScalingReplicaSet 7m25s (x2 over 17m) deployment-controller Scaled up replica set nginx-deploy-ff6655784 to 3 Normal ScalingReplicaSet 7m23s (x3 over 7m27s) deployment-controller (combined from similar events): Scaled down replica set nginx-deploy-79fccc485 to 0 Normal ScalingReplicaSet 3m16s (x2 over 13m) deployment-controller Scaled up replica set nginx-deploy-79fccc485 to 1 Normal ScalingReplicaSet 3m14s (x2 over 13m) deployment-controller Scaled down replica set nginx-deploy-ff6655784 to 2 Normal ScalingReplicaSet 3m14s (x2 over 13m) deployment-controller Scaled up replica set nginx-deploy-79fccc485 to 2 Normal ScalingReplicaSet 3m12s (x2 over 13m) deployment-controller Scaled down replica set nginx-deploy-ff6655784 to 1 Normal ScalingReplicaSet 3m12s (x2 over 13m) deployment-controller Scaled up replica set nginx-deploy-79fccc485 to 3 Normal ScalingReplicaSet 3m10s (x2 over 10m) deployment-controller Scaled down replica set nginx-deploy-ff6655784 to 0 # æŸ¥çœ‹å›æ»šçŠ¶æ€ [root@k8s-master01 ~]# kubectl rollout status deploy nginx-deploy deployment \"nginx-deploy\" successfully rolled out # å†å²è®°å½• [root@k8s-master01 ~]# kubectl rollout history deploy nginx-deploy deployment.apps/nginx-deploy REVISION CHANGE-CAUSE 3 4 kubectl set image deployment/nginx-deploy nginx=nginx:1.18.0 --record=true æš‚åœä¸æ¢å¤ # æš‚åœ deployment çš„æ›´æ–°ï¼Œæš‚åœåé™¤éæ¢å¤æ›´æ–°ï¼Œå¦åˆ™æ“ä½œä¸ä¼šç”Ÿæ•ˆï¼Œå½“éœ€è¦å¤šé¡¹æ›´æ–°æ—¶å¯ä»¥ä½¿ç”¨ [root@k8s-master01 ~]# kubectl rollout pause deployment nginx-deploy deployment.apps/nginx-deploy paused [root@k8s-master01 ~]# kubectl set image deploy/nginx-deploy nginx=nginx:1.16.1 --record Flag --record has been deprecated, --record will be removed in the future deployment.apps/nginx-deploy image updated [root@k8s-master01 ~]# kubectl get deployments.apps -owide NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR nginx-deploy 3/3 0 3 25m nginx nginx:1.16.1 app=nginx # å¯ä»¥çœ‹åˆ°é•œåƒç¡®å®æ˜¯æ›´æ–°äº†ï¼Œä½†RSå’ŒPodåœ¨ç”¨çš„è¿˜æ˜¯è€ç‰ˆæœ¬çš„ï¼Œä¹Ÿå°±æ˜¯å¹¶æœªç”Ÿæ•ˆ [root@k8s-master01 ~]# kubectl get rs,pod -owide NAME DESIRED CURRENT READY AGE CONTAINERS IMAGES SELECTOR replicaset.apps/nginx-deploy-79fccc485 3 3 3 22m nginx nginx:1.18.0 app=nginx,pod-template-hash=79fccc485 replicaset.apps/nginx-deploy-ff6655784 0 0 0 26m nginx nginx:1.16.1 app=nginx,pod-template-hash=ff6655784 NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/nginx-deploy-79fccc485-dwhhr 1/1 Running 0 12m 172.25.92.70 k8s-master02 pod/nginx-deploy-79fccc485-kp2pd 1/1 Running 0 12m 172.17.125.23 k8s-node01 pod/nginx-deploy-79fccc485-z425l 1/1 Running 0 12m 172.27.14.229 k8s-node02 # æ¥ç€è¿›è¡Œä¸‹ä¸€é¡¹æ›´æ–°ï¼Œé…ç½®CPUå’Œå†…å­˜èµ„æº [root@k8s-master01 ~]# kubectl set resources deploy nginx-deploy -c nginx --limits=cpu=100m,memory=128Mi --requests=cpu=10m,memory=16Mi deployment.apps/nginx-deploy resource requirements updated # æ¢å¤deploymentçš„æ›´æ–° [root@k8s-master01 ~]# kubectl rollout resume deployment nginx-deploy deployment.apps/nginx-deploy resumed # æ­£åœ¨æ›´æ–° [root@k8s-master01 ~]# kubectl get rs NAME DESIRED CURRENT READY AGE nginx-deploy-79fccc485 1 1 1 28m nginx-deploy-975d4fc74 3 3 2 5s nginx-deploy-ff6655784 0 0 0 32m # æ›´æ–°å®Œæˆå [root@k8s-master01 ~]# kubectl get deploy,rs,po -owide NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR deployment.apps/nginx-deploy 3/3 3 3 32m nginx nginx:1.16.1 app=nginx NAME DESIRED CURRENT READY AGE CONTAINERS IMAGES SELECTOR replicaset.apps/nginx-deploy-79fccc485 0 0 0 28m nginx nginx:1.18.0 app=nginx,pod-template-hash=79fccc485 replicaset.apps/nginx-deploy-975d4fc74 3 3 3 25s nginx nginx:1.16.1 app=nginx,pod-template-hash=975d4fc74 replicaset.apps/nginx-deploy-ff6655784 0 0 0 32m nginx nginx:1.16.1 app=nginx,pod-template-hash=ff6655784 NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/nginx-deploy-975d4fc74-6d92q 1/1 Running 0 25s 172.27.14.230 k8s-node02 pod/nginx-deploy-975d4fc74-7c7f2 1/1 Running 0 22s 172.17.125.24 k8s-node01 pod/nginx-deploy-975d4fc74-snpkb 1/1 Running 0 20s 172.25.92.71 k8s-master02 # å¯ä»¥çœ‹åˆ°èµ„æºé…é¢å’Œé•œåƒç‰ˆæœ¬å‡å·²æ›´æ–° [root@k8s-master01 ~]# kubectl describe deployments.apps nginx-deploy ... Pod Template: Labels: app=nginx Containers: nginx: Image: nginx:1.16.1 Port: 80/TCP Host Port: 0/TCP Limits: cpu: 100m memory: 128Mi Requests: cpu: 10m memory: 16Mi Environment: Mounts: Volumes: ... å…¶ä»–é…ç½® .spec.revisionHistoryLimitï¼šè®¾ç½®ä¿ç•™RSæ—§çš„revisionçš„ä¸ªæ•°ï¼Œè®¾ç½®ä¸º0çš„è¯ï¼Œä¸ä¿ç•™å†å²æ•°æ® .spec.minReadySecondsï¼šå¯é€‰å‚æ•°ï¼ŒæŒ‡å®šæ–°åˆ›å»ºçš„Podåœ¨æ²¡æœ‰ä»»ä½•å®¹å™¨å´©æºƒçš„æƒ…å†µä¸‹è§†ä¸ºReadyæœ€å°çš„ç§’æ•°ï¼Œé»˜è®¤ä¸º0ï¼Œå³ä¸€æ—¦è¢«åˆ›å»ºå°±è§†ä¸ºå¯ç”¨ã€‚ æ»šåŠ¨æ›´æ–°çš„ç­–ç•¥ï¼š .spec.strategy.typeï¼šæ›´æ–°deploymentçš„æ–¹å¼ï¼Œé»˜è®¤æ˜¯RollingUpdate RollingUpdateï¼šæ»šåŠ¨æ›´æ–°ï¼Œå¯ä»¥æŒ‡å®šmaxSurgeå’ŒmaxUnavailable maxUnavailableï¼šæŒ‡å®šåœ¨å›æ»šæˆ–æ›´æ–°æ—¶æœ€å¤§ä¸å¯ç”¨çš„Podçš„æ•°é‡ï¼Œå¯é€‰å­—æ®µï¼Œé»˜è®¤25%ï¼Œå¯ä»¥è®¾ç½®æˆæ•°å­—æˆ–ç™¾åˆ†æ¯”ï¼Œå¦‚æœè¯¥å€¼ä¸º0ï¼Œé‚£ä¹ˆmaxSurgeå°±ä¸èƒ½0 maxSurgeï¼šå¯ä»¥è¶…è¿‡æœŸæœ›å€¼çš„æœ€å¤§Podæ•°ï¼Œå¯é€‰å­—æ®µï¼Œé»˜è®¤ä¸º25%ï¼Œå¯ä»¥è®¾ç½®æˆæ•°å­—æˆ–ç™¾åˆ†æ¯”ï¼Œå¦‚æœè¯¥å€¼ä¸º0ï¼Œé‚£ä¹ˆmaxUnavailableä¸èƒ½ä¸º0 Recreateï¼šé‡å»ºï¼Œå…ˆåˆ é™¤æ—§çš„Podï¼Œåœ¨åˆ›å»ºæ–°çš„Pod # specä¸­çš„é…ç½®å®ä¾‹ spec: progressDeadlineSeconds: 600 replicas: 2 revisionHistoryLimit: 10 selector: matchLabels: app: nginx strategy: rollingUpdate: maxSurge: 25% maxUnavailable: 25% type: RollingUpdate template: metadata: ... StatefulSet StatefulSetå¸¸ç”¨äºéƒ¨ç½²æœ‰çŠ¶æ€çš„ä¸”éœ€è¦æœ‰åºå¯åŠ¨çš„åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯ä»¥éƒ¨ç½²ElasticSearché›†ç¾¤ã€MongoDBé›†ç¾¤æˆ–è€…éœ€è¦æŒä¹…åŒ–çš„RabbitMQé›†ç¾¤ã€Redisé›†ç¾¤ã€Kafkaé›†ç¾¤å’ŒZooKeeperé›†ç¾¤ç­‰ã€‚\nStatefulSet ä¸­çš„ Pod æ‹¥æœ‰ç‹¬ä¸€æ— äºŒçš„èº«ä»½æ ‡è¯†ã€‚è¿™ä¸ªæ ‡è¯†åŸºäº StatefulSet æ§åˆ¶å™¨åˆ†é…ç»™æ¯ä¸ª Pod çš„å”¯ä¸€é¡ºåºç´¢å¼•ã€‚Pod çš„åç§°çš„å½¢å¼ä¸º- ã€‚ä¾‹å¦‚: webçš„StatefulSet æ‹¥æœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥å®ƒåˆ›å»ºäº†ä¸¤ä¸ª Pod: web-0å’Œweb-1ã€‚\nå’Œ Deployment ç›¸åŒçš„æ˜¯ï¼ŒStatefulSet ç®¡ç†äº†åŸºäºç›¸åŒå®¹å™¨å®šä¹‰çš„ä¸€ç»„ Podï¼›ä½†å’Œ Deployment ä¸åŒçš„æ˜¯ï¼ŒStatefulSet ä¸ºå®ƒä»¬çš„æ¯ä¸ª Pod ç»´æŠ¤äº†ä¸€ä¸ªå›ºå®šçš„IDæ ‡è¯†ã€‚è¿™äº› Pod æ˜¯åŸºäºç›¸åŒçš„å£°æ˜æ¥åˆ›å»ºçš„ï¼Œä½†æ˜¯ä¸èƒ½ç›¸äº’æ›¿æ¢: æ— è®ºæ€ä¹ˆè°ƒåº¦ï¼Œæ¯ä¸ª Pod éƒ½æœ‰ä¸€ä¸ªæ°¸ä¹…ä¸å˜çš„IDæ ‡è¯†ã€‚\nStatefulSetåˆ›å»ºçš„Podä¸€èˆ¬ä½¿ç”¨Headless Serviceï¼ˆæ— å¤´æœåŠ¡ï¼‰è¿›è¡Œé€šä¿¡ï¼Œå’Œæ™®é€šçš„Serviceçš„åŒºåˆ«åœ¨äºHeadless Serviceæ²¡æœ‰ClusterIPï¼Œå®ƒä½¿ç”¨çš„æ˜¯Endpointè¿›è¡Œäº’ç›¸é€šä¿¡ï¼ŒHeadlessä¸€èˆ¬çš„æ ¼å¼ä¸ºï¼šstatefulSetName-{0..N-1}.serviceName.namespace.svc.cluster.localã€‚\nserviceNameä¸ºHeadless Serviceçš„åå­—ï¼Œåˆ›å»ºStatefulSetæ—¶ï¼Œå¿…é¡»æŒ‡å®šHeadless Serviceåç§° 0..N-1ä¸ºPodæ‰€åœ¨çš„åºå·ï¼Œä»0å¼€å§‹åˆ°N-1 statefulSetNameä¸ºStatefulSetçš„åå­— namespaceä¸ºæœåŠ¡æ‰€åœ¨çš„å‘½åç©ºé—´ .cluster.localä¸ºCluster Domainï¼ˆé›†ç¾¤åŸŸï¼‰ ä½¿ç”¨åœºæ™¯ ç¨³å®šçš„ã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç¬¦,å³Podé‡æ–°è°ƒåº¦åå…¶PodNameå’ŒHostNameä¸å˜(å½“ç„¶IPæ˜¯ä¼šå˜çš„) ç¨³å®šçš„ã€æŒä¹…çš„å­˜å‚¨,å³Podé‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®,åŸºäºPVCå®ç° æœ‰åºçš„ã€ä¼˜é›…çš„éƒ¨ç½²å’Œç¼©æ”¾ æœ‰åºçš„ã€è‡ªåŠ¨çš„æ»šåŠ¨æ›´æ–° å¦‚ä¸Šé¢,ç¨³å®šæ„å‘³ç€ Pod è°ƒåº¦æˆ–é‡æ–°è°ƒåº¦çš„æ•´ä¸ªè¿‡ç¨‹æ˜¯æœ‰æŒä¹…æ€§çš„ã€‚\nå¦‚æœåº”ç”¨ç¨‹åºä¸éœ€è¦ä»»ä½•ç¨³å®šçš„æ ‡è¯†ç¬¦æˆ–æœ‰åºçš„éƒ¨ç½²ã€åˆ é™¤æˆ–ä¼¸ç¼©ï¼Œåˆ™åº”è¯¥ä½¿ç”¨ç”±ä¸€ç»„æ— çŠ¶æ€çš„å‰¯æœ¬æ§åˆ¶å™¨æä¾›çš„å·¥ä½œè´Ÿè½½æ¥éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚ä½¿ç”¨ Deployment æˆ–è€… ReplicaSet å¯èƒ½æ›´é€‚ç”¨äºæ— çŠ¶æ€åº”ç”¨éƒ¨ç½²éœ€è¦ã€‚\né™åˆ¶ ç»™å®š Pod çš„å­˜å‚¨å¿…é¡»ç”± PersistentVolume(PV) é©±åŠ¨åŸºäºæ‰€è¯·æ±‚çš„ storage class æ¥æä¾›,æˆ–è€…ç”±ç®¡ç†å‘˜é¢„å…ˆæä¾› åˆ é™¤æˆ–è€…æ”¶ç¼© StatefulSet å¹¶ä¸ä¼šåˆ é™¤å®ƒå…³è”çš„å­˜å‚¨å·.è¿™æ ·åšæ˜¯ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨ StatefulSet å½“å‰éœ€è¦ headless æœåŠ¡æ¥è´Ÿè´£ Pod çš„ç½‘ç»œæ ‡è¯†ã€‚éœ€è¦å…ˆåˆ›å»ºæ­¤æœåŠ¡ã€‚ åˆ é™¤StatefulSetæ—¶ï¼ŒStatefulSet ä¸æä¾›ä»»ä½•ç»ˆæ­¢ Pod çš„ä¿è¯ã€‚ä¸ºäº†å®ç° StatefulSet ä¸­çš„ Pod å¯ä»¥æœ‰åºå’Œä¼˜é›…çš„ç»ˆæ­¢ï¼Œå¯ä»¥åœ¨åˆ é™¤ä¹‹å‰å°† StatefulSetç¼©æ”¾ä¸º0ã€‚ åœ¨é»˜è®¤Podç®¡ç†ç­–ç•¥(OrderedReady) æ—¶ä½¿ç”¨æ»šåŠ¨æ›´æ–°ï¼Œå¯èƒ½è¿›å…¥éœ€è¦äººå·¥å¹²é¢„æ‰èƒ½ä¿®å¤çš„æŸåçŠ¶æ€ éƒ¨ç½² å¯¹äºåŒ…å« N ä¸ª å‰¯æœ¬çš„ StatefulSetï¼Œå½“éƒ¨ç½² Pod æ—¶ï¼Œå®ƒä»¬æ˜¯ä¾æ¬¡åˆ›å»ºçš„ï¼Œé¡ºåºä¸º 0~(N-1) å½“åˆ é™¤ Pod æ—¶ï¼Œå®ƒä»¬æ˜¯é€†åºç»ˆæ­¢çš„,é¡ºåºä¸º (N-1)~0 åœ¨å°†ç¼©æ”¾æ“ä½œåº”ç”¨åˆ° Pod ä¹‹å‰ï¼Œå®ƒå‰é¢çš„æ‰€æœ‰ Pod å¿…é¡»æ˜¯ Running å’Œ Ready çŠ¶æ€ åœ¨Pod ç»ˆæ­¢ä¹‹å‰ï¼Œæ‰€æœ‰çš„ç»§ä»»è€…å¿…é¡»å®Œå…¨å…³é—­ StatefulSet ä¸åº”å°† pod.Spec.TerminationGracePeriodSeconds è®¾ç½®ä¸º 0ã€‚è¿™ç§åšæ³•æ˜¯ä¸å®‰å…¨çš„ï¼Œè¦å¼ºçƒˆé˜»æ­¢ã€‚\néƒ¨ç½²é¡ºåº åœ¨ä¸‹é¢çš„ nginx ç¤ºä¾‹è¢«åˆ›å»ºåï¼Œä¼šæŒ‰ç…§ web-0ã€web-1ã€web-2 çš„é¡ºåºéƒ¨ç½²ä¸‰ä¸ª Podã€‚åœ¨ web-0 è¿›å…¥ Running å’Œ Ready çŠ¶æ€å‰ä¸ä¼šéƒ¨ç½² web-1ã€‚åœ¨ web-1 è¿›å…¥ Running å’Œ Ready çŠ¶æ€å‰ä¸ä¼šéƒ¨ç½² web-2ã€‚\nå¦‚æœ web-1 å·²ç»å¤„äº Running å’Œ Ready çŠ¶æ€ï¼Œè€Œ web-2 å°šæœªéƒ¨ç½²ï¼Œåœ¨æ­¤æœŸé—´å‘ç”Ÿäº† web-0 è¿è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆ web-2 å°†ä¸ä¼šè¢«éƒ¨ç½²ï¼Œè¦ç­‰åˆ° web-0 éƒ¨ç½²å®Œæˆå¹¶è¿›å…¥ Running å’Œ Ready çŠ¶æ€åï¼Œæ‰ä¼šéƒ¨ç½² web-2ã€‚\næ”¶ç¼©é¡ºåº å¦‚æœæƒ³å°†ç¤ºä¾‹ä¸­çš„ StatefulSet æ”¶ç¼©ä¸º replicas=1ï¼Œé¦–å…ˆè¢«ç»ˆæ­¢çš„æ˜¯ web-2ã€‚åœ¨ web-2 æ²¡æœ‰è¢«å®Œå…¨åœæ­¢å’Œåˆ é™¤å‰ï¼Œweb-1 ä¸ä¼šè¢«ç»ˆæ­¢ã€‚å½“ web-2 å·²è¢«ç»ˆæ­¢å’Œåˆ é™¤ï¼›ä½†web-1 å°šæœªè¢«ç»ˆæ­¢ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å‘ç”Ÿ web-0 è¿è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¸ä¼šç»ˆæ­¢ web-1ï¼Œå¿…é¡»ç­‰åˆ° web-0 è¿›å…¥ Running å’Œ Ready çŠ¶æ€åæ‰ä¼šç»ˆæ­¢ web-1\nSTSå®ä¾‹ [root@k8s-master01 ~]# cat \u003c\u003c \"EOF\" \u003e statefulset.yaml apiVersion: v1 kind: Service metadata: name: nginx labels: app: nginx spec: ports: - port: 80 name: http type: ClusterIP clusterIP: None selector: app: nginx --- apiVersion: apps/v1 kind: StatefulSet metadata: name: web spec: selector: matchLabels: app: nginx # has to match .spec.template.metadata.labels serviceName: nginx replicas: 3 # by default is 1 template: metadata: labels: app: nginx # has to match .spec.selector.matchLabels spec: terminationGracePeriodSeconds: 10 # é»˜è®¤30ç§’ containers: - name: nginx image: nginx:1.18.0 imagePullPolicy: IfNotPresent ports: - containerPort: 80 name: http EOF [root@k8s-master01 ~]# kubectl apply -f statefulset.yaml service/nginx created statefulset.apps/web created [root@k8s-master01 ~]# kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 443/TCP 30d nginx ClusterIP None 80/TCP 27s [root@k8s-master01 ~]# kubectl get sts -owide NAME READY AGE CONTAINERS IMAGES web 3/3 63s nginx nginx:1.18.0 [root@k8s-master01 ~]# kubectl get po -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES web-0 1/1 Running 0 83s 172.27.14.233 k8s-node02 web-1 1/1 Running 0 81s 172.17.125.28 k8s-node01 web-2 1/1 Running 0 79s 172.25.92.73 k8s-master02 # åˆ›å»ºbusybox Podè¿›å»æŸ¥çœ‹ä¸‰ä¸ªweb-Podçš„åŸŸåä¿¡æ¯ [root@k8s-master01 ~]# cat \u003c\u003c \"EOF\" \u003e busybox.yaml apiVersion: v1 kind: Pod metadata: name: busybox namespace: default spec: containers: - name: busybox image: busybox:1.28 command: - sleep - \"3600\" imagePullPolicy: IfNotPresent restartPolicy: Always EOF [root@k8s-master01 ~]# kubectl apply -f busybox.yaml pod/busybox created # è¿›å…¥busyboxè§£æåŸŸå [root@k8s-master01 ~]# kubectl exec busybox -it -- sh / # nslookup web-0.nginx Server: 10.96.0.10 Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local Name: web-0.nginx Address 1: 172.27.14.233 web-0.nginx.default.svc.cluster.local / # nslookup web-1.nginx Server: 10.96.0.10 Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local Name: web-1.nginx Address 1: 172.17.125.28 web-1.nginx.default.svc.cluster.local / # nslookup web-2.nginx Server: 10.96.0.10 Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local Name: web-2.nginx Address 1: 172.25.92.73 web-2.nginx.default.svc.cluster.local / # exit åˆ é™¤STS åˆ é™¤STSæœ‰ä¸¤ç§æ–¹å¼ï¼šçº§è”åˆ é™¤å’Œéçº§è”åˆ é™¤ã€‚éçº§è”åˆ é™¤æ—¶ï¼ŒSTSè¢«åˆ é™¤åPodä¾æ—§å­˜æ´»ï¼Œå˜æˆäº†Orphan Podï¼ˆå³å­¤å„¿Podï¼‰ï¼Œå­¤å„¿Podå¯ä»¥è¢«å•ç‹¬æ“ä½œã€‚\n# ä½¿ç”¨--cascade=orphanå‚æ•°å®ç°éçº§è”åˆ é™¤ [root@k8s-master01 yamls]# kubectl delete sts web --cascade=orphan [root@k8s-master01 yamls]# kubectl get sts web Error from server (NotFound): statefulsets.apps \"web\" not found [root@k8s-master01 yamls]# kubectl get pod | grep web web-0 1/1 Running 0 30m web-1 1/1 Running 0 29m web-2 1/1 Running 0 28m # åˆ é™¤Pod web-1 [root@k8s-master01 yamls]# kubectl delete po web-1 pod \"web-1\" deleted [root@k8s-master01 yamls]# kubectl get pod | grep web web-0 1/1 Running 0 30m web-2 1/1 Running 0 29m # é‡å»ºSTSï¼Œå¹¶æŠŠå‰¯æœ¬æ•°é‡ä¿®æ”¹ä¸º2 [root@k8s-master01 yamls]# cat statefulset.yaml | grep repli replicas: 2 # by default is 1 [root@k8s-master01 yamls]# kubectl apply -f statefulset.yaml service/nginx unchanged statefulset.apps/web created [root@k8s-master01 yamls]# kubectl get po | grep web web-0 1/1 Running 0 32m web-1 1/1 Running 0 13s # çº§è”åˆ é™¤ [root@k8s-master01 yamls]# kubectl delete sts web statefulset.apps \"web\" deleted [root@k8s-master01 yamls]# kubectl get po | grep web # æ­¤æ—¶STSå’ŒPodéƒ½åˆ æ‰äº† éçº§è”åˆ é™¤æ—¶ï¼Œç”±äºweb-1è¢«åˆ äº†ï¼Œè€Œä¸”å‰¯æœ¬æ•°å˜æˆäº†2ï¼Œæ‰€ä»¥é‡å»ºSTSï¼ˆç”¨åŸæ¥çš„é…ç½®æ–‡ä»¶ï¼‰åï¼Œä¼šå…ˆåˆ é™¤web-2ï¼Œç„¶åé‡æ–°åˆ›å»ºPod web-1ï¼Œweb-0å·²å­˜åœ¨ï¼Œä¸å‘ç”Ÿå˜åŒ–ã€‚\nDaemonSet DaemonSetå®ˆæŠ¤è¿›ç¨‹ç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–åŒ¹é…çš„ä¸€éƒ¨åˆ†ï¼‰èŠ‚ç‚¹ä¸Šéƒ¨ç½²ä¸€ä¸ªPodã€‚å½“æœ‰æ–°çš„èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºå®ƒä»¬æ–°å¢ä¸€ä¸ªPodï¼Œå½“æœ‰èŠ‚ç‚¹ä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº›Podä¹Ÿä¼šè¢«å›æ”¶ã€‚\nDaemonSetå…¸å‹ç”¨æ³•:\nåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹ï¼Œä¾‹å¦‚ glusterdã€ceph åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ—¥å¿—å®ˆæŠ¤è¿›ç¨‹ï¼Œä¾‹å¦‚ fluentdã€logstash åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›‘æ§å®ˆæŠ¤è¿›ç¨‹ï¼Œä¾‹å¦‚ Prometheus Node Exporterã€Flowmillã€Sysdig ä»£ç†ã€collectdã€Dynatrace OneAgentã€AppDynamics ä»£ç†ã€Datadog ä»£ç†ã€New Relic ä»£ç†ã€Ganglia gmond æˆ–è€… Instana ä»£ç† DaemonSetå®ä¾‹ # åˆ›å»ºyaml [root@k8s-master01 ~]# cat \u003c\u003c \"EOF\" \u003e daemonset.yaml apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: default labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: tolerations: # å®¹å¿åœ¨masterèŠ‚ç‚¹è¿è¡Œ - key: node-role.kubernetes.io/master effect: NoSchedule containers: - name: fluentd-elasticsearch image: registry.cn-beijing.aliyuncs.com/google_registry/fluentd:v2.5.2 resources: limits: cpu: 1 memory: 200Mi requests: cpu: 100m memory: 200Mi volumeMounts: - name: varlog mountPath: /var/log - name: varlibdockercontainers mountPath: /var/lib/docker/containers readOnly: true # ä¼˜é›…å…³é—­åº”ç”¨,æ—¶é—´è®¾ç½®.è¶…è¿‡è¯¥æ—¶é—´ä¼šå¼ºåˆ¶å…³é—­,é»˜è®¤30ç§’ terminationGracePeriodSeconds: 30 volumes: - name: varlog hostPath: path: /var/log - name: varlibdockercontainers hostPath: path: /var/lib/docker/containers EOF [root@k8s-master01 ~]# kubectl apply -f daemonset.yaml daemonset.apps/fluentd-elasticsearch created [root@k8s-master01 ~]# kubectl get ds -owide NAME DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGE CONTAINERS IMAGES SELECTOR fluentd-elasticsearch 5 5 0 5 0 11s fluentd-elasticsearch registry.cn-beijing.aliyuncs.com/google_registry/fluentd:v2.5.2 name=fluentd-elasticsearch # å¯è§DaemonSetåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰ç›¸åº”çš„pod [root@k8s-master01 ~]# kubectl get po -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES fluentd-elasticsearch-blmjp 1/1 Running 0 2m9s 172.18.195.19 k8s-master03 fluentd-elasticsearch-t8bpk 1/1 Running 0 2m9s 172.17.125.29 k8s-node01 fluentd-elasticsearch-v8dwj 1/1 Running 0 2m9s 172.27.14.236 k8s-node02 fluentd-elasticsearch-w9wpb 1/1 Running 0 2m9s 172.25.92.74 k8s-master02 fluentd-elasticsearch-xrphv 1/1 Running 0 2m9s 172.25.244.193 k8s-master01 DaemonSetæ›´æ–°ä¸å›æ»šå’ŒDeploymentä¸€è‡´\nJob Job è´Ÿè´£ä»…æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œå®ƒä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ª Pod æˆåŠŸç»“æŸã€‚\n[root@k8s-master01 ~]# kubectl explain job KIND: Job VERSION: batch/v1 DESCRIPTION: Job represents the configuration of a single job. FIELDS: ... # åˆ›å»ºyaml [root@k8s-master01 ~]# cat \u003c\u003c \"EOF\" \u003e job-example.yaml apiVersion: batch/v1 kind: Job metadata: name: pi spec: template: metadata: name: pi spec: containers: - name: pi image: perl command: [\"perl\", \"-Mbignum=bpi\", \"-wle\", \"print bpi(1000)\"] restartPolicy: Never EOF [root@k8s-master01 ~]# kubectl get po NAME READY STATUS RESTARTS AGE daemonset-example-f57kg 1/1 Running 0 13m pi-2nlj5 0/1 Completed 0 4m [root@k8s-master01 ~]# kubectl get job NAME COMPLETIONS DURATION AGE pi 1/1 3m19s 4m15s [root@k8s-master01 ~]# kubectl get po pi-2nlj5 -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pi-2nlj5 0/1 Completed 0 4m54s 172.16.36.119 k8s-node1 # æŸ¥çœ‹æ—¥å¿—å¯ä»¥çœ‹åˆ°jobæ‰§è¡Œçš„ç»“æœ # è®¡ç®—å‡ºäº†åœ†å‘¨ç‡å1000ä½ CronJob Cron Job ç®¡ç†åŸºäºæ—¶é—´çš„ Jobï¼Œå³:\nåœ¨ç»™å®šæ—¶é—´ç‚¹åªè¿è¡Œä¸€æ¬¡ å‘¨æœŸæ€§åœ°åœ¨è®¾å®šæ—¶é—´ç‚¹è¿è¡Œ å…¸å‹çš„ç”¨æ³•ç¤ºä¾‹:\nåœ¨ç»™ä½ å†™çš„æ—¶é—´ç‚¹è°ƒåº¦ Job è¿è¡Œ åˆ›å»ºå‘¨æœŸæ€§è¿è¡Œçš„ Jobï¼Œä¾‹å¦‚: æ•°æ®åº“å¤‡ä»½ã€å‘é€é‚®ä»¶ [root@k8s-master01 ~]# kubectl explain cj KIND: CronJob VERSION: batch/v1 DESCRIPTION: CronJob represents the configuration of a single cron job. FIELDS: ... # åˆ›å»ºcronjob yamlæ–‡ä»¶ [root@k8s-master01 ~]# cat \u003c\u003c \"EOF\" \u003e cronjob-example.yaml apiVersion: batch/v1 kind: CronJob metadata: name: hello spec: schedule: \"*/1 * * * *\" # åˆ† æ—¶ æ—¥ æœˆ æ˜ŸæœŸ successfulJobsHistoryLimit: 3 # ä¿ç•™æˆåŠŸçš„è®°å½•æ•° failedJobHistoryLimit: 1 # ä¿ç•™å¤±è´¥çš„è®°å½•æ•° concurrencyPolicy: Allow # å¹¶å‘è°ƒåº¦ç­–ç•¥ suspend: false # æ˜¯å¦æš‚åœåç»­ä»»åŠ¡ï¼Œé»˜è®¤false jobTemplate: spec: template: metadata: labels: run: hello spec: containers: - name: hello image: busybox args: - /bin/sh - -c - date; echo Hello CronJob imagePolicy: Always restartPolicy: OnFailure EOF [root@k8s-master01 ~]# kubectl apply -f cronjob-example.yaml cronjob.batch/hello created [root@k8s-master01 ~]# kubectl get cj NAME SCHEDULE SUSPEND ACTIVE LAST SCHEDULE AGE hello */1 * * * * False 0 44s 69s [root@k8s-master01 ~]# kubectl get po NAME READY STATUS RESTARTS AGE hello-27366655-8mm5c 0/1 Completed 0 84s hello-27366656-pjbv6 0/1 Completed 0 24s # æŸ¥çœ‹è¾“å‡ºæ—¥å¿— [root@k8s-master01 ~]# kubectl logs hello-27366655-8mm5c Wed Jan 12 14:55:17 UTC 2022 Hello CronJob [root@k8s-master01 ~]# kubectl logs hello-27366656-pjbv6 Wed Jan 12 14:56:15 UTC 2022 Hello CronJob [root@k8s-master01 ~]# kubectl get job NAME COMPLETIONS DURATION AGE hello-27366655 1/1 17s 2m29s hello-27366656 1/1 16s 89s hello-27366657 0/1 29s 29s # åˆ é™¤cronjob [root@k8s-master01 ~]# kubectl delete cronjob hello cronjob.batch \"hello\" deleted [root@k8s-master01 ~]# kubectl get job No resources found in default namespace. å¹¶å‘è°ƒåº¦ç­–ç•¥concurrencyPolicy:\nAllowï¼šå…è®¸å¤šä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œ Forbidï¼šä¸å…è®¸å¹¶å‘ï¼Œå½“å‰ä»»åŠ¡æœªå®Œæˆï¼Œæ–°ä»»åŠ¡ä¸ä¼šåˆ›å»º Replaceï¼šå¦‚æœä¹‹å‰çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œåˆ™åˆ›å»ºæ–°çš„ä»£æ›¿ä¹‹ HPA é¡¾åæ€ä¹‰ï¼ŒHorizontal Pod Autoscalingï¼ˆPod æ°´å¹³è‡ªåŠ¨ç¼©æ”¾ï¼‰ï¼Œå¯ä»¥åŸºäº CPU åˆ©ç”¨ç‡è‡ªåŠ¨ä¼¸ç¼© ReplicationControllerã€Deploymentã€ReplicaSet å’Œ StatefulSet ä¸­çš„ Pod æ•°é‡ã€‚é™¤äº† CPU åˆ©ç”¨ç‡ï¼Œä¹Ÿå¯ä»¥åŸºäºå…¶ä»–åº”ç¨‹åºæä¾›çš„è‡ªå®šä¹‰åº¦é‡æŒ‡æ ‡æ¥æ‰§è¡Œè‡ªåŠ¨æ‰©ç¼©ã€‚ Pod è‡ªåŠ¨æ‰©ç¼©ä¸é€‚ç”¨äºæ— æ³•æ‰©ç¼©çš„å¯¹è±¡ï¼Œæ¯”å¦‚ DaemonSetã€‚\nPod æ°´å¹³è‡ªåŠ¨æ‰©ç¼©ç‰¹æ€§ç”± Kubernetes API èµ„æºå’Œæ§åˆ¶å™¨å®ç°ã€‚èµ„æºå†³å®šäº†æ§åˆ¶å™¨çš„è¡Œä¸ºã€‚æ§åˆ¶å™¨ä¼šå‘¨æœŸæ€§åœ°è°ƒæ•´å‰¯æœ¬æ§åˆ¶å™¨æˆ– Deployment ä¸­çš„å‰¯æœ¬æ•°é‡ï¼Œä»¥ä½¿å¾—ç±»ä¼¼ Pod å¹³å‡ CPU åˆ©ç”¨ç‡ã€å¹³å‡å†…å­˜åˆ©ç”¨ç‡è¿™ç±»è§‚æµ‹åˆ°çš„åº¦é‡å€¼ä¸ç”¨æˆ·æ‰€è®¾å®šçš„ç›®æ ‡å€¼åŒ¹é…ã€‚\nä¸‹é¢æ˜¯HPAå·¥ä½œæœºåˆ¶æ¨¡å‹å›¾:\nHPAä¸¤ä¸ªç‰ˆæœ¬åŒºåˆ«:\nautoscaling/v1ï¼šç¨³å®šç‰ˆæœ¬ï¼Œåªæ”¯æŒ cpu autoscaling/v2betaï¼šæµ‹è¯•é˜¶æ®µ v2beta1(æ”¯æŒCPUã€å†…å­˜å’Œè‡ªå®šä¹‰æŒ‡æ ‡) v2beta2(æ”¯æŒCPUã€å†…å­˜ã€è‡ªå®šä¹‰æŒ‡æ ‡Customå’Œé¢å¤–æŒ‡æ ‡ExternalMetrics) Kubernetesç›®å‰ï¼ˆv1.23.0åï¼‰autoscaling/v2ç‰ˆæœ¬å·²è¿›å…¥ç¨³å®šç‰ˆï¼Œæ”¯æŒCPUã€å†…å­˜ã€è‡ªå®šä¹‰æŒ‡æ ‡Customå’Œé¢å¤–æŒ‡æ ‡ExternalMetrics\næŒ‡æ ‡ Pod æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©å™¨çš„å®ç°æ˜¯ä¸€ä¸ªæ§åˆ¶å›è·¯ï¼Œç”±æ§åˆ¶å™¨ç®¡ç†å™¨çš„--horizontal-pod-autoscaler-sync-periodå‚æ•°æŒ‡å®šå‘¨æœŸï¼ˆé»˜è®¤å€¼ä¸º 15 ç§’ï¼‰ã€‚\næ¯ä¸ªå‘¨æœŸå†…ï¼Œæ§åˆ¶å™¨ç®¡ç†å™¨æ ¹æ®æ¯ä¸ªHorizontalPodAutoscalerå®šä¹‰ä¸­æŒ‡å®šçš„æŒ‡æ ‡æŸ¥è¯¢èµ„æºåˆ©ç”¨ç‡ã€‚æ§åˆ¶å™¨ç®¡ç†å™¨å¯ä»¥ä»èµ„æºåº¦é‡æŒ‡æ ‡ APIï¼ˆæŒ‰ Pod ç»Ÿè®¡çš„èµ„æºç”¨é‡ï¼‰å’Œè‡ªå®šä¹‰åº¦é‡æŒ‡æ ‡ APIï¼ˆå…¶ä»–æŒ‡æ ‡ï¼‰è·å–åº¦é‡å€¼ã€‚\nå¯¹äºæŒ‰ Pod ç»Ÿè®¡çš„èµ„æºæŒ‡æ ‡ï¼ˆå¦‚ CPUï¼‰ï¼Œæ§åˆ¶å™¨ä»èµ„æºæŒ‡æ ‡ API ä¸­è·å–æ¯ä¸€ä¸ªHorizontalPodAutoscaleræŒ‡å®šçš„ Pod çš„åº¦é‡å€¼ï¼Œå¦‚æœè®¾ç½®äº†ç›®æ ‡ä½¿ç”¨ç‡ï¼Œæ§åˆ¶å™¨è·å–æ¯ä¸ª Pod ä¸­çš„å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¹¶è®¡ç®—èµ„æºä½¿ç”¨ç‡ã€‚ å¦‚æœè®¾ç½®äº† target å€¼ï¼Œå°†ç›´æ¥ä½¿ç”¨åŸå§‹æ•°æ®ï¼ˆä¸å†è®¡ç®—ç™¾åˆ†æ¯”ï¼‰ã€‚ æ¥ä¸‹æ¥ï¼Œæ§åˆ¶å™¨æ ¹æ®å¹³å‡çš„èµ„æºä½¿ç”¨ç‡æˆ–åŸå§‹å€¼è®¡ç®—å‡ºæ‰©ç¼©çš„æ¯”ä¾‹ï¼Œè¿›è€Œè®¡ç®—å‡ºç›®æ ‡å‰¯æœ¬æ•°ã€‚ å¦‚æœ Pod ä½¿ç”¨è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œæ§åˆ¶å™¨æœºåˆ¶ä¸èµ„æºæŒ‡æ ‡ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºè‡ªå®šä¹‰æŒ‡æ ‡åªä½¿ç”¨åŸå§‹å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç‡ã€‚ å¦‚æœ Pod ä½¿ç”¨å¯¹è±¡æŒ‡æ ‡å’Œå¤–éƒ¨æŒ‡æ ‡ï¼ˆæ¯ä¸ªæŒ‡æ ‡æè¿°ä¸€ä¸ªå¯¹è±¡ä¿¡æ¯ï¼‰ã€‚è¿™ä¸ªæŒ‡æ ‡å°†ç›´æ¥æ ¹æ®ç›®æ ‡è®¾å®šå€¼ç›¸æ¯”è¾ƒï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªä¸Šé¢æåˆ°çš„æ‰©ç¼©æ¯”ä¾‹ã€‚åœ¨autoscaling/v2beta2ç‰ˆæœ¬ API ä¸­ï¼Œè¿™ä¸ªæŒ‡æ ‡ä¹Ÿå¯ä»¥æ ¹æ® Pod æ•°é‡å¹³åˆ†åå†è®¡ç®—ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œæ§åˆ¶å™¨å°†ä»ä¸€ç³»åˆ—çš„èšåˆAPIï¼ˆmetrics.k8s.ioã€custom.metrics.k8s.io å’Œ external.metrics.k8s.ioï¼‰ä¸­è·å–åº¦é‡å€¼ã€‚metrics.k8s.io API é€šå¸¸ç”± Metrics æœåŠ¡å™¨ï¼ˆéœ€è¦æå‰å¯åŠ¨ï¼‰æä¾›ã€‚\nHPAä½¿ç”¨ 1.ä½¿ç”¨kubectl\n# è‡ªåŠ¨ä¼¸ç¼©deploy/php-apacheï¼Œç›®æ ‡CPUä½¿ç”¨ç‡50%ï¼Œdeployå‰¯æœ¬æ•°åœ¨1~10ä¹‹é—´ kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10 2.ä½¿ç”¨yamlåˆ›å»º\n# ä½œç”¨åŒä¸Š apiVersion: autoscaling/v2 kind: HorizontalPodAutoscaler metadata: name: php-apache namespace: default spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: php-apache minReplicas: 1 maxReplicas: 10 targetCPUUtilizationPercentage: 50 ç¤ºä¾‹ ä¸‹è½½å›½å†…ç¤ºä¾‹é•œåƒ\n# é›†ç¾¤æ‰€æœ‰å¯è°ƒåº¦Podçš„èŠ‚ç‚¹å…ˆè·å–è¦ä½¿ç”¨çš„hpaç¤ºä¾‹é•œåƒ docker pull registry.cn-beijing.aliyuncs.com/google_registry/hpa-example # yaml [root@k8s-master01 ~]# cat \u003c\u003c \"EOF\" \u003e php-apache.yaml apiVersion: apps/v1 kind: Deployment metadata: name: php-apache spec: selector: matchLabels: hpa: php-apache replicas: 1 template: metadata: labels: hpa: php-apache spec: containers: - name: php-apache image: registry.cn-beijing.aliyuncs.com/google_registry/hpa-example imagePullPolicy: IfNotPresent ports: - containerPort: 80 resources: limits: cpu: 500m requests: cpu: 200m --- apiVersion: v1 kind: Service metadata: name: php-apache labels: hpa: php-apache spec: ports: - port: 80 selector: hpa: php-apache EOF [root@k8s-master01 ~]# kubectl apply -f php-apache.yaml deployment.apps/php-apache created service/php-apache created [root@k8s-master01 ~]# kubectl get deployments.apps NAME READY UP-TO-DATE AVAILABLE AGE php-apache 1/1 1 1 9s # åˆ›å»ºHPA # å½“podä¸­CPUä½¿ç”¨ç‡è¾¾50%å°±æ‰©å®¹.æœ€å°1ä¸ª,æœ€å¤§10ä¸ª [root@k8s-master01 ~]# kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10 horizontalpodautoscaler.autoscaling/php-apache autoscaled [root@k8s-master01 ~]# kubectl get hpa NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE php-apache Deployment/php-apache 0%/50% 1 10 1 18s å‹æµ‹php-apache # åˆ›å»ºå‹æµ‹Podå¹¶è¿›å…¥, å…ˆä¸è¦é€€å‡º [root@k8s-master01 ~]# kubectl run -it load-test --image=busybox /bin/sh / # # å¦èµ·ä¸€çª—å£å¯æŸ¥çœ‹åˆ°podåœ¨è¿è¡Œ [root@k8s-master01 ~]# kubectl get po | grep load load-test 1/1 Running 0 26s # åœ¨load-testç»§ç»­ä¸­æ“ä½œï¼Œè¿ç»­è®¿é—®php-apacheçš„Service / # while true; do wget -q -O- http://php-apache.default.svc.cluster.local; done OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK! # ä¸€åˆ†é’Ÿå·¦å³ï¼Œåœ¨å¦å¤–ä¸€ä¸ªçª—å£å¯çœ‹åˆ°ï¼Œè´Ÿè½½é£™å‡, å‰¯æœ¬æ•°å¢å¤š [root@k8s-master01 ~]# kubectl get hpa NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE php-apache Deployment/php-apache 254%/50% 1 10 3 21m # è‡ªåŠ¨æ‰©å®¹ [root@k8s-master01 ~]# kubectl get deploy,rs,po NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/php-apache 6/6 6 6 23m NAME DESIRED CURRENT READY AGE replicaset.apps/php-apache-7db9c95858 6 6 6 23m NAME READY STATUS RESTARTS AGE pod/php-apache-7db9c95858-6wrp2 1/1 Running 0 32s pod/php-apache-7db9c95858-7dbjv 1/1 Running 0 10m pod/php-apache-7db9c95858-cfwrk 1/1 Running 0 32s pod/php-apache-7db9c95858-ksbgh 1/1 Running 0 47s pod/php-apache-7db9c95858-m9mtn 1/1 Running 0 47s pod/php-apache-7db9c95858-znczt 1/1 Running 0 32s # åœæ­¢å‹æµ‹ # Ctrl+Cåœæ­¢åœ¨è·‘çš„å¾ªç¯ / # while true; do wget -q -O- http://php-apache.default.svc.cluster.local; done OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!.\u003cçœç•¥å¾ˆå¤šè¾“å‡º\u003e..!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!^C # åœæ­¢å‹æµ‹åè´Ÿè½½é™ä¸‹æ¥ [root@k8s-master01 ~]# kubectl get hpa NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE php-apache Deployment/php-apache 0%/50% 1 10 6 24m # å†è¿‡å‡ åˆ†é’Ÿå‰¯æœ¬æ•°ä¹Ÿé™äº† [root@k8s-master01 ~]# kubectl get hpa NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE php-apache Deployment/php-apache 0%/50% 1 10 1 29m [root@k8s-master01 ~]# kubectl get deploy,rs,po NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/php-apache 1/1 1 1 31m NAME DESIRED CURRENT READY AGE replicaset.apps/php-apache-7db9c95858 1 1 1 31m NAME READY STATUS RESTARTS AGE pod/php-apache-7db9c95858-7dbjv 1/1 Running 0 18m è¯´æ˜:åœæ­¢å‹æµ‹ï¼Œpodæ•°é‡ä¹Ÿä¸ä¼šç«‹å³é™ä¸‹æ¥.è€Œæ˜¯è¿‡æ®µæ—¶é—´åæ‰ä¼šæ…¢æ…¢é™ä¸‹æ¥.è¿™æ˜¯ä¸ºäº†é˜²æ­¢ç”±äºç½‘ç»œåŸå› æˆ–è€…é—´æ­‡æ€§æµé‡çªå¢ã€çªé™ï¼Œå¯¼è‡´podå›æ”¶å¤ªå¿«åé¢æµé‡ä¸Šæ¥åPodæ•°é‡ä¸å¤Ÿ\n",
  "wordCount" : "9926",
  "inLanguage": "en",
  "image":"https://deemoprobe.github.io/img/kubernetes.png","datePublished": "2023-04-29T14:23:19+08:00",
  "dateModified": "2023-04-29T14:23:19+08:00",
  "author":[{
    "@type": "Person",
    "name": "deemoprobe"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://deemoprobe.github.io/posts/tech/kubernetes/kubernetespodcontroller/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "William's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://deemoprobe.github.io/img/bear.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://deemoprobe.github.io/" accesskey="h" title="William&#39;s Blog (Alt + H)">
            <img src="https://deemoprobe.github.io/img/bear.gif" alt="logo" aria-label="logo"
                 height="35">William&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://deemoprobe.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tags" title="ğŸ¨ æ ‡ç­¾">
                <span>ğŸ¨ æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/archives/" title="ğŸ“ˆ å½’æ¡£">
                <span>ğŸ“ˆ å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tools" title="ğŸª å·¥å…·">
                <span>ğŸª å·¥å…·</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            
            <h1 class="post-title">
                KubernetesPodController
            </h1>
            <div class="post-description">
                Kubernetes Podæ§åˆ¶å™¨
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-04-29
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>9926å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>20åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>deemoprobe
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://deemoprobe.github.io/tags/kubernetes/" style="color: var(--secondary)!important;">kubernetes</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="https://deemoprobe.github.io/img/kubernetes.png" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%8e%a7%e5%88%b6%e5%99%a8%e7%b1%bb%e5%9e%8b" aria-label="æ§åˆ¶å™¨ç±»å‹">æ§åˆ¶å™¨ç±»å‹</a><ul>
                        
                <li>
                    <a href="#rs%e5%92%8crc" aria-label="RSå’ŒRC">RSå’ŒRC</a></li>
                <li>
                    <a href="#deployment" aria-label="Deployment">Deployment</a><ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%badeployment" aria-label="åˆ›å»ºDeployment">åˆ›å»ºDeployment</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0deployment" aria-label="æ›´æ–°Deployment">æ›´æ–°Deployment</a></li>
                <li>
                    <a href="#%e5%9b%9e%e6%bb%9adeployment" aria-label="å›æ»šDeployment">å›æ»šDeployment</a></li>
                <li>
                    <a href="#%e5%9b%9e%e9%80%80%e5%8e%86%e5%8f%b2%e7%89%88%e6%9c%ac" aria-label="å›é€€å†å²ç‰ˆæœ¬">å›é€€å†å²ç‰ˆæœ¬</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0%e8%af%a6%e6%83%85" aria-label="æ›´æ–°è¯¦æƒ…">æ›´æ–°è¯¦æƒ…</a></li>
                <li>
                    <a href="#%e6%9a%82%e5%81%9c%e4%b8%8e%e6%81%a2%e5%a4%8d" aria-label="æš‚åœä¸æ¢å¤">æš‚åœä¸æ¢å¤</a></li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e9%85%8d%e7%bd%ae" aria-label="å…¶ä»–é…ç½®">å…¶ä»–é…ç½®</a></li></ul>
                </li>
                <li>
                    <a href="#statefulset" aria-label="StatefulSet">StatefulSet</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af" aria-label="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</a></li>
                <li>
                    <a href="#%e9%99%90%e5%88%b6" aria-label="é™åˆ¶">é™åˆ¶</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2" aria-label="éƒ¨ç½²">éƒ¨ç½²</a></li>
                <li>
                    <a href="#sts%e5%ae%9e%e4%be%8b" aria-label="STSå®ä¾‹">STSå®ä¾‹</a></li>
                <li>
                    <a href="#%e5%88%a0%e9%99%a4sts" aria-label="åˆ é™¤STS">åˆ é™¤STS</a></li></ul>
                </li>
                <li>
                    <a href="#daemonset" aria-label="DaemonSet">DaemonSet</a><ul>
                        
                <li>
                    <a href="#daemonset%e5%ae%9e%e4%be%8b" aria-label="DaemonSetå®ä¾‹">DaemonSetå®ä¾‹</a></li></ul>
                </li>
                <li>
                    <a href="#job" aria-label="Job">Job</a></li>
                <li>
                    <a href="#cronjob" aria-label="CronJob">CronJob</a></li>
                <li>
                    <a href="#hpa" aria-label="HPA">HPA</a><ul>
                        
                <li>
                    <a href="#%e6%8c%87%e6%a0%87" aria-label="æŒ‡æ ‡">æŒ‡æ ‡</a></li>
                <li>
                    <a href="#hpa%e4%bd%bf%e7%94%a8" aria-label="HPAä½¿ç”¨">HPAä½¿ç”¨</a></li>
                <li>
                    <a href="#%e7%a4%ba%e4%be%8b" aria-label="ç¤ºä¾‹">ç¤ºä¾‹</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><p>Kubernetes ä¸­å†…å»ºäº†å¾ˆå¤š Controller(æ§åˆ¶å™¨)ï¼Œç”¨æ¥ç¡®ä¿podèµ„æºç¬¦åˆé¢„æœŸçš„çŠ¶æ€ï¼Œæ§åˆ¶ Pod çš„çŠ¶æ€å’Œè¡Œä¸ºã€‚</p>
<h2 id="æ§åˆ¶å™¨ç±»å‹">æ§åˆ¶å™¨ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#æ§åˆ¶å™¨ç±»å‹">#</a></h2>
<ul>
<li>ReplicationController(rc)</li>
<li>ReplicaSet(rs)</li>
<li>Deployment(deploy)</li>
<li>DaemonSet(ds)</li>
<li>StatefulSet(sts)</li>
<li>Job/CronJob(cj)</li>
<li>Horizontal Pod Autoscaling(hpa)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥ä½¿ç”¨kubectl explainå‘½ä»¤æŸ¥çœ‹k8s APIèµ„æºå¯¹è±¡æè¿°ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>kubectl explain &lt;apiresource-name&gt; | egrep -v <span style="color:#e6db74">&#34;^</span>$<span style="color:#e6db74">|^\s*http&#34;</span> | sed s/<span style="color:#e6db74">&#34;More info:&#34;</span>//
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹APIèµ„æºåˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>kubectl api-resources
</span></span></code></pre></div><h3 id="rså’Œrc">RSå’ŒRC<a hidden class="anchor" aria-hidden="true" href="#rså’Œrc">#</a></h3>
<p>ReplicationController(RC)ç”¨æ¥ç¡®ä¿å®¹å™¨åº”ç”¨çš„å‰¯æœ¬æ•°å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•°ï¼Œå³å¦‚æœæœ‰å®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ Pod æ¥æ›¿ä»£ï¼›è€Œå¦‚æœå¼‚å¸¸å¤šå‡ºæ¥çš„å®¹å™¨ä¹Ÿä¼šè‡ªåŠ¨å›æ”¶ã€‚</p>
<p>åœ¨æ–°ç‰ˆæœ¬çš„Kubernetesä¸­å»ºè®®ä½¿ç”¨ReplicaSetæ¥å–ä»£ReplicationControllerï¼ŒReplicaSetè§„åˆ™è·ŸReplicationControlleræ²¡æœ‰æœ¬è´¨çš„ä¸åŒï¼Œå”¯ä¸€åŒºåˆ«æ˜¯ReplicaSetæ”¯æŒ<code>selector</code>é€‰æ‹©å™¨ã€‚</p>
<p>ReplicaSetä¹Ÿå¾ˆå°‘å•ç‹¬è¢«ä½¿ç”¨ï¼Œéƒ½æ˜¯ä½¿ç”¨æ›´é«˜çº§çš„èµ„æºDeploymentã€DaemonSetã€StatefulSetè¿›è¡Œç®¡ç†Podï¼ŒReplicaSetä¸»è¦ç”¨ä½œDeploymentåè°ƒåˆ›å»ºã€åˆ é™¤å’Œæ›´æ–°Podã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># RCå®ä¾‹ï¼Œä¹Ÿæ˜¯åé¢çš„rc-demo.yamlä¸­çš„å†…å®¹</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ReplicationController
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: nginx
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      name: nginx
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: nginx
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: nginx
</span></span><span style="display:flex;"><span>        image: nginx
</span></span><span style="display:flex;"><span>        imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RSå®ä¾‹ï¼Œå’ŒRCé…ç½®çš„ä¸»è¦åŒºåˆ«æ˜¯å¤šäº†ä¸ªselector</span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: ReplicaSet
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: frontend
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: guestbook
</span></span><span style="display:flex;"><span>    tier: frontend
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      tier: frontend
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        tier: frontend
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: php-redis
</span></span><span style="display:flex;"><span>        image: gcr.io/google_samples/gb-frontend:v3
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä»¥ä¸Šé¢RCå®ä¾‹é…ç½®ä¸ºä¾‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f rc-demo.yaml </span>
</span></span><span style="display:flex;"><span>replicationcontroller/nginx created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po,rc</span>
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS    RESTARTS        AGE
</span></span><span style="display:flex;"><span>pod/nginx-5w6v6                1/1     Running   <span style="color:#ae81ff">0</span>               6s
</span></span><span style="display:flex;"><span>pod/nginx-8265c                1/1     Running   <span style="color:#ae81ff">0</span>               6s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                          DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicationcontroller/nginx   <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       6s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RCçš„PodåŠ¨æ€ç¼©æ”¾</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl scale rc nginx --replicas=3</span>
</span></span><span style="display:flex;"><span>replicationcontroller/nginx scaled
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥çœ‹åˆ°æ­£åœ¨æ‰©å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po,rc</span>
</span></span><span style="display:flex;"><span>NAME              READY   STATUS              RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/nginx-5w6v6   1/1     Running             <span style="color:#ae81ff">0</span>          97s
</span></span><span style="display:flex;"><span>pod/nginx-8265c   1/1     Running             <span style="color:#ae81ff">0</span>          97s
</span></span><span style="display:flex;"><span>pod/nginx-jhsjr   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          3s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                          DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicationcontroller/nginx   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">2</span>       97s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰©å®¹æˆåŠŸ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po,rc</span>
</span></span><span style="display:flex;"><span>NAME              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/nginx-5w6v6   1/1     Running   <span style="color:#ae81ff">0</span>          2m17s
</span></span><span style="display:flex;"><span>pod/nginx-8265c   1/1     Running   <span style="color:#ae81ff">0</span>          2m17s
</span></span><span style="display:flex;"><span>pod/nginx-jhsjr   1/1     Running   <span style="color:#ae81ff">0</span>          43s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¼©å®¹æµ‹è¯•</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl scale rc nginx --replicas=1</span>
</span></span><span style="display:flex;"><span>replicationcontroller/nginx scaled
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po,rc</span>
</span></span><span style="display:flex;"><span>NAME              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/nginx-5w6v6   1/1     Running   <span style="color:#ae81ff">0</span>          4m26s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                          DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicationcontroller/nginx   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>       4m26s
</span></span></code></pre></div><h3 id="deployment">Deployment<a hidden class="anchor" aria-hidden="true" href="#deployment">#</a></h3>
<p>ç”¨äºéƒ¨ç½²æ— çŠ¶æ€çš„æœåŠ¡ï¼Œæœ€å¸¸ç”¨çš„æ§åˆ¶å™¨ã€‚ä¸€èˆ¬ç”¨äºç®¡ç†ç»´æŠ¤ä¼ä¸šå†…éƒ¨æ— çŠ¶æ€çš„å¾®æœåŠ¡ï¼Œæ¯”å¦‚configserverã€zuulã€springbootã€‚å¯ä»¥ç®¡ç†å¤šä¸ªå‰¯æœ¬çš„Podå®ç°æ— ç¼è¿ç§»ã€è‡ªåŠ¨æ‰©å®¹ç¼©å®¹ã€è‡ªåŠ¨ç¾éš¾æ¢å¤ã€ä¸€é”®å›æ»šç­‰åŠŸèƒ½ã€‚</p>
<p>Deploymentæ˜¯ä¸€ç§æ›´é«˜çº§åˆ«çš„ API èµ„æºå¯¹è±¡ï¼Œä¸º Pods å’Œ ReplicaSets æä¾›å£°æ˜å¼çš„æ›´æ–°èƒ½åŠ›ã€‚å®ƒä»¥ç±»ä¼¼äº <code>kubectl rolling-update</code> çš„æ–¹å¼æ›´æ–°å…¶åº•å±‚ ReplicaSet åŠå…¶ Podã€‚</p>
<p>Deployments çš„å…¸å‹ç”¨ä¾‹ï¼š</p>
<ul>
<li>åˆ›å»ºDeploymentå°†ReplicaSetä¸Šçº¿ã€‚ReplicaSet åœ¨åå°åˆ›å»º Pods.æ£€æŸ¥ ReplicaSet çš„ä¸Šçº¿çŠ¶æ€ï¼ŒæŸ¥çœ‹å…¶æ˜¯å¦æˆåŠŸ</li>
<li>é€šè¿‡æ›´æ–° Deployment çš„ PodTemplateSpecï¼Œå£°æ˜ Pod çš„æ–°çŠ¶æ€ã€‚æ–°çš„ ReplicaSet ä¼šè¢«åˆ›å»ºï¼ŒDeployment å°† Pod ä»æ—§ ReplicaSet è¿ç§»åˆ°æ–° ReplicaSetã€‚ æ¯ä¸ªæ–°çš„ ReplicaSet éƒ½ä¼šæ›´æ–° Deployment çš„ä¿®è®¢ç‰ˆæœ¬</li>
<li>å¦‚æœ Deployment çš„å½“å‰çŠ¶æ€ä¸ç¨³å®šï¼Œå›æ»šåˆ°è¾ƒæ—©çš„ Deployment ç‰ˆæœ¬ã€‚æ¯æ¬¡å›æ»šéƒ½ä¼šæ›´æ–° Deployment çš„ä¿®è®¢ç‰ˆæœ¬</li>
<li>æ‰©å¤§ Deployment è§„æ¨¡ä»¥æ‰¿æ‹…æ›´å¤šè´Ÿè½½</li>
<li>æš‚åœ Deployment ä»¥åº”ç”¨å¯¹ PodTemplateSpec æ‰€ä½œçš„å¤šé¡¹ä¿®æ”¹ï¼Œç„¶åæ¢å¤å…¶æ‰§è¡Œä»¥å¯åŠ¨æ–°çš„ä¸Šçº¿ç‰ˆæœ¬</li>
<li>ä½¿ç”¨ Deployment çŠ¶æ€æ¥åˆ¤å®šä¸Šçº¿è¿‡ç¨‹æ˜¯å¦å‡ºç°åœæ»</li>
<li>æ¸…ç†è¾ƒæ—§çš„ä¸å†éœ€è¦çš„ ReplicaSet</li>
</ul>
<h4 id="åˆ›å»ºdeployment">åˆ›å»ºDeployment<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºdeployment">#</a></h4>
<p>Deploymentåˆ›å»ºä¸€ä¸ªReplicaSetï¼Œè¯¥RSè´Ÿè´£å¯åŠ¨ç®¡ç†ä¸‰ä¸ªPodã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºyamlæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim nginx-deploy.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx-deploy
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: nginx
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: nginx
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: nginx
</span></span><span style="display:flex;"><span>        image: nginx:1.16.1
</span></span><span style="display:flex;"><span>        imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f nginx-deploy.yaml </span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy,rs,po</span>
</span></span><span style="display:flex;"><span>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy   3/3     <span style="color:#ae81ff">3</span>            <span style="color:#ae81ff">3</span>           58s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                     DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-ff6655784   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       58s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/nginx-deploy-ff6655784-2jxbv   1/1     Running   <span style="color:#ae81ff">0</span>          58s
</span></span><span style="display:flex;"><span>pod/nginx-deploy-ff6655784-b8gq8   1/1     Running   <span style="color:#ae81ff">0</span>          58s
</span></span><span style="display:flex;"><span>pod/nginx-deploy-ff6655784-qj2k2   1/1     Running   <span style="color:#ae81ff">0</span>          58s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po --show-labels </span>
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>nginx-deploy-ff6655784-2jxbv   1/1     Running   <span style="color:#ae81ff">0</span>          98s   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span><span style="display:flex;"><span>nginx-deploy-ff6655784-b8gq8   1/1     Running   <span style="color:#ae81ff">0</span>          98s   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span><span style="display:flex;"><span>nginx-deploy-ff6655784-qj2k2   1/1     Running   <span style="color:#ae81ff">0</span>          98s   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰©ç¼©å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl scale deployment nginx-deploy --replicas=2</span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy scaled
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy,rs,po</span>
</span></span><span style="display:flex;"><span>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy   2/2     <span style="color:#ae81ff">2</span>            <span style="color:#ae81ff">2</span>           2m18s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                     DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-ff6655784   <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       2m18s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/nginx-deploy-ff6655784-b8gq8   1/1     Running   <span style="color:#ae81ff">0</span>          2m18s
</span></span><span style="display:flex;"><span>pod/nginx-deploy-ff6655784-qj2k2   1/1     Running   <span style="color:#ae81ff">0</span>          2m18s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹podè¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po -owide</span>
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS    RESTARTS   AGE     IP              NODE           NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>nginx-deploy-ff6655784-b8gq8   1/1     Running   <span style="color:#ae81ff">0</span>          2m40s   172.25.92.66    k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>nginx-deploy-ff6655784-qj2k2   1/1     Running   <span style="color:#ae81ff">0</span>          2m40s   172.17.125.18   k8s-node01     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¿é—®nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 172.25.92.66</span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 172.17.125.18</span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div><p>è¯´æ˜:</p>
<ul>
<li>ReplicaSet çš„åç§°å§‹ç»ˆè¢«æ ¼å¼åŒ–ä¸º[DEPLOYMENT-NAME]-[RANDOM-STRING]ã€‚<code>RANDOM-STRING</code>éšæœºç”Ÿæˆã€‚å¹¶ä½¿ç”¨<code>pod-template-hash=[RANDOM-STRING]</code>ä½œä¸ºé€‰æ‹©å™¨å’Œæ ‡ç­¾</li>
<li>Deployment æ§åˆ¶å™¨å°†<code>pod-template-hash=[RANDOM-STRING]</code>æ ‡ç­¾æ·»åŠ åˆ° Deployment åˆ›å»ºæˆ–ä½¿ç”¨çš„ReplicaSetå’ŒPodã€‚æ­¤æ ‡ç­¾å¯ç¡®ä¿ Deploymentçš„å­ReplicaSetsä¸é‡å ï¼Œå› æ­¤ä¸å¯ä¿®æ”¹</li>
<li>æ³¨æ„Deploymentã€ReplicaSetå’ŒPodä¸‰è€…çš„åç§°å…³ç³»</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs --show-labels </span>
</span></span><span style="display:flex;"><span>NAME                     DESIRED   CURRENT   READY   AGE     LABELS
</span></span><span style="display:flex;"><span>nginx-deploy-ff6655784   <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       6m49s   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy,rs,po --show-labels </span>
</span></span><span style="display:flex;"><span>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE    LABELS
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy   2/2     <span style="color:#ae81ff">2</span>            <span style="color:#ae81ff">2</span>           8m2s   app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                     DESIRED   CURRENT   READY   AGE    LABELS
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-ff6655784   <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       8m2s   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS    RESTARTS   AGE    LABELS
</span></span><span style="display:flex;"><span>pod/nginx-deploy-ff6655784-b8gq8   1/1     Running   <span style="color:#ae81ff">0</span>          8m2s   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span><span style="display:flex;"><span>pod/nginx-deploy-ff6655784-qj2k2   1/1     Running   <span style="color:#ae81ff">0</span>          8m2s   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span></code></pre></div><h4 id="æ›´æ–°deployment">æ›´æ–°Deployment<a hidden class="anchor" aria-hidden="true" href="#æ›´æ–°deployment">#</a></h4>
<p>Deployment å¯ç¡®ä¿åœ¨æ›´æ–°æ—¶ä»…å…³é—­ä¸€å®šæ•°é‡çš„ Pods.é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒç¡®ä¿è‡³å°‘ 75% æ‰€éœ€ Pods åœ¨è¿è¡Œ(25%ä¸ºå®¹å¿çš„æœ€å¤§ä¸å¯ç”¨é‡)ã€‚æ›´æ–°æ—¶ä¸ä¼šå…ˆåˆ é™¤æ—§çš„podï¼Œè€Œæ˜¯å…ˆæ–°å»ºä¸€ä¸ªpod.æ–°podè¿è¡Œæ—¶ï¼Œæ‰ä¼šåˆ é™¤å¯¹åº”è€çš„podã€‚ä¸€åˆ‡çš„å‰æéƒ½æ˜¯ä¸ºäº†æ»¡è¶³ä¸Šè¿°çš„æ¡ä»¶ã€‚</p>
<p>å¤‡æ³¨: å¦‚æœéœ€è¦æ›´æ–°Deploymentï¼Œæœ€å¥½é€šè¿‡yamlæ–‡ä»¶æ›´æ–°ï¼Œè¿™æ ·å›æ»šåˆ°ä»»ä½•ç‰ˆæœ¬éƒ½éå¸¸ä¾¿æ·ï¼Œè€Œä¸”æ›´å®¹æ˜“è¿½æº¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æ–¹å¼ä¸€: ç›´æ¥ä¿®æ”¹é•œåƒ[ä¸æ¨è]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰§è¡Œä¸‹é¢å‘½ä»¤åä¿®æ”¹å¯¹äºé•œåƒç‰ˆæœ¬å³å¯, è¯¥æ–¹æ³•ä¸ä¼šè®°å½•å‘½ä»¤,é€šè¿‡kubectl rollout history deployment/nginx-deploy æ— æ³•æŸ¥è¯¢</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl edit deploy/nginx-deploy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ–¹å¼äºŒ: å‘½ä»¤è¡Œæ›´æ–°image[å¯ä½¿ç”¨]ï¼Œä½†ä¹Ÿæç¤º--recordå³å°†åºŸå¼ƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl set image deploy/nginx-deploy nginx=nginx:1.18.0 --record</span>
</span></span><span style="display:flex;"><span>Flag --record has been deprecated, --record will be removed in the future
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy image updated
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout history deployment nginx-deploy </span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy 
</span></span><span style="display:flex;"><span>REVISION  CHANGE-CAUSE
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>         &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>         kubectl set image deploy/nginx-deploy nginx<span style="color:#f92672">=</span>nginx:1.18.0 --record<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deployments.apps -owide</span>
</span></span><span style="display:flex;"><span>NAME           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>nginx-deploy   2/2     <span style="color:#ae81ff">2</span>            <span style="color:#ae81ff">2</span>           16m   nginx        nginx:1.18.0   app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ–¹å¼ä¸‰: ä½¿ç”¨yamlæ–‡ä»¶æ›´æ–°ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å½“å‰nginx ç‰ˆæœ¬æ˜¯1.16.1, æ›´æ–°åˆ°1.18.0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…ˆåˆ é™¤ä¹‹å‰æ›´æ–°çš„deployï¼Œåœ¨é‡æ–°å¯åŠ¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f nginx-deploy.yaml </span>
</span></span><span style="display:flex;"><span>deployment.apps <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f nginx-deploy.yaml </span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deployments.apps -owide</span>
</span></span><span style="display:flex;"><span>NAME           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>nginx-deploy   3/3     <span style="color:#ae81ff">3</span>            <span style="color:#ae81ff">3</span>           35s   nginx        nginx:1.16.1   app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‹·è´ä¸€ä»½yamlæ–‡ä»¶ï¼ŒäºŒè€…é‡å‘½åï¼ˆè€ç‰ˆä¿ç•™ä»¥ä¾¿æœ‰é—®é¢˜æ—¶å›é€€ï¼‰ï¼Œç¼–è¾‘æ–°æ–‡ä»¶é•œåƒä¸º1.18.0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ll</span>
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">337</span> Dec <span style="color:#ae81ff">21</span> 09:59 nginx-deploy-1161.yaml
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">337</span> Dec <span style="color:#ae81ff">21</span> 11:01 nginx-deploy-1180.yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat nginx-deploy-1161.yaml </span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx-deploy
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: nginx
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: nginx
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: nginx
</span></span><span style="display:flex;"><span>        image: nginx:1.16.1
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat nginx-deploy-1180.yaml </span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx-deploy
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: nginx
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: nginx
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: nginx
</span></span><span style="display:flex;"><span>        image: nginx:1.18.0
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åº”ç”¨é•œåƒä¸º1180çš„åŒæ ·çš„é…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --record å‚æ•°å¯ä»¥è®°å½•å‘½ä»¤,é€šè¿‡ kubectl rollout history deployment/nginx-deployment å¯æŸ¥è¯¢</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f nginx-deploy-1180.yaml --record</span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy configured
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦‚æœæ­£åœ¨æ›´æ–°, å¯çœ‹åˆ°ä¸‹é¢æ—¥å¿—</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout status deploy/nginx-deploy</span>
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> rollout to finish: <span style="color:#ae81ff">1</span> out of <span style="color:#ae81ff">3</span> new replicas have been updated...
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> rollout to finish: <span style="color:#ae81ff">1</span> out of <span style="color:#ae81ff">3</span> new replicas have been updated...
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> rollout to finish: <span style="color:#ae81ff">2</span> out of <span style="color:#ae81ff">3</span> new replicas have been updated...
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> rollout to finish: <span style="color:#ae81ff">2</span> out of <span style="color:#ae81ff">3</span> new replicas have been updated...
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> rollout to finish: <span style="color:#ae81ff">2</span> out of <span style="color:#ae81ff">3</span> new replicas have been updated...
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> rollout to finish: <span style="color:#ae81ff">2</span> old replicas are pending termination...
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> rollout to finish: <span style="color:#ae81ff">1</span> old replicas are pending termination...
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> rollout to finish: <span style="color:#ae81ff">1</span> old replicas are pending termination...
</span></span><span style="display:flex;"><span>deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> successfully rolled out
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ›´æ–°ç»“æŸå, å¯çœ‹åˆ°ä¸‹é¢æ—¥å¿—</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout status deploy/nginx-deploy</span>
</span></span><span style="display:flex;"><span>deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> successfully rolled out
</span></span></code></pre></div><h4 id="å›æ»šdeployment">å›æ»šDeployment<a hidden class="anchor" aria-hidden="true" href="#å›æ»šdeployment">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout undo deployment nginx-deploy</span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy rolled back
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy,rs,po -owide</span>
</span></span><span style="display:flex;"><span>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy   3/3     <span style="color:#ae81ff">3</span>            <span style="color:#ae81ff">3</span>           11m   nginx        nginx:1.16.1   app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                     DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-79fccc485   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       7m46s   nginx        nginx:1.18.0   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>79fccc485
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-ff6655784   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       11m     nginx        nginx:1.16.1   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS    RESTARTS   AGE     IP              NODE           NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>pod/nginx-deploy-ff6655784-c9gf9   1/1     Running   <span style="color:#ae81ff">0</span>          2m7s    172.25.92.69    k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>pod/nginx-deploy-ff6655784-xl4rx   1/1     Running   <span style="color:#ae81ff">0</span>          2m12s   172.27.14.228   k8s-node02     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>pod/nginx-deploy-ff6655784-zzpvm   1/1     Running   <span style="color:#ae81ff">0</span>          2m9s    172.17.125.22   k8s-node01     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç›´æ¥ç”¨Yamlæ–‡ä»¶å›é€€[æ›´æ–°]ä¸ºå¯¹åº”é•œåƒ, æ¯”å¦‚ 1180--&gt;1161</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f nginx-deploy-1161.yaml --record</span>
</span></span></code></pre></div><h4 id="å›é€€å†å²ç‰ˆæœ¬">å›é€€å†å²ç‰ˆæœ¬<a hidden class="anchor" aria-hidden="true" href="#å›é€€å†å²ç‰ˆæœ¬">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹å†å²ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout history deployment nginx-deploy </span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy 
</span></span><span style="display:flex;"><span>REVISION  CHANGE-CAUSE
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>         kubectl apply --filename<span style="color:#f92672">=</span>nginx-deploy.yaml --record<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>         &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹å†å²ç‰ˆæœ¬ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout history deployment nginx-deploy --revision=2</span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy with revision <span style="color:#75715e">#2</span>
</span></span><span style="display:flex;"><span>Pod Template:
</span></span><span style="display:flex;"><span>  Labels:       app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>        pod-template-hash<span style="color:#f92672">=</span>79fccc485
</span></span><span style="display:flex;"><span>  Annotations:  kubernetes.io/change-cause: kubectl apply --filename<span style="color:#f92672">=</span>nginx-deploy.yaml --record<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>  Containers:
</span></span><span style="display:flex;"><span>   nginx:
</span></span><span style="display:flex;"><span>    Image:      nginx:1.18.0
</span></span><span style="display:flex;"><span>    Port:       80/TCP
</span></span><span style="display:flex;"><span>    Host Port:  0/TCP
</span></span><span style="display:flex;"><span>    Environment:        &lt;none&gt;
</span></span><span style="display:flex;"><span>    Mounts:     &lt;none&gt;
</span></span><span style="display:flex;"><span>  Volumes:      &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥ä½¿ç”¨--to-revisionå‚æ•°æŒ‡å®šå›é€€åˆ°æŸä¸ªå†å²ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout undo deployment nginx-deploy --to-revision=2</span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy rolled back
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy,rs,po -owide</span>
</span></span><span style="display:flex;"><span>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy   3/3     <span style="color:#ae81ff">3</span>            <span style="color:#ae81ff">3</span>           14m   nginx        nginx:1.18.0   app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                     DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-79fccc485   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       10m   nginx        nginx:1.18.0   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>79fccc485
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-ff6655784   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       14m   nginx        nginx:1.16.1   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS    RESTARTS   AGE   IP              NODE           NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>pod/nginx-deploy-79fccc485-dwhhr   1/1     Running   <span style="color:#ae81ff">0</span>          49s   172.25.92.70    k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>pod/nginx-deploy-79fccc485-kp2pd   1/1     Running   <span style="color:#ae81ff">0</span>          51s   172.17.125.23   k8s-node01     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>pod/nginx-deploy-79fccc485-z425l   1/1     Running   <span style="color:#ae81ff">0</span>          53s   172.27.14.229   k8s-node02     &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><h4 id="æ›´æ–°è¯¦æƒ…">æ›´æ–°è¯¦æƒ…<a hidden class="anchor" aria-hidden="true" href="#æ›´æ–°è¯¦æƒ…">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe deployments.apps nginx-deploy </span>
</span></span><span style="display:flex;"><span>Name:                   nginx-deploy
</span></span><span style="display:flex;"><span>Namespace:              default
</span></span><span style="display:flex;"><span>CreationTimestamp:      Wed, <span style="color:#ae81ff">12</span> Jan <span style="color:#ae81ff">2022</span> 13:17:12 +0800
</span></span><span style="display:flex;"><span>Labels:                 app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>Annotations:            deployment.kubernetes.io/revision: <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>                        kubernetes.io/change-cause: kubectl apply --filename<span style="color:#f92672">=</span>nginx-deploy.yaml --record<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>Selector:               app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>Replicas:               <span style="color:#ae81ff">3</span> desired | <span style="color:#ae81ff">3</span> updated | <span style="color:#ae81ff">3</span> total | <span style="color:#ae81ff">3</span> available | <span style="color:#ae81ff">0</span> unavailable
</span></span><span style="display:flex;"><span>StrategyType:           RollingUpdate
</span></span><span style="display:flex;"><span>MinReadySeconds:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>RollingUpdateStrategy:  25% max unavailable, 25% max surge <span style="color:#75715e"># æ›´æ–°ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>Pod Template:
</span></span><span style="display:flex;"><span>  Labels:  app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>  Containers:
</span></span><span style="display:flex;"><span>   nginx:
</span></span><span style="display:flex;"><span>    Image:        nginx:1.18.0
</span></span><span style="display:flex;"><span>    Port:         80/TCP
</span></span><span style="display:flex;"><span>    Host Port:    0/TCP
</span></span><span style="display:flex;"><span>    Environment:  &lt;none&gt;
</span></span><span style="display:flex;"><span>    Mounts:       &lt;none&gt;
</span></span><span style="display:flex;"><span>  Volumes:        &lt;none&gt;
</span></span><span style="display:flex;"><span>Conditions:
</span></span><span style="display:flex;"><span>  Type           Status  Reason
</span></span><span style="display:flex;"><span>  ----           ------  ------
</span></span><span style="display:flex;"><span>  Available      True    MinimumReplicasAvailable
</span></span><span style="display:flex;"><span>  Progressing    True    NewReplicaSetAvailable
</span></span><span style="display:flex;"><span>OldReplicaSets:  &lt;none&gt;
</span></span><span style="display:flex;"><span>NewReplicaSet:   nginx-deploy-79fccc485 <span style="color:#f92672">(</span>3/3 replicas created<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Events: <span style="color:#75715e"># å¯ä»¥çœ‹åˆ°ä¹‹å‰çš„æ“ä½œè®°å½•å’Œæ›´æ–°è®°å½•</span>
</span></span><span style="display:flex;"><span>  Type    Reason             Age                    From                   Message
</span></span><span style="display:flex;"><span>  ----    ------             ----                   ----                   -------
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  7m30s                  deployment-controller  Scaled up replica set nginx-deploy-ff6655784 to <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  7m27s                  deployment-controller  Scaled down replica set nginx-deploy-79fccc485 to <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  7m25s <span style="color:#f92672">(</span>x2 over 17m<span style="color:#f92672">)</span>    deployment-controller  Scaled up replica set nginx-deploy-ff6655784 to <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  7m23s <span style="color:#f92672">(</span>x3 over 7m27s<span style="color:#f92672">)</span>  deployment-controller  <span style="color:#f92672">(</span>combined from similar events<span style="color:#f92672">)</span>: Scaled down replica set nginx-deploy-79fccc485 to <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  3m16s <span style="color:#f92672">(</span>x2 over 13m<span style="color:#f92672">)</span>    deployment-controller  Scaled up replica set nginx-deploy-79fccc485 to <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  3m14s <span style="color:#f92672">(</span>x2 over 13m<span style="color:#f92672">)</span>    deployment-controller  Scaled down replica set nginx-deploy-ff6655784 to <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  3m14s <span style="color:#f92672">(</span>x2 over 13m<span style="color:#f92672">)</span>    deployment-controller  Scaled up replica set nginx-deploy-79fccc485 to <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  3m12s <span style="color:#f92672">(</span>x2 over 13m<span style="color:#f92672">)</span>    deployment-controller  Scaled down replica set nginx-deploy-ff6655784 to <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  3m12s <span style="color:#f92672">(</span>x2 over 13m<span style="color:#f92672">)</span>    deployment-controller  Scaled up replica set nginx-deploy-79fccc485 to <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  3m10s <span style="color:#f92672">(</span>x2 over 10m<span style="color:#f92672">)</span>    deployment-controller  Scaled down replica set nginx-deploy-ff6655784 to <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹å›æ»šçŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout status deploy nginx-deploy</span>
</span></span><span style="display:flex;"><span>deployment <span style="color:#e6db74">&#34;nginx-deploy&#34;</span> successfully rolled out
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å†å²è®°å½•</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout history deploy nginx-deploy</span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy
</span></span><span style="display:flex;"><span>REVISION  CHANGE-CAUSE
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>         &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span>         kubectl set image deployment/nginx-deploy nginx<span style="color:#f92672">=</span>nginx:1.18.0 --record<span style="color:#f92672">=</span>true
</span></span></code></pre></div><h4 id="æš‚åœä¸æ¢å¤">æš‚åœä¸æ¢å¤<a hidden class="anchor" aria-hidden="true" href="#æš‚åœä¸æ¢å¤">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æš‚åœ deployment çš„æ›´æ–°ï¼Œæš‚åœåé™¤éæ¢å¤æ›´æ–°ï¼Œå¦åˆ™æ“ä½œä¸ä¼šç”Ÿæ•ˆï¼Œå½“éœ€è¦å¤šé¡¹æ›´æ–°æ—¶å¯ä»¥ä½¿ç”¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout pause deployment nginx-deploy </span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy paused
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl set image deploy/nginx-deploy nginx=nginx:1.16.1 --record</span>
</span></span><span style="display:flex;"><span>Flag --record has been deprecated, --record will be removed in the future
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy image updated
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deployments.apps -owide</span>
</span></span><span style="display:flex;"><span>NAME           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>nginx-deploy   3/3     <span style="color:#ae81ff">0</span>            <span style="color:#ae81ff">3</span>           25m   nginx        nginx:1.16.1   app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥çœ‹åˆ°é•œåƒç¡®å®æ˜¯æ›´æ–°äº†ï¼Œä½†RSå’ŒPodåœ¨ç”¨çš„è¿˜æ˜¯è€ç‰ˆæœ¬çš„ï¼Œä¹Ÿå°±æ˜¯å¹¶æœªç”Ÿæ•ˆ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs,pod -owide</span>
</span></span><span style="display:flex;"><span>NAME                                     DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-79fccc485   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       22m   nginx        nginx:1.18.0   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>79fccc485
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-ff6655784   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       26m   nginx        nginx:1.16.1   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS    RESTARTS   AGE   IP              NODE           NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>pod/nginx-deploy-79fccc485-dwhhr   1/1     Running   <span style="color:#ae81ff">0</span>          12m   172.25.92.70    k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>pod/nginx-deploy-79fccc485-kp2pd   1/1     Running   <span style="color:#ae81ff">0</span>          12m   172.17.125.23   k8s-node01     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>pod/nginx-deploy-79fccc485-z425l   1/1     Running   <span style="color:#ae81ff">0</span>          12m   172.27.14.229   k8s-node02     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ç€è¿›è¡Œä¸‹ä¸€é¡¹æ›´æ–°ï¼Œé…ç½®CPUå’Œå†…å­˜èµ„æº</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl set resources deploy nginx-deploy -c nginx --limits=cpu=100m,memory=128Mi --requests=cpu=10m,memory=16Mi</span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy resource requirements updated
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¢å¤deploymentçš„æ›´æ–°</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout resume deployment nginx-deploy </span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy resumed
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­£åœ¨æ›´æ–°</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs</span>
</span></span><span style="display:flex;"><span>NAME                     DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>nginx-deploy-79fccc485   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>       28m
</span></span><span style="display:flex;"><span>nginx-deploy-975d4fc74   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">2</span>       5s
</span></span><span style="display:flex;"><span>nginx-deploy-ff6655784   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       32m
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ›´æ–°å®Œæˆå</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy,rs,po -owide</span>
</span></span><span style="display:flex;"><span>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy   3/3     <span style="color:#ae81ff">3</span>            <span style="color:#ae81ff">3</span>           32m   nginx        nginx:1.16.1   app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                     DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-79fccc485   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       28m   nginx        nginx:1.18.0   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>79fccc485
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-975d4fc74   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       25s   nginx        nginx:1.16.1   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>975d4fc74
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-deploy-ff6655784   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       32m   nginx        nginx:1.16.1   app<span style="color:#f92672">=</span>nginx,pod-template-hash<span style="color:#f92672">=</span>ff6655784
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS    RESTARTS   AGE   IP              NODE           NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>pod/nginx-deploy-975d4fc74-6d92q   1/1     Running   <span style="color:#ae81ff">0</span>          25s   172.27.14.230   k8s-node02     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>pod/nginx-deploy-975d4fc74-7c7f2   1/1     Running   <span style="color:#ae81ff">0</span>          22s   172.17.125.24   k8s-node01     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>pod/nginx-deploy-975d4fc74-snpkb   1/1     Running   <span style="color:#ae81ff">0</span>          20s   172.25.92.71    k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥çœ‹åˆ°èµ„æºé…é¢å’Œé•œåƒç‰ˆæœ¬å‡å·²æ›´æ–°</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe deployments.apps nginx-deploy </span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Pod Template:
</span></span><span style="display:flex;"><span>  Labels:  app<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>  Containers:
</span></span><span style="display:flex;"><span>   nginx:
</span></span><span style="display:flex;"><span>    Image:      nginx:1.16.1
</span></span><span style="display:flex;"><span>    Port:       80/TCP
</span></span><span style="display:flex;"><span>    Host Port:  0/TCP
</span></span><span style="display:flex;"><span>    Limits:
</span></span><span style="display:flex;"><span>      cpu:     100m
</span></span><span style="display:flex;"><span>      memory:  128Mi
</span></span><span style="display:flex;"><span>    Requests:
</span></span><span style="display:flex;"><span>      cpu:        10m
</span></span><span style="display:flex;"><span>      memory:     16Mi
</span></span><span style="display:flex;"><span>    Environment:  &lt;none&gt;
</span></span><span style="display:flex;"><span>    Mounts:       &lt;none&gt;
</span></span><span style="display:flex;"><span>  Volumes:        &lt;none&gt;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h4 id="å…¶ä»–é…ç½®">å…¶ä»–é…ç½®<a hidden class="anchor" aria-hidden="true" href="#å…¶ä»–é…ç½®">#</a></h4>
<ul>
<li>.spec.revisionHistoryLimitï¼šè®¾ç½®ä¿ç•™RSæ—§çš„revisionçš„ä¸ªæ•°ï¼Œè®¾ç½®ä¸º0çš„è¯ï¼Œä¸ä¿ç•™å†å²æ•°æ®</li>
<li>.spec.minReadySecondsï¼šå¯é€‰å‚æ•°ï¼ŒæŒ‡å®šæ–°åˆ›å»ºçš„Podåœ¨æ²¡æœ‰ä»»ä½•å®¹å™¨å´©æºƒçš„æƒ…å†µä¸‹è§†ä¸ºReadyæœ€å°çš„ç§’æ•°ï¼Œé»˜è®¤ä¸º0ï¼Œå³ä¸€æ—¦è¢«åˆ›å»ºå°±è§†ä¸ºå¯ç”¨ã€‚</li>
<li>æ»šåŠ¨æ›´æ–°çš„ç­–ç•¥ï¼š
<ul>
<li>.spec.strategy.typeï¼šæ›´æ–°deploymentçš„æ–¹å¼ï¼Œé»˜è®¤æ˜¯RollingUpdate
<ul>
<li>RollingUpdateï¼šæ»šåŠ¨æ›´æ–°ï¼Œå¯ä»¥æŒ‡å®šmaxSurgeå’ŒmaxUnavailable
<ul>
<li>maxUnavailableï¼šæŒ‡å®šåœ¨å›æ»šæˆ–æ›´æ–°æ—¶æœ€å¤§ä¸å¯ç”¨çš„Podçš„æ•°é‡ï¼Œå¯é€‰å­—æ®µï¼Œé»˜è®¤25%ï¼Œå¯ä»¥è®¾ç½®æˆæ•°å­—æˆ–ç™¾åˆ†æ¯”ï¼Œå¦‚æœè¯¥å€¼ä¸º0ï¼Œé‚£ä¹ˆmaxSurgeå°±ä¸èƒ½0</li>
<li>maxSurgeï¼šå¯ä»¥è¶…è¿‡æœŸæœ›å€¼çš„æœ€å¤§Podæ•°ï¼Œå¯é€‰å­—æ®µï¼Œé»˜è®¤ä¸º25%ï¼Œå¯ä»¥è®¾ç½®æˆæ•°å­—æˆ–ç™¾åˆ†æ¯”ï¼Œå¦‚æœè¯¥å€¼ä¸º0ï¼Œé‚£ä¹ˆmaxUnavailableä¸èƒ½ä¸º0</li>
</ul>
</li>
<li>Recreateï¼šé‡å»ºï¼Œå…ˆåˆ é™¤æ—§çš„Podï¼Œåœ¨åˆ›å»ºæ–°çš„Pod</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># specä¸­çš„é…ç½®å®ä¾‹</span>
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  progressDeadlineSeconds: <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  revisionHistoryLimit: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: nginx
</span></span><span style="display:flex;"><span>  strategy:
</span></span><span style="display:flex;"><span>    rollingUpdate:
</span></span><span style="display:flex;"><span>      maxSurge: 25%
</span></span><span style="display:flex;"><span>      maxUnavailable: 25%
</span></span><span style="display:flex;"><span>    type: RollingUpdate
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      ...
</span></span></code></pre></div><h3 id="statefulset">StatefulSet<a hidden class="anchor" aria-hidden="true" href="#statefulset">#</a></h3>
<p>StatefulSetå¸¸ç”¨äºéƒ¨ç½²æœ‰çŠ¶æ€çš„ä¸”éœ€è¦æœ‰åºå¯åŠ¨çš„åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯ä»¥éƒ¨ç½²ElasticSearché›†ç¾¤ã€MongoDBé›†ç¾¤æˆ–è€…éœ€è¦æŒä¹…åŒ–çš„RabbitMQé›†ç¾¤ã€Redisé›†ç¾¤ã€Kafkaé›†ç¾¤å’ŒZooKeeperé›†ç¾¤ç­‰ã€‚</p>
<p>StatefulSet ä¸­çš„ Pod æ‹¥æœ‰ç‹¬ä¸€æ— äºŒçš„èº«ä»½æ ‡è¯†ã€‚è¿™ä¸ªæ ‡è¯†åŸºäº StatefulSet æ§åˆ¶å™¨åˆ†é…ç»™æ¯ä¸ª Pod çš„å”¯ä¸€é¡ºåºç´¢å¼•ã€‚Pod çš„åç§°çš„å½¢å¼ä¸º<code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code> ã€‚ä¾‹å¦‚: webçš„StatefulSet æ‹¥æœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥å®ƒåˆ›å»ºäº†ä¸¤ä¸ª Pod: web-0å’Œweb-1ã€‚</p>
<p>å’Œ Deployment ç›¸åŒçš„æ˜¯ï¼ŒStatefulSet ç®¡ç†äº†åŸºäºç›¸åŒå®¹å™¨å®šä¹‰çš„ä¸€ç»„ Podï¼›ä½†å’Œ Deployment ä¸åŒçš„æ˜¯ï¼ŒStatefulSet ä¸ºå®ƒä»¬çš„æ¯ä¸ª Pod ç»´æŠ¤äº†ä¸€ä¸ªå›ºå®šçš„IDæ ‡è¯†ã€‚è¿™äº› Pod æ˜¯åŸºäºç›¸åŒçš„å£°æ˜æ¥åˆ›å»ºçš„ï¼Œä½†æ˜¯ä¸èƒ½ç›¸äº’æ›¿æ¢: æ— è®ºæ€ä¹ˆè°ƒåº¦ï¼Œæ¯ä¸ª Pod éƒ½æœ‰ä¸€ä¸ªæ°¸ä¹…ä¸å˜çš„IDæ ‡è¯†ã€‚</p>
<p>StatefulSetåˆ›å»ºçš„Podä¸€èˆ¬ä½¿ç”¨Headless Serviceï¼ˆæ— å¤´æœåŠ¡ï¼‰è¿›è¡Œé€šä¿¡ï¼Œå’Œæ™®é€šçš„Serviceçš„åŒºåˆ«åœ¨äºHeadless Serviceæ²¡æœ‰ClusterIPï¼Œå®ƒä½¿ç”¨çš„æ˜¯Endpointè¿›è¡Œäº’ç›¸é€šä¿¡ï¼ŒHeadlessä¸€èˆ¬çš„æ ¼å¼ä¸ºï¼šstatefulSetName-{0..N-1}.serviceName.namespace.svc.cluster.localã€‚</p>
<ul>
<li>serviceNameä¸ºHeadless Serviceçš„åå­—ï¼Œåˆ›å»ºStatefulSetæ—¶ï¼Œå¿…é¡»æŒ‡å®šHeadless Serviceåç§°</li>
<li>0..N-1ä¸ºPodæ‰€åœ¨çš„åºå·ï¼Œä»0å¼€å§‹åˆ°N-1</li>
<li>statefulSetNameä¸ºStatefulSetçš„åå­—</li>
<li>namespaceä¸ºæœåŠ¡æ‰€åœ¨çš„å‘½åç©ºé—´</li>
<li>.cluster.localä¸ºCluster Domainï¼ˆé›†ç¾¤åŸŸï¼‰</li>
</ul>
<h4 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨åœºæ™¯">#</a></h4>
<ul>
<li>ç¨³å®šçš„ã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç¬¦,å³Podé‡æ–°è°ƒåº¦åå…¶PodNameå’ŒHostNameä¸å˜(å½“ç„¶IPæ˜¯ä¼šå˜çš„)</li>
<li>ç¨³å®šçš„ã€æŒä¹…çš„å­˜å‚¨,å³Podé‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®,åŸºäºPVCå®ç°</li>
<li>æœ‰åºçš„ã€ä¼˜é›…çš„éƒ¨ç½²å’Œç¼©æ”¾</li>
<li>æœ‰åºçš„ã€è‡ªåŠ¨çš„æ»šåŠ¨æ›´æ–°</li>
</ul>
<p>å¦‚ä¸Šé¢,ç¨³å®šæ„å‘³ç€ Pod è°ƒåº¦æˆ–é‡æ–°è°ƒåº¦çš„æ•´ä¸ªè¿‡ç¨‹æ˜¯æœ‰æŒä¹…æ€§çš„ã€‚</p>
<p>å¦‚æœåº”ç”¨ç¨‹åºä¸éœ€è¦ä»»ä½•ç¨³å®šçš„æ ‡è¯†ç¬¦æˆ–æœ‰åºçš„éƒ¨ç½²ã€åˆ é™¤æˆ–ä¼¸ç¼©ï¼Œåˆ™åº”è¯¥ä½¿ç”¨ç”±ä¸€ç»„æ— çŠ¶æ€çš„å‰¯æœ¬æ§åˆ¶å™¨æä¾›çš„å·¥ä½œè´Ÿè½½æ¥éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚ä½¿ç”¨ Deployment æˆ–è€… ReplicaSet å¯èƒ½æ›´é€‚ç”¨äºæ— çŠ¶æ€åº”ç”¨éƒ¨ç½²éœ€è¦ã€‚</p>
<h4 id="é™åˆ¶">é™åˆ¶<a hidden class="anchor" aria-hidden="true" href="#é™åˆ¶">#</a></h4>
<ul>
<li>ç»™å®š Pod çš„å­˜å‚¨å¿…é¡»ç”± PersistentVolume(PV) é©±åŠ¨åŸºäºæ‰€è¯·æ±‚çš„ storage class æ¥æä¾›,æˆ–è€…ç”±ç®¡ç†å‘˜é¢„å…ˆæä¾›</li>
<li>åˆ é™¤æˆ–è€…æ”¶ç¼© StatefulSet å¹¶ä¸ä¼šåˆ é™¤å®ƒå…³è”çš„å­˜å‚¨å·.è¿™æ ·åšæ˜¯ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨</li>
<li>StatefulSet å½“å‰éœ€è¦ headless æœåŠ¡æ¥è´Ÿè´£ Pod çš„ç½‘ç»œæ ‡è¯†ã€‚éœ€è¦å…ˆåˆ›å»ºæ­¤æœåŠ¡ã€‚</li>
<li>åˆ é™¤StatefulSetæ—¶ï¼ŒStatefulSet ä¸æä¾›ä»»ä½•ç»ˆæ­¢ Pod çš„ä¿è¯ã€‚ä¸ºäº†å®ç° StatefulSet ä¸­çš„ Pod å¯ä»¥æœ‰åºå’Œä¼˜é›…çš„ç»ˆæ­¢ï¼Œå¯ä»¥åœ¨åˆ é™¤ä¹‹å‰å°† StatefulSetç¼©æ”¾ä¸º0ã€‚</li>
<li>åœ¨é»˜è®¤Podç®¡ç†ç­–ç•¥(OrderedReady) æ—¶ä½¿ç”¨æ»šåŠ¨æ›´æ–°ï¼Œå¯èƒ½è¿›å…¥éœ€è¦äººå·¥å¹²é¢„æ‰èƒ½ä¿®å¤çš„æŸåçŠ¶æ€</li>
</ul>
<h4 id="éƒ¨ç½²">éƒ¨ç½²<a hidden class="anchor" aria-hidden="true" href="#éƒ¨ç½²">#</a></h4>
<ul>
<li>å¯¹äºåŒ…å« N ä¸ª å‰¯æœ¬çš„ StatefulSetï¼Œå½“éƒ¨ç½² Pod æ—¶ï¼Œå®ƒä»¬æ˜¯ä¾æ¬¡åˆ›å»ºçš„ï¼Œé¡ºåºä¸º 0~(N-1)</li>
<li>å½“åˆ é™¤ Pod æ—¶ï¼Œå®ƒä»¬æ˜¯é€†åºç»ˆæ­¢çš„,é¡ºåºä¸º (N-1)~0</li>
<li>åœ¨å°†ç¼©æ”¾æ“ä½œåº”ç”¨åˆ° Pod ä¹‹å‰ï¼Œå®ƒå‰é¢çš„æ‰€æœ‰ Pod å¿…é¡»æ˜¯ Running å’Œ Ready çŠ¶æ€</li>
<li>åœ¨Pod ç»ˆæ­¢ä¹‹å‰ï¼Œæ‰€æœ‰çš„ç»§ä»»è€…å¿…é¡»å®Œå…¨å…³é—­</li>
</ul>
<p>StatefulSet ä¸åº”å°† pod.Spec.TerminationGracePeriodSeconds è®¾ç½®ä¸º 0ã€‚è¿™ç§åšæ³•æ˜¯ä¸å®‰å…¨çš„ï¼Œè¦å¼ºçƒˆé˜»æ­¢ã€‚</p>
<ul>
<li>éƒ¨ç½²é¡ºåº</li>
</ul>
<p>åœ¨ä¸‹é¢çš„ nginx ç¤ºä¾‹è¢«åˆ›å»ºåï¼Œä¼šæŒ‰ç…§ web-0ã€web-1ã€web-2 çš„é¡ºåºéƒ¨ç½²ä¸‰ä¸ª Podã€‚åœ¨ web-0 è¿›å…¥ Running å’Œ Ready çŠ¶æ€å‰ä¸ä¼šéƒ¨ç½² web-1ã€‚åœ¨ web-1 è¿›å…¥ Running å’Œ Ready çŠ¶æ€å‰ä¸ä¼šéƒ¨ç½² web-2ã€‚</p>
<p>å¦‚æœ web-1 å·²ç»å¤„äº Running å’Œ Ready çŠ¶æ€ï¼Œè€Œ web-2 å°šæœªéƒ¨ç½²ï¼Œåœ¨æ­¤æœŸé—´å‘ç”Ÿäº† web-0 è¿è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆ web-2 å°†ä¸ä¼šè¢«éƒ¨ç½²ï¼Œè¦ç­‰åˆ° web-0 éƒ¨ç½²å®Œæˆå¹¶è¿›å…¥ Running å’Œ Ready çŠ¶æ€åï¼Œæ‰ä¼šéƒ¨ç½² web-2ã€‚</p>
<ul>
<li>æ”¶ç¼©é¡ºåº</li>
</ul>
<p>å¦‚æœæƒ³å°†ç¤ºä¾‹ä¸­çš„ StatefulSet æ”¶ç¼©ä¸º replicas=1ï¼Œé¦–å…ˆè¢«ç»ˆæ­¢çš„æ˜¯ web-2ã€‚åœ¨ web-2 æ²¡æœ‰è¢«å®Œå…¨åœæ­¢å’Œåˆ é™¤å‰ï¼Œweb-1 ä¸ä¼šè¢«ç»ˆæ­¢ã€‚å½“ web-2 å·²è¢«ç»ˆæ­¢å’Œåˆ é™¤ï¼›ä½†web-1 å°šæœªè¢«ç»ˆæ­¢ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å‘ç”Ÿ web-0 è¿è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¸ä¼šç»ˆæ­¢ web-1ï¼Œå¿…é¡»ç­‰åˆ° web-0 è¿›å…¥ Running å’Œ Ready çŠ¶æ€åæ‰ä¼šç»ˆæ­¢ web-1</p>
<h4 id="stså®ä¾‹">STSå®ä¾‹<a hidden class="anchor" aria-hidden="true" href="#stså®ä¾‹">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &lt;&lt; &#34;EOF&#34; &gt; statefulset.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    name: http
</span></span><span style="display:flex;"><span>  type: ClusterIP
</span></span><span style="display:flex;"><span>  clusterIP: None
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: nginx
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: StatefulSet
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: web
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: nginx <span style="color:#75715e"># has to match .spec.template.metadata.labels</span>
</span></span><span style="display:flex;"><span>  serviceName: nginx
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># by default is 1</span>
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: nginx <span style="color:#75715e"># has to match .spec.selector.matchLabels</span>
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      terminationGracePeriodSeconds: <span style="color:#ae81ff">10</span>   <span style="color:#75715e"># é»˜è®¤30ç§’</span>
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: nginx
</span></span><span style="display:flex;"><span>        image: nginx:1.18.0
</span></span><span style="display:flex;"><span>        imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          name: http
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f statefulset.yaml </span>
</span></span><span style="display:flex;"><span>service/nginx created
</span></span><span style="display:flex;"><span>statefulset.apps/web created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc</span>
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>   AGE
</span></span><span style="display:flex;"><span>kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   30d
</span></span><span style="display:flex;"><span>nginx        ClusterIP   None         &lt;none&gt;        80/TCP    27s
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get sts -owide</span>
</span></span><span style="display:flex;"><span>NAME   READY   AGE   CONTAINERS   IMAGES
</span></span><span style="display:flex;"><span>web    3/3     63s   nginx        nginx:1.18.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po -owide</span>
</span></span><span style="display:flex;"><span>NAME    READY   STATUS    RESTARTS   AGE   IP              NODE           NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>web-0   1/1     Running   <span style="color:#ae81ff">0</span>          83s   172.27.14.233   k8s-node02     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>web-1   1/1     Running   <span style="color:#ae81ff">0</span>          81s   172.17.125.28   k8s-node01     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>web-2   1/1     Running   <span style="color:#ae81ff">0</span>          79s   172.25.92.73    k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºbusybox Podè¿›å»æŸ¥çœ‹ä¸‰ä¸ªweb-Podçš„åŸŸåä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &lt;&lt; &#34;EOF&#34; &gt; busybox.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: busybox
</span></span><span style="display:flex;"><span>  namespace: default
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: busybox
</span></span><span style="display:flex;"><span>    image: busybox:1.28
</span></span><span style="display:flex;"><span>    command:
</span></span><span style="display:flex;"><span>      - sleep
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;3600&#34;</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>  restartPolicy: Always
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f busybox.yaml </span>
</span></span><span style="display:flex;"><span>pod/busybox created
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿›å…¥busyboxè§£æåŸŸå</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec busybox -it -- sh</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># nslookup web-0.nginx</span>
</span></span><span style="display:flex;"><span>Server:    10.96.0.10
</span></span><span style="display:flex;"><span>Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:      web-0.nginx
</span></span><span style="display:flex;"><span>Address 1: 172.27.14.233 web-0.nginx.default.svc.cluster.local
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># nslookup web-1.nginx</span>
</span></span><span style="display:flex;"><span>Server:    10.96.0.10
</span></span><span style="display:flex;"><span>Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:      web-1.nginx
</span></span><span style="display:flex;"><span>Address 1: 172.17.125.28 web-1.nginx.default.svc.cluster.local
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># nslookup web-2.nginx</span>
</span></span><span style="display:flex;"><span>Server:    10.96.0.10
</span></span><span style="display:flex;"><span>Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:      web-2.nginx
</span></span><span style="display:flex;"><span>Address 1: 172.25.92.73 web-2.nginx.default.svc.cluster.local
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># exit</span>
</span></span></code></pre></div><h4 id="åˆ é™¤sts">åˆ é™¤STS<a hidden class="anchor" aria-hidden="true" href="#åˆ é™¤sts">#</a></h4>
<p>åˆ é™¤STSæœ‰ä¸¤ç§æ–¹å¼ï¼šçº§è”åˆ é™¤å’Œéçº§è”åˆ é™¤ã€‚éçº§è”åˆ é™¤æ—¶ï¼ŒSTSè¢«åˆ é™¤åPodä¾æ—§å­˜æ´»ï¼Œå˜æˆäº†Orphan Podï¼ˆå³å­¤å„¿Podï¼‰ï¼Œå­¤å„¿Podå¯ä»¥è¢«å•ç‹¬æ“ä½œã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨--cascade=orphanå‚æ•°å®ç°éçº§è”åˆ é™¤</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete sts web --cascade=orphan</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get sts web</span>
</span></span><span style="display:flex;"><span>Error from server <span style="color:#f92672">(</span>NotFound<span style="color:#f92672">)</span>: statefulsets.apps <span style="color:#e6db74">&#34;web&#34;</span> not found
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod | grep web</span>
</span></span><span style="display:flex;"><span>web-0                         1/1     Running     <span style="color:#ae81ff">0</span>          30m
</span></span><span style="display:flex;"><span>web-1                         1/1     Running     <span style="color:#ae81ff">0</span>          29m
</span></span><span style="display:flex;"><span>web-2                         1/1     Running     <span style="color:#ae81ff">0</span>          28m
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤Pod web-1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete po web-1</span>
</span></span><span style="display:flex;"><span>pod <span style="color:#e6db74">&#34;web-1&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod | grep web</span>
</span></span><span style="display:flex;"><span>web-0                         1/1     Running     <span style="color:#ae81ff">0</span>          30m
</span></span><span style="display:flex;"><span>web-2                         1/1     Running     <span style="color:#ae81ff">0</span>          29m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é‡å»ºSTSï¼Œå¹¶æŠŠå‰¯æœ¬æ•°é‡ä¿®æ”¹ä¸º2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># cat statefulset.yaml | grep repli</span>
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">2</span> <span style="color:#75715e"># by default is 1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f statefulset.yaml</span>
</span></span><span style="display:flex;"><span>service/nginx unchanged
</span></span><span style="display:flex;"><span>statefulset.apps/web created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po | grep web</span>
</span></span><span style="display:flex;"><span>web-0                         1/1     Running     <span style="color:#ae81ff">0</span>          32m
</span></span><span style="display:flex;"><span>web-1                         1/1     Running     <span style="color:#ae81ff">0</span>          13s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># çº§è”åˆ é™¤</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete sts web</span>
</span></span><span style="display:flex;"><span>statefulset.apps <span style="color:#e6db74">&#34;web&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po | grep web</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ—¶STSå’ŒPodéƒ½åˆ æ‰äº†</span>
</span></span></code></pre></div><blockquote>
<p>éçº§è”åˆ é™¤æ—¶ï¼Œç”±äºweb-1è¢«åˆ äº†ï¼Œè€Œä¸”å‰¯æœ¬æ•°å˜æˆäº†2ï¼Œæ‰€ä»¥é‡å»ºSTSï¼ˆç”¨åŸæ¥çš„é…ç½®æ–‡ä»¶ï¼‰åï¼Œä¼šå…ˆåˆ é™¤web-2ï¼Œç„¶åé‡æ–°åˆ›å»ºPod web-1ï¼Œweb-0å·²å­˜åœ¨ï¼Œä¸å‘ç”Ÿå˜åŒ–ã€‚</p>
</blockquote>
<h3 id="daemonset">DaemonSet<a hidden class="anchor" aria-hidden="true" href="#daemonset">#</a></h3>
<p>DaemonSetå®ˆæŠ¤è¿›ç¨‹ç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–åŒ¹é…çš„ä¸€éƒ¨åˆ†ï¼‰èŠ‚ç‚¹ä¸Šéƒ¨ç½²ä¸€ä¸ªPodã€‚å½“æœ‰æ–°çš„èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºå®ƒä»¬æ–°å¢ä¸€ä¸ªPodï¼Œå½“æœ‰èŠ‚ç‚¹ä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº›Podä¹Ÿä¼šè¢«å›æ”¶ã€‚</p>
<p>DaemonSetå…¸å‹ç”¨æ³•:</p>
<ul>
<li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹ï¼Œä¾‹å¦‚ glusterdã€ceph</li>
<li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ—¥å¿—å®ˆæŠ¤è¿›ç¨‹ï¼Œä¾‹å¦‚ fluentdã€logstash</li>
<li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›‘æ§å®ˆæŠ¤è¿›ç¨‹ï¼Œä¾‹å¦‚ Prometheus Node Exporterã€Flowmillã€Sysdig ä»£ç†ã€collectdã€Dynatrace OneAgentã€AppDynamics ä»£ç†ã€Datadog ä»£ç†ã€New Relic ä»£ç†ã€Ganglia gmond æˆ–è€… Instana ä»£ç†</li>
</ul>
<h4 id="daemonsetå®ä¾‹">DaemonSetå®ä¾‹<a hidden class="anchor" aria-hidden="true" href="#daemonsetå®ä¾‹">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºyaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &lt;&lt; &#34;EOF&#34; &gt; daemonset.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: DaemonSet
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: fluentd-elasticsearch
</span></span><span style="display:flex;"><span>  namespace: default
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: fluentd-logging
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      name: fluentd-elasticsearch
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        name: fluentd-elasticsearch
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      tolerations:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># å®¹å¿åœ¨masterèŠ‚ç‚¹è¿è¡Œ</span>
</span></span><span style="display:flex;"><span>      - key: node-role.kubernetes.io/master
</span></span><span style="display:flex;"><span>        effect: NoSchedule
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: fluentd-elasticsearch
</span></span><span style="display:flex;"><span>        image: registry.cn-beijing.aliyuncs.com/google_registry/fluentd:v2.5.2
</span></span><span style="display:flex;"><span>        resources:
</span></span><span style="display:flex;"><span>          limits:
</span></span><span style="display:flex;"><span>            cpu: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            memory: 200Mi
</span></span><span style="display:flex;"><span>          requests:
</span></span><span style="display:flex;"><span>            cpu: 100m
</span></span><span style="display:flex;"><span>            memory: 200Mi
</span></span><span style="display:flex;"><span>        volumeMounts:
</span></span><span style="display:flex;"><span>        - name: varlog
</span></span><span style="display:flex;"><span>          mountPath: /var/log
</span></span><span style="display:flex;"><span>        - name: varlibdockercontainers
</span></span><span style="display:flex;"><span>          mountPath: /var/lib/docker/containers
</span></span><span style="display:flex;"><span>          readOnly: true
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># ä¼˜é›…å…³é—­åº”ç”¨,æ—¶é—´è®¾ç½®.è¶…è¿‡è¯¥æ—¶é—´ä¼šå¼ºåˆ¶å…³é—­,é»˜è®¤30ç§’</span>
</span></span><span style="display:flex;"><span>      terminationGracePeriodSeconds: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>      - name: varlog
</span></span><span style="display:flex;"><span>        hostPath:
</span></span><span style="display:flex;"><span>          path: /var/log
</span></span><span style="display:flex;"><span>      - name: varlibdockercontainers
</span></span><span style="display:flex;"><span>        hostPath:
</span></span><span style="display:flex;"><span>          path: /var/lib/docker/containers
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f daemonset.yaml </span>
</span></span><span style="display:flex;"><span>daemonset.apps/fluentd-elasticsearch created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get ds -owide</span>
</span></span><span style="display:flex;"><span>NAME                    DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE   CONTAINERS              IMAGES                                                            SELECTOR
</span></span><span style="display:flex;"><span>fluentd-elasticsearch   <span style="color:#ae81ff">5</span>         <span style="color:#ae81ff">5</span>         <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">5</span>            <span style="color:#ae81ff">0</span>           &lt;none&gt;          11s   fluentd-elasticsearch   registry.cn-beijing.aliyuncs.com/google_registry/fluentd:v2.5.2   name<span style="color:#f92672">=</span>fluentd-elasticsearch
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯è§DaemonSetåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰ç›¸åº”çš„pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po -owide</span>
</span></span><span style="display:flex;"><span>NAME                          READY   STATUS    RESTARTS   AGE    IP               NODE           NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>fluentd-elasticsearch-blmjp   1/1     Running   <span style="color:#ae81ff">0</span>          2m9s   172.18.195.19    k8s-master03   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>fluentd-elasticsearch-t8bpk   1/1     Running   <span style="color:#ae81ff">0</span>          2m9s   172.17.125.29    k8s-node01     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>fluentd-elasticsearch-v8dwj   1/1     Running   <span style="color:#ae81ff">0</span>          2m9s   172.27.14.236    k8s-node02     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>fluentd-elasticsearch-w9wpb   1/1     Running   <span style="color:#ae81ff">0</span>          2m9s   172.25.92.74     k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>fluentd-elasticsearch-xrphv   1/1     Running   <span style="color:#ae81ff">0</span>          2m9s   172.25.244.193   k8s-master01   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><blockquote>
<p>DaemonSetæ›´æ–°ä¸å›æ»šå’ŒDeploymentä¸€è‡´</p>
</blockquote>
<h3 id="job">Job<a hidden class="anchor" aria-hidden="true" href="#job">#</a></h3>
<p>Job è´Ÿè´£ä»…æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œå®ƒä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ª Pod æˆåŠŸç»“æŸã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl explain job</span>
</span></span><span style="display:flex;"><span>KIND:     Job
</span></span><span style="display:flex;"><span>VERSION:  batch/v1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DESCRIPTION:
</span></span><span style="display:flex;"><span>     Job represents the configuration of a single job.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºyaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &lt;&lt; &#34;EOF&#34; &gt; job-example.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: batch/v1
</span></span><span style="display:flex;"><span>kind: Job
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: pi
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      name: pi
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: pi
</span></span><span style="display:flex;"><span>        image: perl
</span></span><span style="display:flex;"><span>        command: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;perl&#34;</span>, <span style="color:#e6db74">&#34;-Mbignum=bpi&#34;</span>, <span style="color:#e6db74">&#34;-wle&#34;</span>, <span style="color:#e6db74">&#34;print bpi(1000)&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      restartPolicy: Never
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po</span>
</span></span><span style="display:flex;"><span>NAME                      READY   STATUS      RESTARTS   AGE
</span></span><span style="display:flex;"><span>daemonset-example-f57kg   1/1     Running     <span style="color:#ae81ff">0</span>          13m
</span></span><span style="display:flex;"><span>pi-2nlj5                  0/1     Completed   <span style="color:#ae81ff">0</span>          4m
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get job</span>
</span></span><span style="display:flex;"><span>NAME   COMPLETIONS   DURATION   AGE
</span></span><span style="display:flex;"><span>pi     1/1           3m19s      4m15s
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po pi-2nlj5 -o wide</span>
</span></span><span style="display:flex;"><span>NAME       READY   STATUS      RESTARTS   AGE     IP              NODE        NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>pi-2nlj5   0/1     Completed   <span style="color:#ae81ff">0</span>          4m54s   172.16.36.119   k8s-node1   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹æ—¥å¿—å¯ä»¥çœ‹åˆ°jobæ‰§è¡Œçš„ç»“æœ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¡ç®—å‡ºäº†åœ†å‘¨ç‡å1000ä½</span>
</span></span></code></pre></div><p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20201123180138.png" alt="20201123180138"  />
</p>
<h3 id="cronjob">CronJob<a hidden class="anchor" aria-hidden="true" href="#cronjob">#</a></h3>
<p>Cron Job ç®¡ç†åŸºäºæ—¶é—´çš„ Jobï¼Œå³:</p>
<ul>
<li>åœ¨ç»™å®šæ—¶é—´ç‚¹åªè¿è¡Œä¸€æ¬¡</li>
<li>å‘¨æœŸæ€§åœ°åœ¨è®¾å®šæ—¶é—´ç‚¹è¿è¡Œ</li>
</ul>
<p>å…¸å‹çš„ç”¨æ³•ç¤ºä¾‹:</p>
<ul>
<li>åœ¨ç»™ä½ å†™çš„æ—¶é—´ç‚¹è°ƒåº¦ Job è¿è¡Œ</li>
<li>åˆ›å»ºå‘¨æœŸæ€§è¿è¡Œçš„ Jobï¼Œä¾‹å¦‚: æ•°æ®åº“å¤‡ä»½ã€å‘é€é‚®ä»¶</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl explain cj</span>
</span></span><span style="display:flex;"><span>KIND:     CronJob
</span></span><span style="display:flex;"><span>VERSION:  batch/v1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DESCRIPTION:
</span></span><span style="display:flex;"><span>     CronJob represents the configuration of a single cron job.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºcronjob yamlæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &lt;&lt; &#34;EOF&#34; &gt; cronjob-example.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: batch/v1
</span></span><span style="display:flex;"><span>kind: CronJob
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: hello
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  schedule: <span style="color:#e6db74">&#34;*/1 * * * *&#34;</span> <span style="color:#75715e"># åˆ† æ—¶ æ—¥ æœˆ æ˜ŸæœŸ</span>
</span></span><span style="display:flex;"><span>  successfulJobsHistoryLimit: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># ä¿ç•™æˆåŠŸçš„è®°å½•æ•°</span>
</span></span><span style="display:flex;"><span>  failedJobHistoryLimit: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># ä¿ç•™å¤±è´¥çš„è®°å½•æ•°</span>
</span></span><span style="display:flex;"><span>  concurrencyPolicy: Allow <span style="color:#75715e"># å¹¶å‘è°ƒåº¦ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>  suspend: false <span style="color:#75715e"># æ˜¯å¦æš‚åœåç»­ä»»åŠ¡ï¼Œé»˜è®¤false</span>
</span></span><span style="display:flex;"><span>  jobTemplate:
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>	    metadata:
</span></span><span style="display:flex;"><span>		  labels:
</span></span><span style="display:flex;"><span>		    run: hello
</span></span><span style="display:flex;"><span>        spec:
</span></span><span style="display:flex;"><span>          containers:
</span></span><span style="display:flex;"><span>          - name: hello
</span></span><span style="display:flex;"><span>            image: busybox
</span></span><span style="display:flex;"><span>            args:
</span></span><span style="display:flex;"><span>            - /bin/sh
</span></span><span style="display:flex;"><span>            - -c
</span></span><span style="display:flex;"><span>            - date; echo Hello CronJob
</span></span><span style="display:flex;"><span>			imagePolicy: Always
</span></span><span style="display:flex;"><span>          restartPolicy: OnFailure
</span></span><span style="display:flex;"><span>		  
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f cronjob-example.yaml</span>
</span></span><span style="display:flex;"><span>cronjob.batch/hello created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get cj</span>
</span></span><span style="display:flex;"><span>NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
</span></span><span style="display:flex;"><span>hello   */1 * * * *   False     <span style="color:#ae81ff">0</span>        44s             69s
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po</span>
</span></span><span style="display:flex;"><span>NAME                   READY   STATUS      RESTARTS   AGE
</span></span><span style="display:flex;"><span>hello-27366655-8mm5c   0/1     Completed   <span style="color:#ae81ff">0</span>          84s
</span></span><span style="display:flex;"><span>hello-27366656-pjbv6   0/1     Completed   <span style="color:#ae81ff">0</span>          24s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹è¾“å‡ºæ—¥å¿—</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl logs hello-27366655-8mm5c</span>
</span></span><span style="display:flex;"><span>Wed Jan <span style="color:#ae81ff">12</span> 14:55:17 UTC <span style="color:#ae81ff">2022</span>
</span></span><span style="display:flex;"><span>Hello CronJob
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl logs hello-27366656-pjbv6</span>
</span></span><span style="display:flex;"><span>Wed Jan <span style="color:#ae81ff">12</span> 14:56:15 UTC <span style="color:#ae81ff">2022</span>
</span></span><span style="display:flex;"><span>Hello CronJob
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get job</span>
</span></span><span style="display:flex;"><span>NAME             COMPLETIONS   DURATION   AGE
</span></span><span style="display:flex;"><span>hello-27366655   1/1           17s        2m29s
</span></span><span style="display:flex;"><span>hello-27366656   1/1           16s        89s
</span></span><span style="display:flex;"><span>hello-27366657   0/1           29s        29s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete cronjob hello</span>
</span></span><span style="display:flex;"><span>cronjob.batch <span style="color:#e6db74">&#34;hello&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get job</span>
</span></span><span style="display:flex;"><span>No resources found in default namespace.
</span></span></code></pre></div><p>å¹¶å‘è°ƒåº¦ç­–ç•¥concurrencyPolicy:</p>
<ul>
<li>Allowï¼šå…è®¸å¤šä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œ</li>
<li>Forbidï¼šä¸å…è®¸å¹¶å‘ï¼Œå½“å‰ä»»åŠ¡æœªå®Œæˆï¼Œæ–°ä»»åŠ¡ä¸ä¼šåˆ›å»º</li>
<li>Replaceï¼šå¦‚æœä¹‹å‰çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œåˆ™åˆ›å»ºæ–°çš„ä»£æ›¿ä¹‹</li>
</ul>
<h3 id="hpa">HPA<a hidden class="anchor" aria-hidden="true" href="#hpa">#</a></h3>
<p>é¡¾åæ€ä¹‰ï¼ŒHorizontal Pod Autoscalingï¼ˆPod æ°´å¹³è‡ªåŠ¨ç¼©æ”¾ï¼‰ï¼Œå¯ä»¥åŸºäº CPU åˆ©ç”¨ç‡è‡ªåŠ¨ä¼¸ç¼© ReplicationControllerã€Deploymentã€ReplicaSet å’Œ StatefulSet ä¸­çš„ Pod æ•°é‡ã€‚é™¤äº† CPU åˆ©ç”¨ç‡ï¼Œä¹Ÿå¯ä»¥åŸºäºå…¶ä»–åº”ç¨‹åºæä¾›çš„<code>è‡ªå®šä¹‰åº¦é‡æŒ‡æ ‡</code>æ¥æ‰§è¡Œè‡ªåŠ¨æ‰©ç¼©ã€‚ Pod è‡ªåŠ¨æ‰©ç¼©ä¸é€‚ç”¨äºæ— æ³•æ‰©ç¼©çš„å¯¹è±¡ï¼Œæ¯”å¦‚ DaemonSetã€‚</p>
<p>Pod æ°´å¹³è‡ªåŠ¨æ‰©ç¼©ç‰¹æ€§ç”± Kubernetes API èµ„æºå’Œæ§åˆ¶å™¨å®ç°ã€‚èµ„æºå†³å®šäº†æ§åˆ¶å™¨çš„è¡Œä¸ºã€‚æ§åˆ¶å™¨ä¼šå‘¨æœŸæ€§åœ°è°ƒæ•´å‰¯æœ¬æ§åˆ¶å™¨æˆ– Deployment ä¸­çš„å‰¯æœ¬æ•°é‡ï¼Œä»¥ä½¿å¾—ç±»ä¼¼ Pod å¹³å‡ CPU åˆ©ç”¨ç‡ã€å¹³å‡å†…å­˜åˆ©ç”¨ç‡è¿™ç±»è§‚æµ‹åˆ°çš„åº¦é‡å€¼ä¸ç”¨æˆ·æ‰€è®¾å®šçš„ç›®æ ‡å€¼åŒ¹é…ã€‚</p>
<p>ä¸‹é¢æ˜¯HPAå·¥ä½œæœºåˆ¶æ¨¡å‹å›¾:</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20201222152148.png" alt="20201222152148"  />
</p>
<p>HPAä¸¤ä¸ªç‰ˆæœ¬åŒºåˆ«:</p>
<ul>
<li>autoscaling/v1ï¼šç¨³å®šç‰ˆæœ¬ï¼Œåªæ”¯æŒ cpu</li>
<li>autoscaling/v2betaï¼šæµ‹è¯•é˜¶æ®µ
<ul>
<li>v2beta1(æ”¯æŒCPUã€å†…å­˜å’Œè‡ªå®šä¹‰æŒ‡æ ‡)</li>
<li>v2beta2(æ”¯æŒCPUã€å†…å­˜ã€è‡ªå®šä¹‰æŒ‡æ ‡Customå’Œé¢å¤–æŒ‡æ ‡ExternalMetrics)</li>
</ul>
</li>
</ul>
<blockquote>
<p>Kubernetesç›®å‰ï¼ˆv1.23.0åï¼‰autoscaling/v2ç‰ˆæœ¬å·²è¿›å…¥ç¨³å®šç‰ˆï¼Œæ”¯æŒCPUã€å†…å­˜ã€è‡ªå®šä¹‰æŒ‡æ ‡Customå’Œé¢å¤–æŒ‡æ ‡ExternalMetrics</p>
</blockquote>
<h4 id="æŒ‡æ ‡">æŒ‡æ ‡<a hidden class="anchor" aria-hidden="true" href="#æŒ‡æ ‡">#</a></h4>
<p>Pod æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©å™¨çš„å®ç°æ˜¯ä¸€ä¸ªæ§åˆ¶å›è·¯ï¼Œç”±æ§åˆ¶å™¨ç®¡ç†å™¨çš„<code>--horizontal-pod-autoscaler-sync-period</code>å‚æ•°æŒ‡å®šå‘¨æœŸï¼ˆé»˜è®¤å€¼ä¸º 15 ç§’ï¼‰ã€‚</p>
<p>æ¯ä¸ªå‘¨æœŸå†…ï¼Œæ§åˆ¶å™¨ç®¡ç†å™¨æ ¹æ®æ¯ä¸ª<code>HorizontalPodAutoscaler</code>å®šä¹‰ä¸­æŒ‡å®šçš„æŒ‡æ ‡æŸ¥è¯¢èµ„æºåˆ©ç”¨ç‡ã€‚æ§åˆ¶å™¨ç®¡ç†å™¨å¯ä»¥ä»èµ„æºåº¦é‡æŒ‡æ ‡ APIï¼ˆæŒ‰ Pod ç»Ÿè®¡çš„èµ„æºç”¨é‡ï¼‰å’Œè‡ªå®šä¹‰åº¦é‡æŒ‡æ ‡ APIï¼ˆå…¶ä»–æŒ‡æ ‡ï¼‰è·å–åº¦é‡å€¼ã€‚</p>
<ul>
<li>å¯¹äºæŒ‰ Pod ç»Ÿè®¡çš„èµ„æºæŒ‡æ ‡ï¼ˆå¦‚ CPUï¼‰ï¼Œæ§åˆ¶å™¨ä»èµ„æºæŒ‡æ ‡ API ä¸­è·å–æ¯ä¸€ä¸ª<code>HorizontalPodAutoscaler</code>æŒ‡å®šçš„ Pod çš„åº¦é‡å€¼ï¼Œå¦‚æœè®¾ç½®äº†ç›®æ ‡ä½¿ç”¨ç‡ï¼Œæ§åˆ¶å™¨è·å–æ¯ä¸ª Pod ä¸­çš„å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¹¶è®¡ç®—èµ„æºä½¿ç”¨ç‡ã€‚ å¦‚æœè®¾ç½®äº† target å€¼ï¼Œå°†ç›´æ¥ä½¿ç”¨åŸå§‹æ•°æ®ï¼ˆä¸å†è®¡ç®—ç™¾åˆ†æ¯”ï¼‰ã€‚ æ¥ä¸‹æ¥ï¼Œæ§åˆ¶å™¨æ ¹æ®å¹³å‡çš„èµ„æºä½¿ç”¨ç‡æˆ–åŸå§‹å€¼è®¡ç®—å‡ºæ‰©ç¼©çš„æ¯”ä¾‹ï¼Œè¿›è€Œè®¡ç®—å‡ºç›®æ ‡å‰¯æœ¬æ•°ã€‚</li>
<li>å¦‚æœ Pod ä½¿ç”¨è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œæ§åˆ¶å™¨æœºåˆ¶ä¸èµ„æºæŒ‡æ ‡ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºè‡ªå®šä¹‰æŒ‡æ ‡åªä½¿ç”¨åŸå§‹å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç‡ã€‚</li>
<li>å¦‚æœ Pod ä½¿ç”¨å¯¹è±¡æŒ‡æ ‡å’Œå¤–éƒ¨æŒ‡æ ‡ï¼ˆæ¯ä¸ªæŒ‡æ ‡æè¿°ä¸€ä¸ªå¯¹è±¡ä¿¡æ¯ï¼‰ã€‚è¿™ä¸ªæŒ‡æ ‡å°†ç›´æ¥æ ¹æ®ç›®æ ‡è®¾å®šå€¼ç›¸æ¯”è¾ƒï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªä¸Šé¢æåˆ°çš„æ‰©ç¼©æ¯”ä¾‹ã€‚åœ¨<code>autoscaling/v2beta2</code>ç‰ˆæœ¬ API ä¸­ï¼Œè¿™ä¸ªæŒ‡æ ‡ä¹Ÿå¯ä»¥æ ¹æ® Pod æ•°é‡å¹³åˆ†åå†è®¡ç®—ã€‚</li>
</ul>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæ§åˆ¶å™¨å°†ä»ä¸€ç³»åˆ—çš„èšåˆAPIï¼ˆmetrics.k8s.ioã€custom.metrics.k8s.io å’Œ external.metrics.k8s.ioï¼‰ä¸­è·å–åº¦é‡å€¼ã€‚<code>metrics.k8s.io</code> API é€šå¸¸ç”± Metrics æœåŠ¡å™¨ï¼ˆéœ€è¦æå‰å¯åŠ¨ï¼‰æä¾›ã€‚</p>
<h4 id="hpaä½¿ç”¨">HPAä½¿ç”¨<a hidden class="anchor" aria-hidden="true" href="#hpaä½¿ç”¨">#</a></h4>
<p>1.ä½¿ç”¨kubectl</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># è‡ªåŠ¨ä¼¸ç¼©deploy/php-apacheï¼Œç›®æ ‡CPUä½¿ç”¨ç‡50%ï¼Œdeployå‰¯æœ¬æ•°åœ¨1~10ä¹‹é—´</span>
</span></span><span style="display:flex;"><span>kubectl autoscale deployment php-apache --cpu-percent<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span> --min<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> --max<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
</span></span></code></pre></div><p>2.ä½¿ç”¨yamlåˆ›å»º</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ä½œç”¨åŒä¸Š</span>
</span></span><span style="display:flex;"><span>apiVersion: autoscaling/v2
</span></span><span style="display:flex;"><span>kind: HorizontalPodAutoscaler
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: php-apache
</span></span><span style="display:flex;"><span>  namespace: default
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  scaleTargetRef:
</span></span><span style="display:flex;"><span>    apiVersion: apps/v1
</span></span><span style="display:flex;"><span>    kind: Deployment
</span></span><span style="display:flex;"><span>    name: php-apache
</span></span><span style="display:flex;"><span>  minReplicas: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  maxReplicas: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  targetCPUUtilizationPercentage: <span style="color:#ae81ff">50</span>
</span></span></code></pre></div><h4 id="ç¤ºä¾‹">ç¤ºä¾‹<a hidden class="anchor" aria-hidden="true" href="#ç¤ºä¾‹">#</a></h4>
<p>ä¸‹è½½å›½å†…ç¤ºä¾‹é•œåƒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># é›†ç¾¤æ‰€æœ‰å¯è°ƒåº¦Podçš„èŠ‚ç‚¹å…ˆè·å–è¦ä½¿ç”¨çš„hpaç¤ºä¾‹é•œåƒ</span>
</span></span><span style="display:flex;"><span>docker pull registry.cn-beijing.aliyuncs.com/google_registry/hpa-example
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &lt;&lt; &#34;EOF&#34; &gt; php-apache.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: php-apache
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      hpa: php-apache
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        hpa: php-apache
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: php-apache
</span></span><span style="display:flex;"><span>        image: registry.cn-beijing.aliyuncs.com/google_registry/hpa-example
</span></span><span style="display:flex;"><span>        imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        resources:
</span></span><span style="display:flex;"><span>          limits:
</span></span><span style="display:flex;"><span>            cpu: 500m
</span></span><span style="display:flex;"><span>          requests:
</span></span><span style="display:flex;"><span>            cpu: 200m
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: php-apache
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    hpa: php-apache
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    hpa: php-apache
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f php-apache.yaml </span>
</span></span><span style="display:flex;"><span>deployment.apps/php-apache created
</span></span><span style="display:flex;"><span>service/php-apache created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deployments.apps </span>
</span></span><span style="display:flex;"><span>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>php-apache   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           9s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºHPA</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å½“podä¸­CPUä½¿ç”¨ç‡è¾¾50%å°±æ‰©å®¹.æœ€å°1ä¸ª,æœ€å¤§10ä¸ª</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span>
</span></span><span style="display:flex;"><span>horizontalpodautoscaler.autoscaling/php-apache autoscaled
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get hpa</span>
</span></span><span style="display:flex;"><span>NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style="display:flex;"><span>php-apache   Deployment/php-apache   0%/50%    <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">10</span>        <span style="color:#ae81ff">1</span>          18s
</span></span></code></pre></div><ul>
<li>å‹æµ‹php-apache</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºå‹æµ‹Podå¹¶è¿›å…¥, å…ˆä¸è¦é€€å‡º</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl run -it load-test --image=busybox /bin/sh</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦èµ·ä¸€çª—å£å¯æŸ¥çœ‹åˆ°podåœ¨è¿è¡Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po | grep load</span>
</span></span><span style="display:flex;"><span>load-test                     1/1     Running   <span style="color:#ae81ff">0</span>             26s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨load-testç»§ç»­ä¸­æ“ä½œï¼Œè¿ç»­è®¿é—®php-apacheçš„Service</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># while true; do wget -q -O- http://php-apache.default.svc.cluster.local; done</span>
</span></span><span style="display:flex;"><span>OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸€åˆ†é’Ÿå·¦å³ï¼Œåœ¨å¦å¤–ä¸€ä¸ªçª—å£å¯çœ‹åˆ°ï¼Œè´Ÿè½½é£™å‡, å‰¯æœ¬æ•°å¢å¤š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get hpa</span>
</span></span><span style="display:flex;"><span>NAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style="display:flex;"><span>php-apache   Deployment/php-apache   254%/50%   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">10</span>        <span style="color:#ae81ff">3</span>          21m
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è‡ªåŠ¨æ‰©å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy,rs,po</span>
</span></span><span style="display:flex;"><span>NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/php-apache   6/6     <span style="color:#ae81ff">6</span>            <span style="color:#ae81ff">6</span>           23m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                    DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicaset.apps/php-apache-7db9c95858   <span style="color:#ae81ff">6</span>         <span style="color:#ae81ff">6</span>         <span style="color:#ae81ff">6</span>       23m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                              READY   STATUS    RESTARTS      AGE
</span></span><span style="display:flex;"><span>pod/php-apache-7db9c95858-6wrp2   1/1     Running   <span style="color:#ae81ff">0</span>             32s
</span></span><span style="display:flex;"><span>pod/php-apache-7db9c95858-7dbjv   1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>pod/php-apache-7db9c95858-cfwrk   1/1     Running   <span style="color:#ae81ff">0</span>             32s
</span></span><span style="display:flex;"><span>pod/php-apache-7db9c95858-ksbgh   1/1     Running   <span style="color:#ae81ff">0</span>             47s
</span></span><span style="display:flex;"><span>pod/php-apache-7db9c95858-m9mtn   1/1     Running   <span style="color:#ae81ff">0</span>             47s
</span></span><span style="display:flex;"><span>pod/php-apache-7db9c95858-znczt   1/1     Running   <span style="color:#ae81ff">0</span>             32s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœæ­¢å‹æµ‹</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ctrl+Cåœæ­¢åœ¨è·‘çš„å¾ªç¯</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># while true; do wget -q -O- http://php-apache.default.svc.cluster.local; done</span>
</span></span><span style="display:flex;"><span>OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!.&lt;çœç•¥å¾ˆå¤šè¾“å‡º&gt;..!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!^C
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœæ­¢å‹æµ‹åè´Ÿè½½é™ä¸‹æ¥</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get hpa</span>
</span></span><span style="display:flex;"><span>NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style="display:flex;"><span>php-apache   Deployment/php-apache   0%/50%    <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">10</span>        <span style="color:#ae81ff">6</span>          24m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å†è¿‡å‡ åˆ†é’Ÿå‰¯æœ¬æ•°ä¹Ÿé™äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get hpa</span>
</span></span><span style="display:flex;"><span>NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style="display:flex;"><span>php-apache   Deployment/php-apache   0%/50%    <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">10</span>        <span style="color:#ae81ff">1</span>          29m
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy,rs,po</span>
</span></span><span style="display:flex;"><span>NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/php-apache   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           31m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                    DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicaset.apps/php-apache-7db9c95858   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>       31m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                              READY   STATUS    RESTARTS      AGE
</span></span><span style="display:flex;"><span>pod/php-apache-7db9c95858-7dbjv   1/1     Running   <span style="color:#ae81ff">0</span>             18m
</span></span></code></pre></div><blockquote>
<p>è¯´æ˜:åœæ­¢å‹æµ‹ï¼Œpodæ•°é‡ä¹Ÿä¸ä¼šç«‹å³é™ä¸‹æ¥.è€Œæ˜¯è¿‡æ®µæ—¶é—´åæ‰ä¼šæ…¢æ…¢é™ä¸‹æ¥.è¿™æ˜¯ä¸ºäº†é˜²æ­¢ç”±äºç½‘ç»œåŸå› æˆ–è€…é—´æ­‡æ€§æµé‡çªå¢ã€çªé™ï¼Œå¯¼è‡´podå›æ”¶å¤ªå¿«åé¢æµé‡ä¸Šæ¥åPodæ•°é‡ä¸å¤Ÿ</p>
</blockquote>


        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://deemoprobe.github.io/posts/tech/kubernetes/kuberneteslabelselector/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>KubernetesLabelSelector</span>
  </a>
  <a class="next" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetespod/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>KubernetesPod</span>
  </a>
</nav>

        </footer>
    </div>
</article>
</main>

<footer class="footer">
    
        <span id="runtime_span"></span>
        <script
            type="text/javascript">function show_runtime() { window.setTimeout("show_runtime()", 1000); X = new Date("1/1/2023 1:00:00"); Y = new Date(); T = (Y.getTime() - X.getTime()); M = 24 * 60 * 60 * 1000; a = T / M; A = Math.floor(a); b = (a - A) * 24; B = Math.floor(b); c = (b - B) * 60; C = Math.floor((b - B) * 60); D = Math.floor((c - C) * 60); runtime_span.innerHTML = "ç½‘ç«™å·²è¿è¡Œ" + A + "å¤©" + B + "å°æ—¶" + C + "åˆ†" + D + "ç§’" } show_runtime();</script>
    
    
    <br>
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="https://deemoprobe.github.io/" style="color:#939393;">William&#39;s Blog</a>
        All Rights Reserved
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>

<script>
    $("code[class^=language] ").on("mouseover", function () {
        if (this.clientWidth < this.scrollWidth) {
            $(this).css("width", "135%")
            $(this).css("border-top-right-radius", "var(--radius)")
        }
    }).on("mouseout", function () {
        $(this).css("width", "100%")
        $(this).css("border-top-right-radius", "unset")
    })
</script>
</body>

</html>
