<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>KubernetesServiceDiscovery | William&#39;s Blog</title>
<meta name="keywords" content="kubernetes">
<meta name="description" content="Kubernetes Serviceå’ŒæœåŠ¡å‘ç°">
<meta name="author" content="deemoprobe">
<link rel="canonical" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesservicediscovery/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.ddb3ce53f79f05de71d690031b572b6066753a2375de82c18ef290d92427fea4.css" integrity="sha256-3bPOU/efBd5x1pADG1crYGZ1OiN13oLBjvKQ2SQn/qQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://deemoprobe.github.io/img/bear.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://deemoprobe.github.io/img/bear.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://deemoprobe.github.io/img/bear.gif">
<link rel="apple-touch-icon" href="https://deemoprobe.github.io/img/bear.gif">
<link rel="mask-icon" href="https://deemoprobe.github.io/img/bear.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="KubernetesServiceDiscovery" />
<meta property="og:description" content="Kubernetes Serviceå’ŒæœåŠ¡å‘ç°" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesservicediscovery/" />
<meta property="og:image" content="https://deemoprobe.github.io/img/kubernetes.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-30T02:26:47+08:00" />
<meta property="article:modified_time" content="2023-04-30T02:26:47+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://deemoprobe.github.io/img/kubernetes.png" />
<meta name="twitter:title" content="KubernetesServiceDiscovery"/>
<meta name="twitter:description" content="Kubernetes Serviceå’ŒæœåŠ¡å‘ç°"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://deemoprobe.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
          "item": "https://deemoprobe.github.io/posts/tech/"
        },

        {
          "@type": "ListItem",
          "position":  3 ,
          "name": "Kubernetes",
          "item": "https://deemoprobe.github.io/posts/tech/kubernetes/"
        }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "KubernetesServiceDiscovery",
      "item": "https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesservicediscovery/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "KubernetesServiceDiscovery",
  "name": "KubernetesServiceDiscovery",
  "description": "Kubernetes Serviceå’ŒæœåŠ¡å‘ç°",
  "keywords": [
    "kubernetes"
  ],
  "articleBody": "Serviceæ˜¯ä¸€ç§Podçš„æœåŠ¡æš´éœ²æœºåˆ¶ï¼Œå…¶ä»–Podå¯ä»¥é€šè¿‡è¿™ä¸ªServiceè®¿é—®åˆ°è¿™ä¸ªServiceä»£ç†çš„ä¸€ä¸ªæˆ–ä¸€ç»„Podã€‚\nå¸¦æœ‰selectorçš„Serviceåœ¨åˆ›å»ºåä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªåŒåçš„Endpointså®ä¾‹ï¼ŒEndpointså®ä¾‹è®°å½•äº†selectoråŒ¹é…çš„Podçš„IPåœ°å€å’Œç«¯å£ã€‚å½“Podè¢«é‡å»ºåï¼ŒEndpointsä¼šè¢«æ›´æ–°ï¼Œè€Œæˆ‘ä»¬ä½¿ç”¨Serviceåç§°è¿æ¥åç«¯Podï¼ŒIPå˜åŠ¨ä¸ä¼šå¯¹æœåŠ¡é€ æˆå½±å“ã€‚\n# é›†ç¾¤åˆå§‹åŒ–åçš„Serviceå’ŒEndpoint [root@k8s-master01 yamls]# kubectl get svc | grep kubernetes kubernetes ClusterIP 10.96.0.1 443/TCP 8d [root@k8s-master01 yamls]# kubectl get ep | grep kubernetes kubernetes 192.168.43.201:6443,192.168.43.202:6443,192.168.43.203:6443 8d å®šä¹‰ å‡è®¾å­˜åœ¨ä¸€ä¸ªæˆ–ä¸€ç»„æ‰“æœ‰\"app=myapp\"æ ‡ç­¾çš„podï¼ŒPodå¯¹å¤–æš´éœ²çš„ç«¯å£æ˜¯8001ï¼Œé‚£ä¹ˆå¯ä»¥åˆ›å»ºServiceå»ä»£ç†è¿™äº›Pod\n# å•ä¸ªç«¯å£ä»£ç†ç¤ºä¾‹ apiVersion: v1 kind: Service metadata: name: my-service spec: selector: app: myapp # é€‰æ‹©å¸¦æœ‰è¯¥æ ‡ç­¾çš„Pod ports: - protocol: TCP # UDP TCP SCTP default: TCP port: 8080 # Serviceè‡ªå·±çš„ç«¯å£ targetPort: 8001 # åç«¯åº”ç”¨Podæš´éœ²çš„ç«¯å£ # name: http # Serviceç«¯å£çš„åç§° # å¤šä¸ªç«¯å£ä»£ç†ç¤ºä¾‹ apiVersion: v1 kind: Service metadata: name: my-service spec: selector: app: myapp ports: - name: http protocol: TCP port: 80 targetPort: 8001 - name: https protocol: TCP port: 443 targetPort: 8002 # æ— selectorçš„Service apiVersion: v1 kind: Service metadata: name: my-service spec: ports: - protocol: TCP port: 80 targetPort: 8001 # ç”±äºæ²¡æœ‰selectorï¼Œè¯¥Serviceåˆ›å»ºåä¸ä¼šè‡ªåŠ¨åˆ›å»ºEndpointså®ä¾‹ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»º apiVersion: v1 kind: Endpoints metadata: name: my-service subnets: - addresses: - ip: 1.2.3.4 ports: - port: 8001 # ExternalName Serviceï¼Œæ²¡æœ‰selectoræ²¡æœ‰Endpointsï¼Œä»…ä½¿ç”¨åˆ«åè§£æService apiVersion: v1 kind: Service metadata: name: my-service namespace: dev spec: type: ExternalName externalName: my.nginx.example.com è¯´æ˜ï¼šService èƒ½å¤Ÿå°†ä¸€ä¸ªæ¥æ”¶ port æ˜ å°„åˆ°ä»»æ„çš„ targetPortã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒtargetPort å°†è¢«è®¾ç½®ä¸ºä¸ port å­—æ®µç›¸åŒçš„å€¼ã€‚\nHeadless Service æœ‰æ—¶ä¸éœ€è¦æˆ–ä¸æƒ³è¦è´Ÿè½½å‡è¡¡ï¼Œä»¥åŠå•ç‹¬çš„ Service IPã€‚å¯ä»¥é€šè¿‡æŒ‡å®šspecä¸‹é¢çš„clusterIP: Noneæ¥åˆ›å»º Headless Serviceã€‚\næ— å¤´æœåŠ¡å¹¶ä¸ä¼šåˆ†é… Cluster IPï¼Œkube-proxy ä¸ä¼šå¤„ç†å®ƒä»¬ï¼Œè€Œä¸”å¹³å°ä¹Ÿä¸ä¼šä¸ºå®ƒä»¬è¿›è¡Œè´Ÿè½½å‡è¡¡å’Œè·¯ç”±ã€‚DNSå¦‚ä½•å®ç°è‡ªåŠ¨é…ç½®ï¼Œä¾èµ–äº Service æ˜¯å¦å®šä¹‰äº†selectorã€‚\nå¯¹äºå®šä¹‰äº†selectorçš„æ— å¤´æœåŠ¡ï¼ŒEndpoint æ§åˆ¶å™¨åœ¨ API ä¸­åˆ›å»ºäº† Endpoints è®°å½•ï¼Œå¹¶ä¸”ä¿®æ”¹ DNS é…ç½®è¿”å› A è®°å½•ï¼ˆIP åœ°å€ï¼‰ï¼Œé€šè¿‡è¿™ä¸ªåœ°å€ç›´æ¥åˆ°è¾¾ Service çš„åç«¯ Pod ä¸Šã€‚\nå¯¹äºæ²¡æœ‰å®šä¹‰selectorçš„æ— å¤´æœåŠ¡ï¼ŒEndpoint æ§åˆ¶å™¨ä¸ä¼šåˆ›å»º Endpoints è®°å½•ã€‚DNSç³»ç»Ÿä¼šæŸ¥æ‰¾å’Œé…ç½®ï¼š\nå¯¹äº ExternalName ç±»å‹çš„æœåŠ¡ï¼ŒæŸ¥æ‰¾å…¶ CNAME è®°å½• å¯¹æ‰€æœ‰å…¶ä»–ç±»å‹çš„æœåŠ¡ï¼ŒæŸ¥æ‰¾ä¸ Service åç§°ç›¸åŒçš„ä»»ä½• Endpoints çš„è®°å½• Serviceå‘å¸ƒç±»å‹ Kubernetes å…è®¸æŒ‡å®šä½ æ‰€éœ€è¦çš„ Service ç±»å‹ï¼Œé»˜è®¤æ˜¯ ClusterIPï¼Œå¯ä»¥è‡ªå®šä¹‰specå­—æ®µä¸‹çš„typeå­—æ®µã€‚typeçš„å–å€¼ä»¥åŠè¡Œä¸ºå¦‚ä¸‹ï¼š\nClusterIPï¼šé€šè¿‡é›†ç¾¤çš„å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼Œé€‰æ‹©è¯¥å€¼æ—¶æœåŠ¡åªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚ NodePortï¼šé€šè¿‡æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ IP å’Œé™æ€ç«¯å£ï¼ˆNodePortï¼‰æš´éœ²æœåŠ¡ã€‚NodePortæœåŠ¡ä¼šè·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ClusterIPæœåŠ¡ã€‚é€šè¿‡è¯·æ±‚\u003cèŠ‚ç‚¹ IP\u003e:\u003cèŠ‚ç‚¹ç«¯å£\u003eï¼ŒNodePortç«¯å£èŒƒå›´é»˜è®¤æ˜¯30000-32767ã€‚å¯ä»¥ä»é›†ç¾¤çš„å¤–éƒ¨è®¿é—®ã€‚ LoadBalancerï¼šä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å¯ä»¥å°†æµé‡è·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„NodePortæœåŠ¡å’ŒClusterIPæœåŠ¡ä¸Šã€‚ ExternalNameï¼šé€šè¿‡è¿”å›CNAMEï¼ˆåˆ«åï¼‰å’Œå¯¹åº”å€¼ï¼Œå¯ä»¥å°†æœåŠ¡æ˜ å°„åˆ° externalName å­—æ®µçš„å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œfoo.bar.example.comï¼‰ã€‚æ— éœ€åˆ›å»ºä»»ä½•ç±»å‹ä»£ç†ã€‚ è¯´æ˜ï¼škube-dns 1.7 åŠä»¥ä¸Šç‰ˆæœ¬æˆ–è€… CoreDNS 0.0.8 åŠä»¥ä¸Šç‰ˆæœ¬æ‰èƒ½ä½¿ç”¨ ExternalName ç±»å‹ã€‚\n# ClusterIPç±»å‹ï¼Œtypeå¯ä»¥ä¸æŒ‡å®š apiVersion: v1 kind: Service metadata: name: my-service spec: selector: app: myapp ports: # é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ`targetPort` è¢«è®¾ç½®ä¸ºä¸ `port` å­—æ®µç›¸åŒçš„å€¼ã€‚ - port: 80 targetPort: 80 # NodePortç±»å‹ apiVersion: v1 kind: Service metadata: name: my-service spec: type: NodePort selector: app: myapp ports: # é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ`targetPort` è¢«è®¾ç½®ä¸ºä¸ `port` å­—æ®µç›¸åŒçš„å€¼ã€‚ - port: 80 targetPort: 80 # å¯é€‰å­—æ®µï¼Œä¸æŒ‡å®šçš„è¯ä¼šè‡ªåŠ¨è®¾ç½®ä¸º30000-32767ä¸­çš„ä¸€ä¸ª nodePort: 30007 # LoadBalancerç±»å‹ï¼Œstatus.loadBalancerå­—æ®µæŒ‡å®šäº‘å‚å•†æä¾›çš„è´Ÿè½½å‡è¡¡åœ°å€ apiVersion: v1 kind: Service metadata: name: my-service spec: selector: app: MyApp ports: - protocol: TCP port: 80 targetPort: 8001 clusterIP: 10.96.0.239 type: LoadBalancer status: loadBalancer: ingress: - ip: 192.0.2.127 # ExternalNameç±»å‹ # è®¿é—®nginx-externalname.test.svc.cluster.localè¢«é‡å®šå‘åˆ°www.baidu.com apiVersion: v1 kind: Service metadata: labels: app: nginx-externalname name: nginx-externalname namespace: test spec: type: ExternalName externalName: www.baidu.com å¤–éƒ¨IP å¦‚æœå¤–éƒ¨IPè·¯ç”±åˆ°é›†ç¾¤ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªNodeä¸Šï¼ŒKubernetes Service ä¼šè¢«æš´éœ²ç»™è¿™äº›externalIPã€‚é€šè¿‡å¤–éƒ¨ IPï¼ˆä½œä¸ºç›®çš„ IP åœ°å€ï¼‰è¿›å…¥åˆ°é›†ç¾¤ï¼Œæµé‡å°†ä¼šè¢«è·¯ç”±åˆ° Service çš„ Endpoint ä¸Šã€‚æ ¹æ® Service çš„è§„å®šï¼ŒexternalIPs å¯ä»¥åŒä»»æ„çš„ ServiceType æ¥ä¸€èµ·æŒ‡å®šã€‚ åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œmy-service å¯ä»¥é€šè¿‡ â€œ80.11.12.10:80â€(externalIP:port)è¢«å®¢æˆ·ç«¯è®¿é—®ã€‚\napiVersion: v1 kind: Service metadata: name: my-service spec: selector: app: myapp ports: - name: http protocol: TCP port: 80 targetPort: 8001 externalIPs: - 80.11.12.10 Serviceä»£ç†æ¨¡å¼ åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œkube-proxyè´Ÿè´£ä¸ºServiceå®ç°äº†ä¸€ç§VIPå½¢å¼çš„ä»£ç†ï¼Œè€Œä¸æ˜¯ExternalNameçš„å½¢å¼ã€‚è¿™ç§VIPå½¢å¼çš„ä»£ç†ä¸»è¦æœ‰ä¸‹é¢ä¸¤ç§å®ç°æ–¹å¼ï¼Œç°åœ¨kubernetesæ¨èä½¿ç”¨ipvs\niptablesä»£ç†æ¨¡å¼ åœ¨iptablesæ¨¡å¼ä¸­ï¼Œkube-proxy ç›‘è§† Kubernetesçš„Serviceå’ŒEndpointsçš„çŠ¶æ€å˜åŒ–ï¼ˆåˆ›å»ºæˆ–åˆ é™¤ï¼‰ï¼Œå¯¹æ¯ä¸ª Serviceå®ƒéƒ½ä¼šåˆ›å»ºiptablesè§„åˆ™ï¼Œä»è€Œæ•è·åˆ°è¾¾è¯¥ Service çš„ClusterIPå’Œç«¯å£çš„è¯·æ±‚ï¼Œè¿›è€Œå°†è¯·æ±‚é‡å®šå‘åˆ° Service åç«¯ä¸­çš„æŸä¸ª Pod ä¸Šé¢ã€‚ å¯¹äºæ¯ä¸ª Endpoints å¯¹è±¡ï¼Œå®ƒä¹Ÿä¼šåˆ›å»ºiptablesè§„åˆ™ï¼Œè¿™ä¸ªè§„åˆ™ä¼šé€‰æ‹©ä¸€ä¸ªåç«¯podã€‚\né»˜è®¤çš„ç­–ç•¥æ˜¯ï¼Œkube-proxy åœ¨ iptables æ¨¡å¼ä¸‹éšæœºé€‰æ‹©ä¸€ä¸ªåç«¯ã€‚å¦‚æœè¦ç¡®ä¿æ¯æ¬¡éƒ½å°†æ¥è‡ªç‰¹å®šå®¢æˆ·ç«¯çš„è¿æ¥ä¼ é€’åˆ°åŒä¸€Podï¼ˆå³ä¼šè¯ä¿æŒï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡è®¾ç½®äº²å’ŒåŠ›è°ƒåº¦ç­–ç•¥service.spec.sessionAffinity: ClientIPï¼ˆé»˜è®¤å€¼æ˜¯ Noneï¼‰ï¼Œæ¥åŸºäºå®¢æˆ·ç«¯çš„ IP åœ°å€é€‰æ‹©ä¼šè¯å…³è”ã€‚è¿˜å¯ä»¥é€šè¿‡è®¾ç½®service.spec.sessionAffinityConfig.clientIP.timeoutSecondsæ¥é…ç½®æœ€å¤§ä¼šè¯åœç•™æ—¶é—´ã€‚ï¼ˆé»˜è®¤å€¼ä¸º 10800 ç§’ï¼Œå³ 3 å°æ—¶ï¼‰\nIPVSä»£ç†æ¨¡å¼ åœ¨ipvsæ¨¡å¼ä¸­ï¼Œkube-proxy ç›‘è§† Kubernetesçš„Serviceå’ŒEndpointsçš„çŠ¶æ€å˜åŒ–ï¼ˆåˆ›å»ºæˆ–åˆ é™¤ï¼‰ï¼Œè°ƒç”¨netlinkæ¥å£åˆ›å»º IPVS è§„åˆ™ï¼Œå¹¶å®šæœŸå°†è§„åˆ™ä¸Kubernetesçš„Serviceå’ŒEndpointsåŒæ­¥ã€‚ç¡®ä¿IPVSçŠ¶æ€ä¸æ‰€éœ€çŠ¶æ€åŒ¹é…ã€‚è®¿é—®æœåŠ¡æ—¶ï¼ŒIPVSæ ¹æ®è§„åˆ™å°†æµé‡å®šå‘åˆ°åç«¯Podä¹‹ä¸€\nç±»ä¼¼iptablesï¼ŒIPVSåŸºäºnetfilteré’©å­å‡½æ•°ï¼Œä½†æ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåŸºç¡€æ•°æ®ç»“æ„ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­å·¥ä½œï¼Œå†…æ ¸çº§çš„è½¬å‘ï¼Œæ‰€ä»¥é€Ÿåº¦å¾ˆå¿«ã€‚\nIPVS æä¾›ä»¥ä¸‹é€‰é¡¹æ¥å®ç°è´Ÿè½½å‡è¡¡ï¼š\nrrï¼šè½®è¯¢ï¼ˆRound-Robinï¼‰ lcï¼šæœ€å°‘é“¾æ¥ï¼ˆLeast Connectionï¼‰ï¼Œå³æ‰“å¼€é“¾æ¥æ•°é‡æœ€å°‘è€…ä¼˜å…ˆ dhï¼šç›®æ ‡åœ°å€å“ˆå¸Œï¼ˆDestination Hashingï¼‰ shï¼šæºåœ°å€å“ˆå¸Œï¼ˆSource Hashingï¼‰ sedï¼šæœ€çŸ­é¢„æœŸå»¶è¿Ÿï¼ˆShortest Expected Delayï¼‰ nqï¼šä»ä¸æ’é˜Ÿï¼ˆNever Queueï¼‰ è¯´æ˜ï¼šè¦åœ¨ IPVS æ¨¡å¼ä¸‹è¿è¡Œ kube-proxyï¼Œå¿…é¡»åœ¨å¯åŠ¨ kube-proxy ä¹‹å‰ä½¿ IPVS åœ¨èŠ‚ç‚¹ä¸Šå¯ç”¨ï¼ˆå¯ç”¨IPVSå¯ä»¥å‚è€ƒé«˜å¯ç”¨é›†ç¾¤å®‰è£…æ–‡æ¡£ å½“kube-proxy ä»¥ IPVS ä»£ç†æ¨¡å¼å¯åŠ¨æ—¶ï¼Œå®ƒå°†éªŒè¯ IPVS å†…æ ¸æ¨¡å—æ˜¯å¦å¯ç”¨ã€‚ å¦‚æœæœªæ£€æµ‹åˆ° IPVS å†…æ ¸æ¨¡å—ï¼Œåˆ™ kube-proxy å°†é€€å›åˆ°ä»¥ iptables ä»£ç†æ¨¡å¼è¿è¡Œã€‚\né€‰æ‹©åˆé€‚çš„æ¨¡å¼ iptablesç”±äºçº¿æ€§æŸ¥æ‰¾åŒ¹é…ã€å…¨é‡æ›´æ–°ç­‰ç‰¹ç‚¹ï¼Œå½“è§„åˆ™å¾ˆå¤šæ—¶ï¼Œæ€§èƒ½ä¼šæ¯”ipvså·®ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¨èé€‰æ‹©ipvs\niptableså·¥å…·åŸºäºLinuxå†…æ ¸çš„Netfilteræ¨¡å—ï¼Œé»˜è®¤å®šä¹‰äº†å¤šå¼ è¡¨ã€‚æ¯å¼ è¡¨é‡ŒåŒ…å«è‹¥å¹²å†…ç½®é“¾ï¼ˆchainï¼‰ï¼Œä¹Ÿå¯èƒ½åŒ…å«ç”¨æˆ·è‡ªå®šä¹‰çš„é“¾ã€‚æ¯æ¡é“¾æ˜¯ä¸€å¥—è§„åˆ™ï¼ˆruleï¼‰åˆ—è¡¨ï¼Œç”¨äºåŒ¹é…ä¸€ç»„æ•°æ®åŒ…ã€‚æ¯æ¡è§„åˆ™éƒ½æŒ‡å®šå¦‚ä½•å¤„ç†åŒ¹é…çš„æ•°æ®åŒ…ã€‚\ntableï¼šåŒ…å«ä¸€ç»„chainçš„è¡¨\nchainï¼šåŒ…å«ä¸€ç»„ruleçš„é“¾\nruleï¼šåŒ¹é…æ•°æ®åŒ…çš„è§„åˆ™ï¼Œä¾‹å¦‚ï¼šåè®®ï¼Œç«¯å£å·\ntargetï¼šè§„åˆ™ä¸­çš„å…·ä½“è¡Œä¸ºï¼Œä¾‹å¦‚ï¼šACCEPTï¼ŒDROPï¼ŒINPUTï¼ŒFORWARDï¼ŒOUTPUT\nè¡¨\nfilterï¼šé»˜è®¤è¡¨ï¼Œé€šç”¨æ•°æ®åŒ…è¿‡æ»¤è¡¨ mangleï¼šä¸ºç‰¹å®šçš„æ•°æ®åŒ…è®¾è®¡ natï¼šé’ˆå¯¹åˆ›å»ºæ–°è¿æ¥çš„æ•°æ®åŒ… rawï¼šä¸»è¦ç”¨äºç»“åˆ NOTRACK target é…ç½®è¿æ¥è·Ÿè¸ªçš„è±å… securityï¼šç”¨äºMACï¼ˆMandatory Access Controlï¼Œå¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼‰è§„åˆ™ è§„åˆ™é“¾\nINPUTï¼šä»¥æœ¬æœºä¸ºç›®æ ‡çš„å…¥å£æ•°æ®åŒ…è§„åˆ™é“¾ OUTPUTï¼šæœ¬æœºäº§ç”Ÿï¼Œå‘å¤–è½¬å‘çš„æ•°æ®åŒ…è§„åˆ™é“¾ FORWARDï¼šè·¯ç”±ç»è¿‡æœ¬æœºçš„æ•°æ®åŒ…è§„åˆ™é“¾ PREROUTINGï¼šæ•°æ®åŒ…è¿›å…¥è·¯ç”±ä¹‹å‰çš„è§„åˆ™é“¾ POSTROUTINGï¼šæ•°æ®åŒ…å‘é€åˆ°ç›®æ ‡å‰ï¼ˆå‡ºè·¯ç”±ï¼‰çš„è§„åˆ™é“¾ IPtableså¤„ç†é“¾æ¥çš„ç®—æ³•å¤æ‚åº¦ä¸ºO(n)ï¼ŒIPVSä¸ºO(1)ï¼ŒServiceè§„æ¨¡åœ¨1000å†…äºŒè€…å·®è·å¹¶ä¸æ˜¯å¾ˆå¤§ã€‚åœ¨Serviceè§„æ¨¡è¶…è¿‡1000åï¼ŒIPtablesè§„åˆ™é“¾è¾¾åˆ°2000ä»¥ä¸Šï¼Œæ€§èƒ½å¼€å§‹ä¸‹é™ï¼Œå“åº”æ—¶é—´æˆå€æ•°å¢åŠ ï¼ŒIPVSåˆ™å‡ ä¹ä¸å—Serviceè§„æ¨¡çš„å½±å“ã€‚Calicoè™½ç„¶ä¹Ÿé‡‡ç”¨IPtablesæŠ€æœ¯ï¼Œä½†å¯¹è§„åˆ™é“¾è¿›è¡Œäº†ä¼˜åŒ–ï¼Œç®—æ³•å¤æ‚åº¦ä¹Ÿè¾¾åˆ°äº†äº†O(1)çš„æ°´å¹³ã€‚é™¤äº†å¤§è§„æ¨¡æœåŠ¡æ€§èƒ½çš„å·®è·ï¼ŒIPVSè¿˜å…·å¤‡å¤æ‚å‡è¡¡ç®—æ³•å…¨ï¼ˆè½®è¯¢ã€æœ€å°è¿æ¥æ•°ã€å“ˆå¸Œå€¼ã€æœ€å°å»¶è¿Ÿç­‰ï¼‰ã€æ”¯æŒå¥åº·æ£€æŸ¥ç­‰ä¼˜ç‚¹ã€‚\næµé‡è½¬å‘ç­–ç•¥ å¤–éƒ¨æµé‡ å¯ä»¥é€šè¿‡è®¾ç½®spec.externalTrafficPolicyå­—æ®µæ¥æ§åˆ¶æ¥è‡ªäºå¤–éƒ¨çš„æµé‡æ˜¯å¦‚ä½•è·¯ç”±çš„ã€‚å¯é€‰å€¼æœ‰Clusterå’ŒLocalã€‚å­—æ®µè®¾ä¸ºClusterä¼šå°†å¤–éƒ¨æµé‡è·¯ç”±åˆ°æ‰€æœ‰å°±ç»ªçš„Endpointï¼Œè®¾ä¸ºLocalåªä¼šè·¯ç”±åˆ°å½“å‰èŠ‚ç‚¹ä¸Šå°±ç»ªçš„Endpointã€‚å¦‚æœæµé‡ç­–ç•¥è®¾ç½®ä¸ºLocalï¼Œè€Œå½“å‰èŠ‚ç‚¹ä¸Šæ²¡æœ‰å°±ç»ªçš„Endpointï¼Œkube-proxyä¸ä¼šè½¬å‘è¯·æ±‚ç›¸å…³æœåŠ¡çš„ä»»ä½•æµé‡ã€‚\nå†…éƒ¨æµé‡ å¯ä»¥é€šè¿‡è®¾ç½®spec.internalTrafficPolicyå­—æ®µæ¥æ§åˆ¶å†…éƒ¨æ¥æºçš„æµé‡æ˜¯å¦‚ä½•è½¬å‘çš„ã€‚å¯è®¾ç½®çš„å€¼æœ‰Clusterå’ŒLocalã€‚å°†å­—æ®µè®¾ç½®ä¸ºClusterä¼šå°†å†…éƒ¨æµé‡è·¯ç”±åˆ°æ‰€æœ‰å°±ç»ªEndpointï¼Œè®¾ç½®ä¸ºLocalåªä¼šè·¯ç”±åˆ°å½“å‰èŠ‚ç‚¹ä¸Šå°±ç»ªçš„Endpointã€‚å¦‚æœæµé‡ç­–ç•¥æ˜¯Localï¼Œè€Œå½“å‰èŠ‚ç‚¹ä¸Šæ²¡æœ‰å°±ç»ªçš„Endpointï¼Œé‚£ä¹ˆ kube-proxy ä¼šä¸¢å¼ƒæµé‡ã€‚\næœåŠ¡å‘ç° Kubernetes æ”¯æŒä¸¤ç§åŸºæœ¬çš„æœåŠ¡å‘ç°æ¨¡å¼ â€”â€” ç¯å¢ƒå˜é‡å’Œ DNSã€‚\nç¯å¢ƒå˜é‡: Podåˆ›å»ºçš„æ—¶å€™ï¼ŒæœåŠ¡çš„ipå’Œportç­‰ä¿¡æ¯ä¼šä»¥ç¯å¢ƒå˜é‡çš„å½¢å¼æ³¨å…¥åˆ°podé‡Œ DNS: Serviceåˆ›å»ºæˆåŠŸåï¼Œä¼šåœ¨dnsæœåŠ¡å™¨é‡Œå¯¼å…¥ä¸€äº›è®°å½•ï¼Œæƒ³è¦è®¿é—®æŸä¸ªæœåŠ¡ï¼Œé€šè¿‡dnsæœåŠ¡å™¨è§£æå‡ºå¯¹åº”çš„ipå’Œportï¼Œä»è€Œå®ç°æœåŠ¡è®¿é—® åŸºäºç¯å¢ƒå˜é‡æœåŠ¡å‘ç° å½“ Pod è¿è¡Œåœ¨ Node ä¸Šï¼Œkubelet ä¼šä¸ºæ¯ä¸ªæ´»è·ƒçš„ Service æ·»åŠ ä¸€ç»„ç¯å¢ƒå˜é‡ã€‚ æ”¯æŒ {SVCNAME}_SERVICE_HOST å’Œ {SVCNAME}_SERVICE_PORT ç­‰å˜é‡ã€‚è¿™é‡Œ Service çš„åç§°éœ€å¤§å†™ï¼Œæ¨ªçº¿è¢«è½¬æ¢æˆä¸‹åˆ’çº¿ã€‚\nä¾‹å¦‚æœ‰ä¸€ä¸ªåç§°ä¸º nginx-service çš„ Service æš´éœ²äº† TCP ç«¯å£8180ï¼ŒåŒæ—¶ç»™å®ƒåˆ†é…äº†Cluster IPåœ°å€ 10.96.0.11ï¼Œè¿™ä¸ª Service ç”Ÿæˆäº†å¦‚ä¸‹ç¯å¢ƒå˜é‡ï¼š\nNGINX_SERVICE_SERVICE_HOST=10.96.0.11 NGINX_SERVICE_PORT_8180_TCP_ADDR=10.96.0.11 KUBERNETES_PORT_443_TCP_PROTO=tcp NGINX_SERVICE_PORT_8180_TCP_PORT=8180 NGINX_SERVICE_PORT_8180_TCP_PROTO=tcp NGINX_SERVICE_SERVICE_PORT=8180 NGINX_SERVICE_PORT=tcp://10.96.0.11:8180 NGINX_SERVICE_PORT_8180_TCP=tcp://10.96.0.11:8180 # å®ä¾‹ [root@k8s-master01 ~]# mkdir network [root@k8s-master01 ~]# cd network/ [root@k8s-master01 network]# vim nginx-deploy.yaml apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deploy labels: app: nginx spec: replicas: 2 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.18.0 ports: - containerPort: 80 # é…ç½®Service [root@k8s-master01 network]# vim nginx-service.yaml apiVersion: v1 kind: Service metadata: name: nginx-service labels: name: nginx-service spec: ports: - port: 8180 targetPort: 80 selector: app: nginx [root@k8s-master01 network]# kubectl apply -f nginx-deploy.yaml deployment.apps/nginx-deploy created [root@k8s-master01 network]# kubectl apply -f nginx-service.yaml service/nginx-service created [root@k8s-master01 network]# kubectl get deployments.apps,svc NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deploy 2/2 2 2 40s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/nginx-service ClusterIP 10.105.254.62 8180/TCP 33s [root@k8s-master01 network]# kubectl get po NAME READY STATUS RESTARTS AGE busybox 1/1 Running 3 (38m ago) 4h46m look-svc-env 0/1 Completed 0 18s [root@k8s-master01 network]# vim look-svc-env.yaml apiVersion: v1 kind: Pod metadata: name: look-svc-env spec: containers: - name: look-svc-env image: busybox command: [\"/bin/sh\", \"-c\", \"env\"] [root@k8s-master01 network]# kubectl apply -f look-svc-env.yaml pod/look-svc-env created # å¯ä»¥æŸ¥çœ‹åˆ°nginx-serviceç¯å¢ƒå˜é‡å·²ç»å†™å…¥ [root@k8s-master01 network]# kubectl logs look-svc-env KUBERNETES_PORT=tcp://10.96.0.1:443 KUBERNETES_SERVICE_PORT=443 HOSTNAME=look-svc-env SHLVL=1 HOME=/root KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin NGINX_SERVICE_SERVICE_HOST=10.105.254.62 KUBERNETES_PORT_443_TCP_PORT=443 NGINX_SERVICE_PORT_8180_TCP_ADDR=10.105.254.62 KUBERNETES_PORT_443_TCP_PROTO=tcp NGINX_SERVICE_PORT_8180_TCP_PORT=8180 NGINX_SERVICE_PORT_8180_TCP_PROTO=tcp NGINX_SERVICE_PORT=tcp://10.105.254.62:8180 NGINX_SERVICE_SERVICE_PORT=8180 KUBERNETES_SERVICE_PORT_HTTPS=443 KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443 KUBERNETES_SERVICE_HOST=10.96.0.1 PWD=/ NGINX_SERVICE_PORT_8180_TCP=tcp://10.105.254.62:8180 # nginx-serviceåœæ‰åï¼Œnginx-serviceç›¸å…³çš„ç¯å¢ƒå˜é‡æ¶ˆå¤± åŸºäºDNSæœåŠ¡å‘ç° æ”¯æŒé›†ç¾¤çš„ DNS æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ CoreDNSï¼‰ç›‘è§† Kubernetes API ä¸­çš„Serviceï¼Œå¹¶ä¸ºæ¯ä¸ªServiceåˆ›å»ºä¸€ç»„ DNS è®°å½•ã€‚å¦‚æœåœ¨æ•´ä¸ªé›†ç¾¤ä¸­éƒ½å¯ç”¨äº†DNSï¼Œåˆ™æ‰€æœ‰ Pod éƒ½åº”è¯¥èƒ½å¤Ÿé€šè¿‡å…¶ DNS åç§°è‡ªåŠ¨è§£ææœåŠ¡ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨ Kubernetes å‘½åç©ºé—´my-nsä¸­æœ‰ä¸€ä¸ªåä¸ºmy-serviceçš„Serviceï¼Œåˆ™æ§åˆ¶èŠ‚ç‚¹å’ŒDNSæœåŠ¡å…±åŒä¸ºmy-service.my-nsåˆ›å»ºDNSè®°å½•ã€‚my-nså‘½åç©ºé—´ä¸­çš„Podå¯ä»¥ç›´æ¥ç”¨åç§°my-serviceæ¥æ‰¾åˆ°æœåŠ¡ï¼ˆå½“ç„¶ä½¿ç”¨my-service.my-nsä¹Ÿå¯ä»¥ï¼‰ã€‚\nKubernetes ä» v1.11 å¼€å§‹å¯ä»¥ä½¿ç”¨ CoreDNS æ¥æä¾›å‘½åæœåŠ¡ï¼Œå¹¶ä» v1.13 å¼€å§‹æˆä¸ºé»˜è®¤ DNS æœåŠ¡ã€‚CoreDNS çš„ç‰¹ç‚¹æ˜¯æ•ˆç‡æ›´é«˜ï¼Œèµ„æºå ç”¨ç‡æ›´å°ï¼Œæ¨èä½¿ç”¨ CoreDNS æ›¿ä»£ kube-dns ä¸ºé›†ç¾¤æä¾› DNS æœåŠ¡ã€‚CoreDNSåŸºæœ¬æ¶æ„å¦‚ä¸‹:\nå¦‚æœéœ€è¦å®šåˆ¶DNSæœåŠ¡,å¯å‚è€ƒä¸‹é¢å®˜æ–¹ç»™çš„æ–¹æ¡ˆ:https://kubernetes.io/zh/docs/tasks/administer-cluster/dns-custom-nameservers/\nPod DNS DNSç­–ç•¥å¯ä»¥é€ä¸ªPodæ¥è®¾å®šã€‚ç›®å‰ Kubernetes æ”¯æŒä»¥ä¸‹ç‰¹å®š Pod çš„ DNS ç­–ç•¥ã€‚è¿™äº›ç­–ç•¥å¯ä»¥åœ¨Podçš„spec.dnsPolicyå­—æ®µè®¾ç½®ï¼š\nâ€œDefaultâ€: Pod ä»è¿è¡Œæ‰€åœ¨çš„èŠ‚ç‚¹ç»§æ‰¿åç§°è§£æé…ç½® â€œClusterFirstâ€: ä¸é…ç½®çš„é›†ç¾¤åŸŸåç¼€ä¸åŒ¹é…çš„ä»»ä½• DNS æŸ¥è¯¢ï¼ˆä¾‹å¦‚ â€œwww.kubernetes.ioâ€ï¼‰ éƒ½å°†è½¬å‘åˆ°ä»èŠ‚ç‚¹ç»§æ‰¿çš„ä¸Šæ¸¸åç§°æœåŠ¡å™¨ã€‚é›†ç¾¤ç®¡ç†å‘˜å¯èƒ½é…ç½®äº†é¢å¤–çš„å­˜æ ¹åŸŸå’Œä¸Šæ¸¸ DNS æœåŠ¡å™¨ â€œClusterFirstWithHostNetâ€ï¼šå¯¹äºä»¥ hostNetwork æ–¹å¼è¿è¡Œçš„ Podï¼Œåº”æ˜¾å¼è®¾ç½®å…¶ DNS ç­–ç•¥ â€œClusterFirstWithHostNetâ€ â€œNoneâ€: æ­¤è®¾ç½®å…è®¸ Pod å¿½ç•¥ Kubernetes ç¯å¢ƒä¸­çš„ DNS è®¾ç½®ã€‚Pod ä¼šä½¿ç”¨å…¶dnsConfigå­—æ®µæ‰€æä¾›çš„ DNS è®¾ç½® è¯´æ˜ï¼š â€œDefaultâ€ ä¸æ˜¯é»˜è®¤çš„ DNS ç­–ç•¥ã€‚å¦‚æœæœªæ˜ç¡®æŒ‡å®š dnsPolicyï¼Œåˆ™ä½¿ç”¨ â€œClusterFirstâ€ã€‚\nPod çš„ DNS é…ç½®å¯è®©ç”¨æˆ·å¯¹ Pod çš„ DNS è®¾ç½®è¿›è¡Œæ›´å¤šæ§åˆ¶ã€‚\ndnsConfig å­—æ®µæ˜¯å¯é€‰çš„ï¼Œå®ƒå¯ä»¥ä¸ä»»ä½• dnsPolicy è®¾ç½®ä¸€èµ·ä½¿ç”¨ã€‚ ä½†æ˜¯ï¼Œå½“ Pod çš„ dnsPolicy è®¾ç½®ä¸º â€œNoneâ€ æ—¶ï¼Œå¿…é¡»æŒ‡å®š dnsConfig å­—æ®µã€‚\nç”¨æˆ·å¯ä»¥åœ¨ dnsConfig å­—æ®µä¸­æŒ‡å®šä»¥ä¸‹å±æ€§ï¼š\nnameserversï¼šå°†ç”¨ä½œäº Pod çš„ DNS æœåŠ¡å™¨çš„ IP åœ°å€åˆ—è¡¨ã€‚ æœ€å¤šå¯ä»¥æŒ‡å®š 3 ä¸ª IP åœ°å€ã€‚å½“ Pod çš„ dnsPolicy è®¾ç½®ä¸º â€œNoneâ€ æ—¶ï¼Œ åˆ—è¡¨å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ª IP åœ°å€ï¼Œå¦åˆ™æ­¤å±æ€§æ˜¯å¯é€‰çš„ searchesï¼šç”¨äºåœ¨ Pod ä¸­æŸ¥æ‰¾ä¸»æœºåçš„ DNS æœç´¢åŸŸçš„åˆ—è¡¨ã€‚æ­¤å±æ€§æ˜¯å¯é€‰çš„, Kubernetes æœ€å¤šå…è®¸ 6 ä¸ªæœç´¢åŸŸ optionsï¼šå¯é€‰çš„å¯¹è±¡åˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªå¯¹è±¡å¯èƒ½å…·æœ‰ name å±æ€§ï¼ˆå¿…éœ€ï¼‰å’Œ value å±æ€§ï¼ˆå¯é€‰ï¼‰ # åˆ›å»ºè‡ªå®šä¹‰DNSçš„Pod [root@k8s-master01 network]# vim pod_dns.yaml apiVersion: v1 kind: Pod metadata: name: nginx labels: app: nginx spec: containers: - name: nginx image: nginx:1.18.0 ports: - containerPort: 80 dnsPolicy: \"None\" dnsConfig: nameservers: - 8.8.8.8 searches: - default.svc.cluster-domain.example - cluster-domain.example options: - name: pod_num value: \"1\" [root@k8s-master01 network]# kubectl apply -f pod_dns.yaml pod/nginx created # æŸ¥çœ‹DNSä¿¡æ¯ [root@k8s-master01 network]# kubectl exec nginx -- cat /etc/resolv.conf nameserver 8.8.8.8 search default.svc.cluster-domain.example cluster-domain.example options pod_num:1 # Podè®¿é—®éªŒè¯ # åˆ›å»ºServiceæ¥æš´éœ²Pod [root@k8s-master01 network]# cat nginx-service.yaml apiVersion: v1 kind: Service metadata: name: nginx-service labels: name: nginx-service spec: ports: - port: 8180 targetPort: 80 selector: app: nginx [root@k8s-master01 network]# kubectl apply -f nginx-service.yaml service/nginx-service created [root@k8s-master01 network]# kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx-service ClusterIP 10.97.188.44 8180/TCP 75s [root@k8s-master01 network]# kubectl exec busybox -- nslookup 10.97.188.44 Server: 10.96.0.10 Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local Name: 10.97.188.44 Address 1: 10.97.188.44 nginx-service.default.svc.cluster.local [root@k8s-master01 network]# kubectl exec busybox -- wget -q -O- nginx-service.default.svc.cluster.local:8180 \u003c!DOCTYPE html\u003e Welcome to nginx! Welcome to nginx! If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\nFor online documentation and support please refer to ",
  "wordCount" : "6047",
  "inLanguage": "en",
  "image":"https://deemoprobe.github.io/img/kubernetes.png","datePublished": "2023-04-30T02:26:47+08:00",
  "dateModified": "2023-04-30T02:26:47+08:00",
  "author":[{
    "@type": "Person",
    "name": "deemoprobe"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesservicediscovery/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "William's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://deemoprobe.github.io/img/bear.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://deemoprobe.github.io/" accesskey="h" title="William&#39;s Blog (Alt + H)">
            <img src="https://deemoprobe.github.io/img/bear.gif" alt="logo" aria-label="logo"
                 height="35">William&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://deemoprobe.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tags" title="ğŸ¨ æ ‡ç­¾">
                <span>ğŸ¨ æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/archives/" title="ğŸ“ˆ å½’æ¡£">
                <span>ğŸ“ˆ å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tools" title="ğŸª å·¥å…·">
                <span>ğŸª å·¥å…·</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            
            <h1 class="post-title">
                KubernetesServiceDiscovery
            </h1>
            <div class="post-description">
                Kubernetes Serviceå’ŒæœåŠ¡å‘ç°
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-04-30
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>6047å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>13åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>deemoprobe
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://deemoprobe.github.io/tags/kubernetes/" style="color: var(--secondary)!important;">kubernetes</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="https://deemoprobe.github.io/img/kubernetes.png" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%ae%9a%e4%b9%89" aria-label="å®šä¹‰">å®šä¹‰</a></li>
                <li>
                    <a href="#headless-service" aria-label="Headless Service">Headless Service</a></li>
                <li>
                    <a href="#service%e5%8f%91%e5%b8%83%e7%b1%bb%e5%9e%8b" aria-label="Serviceå‘å¸ƒç±»å‹">Serviceå‘å¸ƒç±»å‹</a></li>
                <li>
                    <a href="#%e5%a4%96%e9%83%a8ip" aria-label="å¤–éƒ¨IP">å¤–éƒ¨IP</a></li>
                <li>
                    <a href="#service%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" aria-label="Serviceä»£ç†æ¨¡å¼">Serviceä»£ç†æ¨¡å¼</a><ul>
                        
                <li>
                    <a href="#iptables%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" aria-label="iptablesä»£ç†æ¨¡å¼">iptablesä»£ç†æ¨¡å¼</a></li>
                <li>
                    <a href="#ipvs%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" aria-label="IPVSä»£ç†æ¨¡å¼">IPVSä»£ç†æ¨¡å¼</a></li>
                <li>
                    <a href="#%e9%80%89%e6%8b%a9%e5%90%88%e9%80%82%e7%9a%84%e6%a8%a1%e5%bc%8f" aria-label="é€‰æ‹©åˆé€‚çš„æ¨¡å¼">é€‰æ‹©åˆé€‚çš„æ¨¡å¼</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%b5%81%e9%87%8f%e8%bd%ac%e5%8f%91%e7%ad%96%e7%95%a5" aria-label="æµé‡è½¬å‘ç­–ç•¥">æµé‡è½¬å‘ç­–ç•¥</a><ul>
                        
                <li>
                    <a href="#%e5%a4%96%e9%83%a8%e6%b5%81%e9%87%8f" aria-label="å¤–éƒ¨æµé‡">å¤–éƒ¨æµé‡</a></li>
                <li>
                    <a href="#%e5%86%85%e9%83%a8%e6%b5%81%e9%87%8f" aria-label="å†…éƒ¨æµé‡">å†…éƒ¨æµé‡</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0" aria-label="æœåŠ¡å‘ç°">æœåŠ¡å‘ç°</a><ul>
                        
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0" aria-label="åŸºäºç¯å¢ƒå˜é‡æœåŠ¡å‘ç°">åŸºäºç¯å¢ƒå˜é‡æœåŠ¡å‘ç°</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8edns%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0" aria-label="åŸºäºDNSæœåŠ¡å‘ç°">åŸºäºDNSæœåŠ¡å‘ç°</a><ul>
                        
                <li>
                    <a href="#pod-dns" aria-label="Pod DNS">Pod DNS</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><p>Serviceæ˜¯ä¸€ç§Podçš„æœåŠ¡æš´éœ²æœºåˆ¶ï¼Œå…¶ä»–Podå¯ä»¥é€šè¿‡è¿™ä¸ªServiceè®¿é—®åˆ°è¿™ä¸ªServiceä»£ç†çš„ä¸€ä¸ªæˆ–ä¸€ç»„Podã€‚</p>
<p>å¸¦æœ‰selectorçš„Serviceåœ¨åˆ›å»ºåä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªåŒåçš„Endpointså®ä¾‹ï¼ŒEndpointså®ä¾‹è®°å½•äº†selectoråŒ¹é…çš„Podçš„IPåœ°å€å’Œç«¯å£ã€‚å½“Podè¢«é‡å»ºåï¼ŒEndpointsä¼šè¢«æ›´æ–°ï¼Œè€Œæˆ‘ä»¬ä½¿ç”¨Serviceåç§°è¿æ¥åç«¯Podï¼ŒIPå˜åŠ¨ä¸ä¼šå¯¹æœåŠ¡é€ æˆå½±å“ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># é›†ç¾¤åˆå§‹åŒ–åçš„Serviceå’ŒEndpoint</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc | grep kubernetes</span>
</span></span><span style="display:flex;"><span>kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   8d
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 yamls<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get ep | grep kubernetes</span>
</span></span><span style="display:flex;"><span>kubernetes   192.168.43.201:6443,192.168.43.202:6443,192.168.43.203:6443   8d
</span></span></code></pre></div><h2 id="å®šä¹‰">å®šä¹‰<a hidden class="anchor" aria-hidden="true" href="#å®šä¹‰">#</a></h2>
<p>å‡è®¾å­˜åœ¨ä¸€ä¸ªæˆ–ä¸€ç»„æ‰“æœ‰&quot;app=myapp&quot;æ ‡ç­¾çš„podï¼ŒPodå¯¹å¤–æš´éœ²çš„ç«¯å£æ˜¯8001ï¼Œé‚£ä¹ˆå¯ä»¥åˆ›å»ºServiceå»ä»£ç†è¿™äº›Pod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å•ä¸ªç«¯å£ä»£ç†ç¤ºä¾‹</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: my-service
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: myapp         <span style="color:#75715e"># é€‰æ‹©å¸¦æœ‰è¯¥æ ‡ç­¾çš„Pod</span>
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - protocol: TCP    <span style="color:#75715e"># UDP TCP SCTP default: TCP</span>
</span></span><span style="display:flex;"><span>      port: <span style="color:#ae81ff">8080</span>       <span style="color:#75715e"># Serviceè‡ªå·±çš„ç«¯å£</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#ae81ff">8001</span> <span style="color:#75715e"># åç«¯åº”ç”¨Podæš´éœ²çš„ç«¯å£</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># name: http     # Serviceç«¯å£çš„åç§°</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¤šä¸ªç«¯å£ä»£ç†ç¤ºä¾‹</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: my-service
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: myapp
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - name: http
</span></span><span style="display:flex;"><span>      protocol: TCP
</span></span><span style="display:flex;"><span>      port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span>    - name: https
</span></span><span style="display:flex;"><span>      protocol: TCP
</span></span><span style="display:flex;"><span>      port: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ— selectorçš„Service</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: my-service
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - protocol: TCP
</span></span><span style="display:flex;"><span>	  port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>	  targetPort: <span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”±äºæ²¡æœ‰selectorï¼Œè¯¥Serviceåˆ›å»ºåä¸ä¼šè‡ªåŠ¨åˆ›å»ºEndpointså®ä¾‹ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»º</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Endpoints
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: my-service
</span></span><span style="display:flex;"><span>  subnets:
</span></span><span style="display:flex;"><span>    - addresses:
</span></span><span style="display:flex;"><span>	    - ip: 1.2.3.4
</span></span><span style="display:flex;"><span>	  ports:
</span></span><span style="display:flex;"><span>	    - port: <span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ExternalName Serviceï¼Œæ²¡æœ‰selectoræ²¡æœ‰Endpointsï¼Œä»…ä½¿ç”¨åˆ«åè§£æService</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata: 
</span></span><span style="display:flex;"><span>  name: my-service
</span></span><span style="display:flex;"><span>  namespace: dev
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  type: ExternalName
</span></span><span style="display:flex;"><span>  externalName: my.nginx.example.com
</span></span></code></pre></div><blockquote>
<p>è¯´æ˜ï¼šService èƒ½å¤Ÿå°†ä¸€ä¸ªæ¥æ”¶ port æ˜ å°„åˆ°ä»»æ„çš„ targetPortã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒtargetPort å°†è¢«è®¾ç½®ä¸ºä¸ port å­—æ®µç›¸åŒçš„å€¼ã€‚</p>
</blockquote>
<h2 id="headless-service">Headless Service<a hidden class="anchor" aria-hidden="true" href="#headless-service">#</a></h2>
<p>æœ‰æ—¶ä¸éœ€è¦æˆ–ä¸æƒ³è¦è´Ÿè½½å‡è¡¡ï¼Œä»¥åŠå•ç‹¬çš„ Service IPã€‚å¯ä»¥é€šè¿‡æŒ‡å®šspecä¸‹é¢çš„<code>clusterIP: None</code>æ¥åˆ›å»º Headless Serviceã€‚</p>
<p>æ— å¤´æœåŠ¡å¹¶ä¸ä¼šåˆ†é… Cluster IPï¼Œkube-proxy ä¸ä¼šå¤„ç†å®ƒä»¬ï¼Œè€Œä¸”å¹³å°ä¹Ÿä¸ä¼šä¸ºå®ƒä»¬è¿›è¡Œè´Ÿè½½å‡è¡¡å’Œè·¯ç”±ã€‚DNSå¦‚ä½•å®ç°è‡ªåŠ¨é…ç½®ï¼Œä¾èµ–äº Service æ˜¯å¦å®šä¹‰äº†<code>selector</code>ã€‚</p>
<p>å¯¹äºå®šä¹‰äº†<code>selector</code>çš„æ— å¤´æœåŠ¡ï¼ŒEndpoint æ§åˆ¶å™¨åœ¨ API ä¸­åˆ›å»ºäº† Endpoints è®°å½•ï¼Œå¹¶ä¸”ä¿®æ”¹ DNS é…ç½®è¿”å› A è®°å½•ï¼ˆIP åœ°å€ï¼‰ï¼Œé€šè¿‡è¿™ä¸ªåœ°å€ç›´æ¥åˆ°è¾¾ Service çš„åç«¯ Pod ä¸Šã€‚</p>
<p>å¯¹äºæ²¡æœ‰å®šä¹‰<code>selector</code>çš„æ— å¤´æœåŠ¡ï¼ŒEndpoint æ§åˆ¶å™¨ä¸ä¼šåˆ›å»º Endpoints è®°å½•ã€‚DNSç³»ç»Ÿä¼šæŸ¥æ‰¾å’Œé…ç½®ï¼š</p>
<ul>
<li>å¯¹äº ExternalName ç±»å‹çš„æœåŠ¡ï¼ŒæŸ¥æ‰¾å…¶ CNAME è®°å½•</li>
<li>å¯¹æ‰€æœ‰å…¶ä»–ç±»å‹çš„æœåŠ¡ï¼ŒæŸ¥æ‰¾ä¸ Service åç§°ç›¸åŒçš„ä»»ä½• Endpoints çš„è®°å½•</li>
</ul>
<h2 id="serviceå‘å¸ƒç±»å‹">Serviceå‘å¸ƒç±»å‹<a hidden class="anchor" aria-hidden="true" href="#serviceå‘å¸ƒç±»å‹">#</a></h2>
<p>Kubernetes å…è®¸æŒ‡å®šä½ æ‰€éœ€è¦çš„ Service ç±»å‹ï¼Œé»˜è®¤æ˜¯ ClusterIPï¼Œå¯ä»¥è‡ªå®šä¹‰<code>spec</code>å­—æ®µä¸‹çš„<code>type</code>å­—æ®µã€‚<code>type</code>çš„å–å€¼ä»¥åŠè¡Œä¸ºå¦‚ä¸‹ï¼š</p>
<ul>
<li><code>ClusterIP</code>ï¼šé€šè¿‡é›†ç¾¤çš„å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼Œé€‰æ‹©è¯¥å€¼æ—¶æœåŠ¡åªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚</li>
<li><code>NodePort</code>ï¼šé€šè¿‡æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ IP å’Œé™æ€ç«¯å£ï¼ˆNodePortï¼‰æš´éœ²æœåŠ¡ã€‚NodePortæœåŠ¡ä¼šè·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ClusterIPæœåŠ¡ã€‚é€šè¿‡è¯·æ±‚<code>&lt;èŠ‚ç‚¹ IP&gt;:&lt;èŠ‚ç‚¹ç«¯å£&gt;</code>ï¼ŒNodePortç«¯å£èŒƒå›´é»˜è®¤æ˜¯30000-32767ã€‚å¯ä»¥ä»é›†ç¾¤çš„å¤–éƒ¨è®¿é—®ã€‚</li>
<li><code>LoadBalancer</code>ï¼šä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å¯ä»¥å°†æµé‡è·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„NodePortæœåŠ¡å’ŒClusterIPæœåŠ¡ä¸Šã€‚</li>
<li><code>ExternalName</code>ï¼šé€šè¿‡è¿”å›CNAMEï¼ˆåˆ«åï¼‰å’Œå¯¹åº”å€¼ï¼Œå¯ä»¥å°†æœåŠ¡æ˜ å°„åˆ° externalName å­—æ®µçš„å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œfoo.bar.example.comï¼‰ã€‚æ— éœ€åˆ›å»ºä»»ä½•ç±»å‹ä»£ç†ã€‚</li>
</ul>
<blockquote>
<p>è¯´æ˜ï¼škube-dns 1.7 åŠä»¥ä¸Šç‰ˆæœ¬æˆ–è€… CoreDNS 0.0.8 åŠä»¥ä¸Šç‰ˆæœ¬æ‰èƒ½ä½¿ç”¨ ExternalName ç±»å‹ã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ClusterIPç±»å‹ï¼Œtypeå¯ä»¥ä¸æŒ‡å®š</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: my-service
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: myapp
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ`targetPort` è¢«è®¾ç½®ä¸ºä¸ `port` å­—æ®µç›¸åŒçš„å€¼ã€‚</span>
</span></span><span style="display:flex;"><span>    - port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NodePortç±»å‹</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: my-service
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  type: NodePort
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: myapp
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ`targetPort` è¢«è®¾ç½®ä¸ºä¸ `port` å­—æ®µç›¸åŒçš„å€¼ã€‚</span>
</span></span><span style="display:flex;"><span>    - port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># å¯é€‰å­—æ®µï¼Œä¸æŒ‡å®šçš„è¯ä¼šè‡ªåŠ¨è®¾ç½®ä¸º30000-32767ä¸­çš„ä¸€ä¸ª</span>
</span></span><span style="display:flex;"><span>      nodePort: <span style="color:#ae81ff">30007</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># LoadBalancerç±»å‹ï¼Œstatus.loadBalancerå­—æ®µæŒ‡å®šäº‘å‚å•†æä¾›çš„è´Ÿè½½å‡è¡¡åœ°å€</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: my-service
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: MyApp
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - protocol: TCP
</span></span><span style="display:flex;"><span>      port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span>  clusterIP: 10.96.0.239
</span></span><span style="display:flex;"><span>  type: LoadBalancer
</span></span><span style="display:flex;"><span>status:
</span></span><span style="display:flex;"><span>  loadBalancer:
</span></span><span style="display:flex;"><span>    ingress:
</span></span><span style="display:flex;"><span>      - ip: 192.0.2.127
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ExternalNameç±»å‹</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¿é—®nginx-externalname.test.svc.cluster.localè¢«é‡å®šå‘åˆ°www.baidu.com</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx-externalname
</span></span><span style="display:flex;"><span>  name: nginx-externalname
</span></span><span style="display:flex;"><span>  namespace: test
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  type: ExternalName
</span></span><span style="display:flex;"><span>  externalName: www.baidu.com
</span></span></code></pre></div><h2 id="å¤–éƒ¨ip">å¤–éƒ¨IP<a hidden class="anchor" aria-hidden="true" href="#å¤–éƒ¨ip">#</a></h2>
<p>å¦‚æœå¤–éƒ¨IPè·¯ç”±åˆ°é›†ç¾¤ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªNodeä¸Šï¼ŒKubernetes Service ä¼šè¢«æš´éœ²ç»™è¿™äº›<code>externalIP</code>ã€‚é€šè¿‡å¤–éƒ¨ IPï¼ˆä½œä¸ºç›®çš„ IP åœ°å€ï¼‰è¿›å…¥åˆ°é›†ç¾¤ï¼Œæµé‡å°†ä¼šè¢«è·¯ç”±åˆ° Service çš„ Endpoint ä¸Šã€‚æ ¹æ® Service çš„è§„å®šï¼ŒexternalIPs å¯ä»¥åŒä»»æ„çš„ ServiceType æ¥ä¸€èµ·æŒ‡å®šã€‚ åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œmy-service å¯ä»¥é€šè¿‡ &ldquo;80.11.12.10:80&rdquo;(externalIP:port)è¢«å®¢æˆ·ç«¯è®¿é—®ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: my-service
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: myapp
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - name: http
</span></span><span style="display:flex;"><span>      protocol: TCP
</span></span><span style="display:flex;"><span>      port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span>  externalIPs:
</span></span><span style="display:flex;"><span>    - 80.11.12.10
</span></span></code></pre></div><h2 id="serviceä»£ç†æ¨¡å¼">Serviceä»£ç†æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#serviceä»£ç†æ¨¡å¼">#</a></h2>
<p>åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œ<code>kube-proxy</code>è´Ÿè´£ä¸ºServiceå®ç°äº†ä¸€ç§VIPå½¢å¼çš„ä»£ç†ï¼Œè€Œä¸æ˜¯<code>ExternalName</code>çš„å½¢å¼ã€‚è¿™ç§VIPå½¢å¼çš„ä»£ç†ä¸»è¦æœ‰ä¸‹é¢ä¸¤ç§å®ç°æ–¹å¼ï¼Œç°åœ¨kubernetesæ¨èä½¿ç”¨ipvs</p>
<h3 id="iptablesä»£ç†æ¨¡å¼">iptablesä»£ç†æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#iptablesä»£ç†æ¨¡å¼">#</a></h3>
<p>åœ¨iptablesæ¨¡å¼ä¸­ï¼Œkube-proxy ç›‘è§† Kubernetesçš„Serviceå’ŒEndpointsçš„çŠ¶æ€å˜åŒ–ï¼ˆåˆ›å»ºæˆ–åˆ é™¤ï¼‰ï¼Œå¯¹æ¯ä¸ª Serviceå®ƒéƒ½ä¼šåˆ›å»º<code>iptables</code>è§„åˆ™ï¼Œä»è€Œæ•è·åˆ°è¾¾è¯¥ Service çš„<code>ClusterIP</code>å’Œç«¯å£çš„è¯·æ±‚ï¼Œè¿›è€Œå°†è¯·æ±‚é‡å®šå‘åˆ° Service åç«¯ä¸­çš„æŸä¸ª Pod ä¸Šé¢ã€‚ å¯¹äºæ¯ä¸ª Endpoints å¯¹è±¡ï¼Œå®ƒä¹Ÿä¼šåˆ›å»º<code>iptables</code>è§„åˆ™ï¼Œè¿™ä¸ªè§„åˆ™ä¼šé€‰æ‹©ä¸€ä¸ªåç«¯podã€‚</p>
<p>é»˜è®¤çš„ç­–ç•¥æ˜¯ï¼Œkube-proxy åœ¨ iptables æ¨¡å¼ä¸‹éšæœºé€‰æ‹©ä¸€ä¸ªåç«¯ã€‚å¦‚æœè¦ç¡®ä¿æ¯æ¬¡éƒ½å°†æ¥è‡ªç‰¹å®šå®¢æˆ·ç«¯çš„è¿æ¥ä¼ é€’åˆ°åŒä¸€Podï¼ˆå³ä¼šè¯ä¿æŒï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡è®¾ç½®äº²å’ŒåŠ›è°ƒåº¦ç­–ç•¥<code>service.spec.sessionAffinity: ClientIP</code>ï¼ˆé»˜è®¤å€¼æ˜¯ <code>None</code>ï¼‰ï¼Œæ¥åŸºäºå®¢æˆ·ç«¯çš„ IP åœ°å€é€‰æ‹©ä¼šè¯å…³è”ã€‚è¿˜å¯ä»¥é€šè¿‡è®¾ç½®<code>service.spec.sessionAffinityConfig.clientIP.timeoutSeconds</code>æ¥é…ç½®æœ€å¤§ä¼šè¯åœç•™æ—¶é—´ã€‚ï¼ˆé»˜è®¤å€¼ä¸º 10800 ç§’ï¼Œå³ 3 å°æ—¶ï¼‰</p>
<h3 id="ipvsä»£ç†æ¨¡å¼">IPVSä»£ç†æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#ipvsä»£ç†æ¨¡å¼">#</a></h3>
<p>åœ¨ipvsæ¨¡å¼ä¸­ï¼Œkube-proxy ç›‘è§† Kubernetesçš„Serviceå’ŒEndpointsçš„çŠ¶æ€å˜åŒ–ï¼ˆåˆ›å»ºæˆ–åˆ é™¤ï¼‰ï¼Œè°ƒç”¨<code>netlink</code>æ¥å£åˆ›å»º IPVS è§„åˆ™ï¼Œå¹¶å®šæœŸå°†è§„åˆ™ä¸Kubernetesçš„Serviceå’ŒEndpointsåŒæ­¥ã€‚ç¡®ä¿IPVSçŠ¶æ€ä¸æ‰€éœ€çŠ¶æ€åŒ¹é…ã€‚è®¿é—®æœåŠ¡æ—¶ï¼ŒIPVSæ ¹æ®è§„åˆ™å°†æµé‡å®šå‘åˆ°åç«¯Podä¹‹ä¸€</p>
<p>ç±»ä¼¼iptablesï¼ŒIPVSåŸºäº<code>netfilter</code>é’©å­å‡½æ•°ï¼Œä½†æ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåŸºç¡€æ•°æ®ç»“æ„ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­å·¥ä½œï¼Œå†…æ ¸çº§çš„è½¬å‘ï¼Œæ‰€ä»¥é€Ÿåº¦å¾ˆå¿«ã€‚</p>
<p>IPVS æä¾›ä»¥ä¸‹é€‰é¡¹æ¥å®ç°è´Ÿè½½å‡è¡¡ï¼š</p>
<ul>
<li><code>rr</code>ï¼šè½®è¯¢ï¼ˆRound-Robinï¼‰</li>
<li><code>lc</code>ï¼šæœ€å°‘é“¾æ¥ï¼ˆLeast Connectionï¼‰ï¼Œå³æ‰“å¼€é“¾æ¥æ•°é‡æœ€å°‘è€…ä¼˜å…ˆ</li>
<li><code>dh</code>ï¼šç›®æ ‡åœ°å€å“ˆå¸Œï¼ˆDestination Hashingï¼‰</li>
<li><code>sh</code>ï¼šæºåœ°å€å“ˆå¸Œï¼ˆSource Hashingï¼‰</li>
<li><code>sed</code>ï¼šæœ€çŸ­é¢„æœŸå»¶è¿Ÿï¼ˆShortest Expected Delayï¼‰</li>
<li><code>nq</code>ï¼šä»ä¸æ’é˜Ÿï¼ˆNever Queueï¼‰</li>
</ul>
<blockquote>
<p>è¯´æ˜ï¼šè¦åœ¨ IPVS æ¨¡å¼ä¸‹è¿è¡Œ kube-proxyï¼Œå¿…é¡»åœ¨å¯åŠ¨ kube-proxy ä¹‹å‰ä½¿ IPVS åœ¨èŠ‚ç‚¹ä¸Šå¯ç”¨ï¼ˆå¯ç”¨IPVSå¯ä»¥å‚è€ƒ<a href="https://deemoprobe.github.io/posts/tech/kubernetesbinaryinstallation-ha/#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9call"  target="_blank" rel="noopener" style="color:#42b983" ;>é«˜å¯ç”¨é›†ç¾¤å®‰è£…æ–‡æ¡£</a> å½“kube-proxy ä»¥ IPVS ä»£ç†æ¨¡å¼å¯åŠ¨æ—¶ï¼Œå®ƒå°†éªŒè¯ IPVS å†…æ ¸æ¨¡å—æ˜¯å¦å¯ç”¨ã€‚ å¦‚æœæœªæ£€æµ‹åˆ° IPVS å†…æ ¸æ¨¡å—ï¼Œåˆ™ kube-proxy å°†é€€å›åˆ°ä»¥ iptables ä»£ç†æ¨¡å¼è¿è¡Œã€‚</p>
</blockquote>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20220119161939.png" alt="20220119161939"  />
</p>
<h3 id="é€‰æ‹©åˆé€‚çš„æ¨¡å¼">é€‰æ‹©åˆé€‚çš„æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#é€‰æ‹©åˆé€‚çš„æ¨¡å¼">#</a></h3>
<p>iptablesç”±äºçº¿æ€§æŸ¥æ‰¾åŒ¹é…ã€å…¨é‡æ›´æ–°ç­‰ç‰¹ç‚¹ï¼Œå½“è§„åˆ™å¾ˆå¤šæ—¶ï¼Œæ€§èƒ½ä¼šæ¯”ipvså·®ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¨èé€‰æ‹©ipvs</p>
<p><code>iptables</code>å·¥å…·åŸºäºLinuxå†…æ ¸çš„<code>Netfilter</code>æ¨¡å—ï¼Œé»˜è®¤å®šä¹‰äº†å¤šå¼ è¡¨ã€‚æ¯å¼ è¡¨é‡ŒåŒ…å«è‹¥å¹²å†…ç½®é“¾ï¼ˆchainï¼‰ï¼Œä¹Ÿå¯èƒ½åŒ…å«ç”¨æˆ·è‡ªå®šä¹‰çš„é“¾ã€‚æ¯æ¡é“¾æ˜¯ä¸€å¥—è§„åˆ™ï¼ˆruleï¼‰åˆ—è¡¨ï¼Œç”¨äºåŒ¹é…ä¸€ç»„æ•°æ®åŒ…ã€‚æ¯æ¡è§„åˆ™éƒ½æŒ‡å®šå¦‚ä½•å¤„ç†åŒ¹é…çš„æ•°æ®åŒ…ã€‚</p>
<ul>
<li>
<p>tableï¼šåŒ…å«ä¸€ç»„chainçš„è¡¨</p>
</li>
<li>
<p>chainï¼šåŒ…å«ä¸€ç»„ruleçš„é“¾</p>
</li>
<li>
<p>ruleï¼šåŒ¹é…æ•°æ®åŒ…çš„è§„åˆ™ï¼Œä¾‹å¦‚ï¼šåè®®ï¼Œç«¯å£å·</p>
</li>
<li>
<p>targetï¼šè§„åˆ™ä¸­çš„å…·ä½“è¡Œä¸ºï¼Œä¾‹å¦‚ï¼šACCEPTï¼ŒDROPï¼ŒINPUTï¼ŒFORWARDï¼ŒOUTPUT</p>
</li>
<li>
<p>è¡¨</p>
<ul>
<li>filterï¼šé»˜è®¤è¡¨ï¼Œé€šç”¨æ•°æ®åŒ…è¿‡æ»¤è¡¨</li>
<li>mangleï¼šä¸ºç‰¹å®šçš„æ•°æ®åŒ…è®¾è®¡</li>
<li>natï¼šé’ˆå¯¹åˆ›å»ºæ–°è¿æ¥çš„æ•°æ®åŒ…</li>
<li>rawï¼šä¸»è¦ç”¨äºç»“åˆ NOTRACK target é…ç½®è¿æ¥è·Ÿè¸ªçš„è±å…</li>
<li>securityï¼šç”¨äºMACï¼ˆMandatory Access Controlï¼Œå¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼‰è§„åˆ™</li>
</ul>
</li>
<li>
<p>è§„åˆ™é“¾</p>
<ul>
<li>INPUTï¼šä»¥æœ¬æœºä¸ºç›®æ ‡çš„å…¥å£æ•°æ®åŒ…è§„åˆ™é“¾</li>
<li>OUTPUTï¼šæœ¬æœºäº§ç”Ÿï¼Œå‘å¤–è½¬å‘çš„æ•°æ®åŒ…è§„åˆ™é“¾</li>
<li>FORWARDï¼šè·¯ç”±ç»è¿‡æœ¬æœºçš„æ•°æ®åŒ…è§„åˆ™é“¾</li>
<li>PREROUTINGï¼šæ•°æ®åŒ…è¿›å…¥è·¯ç”±ä¹‹å‰çš„è§„åˆ™é“¾</li>
<li>POSTROUTINGï¼šæ•°æ®åŒ…å‘é€åˆ°ç›®æ ‡å‰ï¼ˆå‡ºè·¯ç”±ï¼‰çš„è§„åˆ™é“¾</li>
</ul>
</li>
</ul>
<p>IPtableså¤„ç†é“¾æ¥çš„ç®—æ³•å¤æ‚åº¦ä¸ºO(n)ï¼ŒIPVSä¸ºO(1)ï¼ŒServiceè§„æ¨¡åœ¨1000å†…äºŒè€…å·®è·å¹¶ä¸æ˜¯å¾ˆå¤§ã€‚åœ¨Serviceè§„æ¨¡è¶…è¿‡1000åï¼ŒIPtablesè§„åˆ™é“¾è¾¾åˆ°2000ä»¥ä¸Šï¼Œæ€§èƒ½å¼€å§‹ä¸‹é™ï¼Œå“åº”æ—¶é—´æˆå€æ•°å¢åŠ ï¼ŒIPVSåˆ™å‡ ä¹ä¸å—Serviceè§„æ¨¡çš„å½±å“ã€‚Calicoè™½ç„¶ä¹Ÿé‡‡ç”¨IPtablesæŠ€æœ¯ï¼Œä½†å¯¹è§„åˆ™é“¾è¿›è¡Œäº†ä¼˜åŒ–ï¼Œç®—æ³•å¤æ‚åº¦ä¹Ÿè¾¾åˆ°äº†äº†O(1)çš„æ°´å¹³ã€‚é™¤äº†å¤§è§„æ¨¡æœåŠ¡æ€§èƒ½çš„å·®è·ï¼ŒIPVSè¿˜å…·å¤‡å¤æ‚å‡è¡¡ç®—æ³•å…¨ï¼ˆè½®è¯¢ã€æœ€å°è¿æ¥æ•°ã€å“ˆå¸Œå€¼ã€æœ€å°å»¶è¿Ÿç­‰ï¼‰ã€æ”¯æŒå¥åº·æ£€æŸ¥ç­‰ä¼˜ç‚¹ã€‚</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/IPVSvsIPtables.png" alt="IPVSvsIPtables"  />
</p>
<h2 id="æµé‡è½¬å‘ç­–ç•¥">æµé‡è½¬å‘ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#æµé‡è½¬å‘ç­–ç•¥">#</a></h2>
<h3 id="å¤–éƒ¨æµé‡">å¤–éƒ¨æµé‡<a hidden class="anchor" aria-hidden="true" href="#å¤–éƒ¨æµé‡">#</a></h3>
<p>å¯ä»¥é€šè¿‡è®¾ç½®<code>spec.externalTrafficPolicy</code>å­—æ®µæ¥æ§åˆ¶æ¥è‡ªäºå¤–éƒ¨çš„æµé‡æ˜¯å¦‚ä½•è·¯ç”±çš„ã€‚å¯é€‰å€¼æœ‰<code>Cluster</code>å’Œ<code>Local</code>ã€‚å­—æ®µè®¾ä¸º<code>Cluster</code>ä¼šå°†å¤–éƒ¨æµé‡è·¯ç”±åˆ°æ‰€æœ‰å°±ç»ªçš„Endpointï¼Œè®¾ä¸º<code>Local</code>åªä¼šè·¯ç”±åˆ°å½“å‰èŠ‚ç‚¹ä¸Šå°±ç»ªçš„Endpointã€‚å¦‚æœæµé‡ç­–ç•¥è®¾ç½®ä¸º<code>Local</code>ï¼Œè€Œå½“å‰èŠ‚ç‚¹ä¸Šæ²¡æœ‰å°±ç»ªçš„Endpointï¼Œkube-proxyä¸ä¼šè½¬å‘è¯·æ±‚ç›¸å…³æœåŠ¡çš„ä»»ä½•æµé‡ã€‚</p>
<h3 id="å†…éƒ¨æµé‡">å†…éƒ¨æµé‡<a hidden class="anchor" aria-hidden="true" href="#å†…éƒ¨æµé‡">#</a></h3>
<p>å¯ä»¥é€šè¿‡è®¾ç½®<code>spec.internalTrafficPolicy</code>å­—æ®µæ¥æ§åˆ¶å†…éƒ¨æ¥æºçš„æµé‡æ˜¯å¦‚ä½•è½¬å‘çš„ã€‚å¯è®¾ç½®çš„å€¼æœ‰<code>Cluster</code>å’Œ<code>Local</code>ã€‚å°†å­—æ®µè®¾ç½®ä¸º<code>Cluster</code>ä¼šå°†å†…éƒ¨æµé‡è·¯ç”±åˆ°æ‰€æœ‰å°±ç»ªEndpointï¼Œè®¾ç½®ä¸º<code>Local</code>åªä¼šè·¯ç”±åˆ°å½“å‰èŠ‚ç‚¹ä¸Šå°±ç»ªçš„Endpointã€‚å¦‚æœæµé‡ç­–ç•¥æ˜¯<code>Local</code>ï¼Œè€Œå½“å‰èŠ‚ç‚¹ä¸Šæ²¡æœ‰å°±ç»ªçš„Endpointï¼Œé‚£ä¹ˆ kube-proxy ä¼šä¸¢å¼ƒæµé‡ã€‚</p>
<h2 id="æœåŠ¡å‘ç°">æœåŠ¡å‘ç°<a hidden class="anchor" aria-hidden="true" href="#æœåŠ¡å‘ç°">#</a></h2>
<p>Kubernetes æ”¯æŒä¸¤ç§åŸºæœ¬çš„æœåŠ¡å‘ç°æ¨¡å¼ â€”â€” ç¯å¢ƒå˜é‡å’Œ DNSã€‚</p>
<ul>
<li>ç¯å¢ƒå˜é‡: Podåˆ›å»ºçš„æ—¶å€™ï¼ŒæœåŠ¡çš„ipå’Œportç­‰ä¿¡æ¯ä¼šä»¥ç¯å¢ƒå˜é‡çš„å½¢å¼æ³¨å…¥åˆ°podé‡Œ</li>
<li>DNS: Serviceåˆ›å»ºæˆåŠŸåï¼Œä¼šåœ¨dnsæœåŠ¡å™¨é‡Œå¯¼å…¥ä¸€äº›è®°å½•ï¼Œæƒ³è¦è®¿é—®æŸä¸ªæœåŠ¡ï¼Œé€šè¿‡dnsæœåŠ¡å™¨è§£æå‡ºå¯¹åº”çš„ipå’Œportï¼Œä»è€Œå®ç°æœåŠ¡è®¿é—®</li>
</ul>
<h3 id="åŸºäºç¯å¢ƒå˜é‡æœåŠ¡å‘ç°">åŸºäºç¯å¢ƒå˜é‡æœåŠ¡å‘ç°<a hidden class="anchor" aria-hidden="true" href="#åŸºäºç¯å¢ƒå˜é‡æœåŠ¡å‘ç°">#</a></h3>
<p>å½“ Pod è¿è¡Œåœ¨ Node ä¸Šï¼Œkubelet ä¼šä¸ºæ¯ä¸ªæ´»è·ƒçš„ Service æ·»åŠ ä¸€ç»„ç¯å¢ƒå˜é‡ã€‚ æ”¯æŒ {SVCNAME}_SERVICE_HOST å’Œ {SVCNAME}_SERVICE_PORT ç­‰å˜é‡ã€‚è¿™é‡Œ Service çš„åç§°éœ€å¤§å†™ï¼Œæ¨ªçº¿è¢«è½¬æ¢æˆä¸‹åˆ’çº¿ã€‚</p>
<p>ä¾‹å¦‚æœ‰ä¸€ä¸ªåç§°ä¸º nginx-service çš„ Service æš´éœ²äº† TCP ç«¯å£8180ï¼ŒåŒæ—¶ç»™å®ƒåˆ†é…äº†<code>Cluster IP</code>åœ°å€ 10.96.0.11ï¼Œè¿™ä¸ª Service ç”Ÿæˆäº†å¦‚ä¸‹ç¯å¢ƒå˜é‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NGINX_SERVICE_SERVICE_HOST<span style="color:#f92672">=</span>10.96.0.11
</span></span><span style="display:flex;"><span>NGINX_SERVICE_PORT_8180_TCP_ADDR<span style="color:#f92672">=</span>10.96.0.11
</span></span><span style="display:flex;"><span>KUBERNETES_PORT_443_TCP_PROTO<span style="color:#f92672">=</span>tcp
</span></span><span style="display:flex;"><span>NGINX_SERVICE_PORT_8180_TCP_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">8180</span>
</span></span><span style="display:flex;"><span>NGINX_SERVICE_PORT_8180_TCP_PROTO<span style="color:#f92672">=</span>tcp
</span></span><span style="display:flex;"><span>NGINX_SERVICE_SERVICE_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">8180</span>
</span></span><span style="display:flex;"><span>NGINX_SERVICE_PORT<span style="color:#f92672">=</span>tcp://10.96.0.11:8180
</span></span><span style="display:flex;"><span>NGINX_SERVICE_PORT_8180_TCP<span style="color:#f92672">=</span>tcp://10.96.0.11:8180
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å®ä¾‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># mkdir network</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cd network/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># vim nginx-deploy.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx-deploy
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: nginx
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: nginx
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: nginx
</span></span><span style="display:flex;"><span>        image: nginx:1.18.0
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é…ç½®Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># vim nginx-service.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx-service
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    name: nginx-service
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#ae81ff">8180</span>
</span></span><span style="display:flex;"><span>    targetPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: nginx
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f nginx-deploy.yaml</span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f nginx-service.yaml</span>
</span></span><span style="display:flex;"><span>service/nginx-service created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deployments.apps,svc</span>
</span></span><span style="display:flex;"><span>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/nginx-deploy   2/2     <span style="color:#ae81ff">2</span>            <span style="color:#ae81ff">2</span>           40s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>    AGE
</span></span><span style="display:flex;"><span>service/nginx-service   ClusterIP   10.105.254.62   &lt;none&gt;        8180/TCP   33s
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po</span>
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS      RESTARTS      AGE
</span></span><span style="display:flex;"><span>busybox                        1/1     Running     <span style="color:#ae81ff">3</span> <span style="color:#f92672">(</span>38m ago<span style="color:#f92672">)</span>   4h46m
</span></span><span style="display:flex;"><span>look-svc-env                   0/1     Completed   <span style="color:#ae81ff">0</span>             18s
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># vim look-svc-env.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: look-svc-env
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: look-svc-env
</span></span><span style="display:flex;"><span>    image: busybox
</span></span><span style="display:flex;"><span>    command: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;env&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f look-svc-env.yaml </span>
</span></span><span style="display:flex;"><span>pod/look-svc-env created
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥æŸ¥çœ‹åˆ°nginx-serviceç¯å¢ƒå˜é‡å·²ç»å†™å…¥</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl logs look-svc-env </span>
</span></span><span style="display:flex;"><span>KUBERNETES_PORT<span style="color:#f92672">=</span>tcp://10.96.0.1:443
</span></span><span style="display:flex;"><span>KUBERNETES_SERVICE_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>HOSTNAME<span style="color:#f92672">=</span>look-svc-env
</span></span><span style="display:flex;"><span>SHLVL<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>HOME<span style="color:#f92672">=</span>/root
</span></span><span style="display:flex;"><span>KUBERNETES_PORT_443_TCP_ADDR<span style="color:#f92672">=</span>10.96.0.1
</span></span><span style="display:flex;"><span>PATH<span style="color:#f92672">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span style="display:flex;"><span>NGINX_SERVICE_SERVICE_HOST<span style="color:#f92672">=</span>10.105.254.62
</span></span><span style="display:flex;"><span>KUBERNETES_PORT_443_TCP_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>NGINX_SERVICE_PORT_8180_TCP_ADDR<span style="color:#f92672">=</span>10.105.254.62
</span></span><span style="display:flex;"><span>KUBERNETES_PORT_443_TCP_PROTO<span style="color:#f92672">=</span>tcp
</span></span><span style="display:flex;"><span>NGINX_SERVICE_PORT_8180_TCP_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">8180</span>
</span></span><span style="display:flex;"><span>NGINX_SERVICE_PORT_8180_TCP_PROTO<span style="color:#f92672">=</span>tcp
</span></span><span style="display:flex;"><span>NGINX_SERVICE_PORT<span style="color:#f92672">=</span>tcp://10.105.254.62:8180
</span></span><span style="display:flex;"><span>NGINX_SERVICE_SERVICE_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">8180</span>
</span></span><span style="display:flex;"><span>KUBERNETES_SERVICE_PORT_HTTPS<span style="color:#f92672">=</span><span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>KUBERNETES_PORT_443_TCP<span style="color:#f92672">=</span>tcp://10.96.0.1:443
</span></span><span style="display:flex;"><span>KUBERNETES_SERVICE_HOST<span style="color:#f92672">=</span>10.96.0.1
</span></span><span style="display:flex;"><span>PWD<span style="color:#f92672">=</span>/
</span></span><span style="display:flex;"><span>NGINX_SERVICE_PORT_8180_TCP<span style="color:#f92672">=</span>tcp://10.105.254.62:8180
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx-serviceåœæ‰åï¼Œnginx-serviceç›¸å…³çš„ç¯å¢ƒå˜é‡æ¶ˆå¤±</span>
</span></span></code></pre></div><h3 id="åŸºäºdnsæœåŠ¡å‘ç°">åŸºäºDNSæœåŠ¡å‘ç°<a hidden class="anchor" aria-hidden="true" href="#åŸºäºdnsæœåŠ¡å‘ç°">#</a></h3>
<p>æ”¯æŒé›†ç¾¤çš„ DNS æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ CoreDNSï¼‰ç›‘è§† Kubernetes API ä¸­çš„Serviceï¼Œå¹¶ä¸ºæ¯ä¸ªServiceåˆ›å»ºä¸€ç»„ DNS è®°å½•ã€‚å¦‚æœåœ¨æ•´ä¸ªé›†ç¾¤ä¸­éƒ½å¯ç”¨äº†DNSï¼Œåˆ™æ‰€æœ‰ Pod éƒ½åº”è¯¥èƒ½å¤Ÿé€šè¿‡å…¶ DNS åç§°è‡ªåŠ¨è§£ææœåŠ¡ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨ Kubernetes å‘½åç©ºé—´<code>my-ns</code>ä¸­æœ‰ä¸€ä¸ªåä¸º<code>my-service</code>çš„Serviceï¼Œåˆ™æ§åˆ¶èŠ‚ç‚¹å’ŒDNSæœåŠ¡å…±åŒä¸º<code>my-service.my-ns</code>åˆ›å»ºDNSè®°å½•ã€‚<code>my-ns</code>å‘½åç©ºé—´ä¸­çš„Podå¯ä»¥ç›´æ¥ç”¨åç§°<code>my-service</code>æ¥æ‰¾åˆ°æœåŠ¡ï¼ˆå½“ç„¶ä½¿ç”¨<code>my-service.my-ns</code>ä¹Ÿå¯ä»¥ï¼‰ã€‚</p>
<p>Kubernetes ä» v1.11 å¼€å§‹å¯ä»¥ä½¿ç”¨ CoreDNS æ¥æä¾›å‘½åæœåŠ¡ï¼Œå¹¶ä» v1.13 å¼€å§‹æˆä¸ºé»˜è®¤ DNS æœåŠ¡ã€‚CoreDNS çš„ç‰¹ç‚¹æ˜¯æ•ˆç‡æ›´é«˜ï¼Œèµ„æºå ç”¨ç‡æ›´å°ï¼Œæ¨èä½¿ç”¨ CoreDNS æ›¿ä»£ kube-dns ä¸ºé›†ç¾¤æä¾› DNS æœåŠ¡ã€‚CoreDNSåŸºæœ¬æ¶æ„å¦‚ä¸‹:</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20201208151150.png" alt="20201208151150"  />
</p>
<p>å¦‚æœéœ€è¦å®šåˆ¶DNSæœåŠ¡,å¯å‚è€ƒä¸‹é¢å®˜æ–¹ç»™çš„æ–¹æ¡ˆ:<a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/dns-custom-nameservers/"  target="_blank" rel="noopener" style="color:#42b983" ;>https://kubernetes.io/zh/docs/tasks/administer-cluster/dns-custom-nameservers/</a></p>
<h4 id="pod-dns">Pod DNS<a hidden class="anchor" aria-hidden="true" href="#pod-dns">#</a></h4>
<p>DNSç­–ç•¥å¯ä»¥é€ä¸ªPodæ¥è®¾å®šã€‚ç›®å‰ Kubernetes æ”¯æŒä»¥ä¸‹ç‰¹å®š Pod çš„ DNS ç­–ç•¥ã€‚è¿™äº›ç­–ç•¥å¯ä»¥åœ¨Podçš„<code>spec.dnsPolicy</code>å­—æ®µè®¾ç½®ï¼š</p>
<ul>
<li>&ldquo;Default&rdquo;: Pod ä»è¿è¡Œæ‰€åœ¨çš„èŠ‚ç‚¹ç»§æ‰¿åç§°è§£æé…ç½®</li>
<li>&ldquo;ClusterFirst&rdquo;: ä¸é…ç½®çš„é›†ç¾¤åŸŸåç¼€ä¸åŒ¹é…çš„ä»»ä½• DNS æŸ¥è¯¢ï¼ˆä¾‹å¦‚ &ldquo;<a href="https://www.kubernetes.io"  target="_blank" rel="noopener" style="color:#42b983" ;>www.kubernetes.io</a>&rdquo;ï¼‰ éƒ½å°†è½¬å‘åˆ°ä»èŠ‚ç‚¹ç»§æ‰¿çš„ä¸Šæ¸¸åç§°æœåŠ¡å™¨ã€‚é›†ç¾¤ç®¡ç†å‘˜å¯èƒ½é…ç½®äº†é¢å¤–çš„å­˜æ ¹åŸŸå’Œä¸Šæ¸¸ DNS æœåŠ¡å™¨</li>
<li>&ldquo;ClusterFirstWithHostNet&rdquo;ï¼šå¯¹äºä»¥ hostNetwork æ–¹å¼è¿è¡Œçš„ Podï¼Œåº”æ˜¾å¼è®¾ç½®å…¶ DNS ç­–ç•¥ &ldquo;ClusterFirstWithHostNet&rdquo;</li>
<li>&ldquo;None&rdquo;: æ­¤è®¾ç½®å…è®¸ Pod å¿½ç•¥ Kubernetes ç¯å¢ƒä¸­çš„ DNS è®¾ç½®ã€‚Pod ä¼šä½¿ç”¨å…¶<code>dnsConfig</code>å­—æ®µæ‰€æä¾›çš„ DNS è®¾ç½®</li>
</ul>
<blockquote>
<p>è¯´æ˜ï¼š &ldquo;Default&rdquo; ä¸æ˜¯é»˜è®¤çš„ DNS ç­–ç•¥ã€‚å¦‚æœæœªæ˜ç¡®æŒ‡å®š dnsPolicyï¼Œåˆ™ä½¿ç”¨ &ldquo;ClusterFirst&rdquo;ã€‚</p>
</blockquote>
<p>Pod çš„ DNS é…ç½®å¯è®©ç”¨æˆ·å¯¹ Pod çš„ DNS è®¾ç½®è¿›è¡Œæ›´å¤šæ§åˆ¶ã€‚</p>
<p>dnsConfig å­—æ®µæ˜¯å¯é€‰çš„ï¼Œå®ƒå¯ä»¥ä¸ä»»ä½• dnsPolicy è®¾ç½®ä¸€èµ·ä½¿ç”¨ã€‚ ä½†æ˜¯ï¼Œå½“ Pod çš„ dnsPolicy è®¾ç½®ä¸º &ldquo;None&rdquo; æ—¶ï¼Œå¿…é¡»æŒ‡å®š dnsConfig å­—æ®µã€‚</p>
<p>ç”¨æˆ·å¯ä»¥åœ¨ dnsConfig å­—æ®µä¸­æŒ‡å®šä»¥ä¸‹å±æ€§ï¼š</p>
<ul>
<li>nameserversï¼šå°†ç”¨ä½œäº Pod çš„ DNS æœåŠ¡å™¨çš„ IP åœ°å€åˆ—è¡¨ã€‚ æœ€å¤šå¯ä»¥æŒ‡å®š 3 ä¸ª IP åœ°å€ã€‚å½“ Pod çš„ dnsPolicy è®¾ç½®ä¸º &ldquo;None&rdquo; æ—¶ï¼Œ åˆ—è¡¨å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ª IP åœ°å€ï¼Œå¦åˆ™æ­¤å±æ€§æ˜¯å¯é€‰çš„</li>
<li>searchesï¼šç”¨äºåœ¨ Pod ä¸­æŸ¥æ‰¾ä¸»æœºåçš„ DNS æœç´¢åŸŸçš„åˆ—è¡¨ã€‚æ­¤å±æ€§æ˜¯å¯é€‰çš„, Kubernetes æœ€å¤šå…è®¸ 6 ä¸ªæœç´¢åŸŸ</li>
<li>optionsï¼šå¯é€‰çš„å¯¹è±¡åˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªå¯¹è±¡å¯èƒ½å…·æœ‰ name å±æ€§ï¼ˆå¿…éœ€ï¼‰å’Œ value å±æ€§ï¼ˆå¯é€‰ï¼‰</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºè‡ªå®šä¹‰DNSçš„Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># vim pod_dns.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: nginx
</span></span><span style="display:flex;"><span>    image: nginx:1.18.0
</span></span><span style="display:flex;"><span>    ports:
</span></span><span style="display:flex;"><span>    - containerPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  dnsPolicy: <span style="color:#e6db74">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>  dnsConfig:
</span></span><span style="display:flex;"><span>    nameservers:
</span></span><span style="display:flex;"><span>      - 8.8.8.8
</span></span><span style="display:flex;"><span>    searches:
</span></span><span style="display:flex;"><span>      - default.svc.cluster-domain.example
</span></span><span style="display:flex;"><span>      - cluster-domain.example
</span></span><span style="display:flex;"><span>    options:
</span></span><span style="display:flex;"><span>      - name: pod_num
</span></span><span style="display:flex;"><span>        value: <span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f pod_dns.yaml </span>
</span></span><span style="display:flex;"><span>pod/nginx created
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹DNSä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec nginx -- cat /etc/resolv.conf</span>
</span></span><span style="display:flex;"><span>nameserver 8.8.8.8
</span></span><span style="display:flex;"><span>search default.svc.cluster-domain.example cluster-domain.example
</span></span><span style="display:flex;"><span>options pod_num:1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Podè®¿é—®éªŒè¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºServiceæ¥æš´éœ²Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># cat nginx-service.yaml </span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx-service
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    name: nginx-service
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#ae81ff">8180</span>
</span></span><span style="display:flex;"><span>    targetPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: nginx
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f nginx-service.yaml </span>
</span></span><span style="display:flex;"><span>service/nginx-service created
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc</span>
</span></span><span style="display:flex;"><span>NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>    AGE
</span></span><span style="display:flex;"><span>nginx-service   ClusterIP   10.97.188.44   &lt;none&gt;        8180/TCP   75s
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec busybox -- nslookup 10.97.188.44</span>
</span></span><span style="display:flex;"><span>Server:    10.96.0.10
</span></span><span style="display:flex;"><span>Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:      10.97.188.44
</span></span><span style="display:flex;"><span>Address 1: 10.97.188.44 nginx-service.default.svc.cluster.local
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 network<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec busybox -- wget -q -O- nginx-service.default.svc.cluster.local:8180</span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;style&gt;
</span></span><span style="display:flex;"><span>    body <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        width: 35em;
</span></span><span style="display:flex;"><span>        margin: <span style="color:#ae81ff">0</span> auto;
</span></span><span style="display:flex;"><span>        font-family: Tahoma, Verdana, Arial, sans-serif;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>&lt;/style&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span style="display:flex;"><span>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span style="display:flex;"><span>working. Further configuration is required.&lt;/p&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;p&gt;For online documentation and support please refer to
</span></span><span style="display:flex;"><span>&lt;a href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span style="display:flex;"><span>Commercial support is available at
</span></span><span style="display:flex;"><span>&lt;a href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;p&gt;&lt;em&gt;Thank you <span style="color:#66d9ef">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div>

        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://deemoprobe.github.io/posts/tech/linux/nfs/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>NFS</span>
  </a>
  <a class="next" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesmetrics/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>KubernetesMetrics</span>
  </a>
</nav>

        </footer>
    </div>
</article>
</main>

<footer class="footer">
    
        <span id="runtime_span"></span>
        <script
            type="text/javascript">function show_runtime() { window.setTimeout("show_runtime()", 1000); X = new Date("1/1/2023 1:00:00"); Y = new Date(); T = (Y.getTime() - X.getTime()); M = 24 * 60 * 60 * 1000; a = T / M; A = Math.floor(a); b = (a - A) * 24; B = Math.floor(b); c = (b - B) * 60; C = Math.floor((b - B) * 60); D = Math.floor((c - C) * 60); runtime_span.innerHTML = "ç½‘ç«™å·²è¿è¡Œ" + A + "å¤©" + B + "å°æ—¶" + C + "åˆ†" + D + "ç§’" } show_runtime();</script>
    
    
    <br>
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="https://deemoprobe.github.io/" style="color:#939393;">William&#39;s Blog</a>
        All Rights Reserved
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"William's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>

<script>
    $("code[class^=language] ").on("mouseover", function () {
        if (this.clientWidth < this.scrollWidth) {
            $(this).css("width", "135%")
            $(this).css("border-top-right-radius", "var(--radius)")
        }
    }).on("mouseout", function () {
        $(this).css("width", "100%")
        $(this).css("border-top-right-radius", "unset")
    })
</script>
</body>

</html>
